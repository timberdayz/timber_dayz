name: Deploy to Staging

on:
  # [DISABLED] 自动部署已禁用，避免重复部署和资源竞争
  # 如果只有一个服务器，建议只使用 Production 手动部署
  # workflow_run:
  #   workflows: ["CI Pipeline", "Docker Build and Push"]
  #   types:
  #     - completed
  #   branches:
  #     - main
  #     - develop
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        type: string
        default: "latest"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
  # 检查是否配置了必要的 secrets
  check-config:
    runs-on: ubuntu-latest
    # [UPDATED] 现在只支持手动触发（workflow_dispatch）
    if: ${{ github.event_name == 'workflow_dispatch' }}
    outputs:
      can_deploy: ${{ steps.check.outputs.can_deploy }}
    steps:
      - name: Check deployment configuration
        id: check
        run: |
          if [ -z "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" ] || [ -z "${{ secrets.STAGING_HOST }}" ]; then
            echo "Deployment secrets not configured. Skipping deployment."
            echo "Required secrets: STAGING_SSH_PRIVATE_KEY, STAGING_HOST"
            echo "can_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "Deployment secrets configured. Proceeding with deployment."
            echo "can_deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: check-config
    if: ${{ needs.check-config.outputs.can_deploy == 'true' }}
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}

      - name: Determine image tag
        id: image-tag
        run: |
          # [UPDATED] 现在只支持手动触发，直接使用输入的 image_tag
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          echo "Deploying with tag: ${{ steps.image-tag.outputs.tag }}"

      - name: Deploy to staging server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER || 'root' }}
          STAGING_PATH: ${{ secrets.STAGING_PATH || '/opt/xihong_erp' }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          ssh -o StrictHostKeyChecking=no ${STAGING_USER}@${STAGING_HOST} << 'ENDSSH'
            set -e
            cd ${STAGING_PATH}
            
            # 登录到容器仓库
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            
            # 拉取指定标签的镜像（如果不存在则使用 latest）
            echo "Pulling images with tag: ${IMAGE_TAG}"
            BACKEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${IMAGE_TAG}"
            FRONTEND_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${IMAGE_TAG}"
            
            docker pull ${BACKEND_IMAGE} || docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
            docker pull ${FRONTEND_IMAGE} || docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
            
            # 标记镜像为本地名称（用于 docker-compose）
            docker tag ${BACKEND_IMAGE} xihong_erp_backend:latest 2>/dev/null || \
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest xihong_erp_backend:latest
            docker tag ${FRONTEND_IMAGE} xihong_erp_frontend:latest 2>/dev/null || \
            docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest xihong_erp_frontend:latest
            
            # 使用 docker-compose 部署（测试环境使用 staging profile）
            # 注意：docker-compose.prod.yml 使用 build，我们需要临时覆盖为 image
            export APP_ENV=staging
            export COMPOSE_PROJECT_NAME=xihong_erp
            
            # 创建临时 compose 文件，覆盖 build 为 image
            cat > docker-compose.deploy.yml <<EOF
            services:
              backend:
                image: xihong_erp_backend:latest
              frontend:
                image: xihong_erp_frontend:latest
            EOF
            
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.deploy.yml --profile production up -d
            
            # 等待服务启动
            sleep 10
            
            # 健康检查
            for i in {1..30}; do
              if curl -f http://localhost:8001/health > /dev/null 2>&1; then
                echo "[OK] Backend health check passed"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "[FAIL] Backend health check failed"
                # 重新创建临时文件以查看日志
                cat > docker-compose.deploy.yml <<EOF
                services:
                  backend:
                    image: xihong_erp_backend:latest
                  frontend:
                    image: xihong_erp_frontend:latest
                EOF
                docker-compose -f docker-compose.yml -f docker-compose.prod.yml -f docker-compose.deploy.yml logs backend
                rm -f docker-compose.deploy.yml
                exit 1
              fi
              echo "Waiting for backend... ($i/30)"
              sleep 2
            done
            
            # 清理临时文件
            rm -f docker-compose.deploy.yml
            
            echo "[OK] Deployment completed successfully"
          ENDSSH

      - name: Health check verification
        run: |
          STAGING_URL=${{ secrets.STAGING_URL || 'http://staging.example.com' }}
          if curl -f ${STAGING_URL}/health > /dev/null 2>&1; then
            echo "[OK] Health check passed"
          else
            echo "[FAIL] Health check failed"
            exit 1
          fi

      - name: Send deployment notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true # 如果 SLACK_WEBHOOK_URL 未配置会静默失败

  # 当部署被跳过时显示消息
  skip-notification:
    runs-on: ubuntu-latest
    needs: check-config
    if: ${{ needs.check-config.outputs.can_deploy == 'false' }}
    steps:
      - name: Deployment skipped
        run: |
          echo "========================================"
          echo "Deployment to staging was SKIPPED"
          echo "========================================"
          echo ""
          echo "Required GitHub Secrets not configured:"
          echo "  - STAGING_SSH_PRIVATE_KEY"
          echo "  - STAGING_HOST"
          echo ""
          echo "To enable deployment, configure these secrets in:"
          echo "  Settings > Secrets and variables > Actions"
          echo "========================================"
