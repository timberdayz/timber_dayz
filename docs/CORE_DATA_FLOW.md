# 核心数据流程设计

**版本**: v4.11.1  
**创建日期**: 2025-11-13  
**状态**: ✅ 生产就绪

---

## 📊 完整数据流程

系统采用**三层数据分类**架构，实现从用户配置到前端展示的完整数据流程：

```
┌─────────────────────────────────────────────────────────────┐
│  1. 用户配置 (A类数据) - User Configuration                │
├─────────────────────────────────────────────────────────────┤
│  • 在系统中创建销售战役                                      │
│  • 在系统中设置月度目标                                      │
│  • 在系统中配置绩效权重                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  2. 数据采集 (B类数据) - Data Collection                    │
├─────────────────────────────────────────────────────────────┤
│  • 从电商平台导出Excel文件                                   │
│  • 通过字段映射系统识别字段                                  │
│  • 自动入库到fact_orders/fact_product_metrics表            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  3. 系统计算 (C类数据) - System Calculation                 │
├─────────────────────────────────────────────────────────────┤
│  • 自动计算达成率 (实际值/目标值)                            │
│  • 自动计算健康度评分                                        │
│  • 自动计算排名和预警                                        │
│  • 更新sales_campaigns/sales_targets/shop_health_scores表   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  4. 前端展示 - Frontend Display                             │
├─────────────────────────────────────────────────────────────┤
│  • 销售看板显示店铺销售表现                                  │
│  • 店铺分析显示健康度评分                                    │
│  • 业务概览显示滞销清理排名                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 数据分类详解

### A类：用户配置数据（User-Configured Data）

**定义**: 用户在系统中手动设置的数据，不需要Excel采集

**典型场景**:
- **销售战役管理**: 战役名称、类型、时间范围、目标销售额、参与店铺
- **目标管理**: 月度/周度目标设置、目标分解（按店铺/按时间）
- **绩效管理**: 绩效计算规则、权重设置（销售额30%、毛利25%等）

**存储位置**:
- `sales_campaigns` - 销售战役配置
- `sales_campaign_shops` - 战役参与店铺
- `sales_targets` - 目标配置
- `target_breakdown` - 目标分解
- `performance_config` - 绩效配置

**特点**:
- ✅ 用户在系统中直接配置
- ✅ 支持实时修改
- ✅ 不需要Excel导入
- ✅ 需要友好的配置界面

---

### B类：业务数据（Business Data from Excel）

**定义**: 从电商平台导出的Excel文件中采集的业务数据

**典型场景**:
- **订单数据**: 订单号、订单日期、订单金额、订单状态
- **产品销售数据**: SKU、销量、销售额、浏览量、转化率
- **库存数据**: 库存数量、库存价值、库存状态
- **流量数据**: 页面浏览量、访客数、点击率

**存储位置**:
- `fact_orders` - 订单事实表
- `fact_order_items` - 订单项事实表
- `fact_product_metrics` - 产品指标事实表（支持7个数据域）

**处理流程**:
1. **Excel导出**: 从Shopee/TikTok/Amazon/妙手ERP等平台导出Excel文件
2. **字段映射**: 通过字段映射系统识别和映射字段
   - 原始字段 → 中文列名层 → 标准字段 → 数据库列名
   - 支持Pattern-based Mapping（一个规则处理无限组合）
   - 支持全球180+货币自动识别和转换
3. **自动入库**: 数据自动同步到对应的fact表
   - 支持数据隔离区（查看和重新处理隔离数据）
   - 支持数据质量检查

**特点**:
- ✅ 从Excel文件采集
- ✅ 需要字段映射系统支持
- ✅ 自动同步到数据库
- ✅ 支持多平台、多格式

---

### C类：计算数据（System-Calculated Data）

**定义**: 系统基于A类和B类数据自动计算得出的数据

**典型场景**:
- **达成率**: 实际值 / 目标值（如销售额达成率、订单数达成率）
- **健康度评分**: 基于GMV、转化率、库存、服务等指标的综合评分
- **排名**: 基于某个指标的排序（如流量排名、滞销清理排名）
- **预警**: 基于规则自动生成的预警（如库存预警、健康度预警）

**存储位置**:
- `sales_campaigns.actual_amount`, `sales_campaigns.achievement_rate` - 战役达成数据
- `target_breakdown.achieved_amount`, `target_breakdown.achievement_rate` - 目标达成数据
- `shop_health_scores` - 店铺健康度评分
- `shop_alerts` - 店铺预警
- `clearance_ranking` - 滞销清理排名

**计算时机**:
- **实时计算**: 用户查看时实时计算（如达成率）
- **定时计算**: 定时任务自动计算（如健康度评分、排名）
- **触发计算**: 数据更新后触发计算（如订单入库后更新达成率）

**特点**:
- ✅ 基于A类和B类数据计算
- ✅ 不需要Excel采集
- ✅ 系统自动计算和更新
- ✅ 支持实时和定时计算

---

## 🔄 数据流程示例

### 示例1：销售战役管理

```
1. 用户配置（A类）
   ↓
   用户在"销售战役管理"页面创建战役
   - 战役名称: "2025春节促销"
   - 时间范围: 2025-01-20 至 2025-02-10
   - 目标销售额: 100,000 CNY
   - 参与店铺: Shopee新加坡旗舰店、Lazada新加坡店
   ↓
   数据存储到 sales_campaigns 和 sales_campaign_shops 表

2. 数据采集（B类）
   ↓
   系统从电商平台采集订单数据
   - 从Shopee/TikTok/Amazon导出Excel文件
   - 通过字段映射系统识别字段
   - 自动入库到 fact_orders 表
   ↓
   订单数据包含：订单号、订单日期、订单金额、店铺ID等

3. 系统计算（C类）
   ↓
   系统自动计算战役达成数据
   - 查询 fact_orders 表，统计参与店铺在时间范围内的订单
   - 计算实际销售额 = SUM(total_amount_rmb)
   - 计算实际订单数 = COUNT(*)
   - 计算达成率 = (实际销售额 / 目标销售额) * 100
   ↓
   更新 sales_campaigns 表的 actual_amount、actual_quantity、achievement_rate 字段

4. 前端展示
   ↓
   用户在"销售看板"页面查看
   - 显示战役名称、时间范围、目标销售额
   - 显示实际销售额、实际订单数
   - 显示达成率（进度条或百分比）
   - 显示参与店铺的详细表现
```

### 示例2：店铺健康度评分

```
1. 用户配置（A类）
   ↓
   用户在"绩效管理"页面配置权重
   - GMV权重: 30%
   - 转化率权重: 25%
   - 库存权重: 25%
   - 服务权重: 20%
   ↓
   数据存储到 performance_config 表

2. 数据采集（B类）
   ↓
   系统从电商平台采集产品数据
   - 从Shopee/TikTok导出产品表现Excel文件
   - 通过字段映射系统识别字段
   - 自动入库到 fact_product_metrics 表
   ↓
   产品数据包含：SKU、销售额、浏览量、转化率、库存等

3. 系统计算（C类）
   ↓
   系统自动计算店铺健康度评分
   - 查询 fact_product_metrics 表，聚合店铺数据
   - 计算GMV得分 = (GMV / 目标GMV) * 30
   - 计算转化率得分 = (转化率 / 目标转化率) * 25
   - 计算库存得分 = (库存周转率 / 目标周转率) * 25
   - 计算服务得分 = (客户满意度 / 目标满意度) * 20
   - 计算总分 = GMV得分 + 转化率得分 + 库存得分 + 服务得分
   ↓
   更新 shop_health_scores 表的各项得分和总分

4. 前端展示
   ↓
   用户在"店铺分析"页面查看
   - 显示店铺健康度总分
   - 显示各项得分（GMV、转化率、库存、服务）
   - 显示风险等级（优秀/良好/警告/严重）
   - 显示预警信息
```

---

## 📋 技术实现

### 数据采集（B类）技术栈

- **采集工具**: Playwright（反检测技术）
- **字段映射**: Pattern-based Mapping + 全球货币支持
- **数据入库**: SQLAlchemy ORM + 批量插入优化
- **数据隔离**: 数据隔离区（查看和重新处理）

### 系统计算（C类）技术栈

- **计算引擎**: Python + SQLAlchemy + PostgreSQL
- **定时任务**: APScheduler（定时刷新）
- **实时计算**: FastAPI异步处理
- **物化视图**: 16个物化视图（性能优化）

### 前端展示技术栈

- **前端框架**: Vue.js 3 + Element Plus + Pinia
- **图表库**: ECharts（数据可视化）
- **API调用**: Axios（RESTful API）

---

## 🎯 关键原则

1. **数据分类清晰**: A类/B类/C类数据职责明确，互不混淆
2. **自动化优先**: 尽可能自动化处理，减少人工干预
3. **实时性保证**: 关键指标支持实时计算和展示
4. **可追溯性**: 所有数据都有明确的来源和计算逻辑
5. **扩展性**: 支持新增数据域、新增计算指标

---

## 📚 相关文档

- [数据来源和字段映射设计](DATA_SOURCE_AND_FIELD_MAPPING_DESIGN.md) - 详细设计文档
- [后端数据库设计总结](BACKEND_DATABASE_DESIGN_SUMMARY.md) - 数据库设计
- [Agent快速上手](AGENT_START_HERE.md) - Agent开发指南

---

**v4.11.1 - 完整数据流程设计 - 三层数据分类架构！** 🚀

