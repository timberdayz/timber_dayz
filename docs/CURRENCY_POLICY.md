# 货币策略文档

**版本**: v1.0.0  
**创建日期**: 2025-01-31  
**用途**: C类数据核心字段优化计划（Phase 3）

---

## 一、概述

本文档定义各数据域的货币策略、平台数据采集优先级、货币转换规则和数据质量要求。

### 1.1 核心原则

- **运营数据（无货币）**: Shopee、TikTok等平台只采集数量指标，禁止货币字段
- **经营数据（CNY本位币）**: 妙手ERP统一CNY本位币，所有金额字段必须为CNY
- **单一数据源**: 每个数据域有明确的数据源优先级，避免多源混用

---

## 二、数据域货币策略定义

### 2.1 orders域（订单数据）

**货币策略**: CNY本位币

**数据源优先级**:
1. **妙手ERP**（优先级最高）
   - 所有订单金额统一为CNY
   - 禁止多币种混用
   - 货币转换在妙手ERP导出时完成

**验证要求**:
- 所有金额字段必须为CNY
- 禁止出现其他货币（如SGD、MYR、BRL等）
- 字段命名必须包含`_rmb`或`_cny`后缀

**核心字段**:
- `total_amount_rmb` - 订单总金额（CNY）
- `sales_amount_rmb` - 销售额（CNY）

**数据质量要求**:
- 金额字段不能为NULL
- 金额字段必须 >= 0
- 金额字段精度为2位小数

---

### 2.2 products域（产品数据）

**货币策略**: 无货币

**数据源优先级**:
1. **Shopee**（运营数据）
   - 只采集数量指标（销量、访客数、订单数等）
   - 禁止采集货币字段
   - 避免货币转换复杂

2. **TikTok**（运营数据）
   - 只采集数量指标（销量、访客数、订单数等）
   - 禁止采集货币字段
   - 避免货币转换复杂

**验证要求**:
- 禁止出现任何货币字段（如`sales_amount_sgd`、`price_myr`等）
- 只允许数量、比率、评分等非货币字段
- 如果Excel文件中包含货币字段，应忽略或标记为警告

**核心字段**（无货币）:
- `sales_volume` - 销量（数量）
- `unique_visitors` - 独立访客数（数量）
- `order_count` - 订单数（数量）
- `conversion_rate` - 转化率（比率）
- `rating` - 评分（0-5）

**数据质量要求**:
- 数量字段不能为NULL
- 数量字段必须 >= 0
- 比率字段范围：0-100

---

### 2.3 inventory域（库存数据）

**货币策略**: CNY本位币

**数据源优先级**:
1. **妙手ERP**（优先级最高）
   - 所有库存价值统一为CNY
   - 禁止多币种混用
   - 货币转换在妙手ERP导出时完成

**验证要求**:
- 所有金额字段必须为CNY
- 禁止出现其他货币
- 字段命名必须包含`_rmb`或`_cny`后缀

**核心字段**:
- `available_stock` - 可用库存（数量）
- `sales_volume_30d` - 近30天销量（数量）
- `price_rmb` - 单价（CNY，可选）

**数据质量要求**:
- 数量字段不能为NULL
- 数量字段必须 >= 0
- 金额字段精度为2位小数

---

## 三、平台数据采集优先级

### 3.1 Shopee平台

**运营数据（products域）**:
- ✅ 采集：销量、访客数、订单数、转化率、评分
- ❌ 禁止：销售额、价格等货币字段

**原因**: Shopee平台货币符号复杂（SGD、MYR、THB等），避免货币转换复杂

---

### 3.2 TikTok平台

**运营数据（products域）**:
- ✅ 采集：销量、访客数、订单数、转化率、评分
- ❌ 禁止：销售额、价格等货币字段

**原因**: TikTok平台货币符号复杂（USD、EUR等），避免货币转换复杂

---

### 3.3 妙手ERP平台

**经营数据（orders域 + inventory域）**:
- ✅ 采集：订单金额、销售额、库存价值（统一CNY）
- ✅ 必须：所有金额字段为CNY本位币

**原因**: 妙手ERP统一导出CNY，无需货币转换

---

## 四、货币转换规则

### 4.1 转换原则

- **不转换**: 运营数据不包含货币字段，无需转换
- **统一CNY**: 经营数据统一为CNY，转换在妙手ERP导出时完成
- **禁止多币种**: 禁止在系统中混用多种货币

### 4.2 转换时机

- **数据采集阶段**: 不进行货币转换
- **数据导出阶段**: 妙手ERP导出时统一转换为CNY
- **数据入库阶段**: 验证货币策略合规性

---

## 五、数据质量要求

### 5.1 运营数据质量要求

**products域**:
- ✅ 数量字段完整性：销量、访客数、订单数必须存在
- ✅ 比率字段有效性：转化率范围0-100
- ✅ 评分字段有效性：评分范围0-5
- ❌ 禁止货币字段：如果发现货币字段，应标记为警告

### 5.2 经营数据质量要求

**orders域**:
- ✅ 金额字段完整性：订单总金额必须存在
- ✅ 金额字段有效性：金额 >= 0，精度2位小数
- ✅ 货币一致性：所有金额字段必须为CNY

**inventory域**:
- ✅ 数量字段完整性：可用库存、近30天销量必须存在
- ✅ 数量字段有效性：数量 >= 0
- ✅ 金额字段（可选）：如果存在，必须为CNY

---

## 六、字段映射模板货币策略

### 6.1 Shopee运营数据模板

**模板配置** (`config/field_mapping_templates/c_class_core_fields.yaml`):
```yaml
shopee:
  products:
    common:
      # 只包含数量指标，不包含货币字段
      sales_volume: [...]
      unique_visitors: [...]
      order_count: [...]
      conversion_rate: [...]
      rating: [...]
```

### 6.2 TikTok运营数据模板

**模板配置**:
```yaml
tiktok:
  products:
    common:
      # 只包含数量指标，不包含货币字段
      sales_volume: [...]
      unique_visitors: [...]
      order_count: [...]
      conversion_rate: [...]
      rating: [...]
```

### 6.3 妙手ERP经营数据模板

**模板配置**:
```yaml
miaoshou:
  orders:
    common:
      # 包含CNY本位币字段
      total_amount_rmb: [...]
      sales_amount_rmb: [...]
  
  products:
    common:
      # 包含CNY本位币字段（可选）
      sales_amount_rmb: [...]
```

---

## 七、验证和监控

### 7.1 字段映射验证

**验证时机**: 数据入库前

**验证规则**:
1. 检查字段是否符合货币策略
2. 运营数据域禁止货币字段
3. 经营数据域必须为CNY

**验证工具**: `backend/services/currency_validator.py`

---

### 7.2 数据质量监控

**监控指标**:
- 货币策略合规率
- 货币字段出现频率
- 多币种混用情况

**监控API**: `GET /api/data-quality/c-class-readiness`

---

## 八、常见问题

### 8.1 Q: Shopee数据中包含销售额字段怎么办？

**A**: 应忽略或标记为警告。运营数据不采集货币字段，销售额统一从妙手ERP获取。

---

### 8.2 Q: 如何确保所有金额字段都是CNY？

**A**: 
1. 数据源统一：经营数据统一从妙手ERP导出
2. 字段命名：金额字段必须包含`_rmb`或`_cny`后缀
3. 验证检查：入库前验证货币策略合规性

---

### 8.3 Q: 如果Excel文件中包含多币种怎么办？

**A**: 
1. 运营数据：忽略货币字段，只采集数量指标
2. 经营数据：拒绝入库，提示用户从妙手ERP导出CNY格式

---

## 九、更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0.0 | 2025-01-31 | 初始版本，定义货币策略和数据源优先级 |

---

## 十、相关文档

- [C类数据核心字段定义](C_CLASS_DATA_CORE_FIELDS.md)
- [数据质量保障指南](DATA_QUALITY_GUIDE.md)
- [字段映射用户指南](USER_GUIDE_FIELD_MAPPING.md)

