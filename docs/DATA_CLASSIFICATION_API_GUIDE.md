# 数据分类传输规范指南

**创建时间**: 2025-01-16  
**状态**: 📋 规划阶段  
**目的**: 定义A类、B类、C类数据的API传输规范和应用场景

---

## 📋 数据分类定义

### A类数据：用户配置数据

**定义**: 用户手动配置的业务规则和策略数据

**特点**:
- 数据量小（通常<1000条）
- 更新频率低（按需更新）
- 需要CRUD操作（创建、读取、更新、删除）
- 需要版本控制和审计

**典型数据**:
- 销售战役配置（目标、规则、时间范围）
- 目标管理配置（销售目标、分解规则）
- 绩效配置（权重、评分规则）
- 店铺配置（基本信息、运营策略）

**API特点**:
- 支持完整的CRUD操作
- 需要数据验证和业务规则检查
- 需要版本控制和变更历史
- 响应时间要求：<200ms

---

### B类数据：业务数据

**定义**: 从外部平台采集的业务交易数据

**特点**:
- 数据量大（百万级到千万级）
- 更新频率高（实时或准实时）
- 主要是查询操作（很少更新）
- 需要高效查询和聚合

**典型数据**:
- 订单数据（订单详情、订单状态）
- 产品数据（产品信息、库存数据）
- 流量数据（访问量、转化率）
- 财务数据（收入、支出、利润）

**API特点**:
- 主要支持查询操作（GET）
- 需要分页支持（大数据量）
- 需要多维度筛选（平台、店铺、时间范围）
- 需要聚合查询（SUM、COUNT、AVG）
- 响应时间要求：<500ms（简单查询）、<2s（复杂聚合）

---

### C类数据：计算数据

**定义**: 基于A类和B类数据计算得出的指标和评分

**特点**:
- 数据量中等（万级到百万级）
- 更新频率中等（定时计算或按需计算）
- 主要是查询操作（计算后存储）
- 需要实时计算或预计算

**典型数据**:
- 店铺健康度评分（基于多个指标计算）
- 达成率（目标 vs 实际）
- 排名数据（GMV排名、转化率排名）
- 预警数据（异常检测、风险预警）

**API特点**:
- 主要支持查询操作（GET）
- 需要实时计算或预计算（物化视图）
- 需要多维度筛选（平台、店铺、时间范围）
- 需要对比分析（同比、环比）
- 响应时间要求：<1s（预计算）、<3s（实时计算）

---

## 🔧 API设计规范

### A类数据API规范

#### 1. 统一响应格式

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "销售战役1",
    "target_amount": 100000.00,
    "start_date": "2025-01-01",
    "end_date": "2025-01-31",
    "status": "active",
    "created_at": "2025-01-16T10:30:00Z",
    "updated_at": "2025-01-16T10:30:00Z"
  },
  "timestamp": "2025-01-16T10:30:00Z"
}
```

**列表响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "销售战役1",
      "status": "active"
    },
    {
      "id": 2,
      "name": "销售战役2",
      "status": "completed"
    }
  ],
  "total": 100,
  "timestamp": "2025-01-16T10:30:00Z"
}
```

#### 2. CRUD操作规范

**创建（POST）**：
```http
POST /api/sales-campaigns
Content-Type: application/json

{
  "name": "销售战役1",
  "target_amount": 100000.00,
  "start_date": "2025-01-01",
  "end_date": "2025-01-31"
}
```

**读取（GET）**：
```http
GET /api/sales-campaigns/{id}
```

**更新（PUT）**：
```http
PUT /api/sales-campaigns/{id}
Content-Type: application/json

{
  "name": "销售战役1（更新）",
  "target_amount": 120000.00
}
```

**删除（DELETE）**：
```http
DELETE /api/sales-campaigns/{id}
```

#### 3. 数据验证规范

- **必填字段验证**: 使用Pydantic模型验证
- **业务规则验证**: 在服务层验证业务规则
- **唯一性验证**: 检查唯一约束（如名称唯一）
- **关联性验证**: 检查外键关联（如店铺存在）

#### 4. 版本控制和审计

- **版本号**: 每次更新自动递增版本号
- **变更历史**: 记录所有变更操作（创建、更新、删除）
- **审计日志**: 记录操作人、操作时间、操作内容

---

### B类数据API规范

#### 1. 统一响应格式

**查询响应**：
```json
{
  "success": true,
  "data": [
    {
      "order_id": "ORD001",
      "platform_code": "shopee",
      "shop_id": "shop001",
      "total_amount": 123.46,
      "order_date": "2025-01-16T10:30:00Z",
      "status": "completed"
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 1000,
    "total_pages": 50,
    "has_previous": false,
    "has_next": true
  },
  "timestamp": "2025-01-16T10:30:00Z"
}
```

**聚合响应**：
```json
{
  "success": true,
  "data": {
    "gmv": 123456.78,
    "orders": 1000,
    "aov": 123.46,
    "period": {
      "start_date": "2025-01-01",
      "end_date": "2025-01-31"
    }
  },
  "timestamp": "2025-01-16T10:30:00Z"
}
```

#### 2. 查询操作规范

**列表查询（分页）**：
```http
GET /api/main-views/orders/summary?page=1&page_size=20&start_date=2025-01-01&end_date=2025-01-31&platform=shopee
```

**详情查询**：
```http
GET /api/main-views/orders/detail/{order_id}
```

**聚合查询**：
```http
GET /api/dashboard/overview?start_date=2025-01-01&end_date=2025-01-31&platforms=shopee,lazada
```

#### 3. 筛选参数规范

**标准筛选参数**：
- `platform` / `platforms`: 平台代码（单个或多个，逗号分隔）
- `shop_id` / `shops`: 店铺ID（单个或多个，逗号分隔）
- `account` / `accounts`: 账号（单个或多个，逗号分隔）
- `start_date`: 开始日期（ISO 8601格式：YYYY-MM-DD）
- `end_date`: 结束日期（ISO 8601格式：YYYY-MM-DD）
- `granularity`: 粒度（daily/weekly/monthly）

**业务筛选参数**（根据数据域不同）：
- 订单数据：`order_status`, `payment_status`, `is_cancelled`
- 产品数据：`category`, `status`, `has_image`
- 流量数据：`traffic_source`, `device_type`

#### 4. 分页规范

**标准分页参数**：
- `page`: 页码（从1开始，默认1）
- `page_size`: 每页数量（默认20，最大100）

**分页响应**：
- `pagination.page`: 当前页码
- `pagination.page_size`: 每页数量
- `pagination.total`: 总记录数
- `pagination.total_pages`: 总页数
- `pagination.has_previous`: 是否有上一页
- `pagination.has_next`: 是否有下一页

---

### C类数据API规范

#### 1. 统一响应格式

**评分响应**：
```json
{
  "success": true,
  "data": {
    "shop_id": "shop001",
    "platform_code": "shopee",
    "health_score": 85.5,
    "scores": {
      "gmv_score": 90.0,
      "conversion_score": 80.0,
      "traffic_score": 85.0
    },
    "period": {
      "start_date": "2025-01-01",
      "end_date": "2025-01-31"
    },
    "calculated_at": "2025-01-16T10:30:00Z"
  },
  "timestamp": "2025-01-16T10:30:00Z"
}
```

**排名响应**：
```json
{
  "success": true,
  "data": [
    {
      "rank": 1,
      "shop_id": "shop001",
      "gmv": 123456.78,
      "growth_rate": 15.5
    },
    {
      "rank": 2,
      "shop_id": "shop002",
      "gmv": 98765.43,
      "growth_rate": 12.3
    }
  ],
  "total": 100,
  "timestamp": "2025-01-16T10:30:00Z"
}
```

#### 2. 查询操作规范

**评分查询**：
```http
GET /api/store-analytics/health-scores?platform=shopee&start_date=2025-01-01&end_date=2025-01-31
```

**排名查询**：
```http
GET /api/dashboard/pk-ranking?granularity=daily&date=2025-01-16&metric=gmv
```

**达成率查询**：
```http
GET /api/target-management/{target_id}/achievement?period=2025-01
```

#### 3. 计算策略规范

**预计算策略**（物化视图）：
- 适用于：标准时间维度（日/周/月）、2年内数据
- 优势：查询速度快（<100ms）
- 劣势：需要定期刷新、存储空间占用

**实时计算策略**（fact表查询）：
- 适用于：自定义时间范围、2年以上数据、复杂筛选条件
- 优势：数据实时、灵活查询
- 劣势：查询速度慢（1-3s）

**混合策略**（智能路由）：
- 根据查询条件自动选择最优策略
- 标准维度 + 2年内 → 物化视图
- 自定义范围 OR 2年以上 → 实时计算

---

## 📊 应用场景

### A类数据应用场景

#### 1. 销售战役管理
- **创建战役**: 设置目标、规则、时间范围
- **查看战役**: 查看战役列表和详情
- **更新战役**: 修改目标、规则
- **删除战役**: 删除无效战役

#### 2. 目标管理
- **设置目标**: 创建销售目标、分解目标
- **查看目标**: 查看目标列表和详情
- **更新目标**: 调整目标金额、时间范围
- **删除目标**: 删除无效目标

#### 3. 绩效配置
- **设置权重**: 配置绩效评分权重
- **查看规则**: 查看评分规则和配置
- **更新规则**: 修改评分规则
- **删除规则**: 删除无效规则

---

### B类数据应用场景

#### 1. 订单数据查询
- **订单列表**: 分页查询订单列表
- **订单详情**: 查看订单详细信息
- **订单统计**: 聚合查询订单数据（GMV、订单数、AOV）

#### 2. 产品数据查询
- **产品列表**: 分页查询产品列表
- **产品详情**: 查看产品详细信息
- **库存查询**: 查询库存数据

#### 3. 流量数据查询
- **流量趋势**: 查询流量趋势数据
- **转化率分析**: 查询转化率数据
- **流量排名**: 查询流量排名数据

---

### C类数据应用场景

#### 1. 店铺健康度评分
- **评分查询**: 查询店铺健康度评分
- **评分计算**: 触发评分计算（实时或定时）
- **评分对比**: 对比不同店铺的评分

#### 2. 达成率分析
- **达成率查询**: 查询目标达成率
- **达成率对比**: 对比不同目标的达成率
- **达成率趋势**: 查询达成率趋势数据

#### 3. 排名数据
- **GMV排名**: 查询GMV排名数据
- **转化率排名**: 查询转化率排名数据
- **排名对比**: 对比不同时间段的排名

---

## 🎯 最佳实践

### 1. A类数据最佳实践

- ✅ **数据验证**: 使用Pydantic模型进行数据验证
- ✅ **业务规则**: 在服务层验证业务规则
- ✅ **版本控制**: 记录每次变更的版本号
- ✅ **审计日志**: 记录所有操作日志
- ✅ **软删除**: 使用软删除而非硬删除（保留历史数据）

### 2. B类数据最佳实践

- ✅ **分页查询**: 大数据量必须使用分页
- ✅ **索引优化**: 为常用查询字段创建索引
- ✅ **聚合查询**: 使用数据库聚合函数（SUM、COUNT、AVG）
- ✅ **缓存策略**: 对热点数据使用缓存（Redis）
- ✅ **查询优化**: 避免全表扫描，使用WHERE条件筛选

### 3. C类数据最佳实践

- ✅ **预计算**: 对标准时间维度使用物化视图预计算
- ✅ **实时计算**: 对自定义范围使用实时计算
- ✅ **智能路由**: 根据查询条件自动选择最优策略
- ✅ **缓存策略**: 对计算结果使用缓存（避免重复计算）
- ✅ **定时刷新**: 物化视图定时刷新（保持数据新鲜度）

---

## 📚 相关文档

- [API契约开发指南](API_CONTRACTS.md)
- [错误处理测试文档](ERROR_HANDLING_TEST.md)
- [端到端测试指南](E2E_TEST_GUIDE.md)
- [Mock数据替换计划](MOCK_DATA_REPLACEMENT_PLAN.md)
- [API兼容性验证指南](API_COMPATIBILITY_VERIFICATION.md)

---

**最后更新**: 2025-01-16  
**维护**: AI Agent Team  
**状态**: 📋 规划阶段，待实施

