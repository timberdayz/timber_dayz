# æ•°æ®æµè½¬æµç¨‹è‡ªåŠ¨åŒ–æµ‹è¯•æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-01-31  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ç›®çš„**: æä¾›å®Œæ•´çš„æ•°æ®æµè½¬æµç¨‹è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ³•å’Œæ­¥éª¤

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ•°æ®æµè½¬æµç¨‹è‡ªåŠ¨åŒ–çš„å®Œæ•´æµ‹è¯•æŒ‡å—ï¼ŒåŒ…æ‹¬Bç±»æ•°æ®å…¥åº“ã€ç‰©åŒ–è§†å›¾åˆ·æ–°ã€Cç±»æ•°æ®è®¡ç®—ç­‰å…¨æµç¨‹æµ‹è¯•ã€‚

---

## ğŸ¯ æµ‹è¯•ç›®æ ‡

### 1. Bç±»æ•°æ®å…¥åº“åè‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾
- âœ… éªŒè¯Bç±»æ•°æ®å…¥åº“åè§¦å‘`DATA_INGESTED`äº‹ä»¶
- âœ… éªŒè¯äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- âœ… éªŒè¯ç‰©åŒ–è§†å›¾è‡ªåŠ¨åˆ·æ–°
- âœ… éªŒè¯åˆ·æ–°é¡ºåºæ­£ç¡®ï¼ˆä¾èµ–å…³ç³»ï¼‰

### 2. ç‰©åŒ–è§†å›¾åˆ·æ–°åè‡ªåŠ¨è®¡ç®—Cç±»æ•°æ®
- âœ… éªŒè¯ç‰©åŒ–è§†å›¾åˆ·æ–°åè§¦å‘`MV_REFRESHED`äº‹ä»¶
- âœ… éªŒè¯äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- âœ… éªŒè¯Cç±»æ•°æ®è‡ªåŠ¨è®¡ç®—
- âœ… éªŒè¯è®¡ç®—ç»“æœæ­£ç¡®

### 3. Aç±»æ•°æ®æ›´æ–°åè‡ªåŠ¨é‡æ–°è®¡ç®—Cç±»æ•°æ®
- âœ… éªŒè¯Aç±»æ•°æ®æ›´æ–°åè§¦å‘`A_CLASS_UPDATED`äº‹ä»¶
- âœ… éªŒè¯äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- âœ… éªŒè¯Cç±»æ•°æ®è‡ªåŠ¨é‡æ–°è®¡ç®—
- âœ… éªŒè¯é‡æ–°è®¡ç®—ç»“æœæ­£ç¡®

---

## ğŸ§ª æµ‹è¯•ç¯å¢ƒå‡†å¤‡

### 1. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åç«¯æœåŠ¡
python run.py --backend-only

# å¯åŠ¨å‰ç«¯æœåŠ¡ï¼ˆå¯é€‰ï¼‰
python run.py --frontend-only
```

### 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥

```bash
# æ£€æŸ¥PostgreSQLæ˜¯å¦è¿è¡Œ
docker ps | grep postgres

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
python -c "from backend.models.database import get_db; db = next(get_db()); print('æ•°æ®åº“è¿æ¥æˆåŠŸ')"
```

### 3. æ£€æŸ¥Celeryï¼ˆå¯é€‰ï¼‰

```bash
# å¦‚æœä½¿ç”¨Celeryï¼Œå¯åŠ¨Celery worker
celery -A backend.celery_app worker --loglevel=info
```

**æ³¨æ„**: å¦‚æœCeleryæœªé…ç½®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°åŒæ­¥å¤„ç†æ¨¡å¼ã€‚

---

## ğŸ“ æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: Bç±»æ•°æ®å…¥åº“åè‡ªåŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾

#### æ­¥éª¤1.1: å‡†å¤‡æµ‹è¯•æ•°æ®

**æ–¹æ³•1: ä½¿ç”¨å­—æ®µæ˜ å°„APIä¸Šä¼ æ•°æ®**

```bash
# 1. ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆå‡è®¾æ–‡ä»¶IDä¸º123ï¼‰
curl -X POST http://localhost:8001/api/field-mapping/ingest \
  -F "file_id=123" \
  -F "template_id=456"

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": {
#     "ingested_count": 100,
#     "file_id": 123
#   }
# }
```

**æ–¹æ³•2: ä½¿ç”¨æ•°æ®é‡‡é›†API**

```bash
# 1. å¯åŠ¨æ•°æ®é‡‡é›†ä»»åŠ¡
curl -X POST http://localhost:8001/api/collection/start \
  -H "Content-Type: application/json" \
  -d '{
    "platform": "shopee",
    "data_domain": "orders",
    "start_date": "2025-01-01",
    "end_date": "2025-01-31"
  }'

# 2. ç­‰å¾…é‡‡é›†å®Œæˆ
# 3. éªŒè¯æ•°æ®å…¥åº“
```

#### æ­¥éª¤1.2: éªŒè¯äº‹ä»¶è§¦å‘

**æ£€æŸ¥åç«¯æ—¥å¿—**:

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆPowerShellçª—å£ï¼‰
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

# [Event] è§¦å‘äº‹ä»¶: DATA_INGESTED
# [Event] Payload: {
#   "file_id": 123,
#   "data_domain": "orders",
#   "platform_code": "shopee",
#   "ingested_count": 100
# }
```

**æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ—¥å¿—**:

```bash
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

# [Event Listener] å¤„ç†DATA_INGESTEDäº‹ä»¶
# [Event Listener] ç¡®å®šéœ€è¦åˆ·æ–°çš„ç‰©åŒ–è§†å›¾: ['mv_shop_daily_performance']
# [Event Listener] è§¦å‘ç‰©åŒ–è§†å›¾åˆ·æ–°ä»»åŠ¡
```

#### æ­¥éª¤1.3: éªŒè¯ç‰©åŒ–è§†å›¾åˆ·æ–°

**æ–¹æ³•1: æ£€æŸ¥ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¥å¿—**

```bash
# æŸ¥çœ‹ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¥å¿—
curl http://localhost:8001/api/materialized-views/refresh-log?view_name=mv_shop_daily_performance

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": [
#     {
#       "view_name": "mv_shop_daily_performance",
#       "refresh_time": "2025-01-31T10:30:00Z",
#       "status": "success",
#       "duration_ms": 150
#     }
#   ]
# }
```

**æ–¹æ³•2: æ£€æŸ¥ç‰©åŒ–è§†å›¾æ•°æ®**

```bash
# æŸ¥è¯¢ç‰©åŒ–è§†å›¾æ•°æ®
curl "http://localhost:8001/api/materialized-views/query/shop-daily-performance?start_date=2025-01-01&end_date=2025-01-31"

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": [
#     {
#       "platform_code": "shopee",
#       "shop_id": "shop1",
#       "metric_date": "2025-01-31",
#       "gmv": 12345.67,
#       ...
#     }
#   ]
# }
```

#### æ­¥éª¤1.4: éªŒè¯åˆ·æ–°é¡ºåº

**æ£€æŸ¥ä¾èµ–å…³ç³»**:

```bash
# æŸ¥çœ‹ç‰©åŒ–è§†å›¾åˆ·æ–°é¡ºåº
# åº”è¯¥æŒ‰ç…§ä¾èµ–å…³ç³»åˆ·æ–°ï¼š
# 1. mv_shop_daily_performanceï¼ˆåŸºç¡€è§†å›¾ï¼‰
# 2. mv_shop_health_summaryï¼ˆä¾èµ–mv_shop_daily_performanceï¼‰
```

**éªŒè¯ç»“æœ**:
- âœ… `DATA_INGESTED`äº‹ä»¶å·²è§¦å‘
- âœ… äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- âœ… ç‰©åŒ–è§†å›¾å·²åˆ·æ–°
- âœ… åˆ·æ–°é¡ºåºæ­£ç¡®

---

### æµ‹è¯•2: ç‰©åŒ–è§†å›¾åˆ·æ–°åè‡ªåŠ¨è®¡ç®—Cç±»æ•°æ®

#### æ­¥éª¤2.1: æ‰‹åŠ¨è§¦å‘ç‰©åŒ–è§†å›¾åˆ·æ–°

```bash
# åˆ·æ–°ç‰©åŒ–è§†å›¾
curl -X POST http://localhost:8001/api/materialized-views/mv_shop_daily_performance/refresh

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": {
#     "view_name": "mv_shop_daily_performance",
#     "refresh_time": "2025-01-31T10:30:00Z",
#     "status": "success"
#   }
# }
```

#### æ­¥éª¤2.2: éªŒè¯äº‹ä»¶è§¦å‘

**æ£€æŸ¥åç«¯æ—¥å¿—**:

```bash
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

# [Event] è§¦å‘äº‹ä»¶: MV_REFRESHED
# [Event] Payload: {
#   "view_name": "mv_shop_daily_performance",
#   "data_domain": "orders",
#   "platform_code": "shopee"
# }
```

**æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ—¥å¿—**:

```bash
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

# [Event Listener] å¤„ç†MV_REFRESHEDäº‹ä»¶
# [Event Listener] ç¡®å®šéœ€è¦è®¡ç®—çš„Cç±»æ•°æ®: ['health_scores']
# [Event Listener] è§¦å‘Cç±»æ•°æ®è®¡ç®—ä»»åŠ¡
```

#### æ­¥éª¤2.3: éªŒè¯Cç±»æ•°æ®è®¡ç®—

**æŸ¥è¯¢å¥åº·åº¦è¯„åˆ†**:

```bash
# æŸ¥è¯¢å¥åº·åº¦è¯„åˆ†
curl "http://localhost:8001/api/store-analytics/health-scores?start_date=2025-01-01&end_date=2025-01-31&granularity=daily"

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": [
#     {
#       "platform_code": "shopee",
#       "shop_id": "shop1",
#       "metric_date": "2025-01-31",
#       "health_score": 85.5,
#       "gmv_score": 90.0,
#       ...
#     }
#   ]
# }
```

**æ£€æŸ¥ç¼“å­˜**:

```bash
# æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡
curl http://localhost:8001/api/store-analytics/cache/stats

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": {
#     "health_scores": {
#       "hits": 10,
#       "misses": 2,
#       "hit_rate": 0.83
#     }
#   }
# }
```

**éªŒè¯ç»“æœ**:
- âœ… `MV_REFRESHED`äº‹ä»¶å·²è§¦å‘
- âœ… äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- âœ… Cç±»æ•°æ®å·²è®¡ç®—
- âœ… è®¡ç®—ç»“æœæ­£ç¡®
- âœ… ç¼“å­˜å·²æ›´æ–°

---

### æµ‹è¯•3: Aç±»æ•°æ®æ›´æ–°åè‡ªåŠ¨é‡æ–°è®¡ç®—Cç±»æ•°æ®

#### æ­¥éª¤3.1: æ›´æ–°é”€å”®æˆ˜å½¹

```bash
# åˆ›å»ºæˆ–æ›´æ–°é”€å”®æˆ˜å½¹
curl -X POST http://localhost:8001/api/sales-campaigns \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•æˆ˜å½¹",
    "target_amount": 200000,
    "start_date": "2025-01-01",
    "end_date": "2025-01-31",
    "platform_code": "shopee",
    "shop_id": "shop1"
  }'

# æˆ–æ›´æ–°ç°æœ‰æˆ˜å½¹
curl -X PUT http://localhost:8001/api/sales-campaigns/1 \
  -H "Content-Type: application/json" \
  -d '{
    "target_amount": 250000
  }'
```

#### æ­¥éª¤3.2: éªŒè¯äº‹ä»¶è§¦å‘

**æ£€æŸ¥åç«¯æ—¥å¿—**:

```bash
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

# [Event] è§¦å‘äº‹ä»¶: A_CLASS_UPDATED
# [Event] Payload: {
#   "data_type": "sales_campaign",
#   "operation": "update",
#   "affected_shops": ["shop1"],
#   "affected_platforms": ["shopee"]
# }
```

**æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ—¥å¿—**:

```bash
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

# [Event Listener] å¤„ç†A_CLASS_UPDATEDäº‹ä»¶
# [Event Listener] ç¡®å®šéœ€è¦é‡æ–°è®¡ç®—çš„Cç±»æ•°æ®: ['achievement_rate']
# [Event Listener] è§¦å‘Cç±»æ•°æ®é‡æ–°è®¡ç®—ä»»åŠ¡
```

#### æ­¥éª¤3.3: éªŒè¯Cç±»æ•°æ®é‡æ–°è®¡ç®—

**æŸ¥è¯¢è¾¾æˆç‡**:

```bash
# æŸ¥è¯¢è¾¾æˆç‡
curl "http://localhost:8001/api/targets/1/calculate"

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": {
#     "target_id": 1,
#     "achievement_rate": 85.5,
#     "achieved_amount": 171000,
#     "target_amount": 200000
#   }
# }
```

**éªŒè¯ç¼“å­˜å¤±æ•ˆ**:

```bash
# æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡ï¼ˆåº”è¯¥æ˜¾ç¤ºç¼“å­˜å·²å¤±æ•ˆï¼‰
curl http://localhost:8001/api/store-analytics/cache/stats

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "data": {
#     "achievement_rate": {
#       "hits": 0,
#       "misses": 1,
#       "hit_rate": 0.0
#     }
#   }
# }
```

**éªŒè¯ç»“æœ**:
- âœ… `A_CLASS_UPDATED`äº‹ä»¶å·²è§¦å‘
- âœ… äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- âœ… Cç±»æ•°æ®å·²é‡æ–°è®¡ç®—
- âœ… é‡æ–°è®¡ç®—ç»“æœæ­£ç¡®
- âœ… ç¼“å­˜å·²å¤±æ•ˆ

---

## ğŸ” æµ‹è¯•æ£€æŸ¥æ¸…å•

### Bç±»æ•°æ®å…¥åº“æµ‹è¯•
- [ ] æ•°æ®æˆåŠŸå…¥åº“
- [ ] `DATA_INGESTED`äº‹ä»¶å·²è§¦å‘
- [ ] äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- [ ] ç‰©åŒ–è§†å›¾å·²åˆ·æ–°
- [ ] åˆ·æ–°é¡ºåºæ­£ç¡®

### ç‰©åŒ–è§†å›¾åˆ·æ–°æµ‹è¯•
- [ ] ç‰©åŒ–è§†å›¾åˆ·æ–°æˆåŠŸ
- [ ] `MV_REFRESHED`äº‹ä»¶å·²è§¦å‘
- [ ] äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- [ ] Cç±»æ•°æ®å·²è®¡ç®—
- [ ] è®¡ç®—ç»“æœæ­£ç¡®

### Aç±»æ•°æ®æ›´æ–°æµ‹è¯•
- [ ] Aç±»æ•°æ®æ›´æ–°æˆåŠŸ
- [ ] `A_CLASS_UPDATED`äº‹ä»¶å·²è§¦å‘
- [ ] äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®å¤„ç†äº‹ä»¶
- [ ] Cç±»æ•°æ®å·²é‡æ–°è®¡ç®—
- [ ] é‡æ–°è®¡ç®—ç»“æœæ­£ç¡®

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: äº‹ä»¶æœªè§¦å‘

**ç—‡çŠ¶**: æ•°æ®å…¥åº“åï¼Œç‰©åŒ–è§†å›¾æœªåˆ·æ–°

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤äº‹ä»¶æ˜¯å¦è§¦å‘
2. æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. æ£€æŸ¥Celery workeræ˜¯å¦è¿è¡Œï¼ˆå¦‚æœä½¿ç”¨å¼‚æ­¥æ¨¡å¼ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ—¥å¿—
# æ£€æŸ¥Celery workerçŠ¶æ€
celery -A backend.celery_app inspect active
```

### é—®é¢˜2: ç‰©åŒ–è§†å›¾åˆ·æ–°å¤±è´¥

**ç—‡çŠ¶**: äº‹ä»¶å·²è§¦å‘ï¼Œä½†ç‰©åŒ–è§†å›¾åˆ·æ–°å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ç‰©åŒ–è§†å›¾å®šä¹‰æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æ•°æ®æºè¡¨æ˜¯å¦å­˜åœ¨æ•°æ®
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ‰‹åŠ¨åˆ·æ–°ç‰©åŒ–è§†å›¾
curl -X POST http://localhost:8001/api/materialized-views/mv_shop_daily_performance/refresh

# æ£€æŸ¥ç‰©åŒ–è§†å›¾çŠ¶æ€
curl http://localhost:8001/api/materialized-views/mv_shop_daily_performance/status
```

### é—®é¢˜3: Cç±»æ•°æ®è®¡ç®—å¤±è´¥

**ç—‡çŠ¶**: ç‰©åŒ–è§†å›¾å·²åˆ·æ–°ï¼Œä½†Cç±»æ•°æ®æœªè®¡ç®—

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥Cç±»æ•°æ®è®¡ç®—æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æ£€æŸ¥ç‰©åŒ–è§†å›¾æ•°æ®æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥è®¡ç®—é€»è¾‘æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ‰‹åŠ¨è§¦å‘Cç±»æ•°æ®è®¡ç®—
curl -X POST http://localhost:8001/api/store-analytics/health-scores/calculate

# æ£€æŸ¥è®¡ç®—æ—¥å¿—
```

---

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### æµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: YYYY-MM-DD  
**æµ‹è¯•äººå‘˜**: XXX  
**æµ‹è¯•ç¯å¢ƒ**: å¼€å‘/æµ‹è¯•/ç”Ÿäº§

**æµ‹è¯•ç»“æœ**:
- âœ… é€šè¿‡
- âŒ å¤±è´¥
- âš ï¸ éƒ¨åˆ†é€šè¿‡

**æµ‹è¯•è¯¦æƒ…**:
- Bç±»æ•°æ®å…¥åº“æµ‹è¯•: âœ…/âŒ
- ç‰©åŒ–è§†å›¾åˆ·æ–°æµ‹è¯•: âœ…/âŒ
- Aç±»æ•°æ®æ›´æ–°æµ‹è¯•: âœ…/âŒ

**é—®é¢˜è®°å½•**:
1. é—®é¢˜æè¿°
2. é‡ç°æ­¥éª¤
3. é¢„æœŸç»“æœ
4. å®é™…ç»“æœ
5. ä¼˜å…ˆçº§

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“– [æ•°æ®æµè½¬æµç¨‹è‡ªåŠ¨åŒ–å®ç°æ–‡æ¡£](DATA_FLOW_AUTOMATION_IMPLEMENTATION.md) - å®ç°ç»†èŠ‚
- ğŸ“– [Cç±»æ•°æ®ç¼“å­˜å®ç°æ–‡æ¡£](C_CLASS_CACHE_IMPLEMENTATION.md) - ç¼“å­˜ç­–ç•¥
- ğŸ“– [APIæµ‹è¯•æŒ‡å—](API_TESTING_GUIDE.md) - APIæµ‹è¯•æ–¹æ³•

---

**æœ€åæ›´æ–°**: 2025-01-31  
**ç»´æŠ¤**: AI Agent Team  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

