# 数据隔离区标准说明（v4.6.1）

**日期**: 2025-11-01  
**版本**: v4.6.1  
**状态**: ✅ **标准已明确**

---

## 📋 **隔离区标准（什么样的数据会进入隔离区）**

### 核心原则

**数据进入隔离区的条件**：
1. ✅ **数据验证失败** - 必填字段缺失、格式错误、范围超出等
2. ✅ **数据质量问题** - 外键引用不存在、数据不一致等
3. ❌ **不进入隔离区** - 数据全0（这是正常情况，如采集期间无业务）

---

## 🔍 **各数据域的验证标准**

### 1. Orders域（订单数据）

**必填字段**:
- ✅ `order_id` - 订单号（必填，长度≥3位）
- ✅ `product_id` 或 `platform_sku` - 产品ID或SKU（必填，长度≥2位）
- ✅ `shop_id` - 店铺ID（必填）
- ✅ `order_date` - 订单日期（必填，格式正确）

**验证规则**:
- 数量字段：`qty` ≥ 0
- 金额字段：`total_amount` ≥ 0
- 货币字段：必须为有效货币代码（USD/CNY/SGD等）

**进入隔离区的情况**:
- ❌ 订单号缺失或格式错误
- ❌ 产品ID/SKU缺失
- ❌ 订单金额为负数
- ❌ 货币代码无效

---

### 2. Products域（商品数据）

**必填字段**:
- ✅ `product_id` 或 `platform_sku` - 产品ID或SKU（必填，长度≥2位）
- ✅ `metric_date` - 指标日期（必填，格式正确）

**验证规则**:
- 数值指标：`page_views`、`unique_visitors`、`sales_amount`等
- 百分比指标：`click_rate`、`conversion_rate`等（0-100%）
- 评分字段：`rating`（0-5）

**进入隔离区的情况**:
- ❌ 产品ID/SKU缺失
- ❌ 指标日期格式错误或缺失
- ❌ 数值字段超出合理范围

---

### 3. Services域（服务/运营数据）⭐ v4.6.1新增

**必填字段**:
- ✅ `shop_id` - 店铺ID（必填，长度≥2位）
- ✅ `metric_date` 或 `date` - 指标日期（必填，格式正确）

**重要特点**:
- ✅ **不需要product_id或SKU**（店铺级数据，不是产品级数据）
- ✅ 适用于店铺运营数据（如访客数、聊天数、转化率等）

**验证规则**:
- 运营指标：`visitor_count`、`chat_inquiry_count`、`replied_chats`、`unreplied_chats`等
- 转化率：`inquiry_rate`、`conversion_rate_reply_to_order`等（0-100%）
- 响应速度：`average_response_speed`、`first_response_speed`（秒）

**进入隔离区的情况**:
- ❌ 店铺ID缺失
- ❌ 指标日期格式错误或缺失
- ❌ 数值字段超出合理范围
- ✅ **不会因为缺少product_id而隔离**（services域不需要product_id）

---

### 4. Traffic域（流量数据）

**必填字段**:
- ✅ `metric_date` - 指标日期（必填）
- ✅ `shop_id` - 店铺ID（必填）

**验证规则**:
- 流量指标：`page_views`、`unique_visitors`、`clicks`等
- 转化率：`conversion_rate`、`click_rate`等

**进入隔离区的情况**:
- ❌ 日期或店铺ID缺失
- ❌ 流量指标格式错误

---

## ❌ **不进入隔离区的情况**

### 1. 数据全0（正常情况）

**识别标准**:
- 所有数值字段均为0（如销售额、访客数、订单数等）
- 这是正常情况（如采集期间无业务、无订单）

**处理方式**:
- ✅ 不入库（导入0条记录）
- ✅ 标记为全0文件（在`file_record.notes`中添加标识）
- ✅ 显示友好提示："数据源所有数值字段均为0，这是正常情况，无需查看隔离区"
- ❌ **不会进入隔离区**

---

### 2. 警告信息（不隔离）

**警告类型**:
- 数值超出合理范围（但仍在可接受范围）
- 日期为未来时间（但格式正确）
- 日期超过3年（但格式正确）

**处理方式**:
- ✅ 显示警告信息
- ✅ 数据正常入库
- ❌ **不会进入隔离区**

---

## 📊 **隔离区数据来源**

### 错误类型分类

1. **required** - 必填字段缺失
   - 示例：`product_id`缺失、`order_id`缺失、`shop_id`缺失

2. **format** - 格式错误
   - 示例：订单号长度<3位、店铺ID长度<2位

3. **data_type** - 数据类型错误
   - 示例：日期格式不正确、数值字段不是数字

4. **range** - 范围错误
   - 示例：订单金额为负数、数量为负数

5. **validation_error** - 验证错误（通用）
   - 示例：外键引用不存在、数据不一致

---

## 🎯 **隔离区管理功能**

### 1. 查询隔离数据

**功能**:
- 按平台、数据域、错误类型筛选
- 分页显示
- 查看详情

**API**: `GET /api/data-quarantine/list`

---

### 2. 查看详情

**功能**:
- 查看隔离记录的完整信息
- 查看错误原因
- 查看原始数据

**API**: `GET /api/data-quarantine/detail/{quarantine_id}`

---

### 3. 重新处理

**功能**:
- 单条重新处理
- 批量重新处理
- 修正数据后重新入库

**API**: `POST /api/data-quarantine/reprocess`

---

### 4. 批量删除 ⭐ v4.6.1新增

**功能**:
- 批量删除隔离记录
- 确认对话框（防止误删）
- 删除后自动刷新列表

**API**: `POST /api/data-quarantine/delete`

**使用场景**:
- 确认是无效数据（如测试数据）
- 数据已通过其他方式处理
- 需要清理隔离区

---

## ✅ **修复总结**

### 修复1: Services域验证 ⭐⭐⭐

**问题**: Services域数据被错误要求product_id，导致店铺运营数据被隔离

**修复**:
- ✅ 创建`validate_services`函数（不需要product_id）
- ✅ 修改入库逻辑，根据data_domain选择正确的验证函数
- ✅ Services域现在只需要`shop_id`和`metric_date`

**文件修改**:
- `backend/services/data_validator.py` - 新增`validate_services`函数
- `backend/routers/field_mapping.py` - 更新验证逻辑

---

### 修复2: 批量删除功能 ⭐⭐⭐

**问题**: 隔离区只有批量重新处理，没有批量删除功能

**修复**:
- ✅ 添加批量删除按钮（前端）
- ✅ 添加批量删除函数（前端）
- ✅ 修改删除API为POST（支持批量删除）
- ✅ 添加确认对话框（防止误删）

**文件修改**:
- `frontend/src/views/DataQuarantine.vue` - 添加批量删除功能
- `backend/routers/data_quarantine.py` - 修改删除API为POST

---

## 📝 **使用说明**

### Services域数据入库

**正确流程**:
1. 上传services域文件（店铺运营数据）
2. 映射字段（不需要product_id字段）
3. 确认映射并入库
4. ✅ **数据正常入库**（不会因为缺少product_id而隔离）

**注意事项**:
- Services域数据不需要product_id或SKU
- 只需要shop_id和metric_date等基础字段
- 运营指标（如访客数、聊天数）会自动验证

---

### 批量删除隔离数据

**使用步骤**:
1. 进入数据隔离区页面
2. 选择要删除的记录（多选）
3. 点击"批量删除"按钮
4. 确认删除（会显示警告：此操作不可恢复）
5. ✅ **删除成功，列表自动刷新**

**注意事项**:
- 删除操作不可恢复
- 删除前请确认数据确实无效
- 可以通过"查看详情"查看完整信息后再决定是否删除

---

## ✅ **完成状态**

- ✅ 问题1: Services域验证标准已明确
- ✅ 问题2: 批量删除功能已添加
- ✅ 隔离区标准文档已创建

**所有问题已修复！隔离区功能已完善。**

---

**报告时间**: 2025-11-01 13:50  
**状态**: ✅ **修复完成，等待测试验证**


