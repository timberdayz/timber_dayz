# 代码质量保证规范 - 企业级ERP标准

**版本**: v4.4.0  
**更新**: 2025-01-30  
**标准**: 企业级代码质量标准

---

## 📋 代码审查流程

### 1. Peer Review
- ✅ **必需**: 所有代码修改必须经过至少1人审查
- ✅ **审查工具**: GitHub Pull Request或GitLab Merge Request
- ✅ **审查清单**: 功能正确性、代码规范、性能、安全性
- ✅ **自动化检查**: CI自动运行代码检查（通过后才能合并）

### 2. 审查清单
- [ ] 功能是否正确实现？
- [ ] 代码是否符合规范？
- [ ] 是否有性能问题？
- [ ] 是否有安全问题？
- [ ] 是否有测试覆盖？
- [ ] 文档是否更新？

---

## 🔍 静态分析工具

### 1. Ruff（Python代码检查）
- ✅ **PEP 8**: 代码格式检查
- ✅ **导入顺序**: 导入顺序检查
- ✅ **未使用变量**: 检测未使用的变量和导入
- ✅ **代码质量**: 代码质量检查

**配置**:
```toml
[tool.ruff]
line-length = 88
target-version = "py311"

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W"]
```

### 2. Pylint（代码质量检查）
- ✅ **复杂度**: 代码复杂度检查
- ✅ **命名规范**: 命名规范检查
- ✅ **代码风格**: 代码风格检查

### 3. mypy（类型检查）
- ✅ **类型注解**: 确保类型注解正确
- ✅ **类型错误**: 检测类型错误
- ✅ **类型兼容**: 检查类型兼容性

**配置**:
```ini
[mypy]
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
```

### 4. bandit（安全漏洞扫描）
- ✅ **SQL注入**: 检测SQL注入漏洞
- ✅ **硬编码密码**: 检测硬编码密码
- ✅ **不安全函数**: 检测不安全函数调用

---

## 🎨 代码格式化

### 1. Black（统一代码格式）
- ✅ **行长度**: 88字符（PEP 8推荐）
- ✅ **引号**: 统一使用双引号
- ✅ **缩进**: 4个空格

**配置**:
```toml
[tool.black]
line-length = 88
target-version = ['py311']
```

### 2. isort（统一导入顺序）
- ✅ **导入顺序**: 标准库、第三方、本地
- ✅ **导入分组**: 每组之间空行分隔

**配置**:
```toml
[tool.isort]
profile = "black"
line_length = 88
```

### 3. pre-commit（Git提交前自动格式化）
- ✅ **自动格式化**: Git提交前自动格式化代码
- ✅ **防止格式不一致**: 确保所有代码格式一致

**配置**:
```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
```

---

## 🧪 测试覆盖率要求

### 1. 覆盖率目标
- ✅ **核心模块**: ≥80%（数据库、ETL、API核心逻辑）
- ✅ **辅助模块**: ≥50%（工具函数、UI组件）
- ✅ **关键业务**: 100%（财务计算、订单处理）

### 2. 覆盖率工具
- ✅ **pytest-cov**: pytest的覆盖率插件
- ✅ **coverage.py**: Python覆盖率工具

**配置**:
```ini
[coverage:run]
source = backend,modules
omit = */tests/*,*/migrations/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False
```

### 3. 覆盖率报告
- ✅ **HTML报告**: 生成HTML覆盖率报告
- ✅ **CI集成**: CI中显示覆盖率
- ✅ **覆盖率要求**: 覆盖率低于目标时CI失败

---

## ⚡ 性能基准测试

### 1. 关键API基准测试
- ✅ **响应时间**: P95 < 500ms
- ✅ **吞吐量**: QPS > 100
- ✅ **并发数**: 支持100并发

### 2. 数据库查询基准测试
- ✅ **慢查询**: < 100ms
- ✅ **索引优化**: 查询使用索引
- ✅ **连接池**: 连接池配置合理

### 3. 批量处理基准测试
- ✅ **文件扫描**: ≥500文件/秒
- ✅ **Excel解析**: ≥1000行/秒
- ✅ **数据入库**: ≥1000行/秒

### 4. 负载测试工具
- ✅ **locust**: Python负载测试工具
- ✅ **JMeter**: Apache JMeter
- ✅ **k6**: 现代负载测试工具

---

## 📏 代码复杂度

### 1. 圈复杂度
- ✅ **函数复杂度**: ≤ 10（超过需要重构）
- ✅ **类复杂度**: ≤ 50（超过需要拆分）

### 2. 函数长度
- ✅ **单个函数**: ≤ 50行（超过需要拆分）
- ✅ **函数职责**: 单一职责原则

### 3. 类长度
- ✅ **单个类**: ≤ 500行（超过需要拆分）
- ✅ **类职责**: 单一职责原则

---

## 📚 文档要求

### 1. 函数文档
- ✅ **docstring**: 所有公开函数必须有docstring（Google风格）
- ✅ **参数说明**: 说明所有参数的类型和含义
- ✅ **返回值说明**: 说明返回值的类型和含义
- ✅ **异常说明**: 说明可能抛出的异常

**示例**:
```python
def create_order(order_data: dict, db: Session) -> FactOrder:
    """
    创建订单
    
    Args:
        order_data: 订单数据字典，包含order_id、total_amount等字段
        db: 数据库会话
    
    Returns:
        FactOrder: 创建的订单对象
    
    Raises:
        ValidationError: 数据验证失败
        BusinessError: 业务规则违反（如库存不足）
    """
    pass
```

### 2. 类型注解
- ✅ **函数签名**: 所有函数必须有类型注解（PEP 484）
- ✅ **变量类型**: 关键变量应该有类型注解
- ✅ **返回类型**: 明确返回类型

### 3. API文档
- ✅ **OpenAPI**: 所有API必须有OpenAPI文档
- ✅ **请求示例**: 包含请求示例
- ✅ **响应示例**: 包含成功和失败响应示例

### 4. 架构文档
- ✅ **重大变更**: 重大架构变更必须更新文档
- ✅ **设计决策**: 记录重要的设计决策（ADR）
- ✅ **架构图**: 提供架构图便于理解

---

## 🔄 持续集成

### 1. CI流程
- ✅ **代码检查**: 自动运行Ruff、Pylint、mypy
- ✅ **单元测试**: 自动运行单元测试
- ✅ **覆盖率检查**: 检查测试覆盖率是否达标
- ✅ **安全扫描**: 自动运行bandit安全扫描

### 2. CI工具
- ✅ **GitHub Actions**: GitHub CI/CD
- ✅ **GitLab CI**: GitLab CI/CD
- ✅ **Jenkins**: 企业级CI/CD

---

**最后更新**: 2025-01-30  
**维护**: AI Agent Team  
**状态**: ✅ 企业级标准

