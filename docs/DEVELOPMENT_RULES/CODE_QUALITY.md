# 代码质量保证规范 - 企业级ERP标准

**版本**: v4.19.7  
**更新**: 2026-01-08  
**标准**: 企业级代码质量标准

---

## 📋 代码审查流程

### 1. Peer Review
- ✅ **必需**: 所有代码修改必须经过至少1人审查
- ✅ **审查工具**: GitHub Pull Request或GitLab Merge Request
- ✅ **审查清单**: 功能正确性、代码规范、性能、安全性
- ✅ **自动化检查**: CI自动运行代码检查（通过后才能合并）

### 2. 审查清单
- [ ] 功能是否正确实现？
- [ ] 代码是否符合规范？
- [ ] 是否有性能问题？
- [ ] 是否有安全问题？
- [ ] 是否有测试覆盖？
- [ ] 文档是否更新？

---

## 🔍 静态分析工具

### 1. Ruff（Python代码检查）
- ✅ **PEP 8**: 代码格式检查
- ✅ **导入顺序**: 导入顺序检查
- ✅ **未使用变量**: 检测未使用的变量和导入
- ✅ **代码质量**: 代码质量检查

**配置**:
```toml
[tool.ruff]
line-length = 88
target-version = "py311"

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W"]
```

### 2. Pylint（代码质量检查）
- ✅ **复杂度**: 代码复杂度检查
- ✅ **命名规范**: 命名规范检查
- ✅ **代码风格**: 代码风格检查

### 3. mypy（类型检查）
- ✅ **类型注解**: 确保类型注解正确
- ✅ **类型错误**: 检测类型错误
- ✅ **类型兼容**: 检查类型兼容性

**配置**:
```ini
[mypy]
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
```

### 4. bandit（安全漏洞扫描）
- ✅ **SQL注入**: 检测SQL注入漏洞
- ✅ **硬编码密码**: 检测硬编码密码
- ✅ **不安全函数**: 检测不安全函数调用

### 5. ESLint（前端代码检查）
- ✅ **Vue 3规范**: Vue 3组件代码规范检查
- ✅ **JavaScript规范**: JavaScript代码规范检查（ESLint推荐规则）
- ✅ **代码质量**: 检测未使用的变量、导入等
- ✅ **最佳实践**: 检测潜在问题和反模式

**配置**:
```json
{
  "extends": [
    "eslint:recommended",
    "plugin:vue/vue3-recommended"
  ],
  "rules": {
    "no-unused-vars": "warn",
    "no-console": "warn",
    "vue/multi-word-component-names": "warn"
  }
}
```

### 6. Prettier（前端代码格式化）
- ✅ **统一格式**: 统一代码格式（缩进、引号、分号等）
- ✅ **自动格式化**: 保存时自动格式化
- ✅ **团队协作**: 确保团队代码格式一致

**配置**:
```json
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5"
}
```

---

## 🎨 代码格式化

### 1. Black（统一代码格式）
- ✅ **行长度**: 88字符（PEP 8推荐）
- ✅ **引号**: 统一使用双引号
- ✅ **缩进**: 4个空格

**配置**:
```toml
[tool.black]
line-length = 88
target-version = ['py311']
```

### 2. isort（统一导入顺序）
- ✅ **导入顺序**: 标准库、第三方、本地
- ✅ **导入分组**: 每组之间空行分隔

**配置**:
```toml
[tool.isort]
profile = "black"
line_length = 88
```

### 3. pre-commit（Git提交前自动格式化）
- ✅ **自动格式化**: Git提交前自动格式化代码
- ✅ **防止格式不一致**: 确保所有代码格式一致

**配置**:
```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
```

---

## 🧪 测试覆盖率要求

### 1. 覆盖率目标
- ✅ **核心模块**: ≥80%（数据库、ETL、API核心逻辑）
- ✅ **辅助模块**: ≥50%（工具函数、UI组件）
- ✅ **关键业务**: 100%（财务计算、订单处理）

### 2. 覆盖率工具
- ✅ **pytest-cov**: pytest的覆盖率插件
- ✅ **coverage.py**: Python覆盖率工具

**配置**:
```ini
[coverage:run]
source = backend,modules
omit = */tests/*,*/migrations/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False
```

### 3. 覆盖率报告
- ✅ **HTML报告**: 生成HTML覆盖率报告
- ✅ **CI集成**: CI中显示覆盖率
- ✅ **覆盖率要求**: 覆盖率低于目标时CI失败

---

## ⚡ 性能基准测试

### 1. 关键API基准测试
- ✅ **响应时间**: P95 < 500ms
- ✅ **吞吐量**: QPS > 100
- ✅ **并发数**: 支持100并发

### 2. 数据库查询基准测试
- ✅ **慢查询**: < 100ms
- ✅ **索引优化**: 查询使用索引
- ✅ **连接池**: 连接池配置合理

### 3. 批量处理基准测试
- ✅ **文件扫描**: ≥500文件/秒
- ✅ **Excel解析**: ≥1000行/秒
- ✅ **数据入库**: ≥1000行/秒

### 4. 负载测试工具
- ✅ **locust**: Python负载测试工具
- ✅ **JMeter**: Apache JMeter
- ✅ **k6**: 现代负载测试工具

---

## 📏 代码复杂度

### 1. 圈复杂度
- ✅ **函数复杂度**: ≤ 10（超过需要重构）
- ✅ **类复杂度**: ≤ 50（超过需要拆分）

### 2. 函数长度
- ✅ **单个函数**: ≤ 50行（超过需要拆分）
- ✅ **函数职责**: 单一职责原则

### 3. 类长度
- ✅ **单个类**: ≤ 500行（超过需要拆分）
- ✅ **类职责**: 单一职责原则

### 4. Vue组件复杂度（前端）
- ✅ **组件行数**: ≤ 500行（超过需要拆分）
- ✅ **计算属性数量**: ≤ 10个（超过需要拆分）
- ✅ **方法数量**: ≤ 20个（超过需要拆分）
- ✅ **Props数量**: ≤ 10个（超过需要拆分或使用对象）

---

## 📚 文档要求

### 1. 函数文档
- ✅ **docstring**: 所有公开函数必须有docstring（Google风格）
- ✅ **参数说明**: 说明所有参数的类型和含义
- ✅ **返回值说明**: 说明返回值的类型和含义
- ✅ **异常说明**: 说明可能抛出的异常

**示例**:
```python
def create_order(order_data: dict, db: Session) -> FactOrder:
    """
    创建订单
    
    Args:
        order_data: 订单数据字典，包含order_id、total_amount等字段
        db: 数据库会话
    
    Returns:
        FactOrder: 创建的订单对象
    
    Raises:
        ValidationError: 数据验证失败
        BusinessError: 业务规则违反（如库存不足）
    """
    pass
```

### 2. 类型注解
- ✅ **函数签名**: 所有函数必须有类型注解（PEP 484）
- ✅ **变量类型**: 关键变量应该有类型注解
- ✅ **返回类型**: 明确返回类型

### 3. API文档
- ✅ **OpenAPI**: 所有API必须有OpenAPI文档
- ✅ **请求示例**: 包含请求示例
- ✅ **响应示例**: 包含成功和失败响应示例

### 4. 架构文档
- ✅ **重大变更**: 重大架构变更必须更新文档
- ✅ **设计决策**: 记录重要的设计决策（ADR）
- ✅ **架构图**: 提供架构图便于理解

---

## 🔄 持续集成

### 1. CI流程
- ✅ **代码检查**: 自动运行Ruff、Pylint、mypy（后端）
- ✅ **前端检查**: 自动运行ESLint、Prettier（前端）
- ✅ **单元测试**: 自动运行单元测试
- ✅ **覆盖率检查**: 检查测试覆盖率是否达标
- ✅ **安全扫描**: 自动运行bandit安全扫描

### 2. CI工具
- ✅ **GitHub Actions**: GitHub CI/CD
- ✅ **GitLab CI**: GitLab CI/CD
- ✅ **Jenkins**: 企业级CI/CD

---

## 🎨 前端代码质量规范（v4.19.7新增）⭐⭐⭐

### 1. Vue组件质量检查

#### 组件结构检查
- ✅ **单文件组件**: 使用单文件组件（.vue）
- ✅ **Composition API**: 优先使用Composition API
- ✅ **组件拆分**: 组件超过500行需要拆分
- ✅ **Props验证**: 所有Props必须有类型和默认值

#### 代码质量检查
- ✅ **未使用变量**: 检测未使用的变量、导入
- ✅ **防御性编程**: 检查空值保护、可选链使用
- ✅ **计算属性**: 检查计算属性是否返回有效值
- ✅ **错误处理**: 检查关键逻辑是否有try-catch

### 2. JavaScript代码质量

#### 代码规范
- ✅ **ESLint规则**: 使用ESLint推荐规则
- ✅ **Prettier格式化**: 统一代码格式
- ✅ **变量命名**: 使用camelCase（变量）、PascalCase（类/组件）
- ✅ **常量命名**: 使用UPPER_SNAKE_CASE

#### 代码质量
- ✅ **避免全局变量**: 不使用全局变量（除非必要）
- ✅ **避免eval**: 禁止使用eval()
- ✅ **避免with**: 禁止使用with语句
- ✅ **严格模式**: 使用严格模式（'use strict'）

### 3. 前端测试覆盖率

#### 覆盖率目标
- ✅ **组件测试**: ≥70%（核心组件）
- ✅ **工具函数**: ≥80%（工具函数）
- ✅ **Store测试**: ≥80%（状态管理）
- ✅ **API调用**: ≥60%（API封装）

#### 测试工具
- ✅ **Vitest**: Vue 3组件测试框架
- ✅ **Vue Test Utils**: Vue组件测试工具
- ✅ **@testing-library/vue**: Vue组件测试库

### 4. 前端性能检查

#### 性能指标
- ✅ **首屏加载**: < 3秒
- ✅ **组件渲染**: < 100ms
- ✅ **API响应**: < 500ms（P95）
- ✅ **包体积**: < 2MB（gzip后）

#### 性能优化检查
- ✅ **代码分割**: 路由懒加载、组件懒加载
- ✅ **图片优化**: 使用WebP、懒加载
- ✅ **缓存策略**: 合理使用浏览器缓存
- ✅ **防抖节流**: 频繁操作使用防抖/节流

### 5. 前端安全检查

#### 安全规则
- ✅ **XSS防护**: 避免innerHTML，使用v-text
- ✅ **CSRF防护**: API请求包含CSRF token
- ✅ **敏感信息**: 不在前端存储敏感信息
- ✅ **依赖安全**: 定期检查依赖漏洞（npm audit）

### 6. 前端代码审查清单

#### 组件审查
- [ ] 组件结构清晰（template、script、style分离）
- [ ] 使用Composition API
- [ ] Props有类型和默认值
- [ ] 计算属性返回有效值
- [ ] 关键逻辑有错误处理
- [ ] 空值保护完善（可选链、默认值）

#### 代码质量审查
- [ ] 代码格式统一（Prettier）
- [ ] 无ESLint错误和警告
- [ ] 无未使用的变量和导入
- [ ] 函数复杂度 ≤ 10
- [ ] 组件行数 ≤ 500

#### 性能审查
- [ ] 路由懒加载
- [ ] 图片懒加载
- [ ] 防抖/节流使用合理
- [ ] 无不必要的重渲染

#### 安全审查
- [ ] 无XSS漏洞
- [ ] 无敏感信息泄露
- [ ] 依赖无已知漏洞

---

**最后更新**: 2026-01-08  
**维护**: AI Agent Team  
**状态**: ✅ 企业级标准（v4.19.7新增前端代码质量规范）

