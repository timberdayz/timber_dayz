# 数据库变更检查清单

**版本**: v4.12.0  
**创建时间**: 2025-11-20  
**状态**: ✅ 已完成

---

## 📋 概述

本文档定义数据库变更时检查规则的要求，确保数据库变更符合数据库设计规范。

---

## 🔍 数据库变更检查清单

### 1. 表结构变更检查

#### 1.1 新增表检查

**检查项**:
- [ ] 表名是否符合命名规范（snake_case，复数形式）？
- [ ] 表是否有主键（Primary Key）？
- [ ] 主键设计是否符合规范（运营数据使用业务标识，业务数据使用自增ID）？
- [ ] 表是否有created_at和updated_at时间戳字段？
- [ ] 表是否有适当的索引（唯一索引、查询索引）？
- [ ] 表是否有外键约束（如需要）？

**检查步骤**:
1. 审查schema.py中的表定义
2. 运行数据库设计验证工具：`python scripts/review_schema_compliance.py`
3. 检查主键设计是否符合规范
4. 检查字段NULL规则是否符合规范

---

#### 1.2 修改表结构检查

**检查项**:
- [ ] 是否创建了Alembic迁移脚本？
- [ ] 迁移脚本是否包含upgrade和downgrade函数？
- [ ] 是否会影响现有数据（需要数据迁移）？
- [ ] 是否会影响现有查询（需要更新查询代码）？
- [ ] 是否会影响现有API（需要更新API文档）？

**检查步骤**:
1. 创建Alembic迁移脚本
2. 测试迁移脚本（upgrade和downgrade）
3. 检查数据迁移逻辑（如需要）
4. 更新相关代码和文档

---

#### 1.3 删除表检查

**检查项**:
- [ ] 是否有其他表依赖此表（外键约束）？
- [ ] 是否有物化视图依赖此表？
- [ ] 是否有API端点使用此表？
- [ ] 是否已备份数据（如需要）？

**检查步骤**:
1. 检查外键依赖关系
2. 检查物化视图依赖关系
3. 检查API端点依赖关系
4. 备份数据（如需要）
5. 创建迁移脚本删除表

---

### 2. 字段变更检查

#### 2.1 新增字段检查

**检查项**:
- [ ] 字段名是否符合命名规范（snake_case）？
- [ ] 字段类型是否合适（VARCHAR长度、数值精度等）？
- [ ] 字段是否允许NULL（关键业务字段应NOT NULL）？
- [ ] 字段是否有默认值（如需要）？
- [ ] 字段是否有索引（如需要查询）？

**检查步骤**:
1. 审查字段定义
2. 检查字段NULL规则
3. 检查字段默认值
4. 检查是否需要索引

---

#### 2.2 修改字段检查

**检查项**:
- [ ] 是否会影响现有数据（类型转换、数据迁移）？
- [ ] 是否会影响现有查询（字段名变更）？
- [ ] 是否会影响现有API（字段名变更）？

**检查步骤**:
1. 检查数据兼容性
2. 更新相关代码
3. 更新API文档

---

#### 2.3 删除字段检查

**检查项**:
- [ ] 是否有其他表依赖此字段（外键）？
- [ ] 是否有物化视图使用此字段？
- [ ] 是否有API端点返回此字段？
- [ ] 是否已备份数据（如需要）？

**检查步骤**:
1. 检查依赖关系
2. 更新相关代码
3. 备份数据（如需要）

---

### 3. 索引变更检查

#### 3.1 新增索引检查

**检查项**:
- [ ] 索引名是否符合命名规范（ix_表名_字段名）？
- [ ] 索引字段顺序是否合理（最左前缀原则）？
- [ ] 索引是否会影响写入性能（索引过多）？

**检查步骤**:
1. 审查索引定义
2. 检查索引字段顺序
3. 评估性能影响

---

#### 3.2 修改索引检查

**检查项**:
- [ ] 是否会影响现有查询性能？
- [ ] 是否需要重建索引？

**检查步骤**:
1. 检查查询性能影响
2. 重建索引（如需要）

---

#### 3.3 删除索引检查

**检查项**:
- [ ] 是否会影响现有查询性能？
- [ ] 是否有其他索引可以替代？

**检查步骤**:
1. 检查查询性能影响
2. 评估替代方案

---

### 4. 外键约束变更检查

#### 4.1 新增外键检查

**检查项**:
- [ ] 外键字段类型是否匹配父表主键类型？
- [ ] 外键级联策略是否合适（CASCADE/SET NULL/RESTRICT）？
- [ ] 外键命名是否符合规范（fk_表名_字段名）？

**检查步骤**:
1. 审查外键定义
2. 检查级联策略
3. 测试外键约束

---

#### 4.2 修改外键检查

**检查项**:
- [ ] 是否会影响现有数据（级联策略变更）？
- [ ] 是否需要数据迁移？

**检查步骤**:
1. 检查数据影响
2. 数据迁移（如需要）

---

#### 4.3 删除外键检查

**检查项**:
- [ ] 是否会影响数据完整性？
- [ ] 是否需要在应用层维护数据完整性？

**检查步骤**:
1. 评估数据完整性影响
2. 更新应用层逻辑（如需要）

---

### 5. 物化视图变更检查

#### 5.1 新增物化视图检查

**检查项**:
- [ ] 物化视图名是否符合命名规范（mv_表名_用途）？
- [ ] 物化视图是否创建了唯一索引？
- [ ] 物化视图是否包含数据域的所有核心字段（主视图）？
- [ ] 物化视图是否依赖主视图或基础数据（辅助视图）？

**检查步骤**:
1. 审查物化视图定义
2. 检查唯一索引
3. 检查字段完整性
4. 更新MaterializedViewService

---

#### 5.2 修改物化视图检查

**检查项**:
- [ ] 是否会影响现有查询？
- [ ] 是否需要刷新物化视图？
- [ ] 是否会影响依赖的辅助视图？

**检查步骤**:
1. 检查查询影响
2. 刷新物化视图
3. 更新依赖视图

---

#### 5.3 删除物化视图检查

**检查项**:
- [ ] 是否有其他物化视图依赖此视图？
- [ ] 是否有API端点使用此视图？
- [ ] 是否有前端组件使用此视图？

**检查步骤**:
1. 检查依赖关系
2. 更新相关代码
3. 更新API文档

---

## 📝 变更流程

### 1. 变更前准备

**步骤**:
1. 明确变更需求
2. 评估变更影响范围
3. 制定变更计划
4. 准备回滚方案

---

### 2. 变更实施

**步骤**:
1. 创建Alembic迁移脚本
2. 审查迁移脚本
3. 测试迁移脚本（开发环境）
4. 执行迁移（生产环境）
5. 验证变更结果

---

### 3. 变更后验证

**步骤**:
1. 运行数据库设计验证工具
2. 检查数据完整性
3. 检查查询性能
4. 更新相关文档

---

## 🔧 验证工具

### 自动化验证工具

1. **数据库设计验证工具**
   - 脚本：`scripts/review_schema_compliance.py`
   - API：`GET /api/database-design/validate`

2. **Alembic迁移工具**
   - 创建迁移：`alembic revision --autogenerate -m "描述"`
   - 执行迁移：`alembic upgrade head`
   - 回滚迁移：`alembic downgrade -1`

---

## 📚 相关文档

- [数据库设计规范](DATABASE_DESIGN.md)
- [数据库设计规则示例](DATABASE_DESIGN_EXAMPLES.md)
- [数据库设计检查清单](DATABASE_DESIGN_CHECKLIST.md)
- [代码审查检查清单](CODE_REVIEW_CHECKLIST.md)

---

**最后更新**: 2025-11-20  
**维护**: AI Agent Team  
**状态**: ✅ 已完成

