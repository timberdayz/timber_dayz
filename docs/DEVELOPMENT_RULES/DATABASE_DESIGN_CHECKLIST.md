# æ•°æ®åº“è®¾è®¡è§„èŒƒæ£€æŸ¥æ¸…å•

**ç‰ˆæœ¬**: v4.12.0  
**åˆ›å»ºæ—¶é—´**: 2025-11-20  
**è®¾è®¡æ ‡å‡†**: ä¼ä¸šçº§ERPæ•°æ®åº“è®¾è®¡è§„èŒƒ

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›æ•°æ®åº“è®¾è®¡è§„èŒƒçš„è‡ªæŸ¥æ¸…å•ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ç¡®ä¿æ•°æ®åº“è®¾è®¡ç¬¦åˆè§„èŒƒã€‚

---

## âœ… è¡¨è®¾è®¡æ£€æŸ¥æ¸…å•

### 1. ä¸»é”®è®¾è®¡

- [ ] **æ‰€æœ‰è¡¨å¿…é¡»æœ‰ä¸»é”®**
  - âœ… æ­£ç¡®ï¼šè¡¨æœ‰ä¸»é”®å®šä¹‰
  - âŒ é”™è¯¯ï¼šè¡¨ç¼ºå°‘ä¸»é”®

- [ ] **ä¸»é”®å­—æ®µå¿…é¡»NOT NULL**
  - âœ… æ­£ç¡®ï¼šä¸»é”®å­—æ®µ `nullable=False`
  - âŒ é”™è¯¯ï¼šä¸»é”®å­—æ®µ `nullable=True`

- [ ] **ç»è¥æ•°æ®è¡¨ä¸»é”®è®¾è®¡**
  - âœ… æ­£ç¡®ï¼šä¸»é”®åŒ…å« `platform_code`, `shop_id`, ä¸šåŠ¡æ ‡è¯†ï¼ˆå¦‚ `platform_sku` æˆ– `order_id`ï¼‰
  - âŒ é”™è¯¯ï¼šä¸»é”®åªåŒ…å«è‡ªå¢IDï¼Œç¼ºå°‘ä¸šåŠ¡æ ‡è¯†

- [ ] **è¿è¥æ•°æ®è¡¨ä¸»é”®è®¾è®¡**
  - âœ… æ­£ç¡®ï¼šä¸»é”®åŒ…å« `platform_code`, `shop_id`, ä¸šåŠ¡æ ‡è¯†ï¼ˆå¦‚ `metric_date`ï¼‰
  - âŒ é”™è¯¯ï¼šä¸»é”®åªåŒ…å«è‡ªå¢IDï¼Œç¼ºå°‘ä¸šåŠ¡æ ‡è¯†

- [ ] **æ¨èä½¿ç”¨è‡ªå¢ID + ä¸šåŠ¡å”¯ä¸€ç´¢å¼•**
  - âœ… æ¨èï¼šè‡ªå¢IDä½œä¸ºä¸»é”®ï¼Œä¸šåŠ¡å”¯ä¸€æ€§é€šè¿‡å”¯ä¸€ç´¢å¼•ä¿è¯
  - âš ï¸ å¯æ¥å—ï¼šä¸šåŠ¡å­—æ®µä½œä¸ºä¸»é”®ï¼ˆéœ€ç¡®ä¿å”¯ä¸€æ€§ï¼‰

---

### 2. å­—æ®µå¿…å¡«è§„åˆ™

- [ ] **ä¸šåŠ¡æ ‡è¯†å­—æ®µå¿…é¡»NOT NULL**
  - âœ… æ­£ç¡®ï¼š`platform_code`, `shop_id`, `order_id`, `platform_sku` ç­‰å­—æ®µ `nullable=False`
  - âŒ é”™è¯¯ï¼šä¸šåŠ¡æ ‡è¯†å­—æ®µ `nullable=True`ï¼ˆé™¤éä¸šåŠ¡æ˜ç¡®éœ€è¦ï¼‰

- [ ] **é‡‘é¢å­—æ®µå¿…é¡»NOT NULL**
  - âœ… æ­£ç¡®ï¼šé‡‘é¢å­—æ®µ `nullable=False`, `default=0.0`
  - âŒ é”™è¯¯ï¼šé‡‘é¢å­—æ®µ `nullable=True`ï¼ˆä¼šå¯¼è‡´NULLè®¡ç®—é—®é¢˜ï¼‰

- [ ] **æ—¶é—´å­—æ®µå¿…é¡»NOT NULL**
  - âœ… æ­£ç¡®ï¼š`created_at`, `updated_at` ç­‰æ—¶é—´å­—æ®µ `nullable=False`
  - âŒ é”™è¯¯ï¼šæ—¶é—´å­—æ®µ `nullable=True`

- [ ] **å¤–é”®å­—æ®µå…è®¸NULL**
  - âœ… æ­£ç¡®ï¼šå¤–é”®å­—æ®µ `nullable=True`ï¼ˆå¦‚ `product_id` åœ¨ `FactOrderItem` ä¸­ï¼‰
  - âŒ é”™è¯¯ï¼šå¤–é”®å­—æ®µå¼ºåˆ¶ `nullable=False`ï¼ˆé™¤éä¸šåŠ¡æ˜ç¡®è¦æ±‚ï¼‰

---

### 3. ç´¢å¼•è®¾è®¡

- [ ] **ä¸»é”®è‡ªåŠ¨åˆ›å»ºç´¢å¼•**
  - âœ… æ­£ç¡®ï¼šä¸»é”®è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•
  - âŒ é”™è¯¯ï¼šæ‰‹åŠ¨åˆ›å»ºé‡å¤çš„ä¸»é”®ç´¢å¼•

- [ ] **ä¸šåŠ¡å”¯ä¸€ç´¢å¼•**
  - âœ… æ­£ç¡®ï¼šç»è¥æ•°æ®è¡¨åˆ›å»ºåŒ…å« `platform_code`, `shop_id`, `platform_sku` çš„å”¯ä¸€ç´¢å¼•
  - âœ… æ­£ç¡®ï¼šè¿è¥æ•°æ®è¡¨åˆ›å»ºåŒ…å« `platform_code`, `shop_id`, `metric_date` çš„å”¯ä¸€ç´¢å¼•
  - âŒ é”™è¯¯ï¼šç¼ºå°‘ä¸šåŠ¡å”¯ä¸€ç´¢å¼•

- [ ] **æŸ¥è¯¢æ€§èƒ½ç´¢å¼•**
  - âœ… æ­£ç¡®ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼ˆå¦‚ `order_date`, `shop_id`, `product_id`ï¼‰
  - âŒ é”™è¯¯ï¼šä¸ºæ‰€æœ‰å­—æ®µåˆ›å»ºç´¢å¼•ï¼ˆå½±å“å†™å…¥æ€§èƒ½ï¼‰

- [ ] **ç´¢å¼•å‘½åè§„èŒƒ**
  - âœ… æ­£ç¡®ï¼š`ix_è¡¨å_å­—æ®µå`ï¼ˆæ™®é€šç´¢å¼•ï¼‰ã€`uq_è¡¨å_å­—æ®µå`ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰
  - âŒ é”™è¯¯ï¼šä½¿ç”¨é»˜è®¤ç´¢å¼•åæˆ–éšæœºå‘½å

---

### 4. å¤–é”®çº¦æŸ

- [ ] **å¤–é”®å‘½åè§„èŒƒ**
  - âœ… æ­£ç¡®ï¼š`fk_è¡¨å_å­—æ®µå`ï¼ˆå¦‚ `fk_fact_order_items_product_id_dim_product_master`ï¼‰
  - âŒ é”™è¯¯ï¼šä½¿ç”¨é»˜è®¤å¤–é”®åæˆ–éšæœºå‘½å

- [ ] **å¤–é”®åˆ é™¤ç­–ç•¥**
  - âœ… æ­£ç¡®ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹© `CASCADE`ã€`SET NULL`ã€`RESTRICT`
  - âŒ é”™è¯¯ï¼šæ‰€æœ‰å¤–é”®éƒ½ä½¿ç”¨ `CASCADE`ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼‰

- [ ] **å¤–é”®å­—æ®µç±»å‹åŒ¹é…**
  - âœ… æ­£ç¡®ï¼šå¤–é”®å­—æ®µç±»å‹ä¸å¼•ç”¨å­—æ®µç±»å‹ä¸€è‡´
  - âŒ é”™è¯¯ï¼šå¤–é”®å­—æ®µç±»å‹ä¸å¼•ç”¨å­—æ®µç±»å‹ä¸ä¸€è‡´

---

### 5. æ•°æ®ç±»å‹é€‰æ‹©

- [ ] **å­—ç¬¦ä¸²å­—æ®µé•¿åº¦**
  - âœ… æ­£ç¡®ï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©é•¿åº¦ï¼ˆå¦‚ `VARCHAR(32)`, `VARCHAR(128)`ï¼‰
  - âŒ é”™è¯¯ï¼šæ‰€æœ‰å­—ç¬¦ä¸²å­—æ®µéƒ½ä½¿ç”¨ `VARCHAR(255)`

- [ ] **é‡‘é¢å­—æ®µç±»å‹**
  - âœ… æ­£ç¡®ï¼šä½¿ç”¨ `DECIMAL(15, 2)` æˆ– `Float`ï¼ˆæ ¹æ®ç²¾åº¦éœ€æ±‚ï¼‰
  - âŒ é”™è¯¯ï¼šä½¿ç”¨ `INTEGER` å­˜å‚¨é‡‘é¢ï¼ˆç²¾åº¦ä¸¢å¤±ï¼‰

- [ ] **æ—¥æœŸæ—¶é—´å­—æ®µç±»å‹**
  - âœ… æ­£ç¡®ï¼š`DATE`ï¼ˆä»…æ—¥æœŸï¼‰ã€`TIMESTAMP`ï¼ˆæ—¥æœŸæ—¶é—´ï¼‰ã€`TIMESTAMPTZ`ï¼ˆå¸¦æ—¶åŒºï¼‰
  - âŒ é”™è¯¯ï¼šä½¿ç”¨ `VARCHAR` å­˜å‚¨æ—¥æœŸæ—¶é—´

- [ ] **å¸ƒå°”å­—æ®µç±»å‹**
  - âœ… æ­£ç¡®ï¼šä½¿ç”¨ `BOOLEAN`
  - âŒ é”™è¯¯ï¼šä½¿ç”¨ `INTEGER(0/1)` æˆ– `VARCHAR('true'/'false')`

---

## âœ… ç‰©åŒ–è§†å›¾è®¾è®¡æ£€æŸ¥æ¸…å•

### 1. ä¸»è§†å›¾è®¾è®¡

- [ ] **ä¸»è§†å›¾åŒ…å«æ•°æ®åŸŸæ‰€æœ‰æ ¸å¿ƒå­—æ®µ**
  - âœ… æ­£ç¡®ï¼šä¸»è§†å›¾åŒ…å«æ•°æ®åŸŸçš„æ‰€æœ‰æ ¸å¿ƒå­—æ®µï¼ˆå¦‚è®¢å•åŸŸåŒ…å«è®¢å•IDã€é‡‘é¢ã€çŠ¶æ€ã€å•†å“ã€ä¹°å®¶ç­‰ï¼‰
  - âŒ é”™è¯¯ï¼šä¸»è§†å›¾åªåŒ…å«éƒ¨åˆ†å­—æ®µ

- [ ] **ä¸»è§†å›¾æœ‰å”¯ä¸€ç´¢å¼•**
  - âœ… æ­£ç¡®ï¼šä¸»è§†å›¾åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œæ”¯æŒ `CONCURRENTLY` åˆ·æ–°
  - âŒ é”™è¯¯ï¼šä¸»è§†å›¾ç¼ºå°‘å”¯ä¸€ç´¢å¼•

- [ ] **ä¸»è§†å›¾å‘½åè§„èŒƒ**
  - âœ… æ­£ç¡®ï¼š`mv_æ•°æ®åŸŸ_summary`ï¼ˆå¦‚ `mv_order_summary`, `mv_traffic_summary`ï¼‰
  - âŒ é”™è¯¯ï¼šä½¿ç”¨éšæœºå‘½å

---

### 2. è¾…åŠ©è§†å›¾è®¾è®¡

- [ ] **è¾…åŠ©è§†å›¾ä¾èµ–å…³ç³»æ˜ç¡®**
  - âœ… æ­£ç¡®ï¼šè¾…åŠ©è§†å›¾æ˜ç¡®ä¾èµ–ä¸»è§†å›¾æˆ–åŸºç¡€æ•°æ®
  - âŒ é”™è¯¯ï¼šè¾…åŠ©è§†å›¾ä¾èµ–å…³ç³»ä¸æ˜ç¡®

- [ ] **è¾…åŠ©è§†å›¾ç”¨äºç‰¹å®šåˆ†æåœºæ™¯**
  - âœ… æ­£ç¡®ï¼šè¾…åŠ©è§†å›¾ç”¨äºæ—¶é—´åºåˆ—åˆ†æã€æ’è¡Œæ¦œã€å¤šç»´åº¦å¯¹æ¯”ç­‰ç‰¹å®šåœºæ™¯
  - âŒ é”™è¯¯ï¼šè¾…åŠ©è§†å›¾ä¸ä¸»è§†å›¾åŠŸèƒ½é‡å¤

- [ ] **è¾…åŠ©è§†å›¾å‘½åè§„èŒƒ**
  - âœ… æ­£ç¡®ï¼š`mv_æ•°æ®åŸŸ_åˆ†æç±»å‹`ï¼ˆå¦‚ `mv_product_sales_trend`, `mv_top_products`ï¼‰
  - âŒ é”™è¯¯ï¼šä½¿ç”¨éšæœºå‘½å

---

### 3. ç‰©åŒ–è§†å›¾åˆ·æ–°

- [ ] **åˆ·æ–°é¡ºåºæ­£ç¡®**
  - âœ… æ­£ç¡®ï¼šå…ˆåˆ·æ–°ä¸»è§†å›¾ï¼Œå†åˆ·æ–°è¾…åŠ©è§†å›¾ï¼ˆæŒ‰ä¾èµ–å…³ç³»ï¼‰
  - âŒ é”™è¯¯ï¼šåˆ·æ–°é¡ºåºä¸æŒ‰ä¾èµ–å…³ç³»

- [ ] **æ”¯æŒCONCURRENTLYåˆ·æ–°**
  - âœ… æ­£ç¡®ï¼šä¸»è§†å›¾æ”¯æŒ `REFRESH MATERIALIZED VIEW CONCURRENTLY`
  - âŒ é”™è¯¯ï¼šä¸»è§†å›¾ä¸æ”¯æŒå¹¶å‘åˆ·æ–°ï¼ˆå½±å“æŸ¥è¯¢æ€§èƒ½ï¼‰

---

## âœ… æ•°æ®å…¥åº“æµç¨‹æ£€æŸ¥æ¸…å•

### 1. shop_idè·å–è§„åˆ™

- [ ] **ä¼˜å…ˆä»æºæ•°æ®è·å–**
  - âœ… æ­£ç¡®ï¼šä»Excelæ–‡ä»¶æˆ–JSONå…ƒæ•°æ®ä¸­è¯»å– `shop_id`
  - âŒ é”™è¯¯ï¼šç¡¬ç¼–ç  `shop_id`

- [ ] **ä½¿ç”¨AccountAliasæ˜ å°„**
  - âœ… æ­£ç¡®ï¼šé€šè¿‡ `AccountAlias` è¡¨æ˜ å°„éæ ‡å‡†åº—é“ºåç§°
  - âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨æºæ•°æ®ä¸­çš„åº—é“ºåç§°

- [ ] **é»˜è®¤å€¼å¤„ç†**
  - âœ… æ­£ç¡®ï¼šæ— æ³•è·å– `shop_id` æ—¶ä½¿ç”¨é»˜è®¤å€¼æˆ–éš”ç¦»æ•°æ®
  - âŒ é”™è¯¯ï¼šå…è®¸ `shop_id` ä¸º NULL

---

### 2. platform_codeè·å–è§„åˆ™

- [ ] **ä»æ–‡ä»¶å…ƒæ•°æ®è·å–**
  - âœ… æ­£ç¡®ï¼šä» `CatalogFile.platform_code` è·å–
  - âŒ é”™è¯¯ï¼šä»æ–‡ä»¶åçŒœæµ‹æˆ–ç¡¬ç¼–ç 

- [ ] **éªŒè¯å¹³å°ä»£ç æœ‰æ•ˆæ€§**
  - âœ… æ­£ç¡®ï¼šéªŒè¯ `platform_code` æ˜¯å¦åœ¨ `DimPlatform` ä¸­å­˜åœ¨
  - âŒ é”™è¯¯ï¼šä¸éªŒè¯å¹³å°ä»£ç æœ‰æ•ˆæ€§

---

### 3. å­—æ®µæ˜ å°„è§„åˆ™

- [ ] **å­—æ®µæ˜ å°„ç¬¦åˆäº‹å®è¡¨ç»“æ„**
  - âœ… æ­£ç¡®ï¼šå­—æ®µæ˜ å°„è¾“å‡ºç¬¦åˆäº‹å®è¡¨å­—æ®µå®šä¹‰
  - âŒ é”™è¯¯ï¼šå­—æ®µæ˜ å°„è¾“å‡ºåŒ…å«äº‹å®è¡¨ä¸­ä¸å­˜åœ¨çš„å­—æ®µ

- [ ] **å­—æ®µç±»å‹åŒ¹é…**
  - âœ… æ­£ç¡®ï¼šæ˜ å°„åçš„å­—æ®µç±»å‹ä¸äº‹å®è¡¨å­—æ®µç±»å‹ä¸€è‡´
  - âŒ é”™è¯¯ï¼šå­—æ®µç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚å­—ç¬¦ä¸²æ˜ å°„åˆ°æ•°å­—å­—æ®µï¼‰

- [ ] **å¿…å¡«å­—æ®µæ˜ å°„**
  - âœ… æ­£ç¡®ï¼šå¿…å¡«å­—æ®µéƒ½æœ‰æ˜ å°„æˆ–é»˜è®¤å€¼
  - âŒ é”™è¯¯ï¼šå¿…å¡«å­—æ®µç¼ºå°‘æ˜ å°„æˆ–é»˜è®¤å€¼

---

### 4. æ•°æ®éªŒè¯è§„åˆ™

- [ ] **æ•°æ®ç±»å‹éªŒè¯**
  - âœ… æ­£ç¡®ï¼šéªŒè¯æ•°æ®ç±»å‹ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€æ—¥æœŸç­‰ï¼‰
  - âŒ é”™è¯¯ï¼šä¸éªŒè¯æ•°æ®ç±»å‹

- [ ] **å–å€¼èŒƒå›´éªŒè¯**
  - âœ… æ­£ç¡®ï¼šéªŒè¯å–å€¼èŒƒå›´ï¼ˆå¦‚é‡‘é¢ >= 0ï¼Œæ•°é‡ > 0ï¼‰
  - âŒ é”™è¯¯ï¼šä¸éªŒè¯å–å€¼èŒƒå›´

- [ ] **ä¸šåŠ¡è§„åˆ™éªŒè¯**
  - âœ… æ­£ç¡®ï¼šéªŒè¯ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚è®¢å•é‡‘é¢ = å•†å“é‡‘é¢ + è¿è´¹ - æŠ˜æ‰£ï¼‰
  - âŒ é”™è¯¯ï¼šä¸éªŒè¯ä¸šåŠ¡è§„åˆ™

---

## âœ… ä½¿ç”¨éªŒè¯å·¥å…·

### 1. è¿è¡Œæ•°æ®åº“è®¾è®¡éªŒè¯

```bash
# é€šè¿‡APIéªŒè¯
curl http://localhost:8001/api/database-design/validate

# æˆ–ä½¿ç”¨Pythonè„šæœ¬
python -c "from backend.services.database_design_validator import validate_database_design; from backend.models.database import get_db; db = next(get_db()); result = validate_database_design(db); print(result.summary)"
```

### 2. æŸ¥çœ‹éªŒè¯æŠ¥å‘Š

éªŒè¯å·¥å…·ä¼šè¿”å›ï¼š
- **é”™è¯¯ï¼ˆerrorï¼‰**ï¼šå¿…é¡»ä¿®å¤çš„é—®é¢˜
- **è­¦å‘Šï¼ˆwarningï¼‰**ï¼šå»ºè®®ä¿®å¤çš„é—®é¢˜
- **ä¿¡æ¯ï¼ˆinfoï¼‰**ï¼šå¯é€‰çš„æ”¹è¿›å»ºè®®

### 3. ä¿®å¤éªŒè¯é—®é¢˜

æ ¹æ®éªŒè¯æŠ¥å‘Šä¸­çš„ `suggestion` å­—æ®µä¿®å¤é—®é¢˜ã€‚

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡è§„èŒƒ](DATABASE_DESIGN.md)
- [ç‰©åŒ–è§†å›¾è®¾è®¡è§„åˆ™](openspec/changes/establish-database-design-rules/specs/database-design/spec.md)
- [ä¸»è§†å›¾å’Œè¾…åŠ©è§†å›¾ä½¿ç”¨æŒ‡å—](../MAIN_VIEWS_USAGE_GUIDE.md)

---

**æœ€åæ›´æ–°**: 2025-11-20  
**ç»´æŠ¤**: AI Agent Team  
**çŠ¶æ€**: âœ… æ­£å¼æ–‡æ¡£

