# 如何导入妙手ERP产品数据 - 完整操作指南

**日期**: 2025-11-05  
**前提条件**: ✅ 所有字段映射已修复并唯一  

## 📋 准备工作

### 1. 确认系统已启动

```bash
# 启动系统（如果还没启动）
python run.py
```

等待看到：
```
[OK] Backend started on http://localhost:8001
[OK] Frontend started on http://localhost:5173
```

### 2. 准备Excel文件

确保您的妙手ERP产品数据Excel文件包含以下字段：

**必需字段**：
- `*商品名称` - 产品名称

**价格字段**：
- `*单价（元）` - 单个售卖价格

**库存字段**（至少有其中几个）：
- `库存总量`
- `可用库存`
- `预占库存`
- `在途库存`

**时间字段**（如果有）：
- `创建时间`
- `更新时间`

## 🚀 导入步骤

### Step 1: 打开字段映射界面

1. 在浏览器打开: `http://localhost:5173`
2. 登录系统
3. 导航到: **数据采集 → 字段映射**
   - 或直接访问: `http://localhost:5173/field-mapping`

### Step 2: 上传文件

1. 点击"上传文件"或"选择文件"按钮
2. 选择您的妙手产品数据Excel文件
3. 等待文件上传完成（显示"上传成功"）

### Step 3: 设置文件元数据

**重要！** 确保设置正确的元数据：

- **平台**: 选择 `miaoshou` （**必须选择miaoshou**）
- **数据域**: 选择 `products`
- **数据粒度**: 选择 `snapshot` (快照数据)
- **表头行**: 通常是 `1`（第一行是表头）

### Step 4: 预览数据

- 系统会自动预览前100行数据
- 检查数据是否正确加载
- 检查列名是否正确识别

### Step 5: 生成智能映射

1. 点击"生成智能映射"按钮
2. 系统会自动识别并映射字段

### Step 6: 验证映射结果

**期望的映射（应该都是绿色✅、高置信度）**：

| 原始字段 | 映射到 | 状态 |
|---------|-------|------|
| *商品名称 | product_name | ✅ 自动映射 |
| *单价（元） | price | ✅ 自动映射 |
| 库存总量 | total_stock | ✅ 自动映射 |
| 可用库存 | available_stock | ✅ 自动映射 |
| 预占库存 | reserved_stock | ✅ 自动映射 |
| 在途库存 | in_transit_stock | ✅ 自动映射 |
| 创建时间 | created_at | ✅ 自动映射 |
| 更新时间 | updated_at | ✅ 自动映射 |

**重要检查点**：
- ✅ 每个字段的下拉菜单只有**1个**选项（没有重复）
- ✅ 所有字段代码都是英文命名（如`total_stock`，不是`stock_zong_liang`）
- ✅ 置信度都显示为"高"（绿色）

**不需要映射的字段**：
- 总价（元） → 选择"无需映射"
- 活动预留库存 → 选择"无需映射"
- 计划库存 → 选择"无需映射"
- 安全库存 → 选择"无需映射"

### Step 7: 确认映射并入库

1. 仔细检查所有映射是否正确
2. 点击**"确认映射并入库"**按钮
3. 等待数据入库完成

**期望看到的成功消息**：
```
✅ 数据入库成功！已导入XXX条记录
```

如果看到：
```
⚠️ 数据质量问题，已移至数据隔离区
```
说明数据有问题，需要查看数据隔离区了解详情。

### Step 8: 验证数据

#### 方法1: 产品管理页面验证

1. 导航到: **产品管理**
   - 或直接访问: `http://localhost:5173/product-management`

2. 点击"查询"按钮（或刷新页面）

3. **期望看到**：
   - ✅ 产品列表显示您的妙手产品（不再是测试商品A/B）
   - ✅ 价格显示正确（不再是0.00）
   - ✅ 库存显示正确（不再是50, 30等测试数据）
   - ✅ Platform显示为"miaoshou"

#### 方法2: 数据库验证

```bash
# 运行验证脚本
python scripts/check_product_metrics_data.py
```

**期望输出**：
```
Platform 'miaoshou': XXX records  ✅
```

### Step 9: 保存映射模板（可选）

如果映射配置正确，建议保存为模板：

1. 点击"保存为模板"按钮
2. **模板名称**: `miaoshou_products_snapshot_v3`
3. **描述**: "妙手产品快照v3 - 包含4个细分库存字段 + 标准时间字段"
4. 保存

下次导入同类型文件时，系统会自动应用此模板！

## ⚠️ 常见问题

### Q1: 点击"确认映射并入库"后，没有任何反应？

**A**: 检查以下几点：
1. 是否正确设置了平台为"miaoshou"
2. 是否正确设置了数据域为"products"
3. 查看浏览器控制台（F12）是否有错误
4. 查看后端日志是否有错误

### Q2: 入库成功了，但产品管理页面还是没有数据？

**A**: 
1. 点击产品管理页面的"刷新"按钮
2. 或者手动刷新浏览器（F5）
3. 检查平台筛选器是否选择了"miaoshou"

### Q3: 看到"数据质量问题"提示？

**A**: 
1. 点击"查看详情"按钮
2. 进入"数据隔离区"查看具体问题
3. 修正数据或映射后重新导入

### Q4: 映射时发现字段重复（同一个字段有多个选项）？

**A**: **这不应该发生！** 我们已经清理了所有重复。如果还有重复：
1. 立即停止
2. 运行检查脚本确认：
   ```bash
   python scripts/check_duplicate_mappings.py
   ```
3. 联系系统管理员

### Q5: 时间字段映射不正确？

**A**: 确认时间字段映射到：
- 创建时间 → `created_at` ✅
- 更新时间 → `updated_at` ✅

**不要选择**拼音命名的字段（如`order_time_utc_chuang_jian`），这些已被删除。

## 📊 验证清单

导入完成后，请逐项检查：

### 数据库层面
- [ ] `fact_product_metrics`表中有`platform_code = 'miaoshou'`的记录
- [ ] `total_stock`等新库存字段有数据（不是NULL）
- [ ] `price`字段有数据（不是0或NULL）
- [ ] `created_at`和`updated_at`有时间戳

### 前端界面
- [ ] 产品管理页面显示妙手产品
- [ ] 价格显示正确（人民币金额）
- [ ] 库存显示正确（4个细分库存）
- [ ] 时间显示正确（创建和更新时间）

### 字段映射
- [ ] 所有字段映射唯一（没有重复选项）
- [ ] 字段代码为英文命名（如`total_stock`）
- [ ] 时间字段映射为`created_at`和`updated_at`

## 🔧 调试工具

如果遇到问题，使用以下脚本诊断：

```bash
# 检查映射唯一性
python scripts/check_duplicate_mappings.py

# 检查产品数据
python scripts/check_product_metrics_data.py

# 诊断数据问题
python scripts/diagnose_product_data_issue.py

# 检查时间字段
python scripts/check_product_metrics_time_columns.py
```

## 📞 需要帮助？

### 查看文档
- **库存价格映射方案**: `docs/INVENTORY_PRICE_MAPPING_SOLUTION.md`
- **快速映射指南**: `docs/MIAOSHOU_PRODUCT_MAPPING_GUIDE.md`
- **重复映射解决报告**: `docs/DUPLICATE_MAPPING_RESOLUTION_REPORT.md`

### 查看日志
- **后端日志**: 查看运行`run.py`的终端窗口
- **前端日志**: 浏览器控制台（F12 → Console）
- **数据隔离区**: 前端界面 → 数据隔离区

---

## ✅ 成功标志

当您看到以下内容时，说明导入成功：

1. **入库消息**：
   ```
   ✅ 数据入库成功！已导入XXX条记录
   ```

2. **产品管理页面**：
   - 显示您的真实妙手产品
   - 价格和库存数据正确
   - 不再是"测试商品A/B"

3. **数据库验证**：
   ```bash
   python scripts/check_product_metrics_data.py
   ```
   输出显示：`Platform 'miaoshou': XXX records`

---

**准备好了吗？** 现在就开始导入您的妙手ERP产品数据吧！ 🚀

按照上面的步骤操作，您的产品数据就会正确显示在产品管理页面了。

