# Metabase ç®€å•é…ç½®æŒ‡å—

**æœ€åæ›´æ–°**ï¼š2025-12-08  
**è¯´æ˜**ï¼šMetabase ä¼šè‡ªåŠ¨å‘ç°æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ï¼Œä¸éœ€è¦ä»»ä½•è„šæœ¬ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**Metabase ä¼šè‡ªåŠ¨å‘ç°æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ï¼Œä¸éœ€è¦ç¡¬ç¼–ç è¡¨ååˆ—è¡¨ï¼**

åªéœ€è¦ï¼š
1. åœ¨ Metabase UI ä¸­é…ç½®æ•°æ®åº“è¿æ¥
2. è®¾ç½®æ­£ç¡®çš„ Schema filters
3. Metabase ä¼šè‡ªåŠ¨åŒæ­¥æ‰€æœ‰è¡¨

---

## ğŸ“‹ é…ç½®æ­¥éª¤

### æ­¥éª¤1ï¼šå¯åŠ¨ Metabase

```bash
docker-compose -f docker-compose.metabase.yml up -d
```

ç­‰å¾… Metabase å®Œå…¨å¯åŠ¨ï¼ˆçº¦ 30-60 ç§’ï¼‰

### æ­¥éª¤2ï¼šå®Œæˆåˆå§‹è®¾ç½®ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰

1. **è®¿é—® Metabase**ï¼š`http://localhost:8080`
2. **åˆ›å»ºç®¡ç†å‘˜è´¦å·**ï¼š
   - å¡«å†™é‚®ç®±ï¼ˆå»ºè®®ï¼š`admin@xihong.com`ï¼‰
   - è®¾ç½®å¯†ç ï¼ˆè¯·è®°ä½è¿™ä¸ªå¯†ç ï¼‰
   - å¡«å†™å§“åï¼ˆå¯é€‰ï¼‰
   - ç‚¹å‡» "è®©æˆ‘ä»¬å¼€å§‹å§"

3. **é€‰æ‹©æ•°æ®æº**ï¼š
   - é€‰æ‹© "ç¨åæ·»åŠ " æˆ– "I'll add my data later"
   - ç‚¹å‡» "å®Œæˆ"

### æ­¥éª¤3ï¼šæ·»åŠ  PostgreSQL æ•°æ®åº“è¿æ¥

1. **è¿›å…¥æ•°æ®åº“è®¾ç½®**ï¼š
   - ç‚¹å‡»å·¦ä¾§èœå•ï¼š**Admin**ï¼ˆç®¡ç†å‘˜ï¼‰
   - ç‚¹å‡»ï¼š**Databases**ï¼ˆæ•°æ®åº“ï¼‰
   - ç‚¹å‡»ï¼š**Add database**ï¼ˆæ·»åŠ æ•°æ®åº“ï¼‰

2. **é€‰æ‹©æ•°æ®åº“ç±»å‹**ï¼š
   - é€‰æ‹©ï¼š**PostgreSQL**

3. **å¡«å†™è¿æ¥ä¿¡æ¯**ï¼š

   | å­—æ®µ | å€¼ | è¯´æ˜ |
   |------|-----|------|
   | **Display name** | è¥¿è™¹ERPæ•°æ®åº“ | è‡ªå®šä¹‰åç§° |
   | **Host** | `postgres` | Docker ç½‘ç»œä¸­çš„æœåŠ¡åï¼ˆæˆ– `localhost`ï¼‰ |
   | **Port** | `5432` | PostgreSQL æ ‡å‡†ç«¯å£ |
   | **Database name** | `xihong_erp` | æ•°æ®åº“å |
   | **Username** | `erp_user` | æ•°æ®åº“ç”¨æˆ·å |
   | **Password** | `erp_pass_2025` | æ•°æ®åº“å¯†ç ï¼ˆæˆ– `.env` ä¸­çš„å€¼ï¼‰ |

4. **é…ç½®é«˜çº§é€‰é¡¹ï¼ˆé‡è¦ï¼‰**ï¼š
   - ç‚¹å‡»ï¼š**Show advanced options**ï¼ˆæ˜¾ç¤ºé«˜çº§é€‰é¡¹ï¼‰
   - **Schema filters**ï¼šè®¾ç½®ä¸º `public,b_class,a_class,c_class,core,finance`
     - **æˆ–è€…**ï¼šé€‰æ‹© **"å…¨éƒ¨"** / **"All schemas"**ï¼ˆæ¨èï¼‰
   - **ä½¿ç”¨å®‰å…¨è¿æ¥ (SSL)**ï¼šâŒ å…³é—­ï¼ˆæœ¬åœ° Docker ç½‘ç»œä¸éœ€è¦ SSLï¼‰
   - **ä½¿ç”¨SSH-tunnel**ï¼šâŒ å…³é—­

5. **æµ‹è¯•è¿æ¥**ï¼š
   - ç‚¹å‡»ï¼š**Test connection**ï¼ˆæµ‹è¯•è¿æ¥ï¼‰
   - åº”è¯¥æ˜¾ç¤ºç»¿è‰²æˆåŠŸçŠ¶æ€

6. **ä¿å­˜è¿æ¥**ï¼š
   - ç‚¹å‡»ï¼š**Save**ï¼ˆä¿å­˜ï¼‰
   - Metabase ä¼šè‡ªåŠ¨å¼€å§‹åŒæ­¥æ•°æ®åº“ Schema

### æ­¥éª¤4ï¼šç­‰å¾… Schema åŒæ­¥å®Œæˆ

1. **æŸ¥çœ‹åŒæ­¥çŠ¶æ€**ï¼š
   - åœ¨æ•°æ®åº“è¯¦æƒ…é¡µï¼Œå¯ä»¥çœ‹åˆ°åŒæ­¥è¿›åº¦
   - åŒæ­¥è¿‡ç¨‹å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿ

2. **æ‰‹åŠ¨è§¦å‘åŒæ­¥ï¼ˆå¦‚æœéœ€è¦ï¼‰**ï¼š
   - ç‚¹å‡»ï¼š**"Sync database schema now"** æŒ‰é’®
   - ç­‰å¾…åŒæ­¥å®Œæˆ

### æ­¥éª¤5ï¼šéªŒè¯ç»“æœ

1. **æŸ¥çœ‹è¡¨åˆ—è¡¨**ï¼š
   - åœ¨æ•°æ®åº“è¯¦æƒ…é¡µï¼Œç‚¹å‡» **"Tables"**ï¼ˆè¡¨ï¼‰æ ‡ç­¾
   - åº”è¯¥èƒ½çœ‹åˆ°æŒ‰ Schema åˆ†ç»„çš„è¡¨

2. **éªŒè¯ b_class schema**ï¼š
   - å±•å¼€ **`b_class`** schema
   - åº”è¯¥èƒ½çœ‹åˆ° **26 ä¸ªæŒ‰å¹³å°åˆ†è¡¨çš„è¡¨**ï¼š
     - **Shopee**: `fact_shopee_orders_daily`, `fact_shopee_products_daily` ç­‰ï¼ˆ14ä¸ªè¡¨ï¼‰
     - **TikTok**: `fact_tiktok_orders_daily`, `fact_tiktok_products_daily` ç­‰ï¼ˆ10ä¸ªè¡¨ï¼‰
     - **Miaoshou**: `fact_miaoshou_inventory_snapshot`ï¼ˆ1ä¸ªè¡¨ï¼‰
     - **Test**: `fact_test_platform_orders_daily`ï¼ˆ1ä¸ªè¡¨ï¼‰

3. **ç¡®è®¤æ²¡æœ‰æ—§è¡¨**ï¼š
   - **ä¸åº”è¯¥çœ‹åˆ°** `fact_raw_data_*` å¼€å¤´çš„æ—§è¡¨
   - å¦‚æœçœ‹åˆ°æ—§è¡¨ï¼Œè¯´æ˜ Schema filters é…ç½®ä¸æ­£ç¡®

---

## âš ï¸ å…³é”®é…ç½®ç‚¹

### Schema filters å¿…é¡»æ­£ç¡®

**é”™è¯¯é…ç½®**ï¼ˆåªåŒ…å« `public`ï¼‰ï¼š
```
Schema filters: public
```
âŒ è¿™ä¼šå¯¼è‡´ Metabase åªåŒæ­¥ `public` schemaï¼Œçœ‹ä¸åˆ° `b_class` schema ä¸­çš„è¡¨

**æ­£ç¡®é…ç½®**ï¼ˆåŒ…å«æ‰€æœ‰ schemaï¼‰ï¼š
```
Schema filters: public,b_class,a_class,c_class,core,finance
```
âœ… æˆ–è€…é€‰æ‹© **"å…¨éƒ¨"** / **"All schemas"**ï¼ˆæ¨èï¼‰

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šMetabase æ˜¾ç¤ºæ—§è¡¨åï¼ˆ`fact_raw_data_*`ï¼‰

**åŸå› **ï¼š
- Schema filters é…ç½®ä¸æ­£ç¡®ï¼ŒåªåŒ…å«äº† `public` schema
- Metabase ç¼“å­˜äº†æ—§çš„è¡¨ç»“æ„

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Schema filters é…ç½®
2. ç¡®ä¿åŒ…å« `b_class` schema
3. ç‚¹å‡» "Sync database schema now" é‡æ–°åŒæ­¥
4. ç­‰å¾… 1-2 åˆ†é’Ÿè®©åŒæ­¥å®Œæˆ

### é—®é¢˜2ï¼šçœ‹ä¸åˆ° `b_class` schema ä¸­çš„è¡¨

**åŸå› **ï¼š
- Schema filters æ²¡æœ‰åŒ…å« `b_class`
- æ•°æ®åº“ç”¨æˆ·æ²¡æœ‰è®¿é—® `b_class` schema çš„æƒé™

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¿®æ”¹ Schema filtersï¼Œæ·»åŠ  `b_class`
2. æˆ–é€‰æ‹© "å…¨éƒ¨" / "All schemas"
3. é‡æ–°åŒæ­¥ Schema

### é—®é¢˜3ï¼šè¿æ¥å¤±è´¥

**åŸå› **ï¼š
- PostgreSQL æœªè¿è¡Œ
- ç½‘ç»œé…ç½®é”™è¯¯ï¼ˆDocker ç½‘ç»œï¼‰
- è¿æ¥å‚æ•°é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ PostgreSQL å®¹å™¨çŠ¶æ€ï¼š`docker ps | grep postgres`
2. ç¡®è®¤ä½¿ç”¨ Docker ç½‘ç»œæ—¶ï¼ŒHost å¡«å†™ `postgres`ï¼ˆæœåŠ¡åï¼‰
3. ç¡®è®¤è¿æ¥å‚æ•°ä¸ `.env` æ–‡ä»¶ä¸€è‡´

---

## ğŸ“Š å½“å‰æ•°æ®åº“ Schema ç»“æ„

### b_class schemaï¼ˆä¸šåŠ¡æ•°æ®ï¼‰

**26 ä¸ªæŒ‰å¹³å°åˆ†è¡¨çš„è¡¨**ï¼š
- `fact_shopee_*` (14ä¸ªè¡¨)
- `fact_tiktok_*` (10ä¸ªè¡¨)
- `fact_miaoshou_*` (1ä¸ªè¡¨)
- `fact_test_*` (1ä¸ªè¡¨)

### a_class schemaï¼ˆç”¨æˆ·é…ç½®æ•°æ®ï¼‰

7 å¼ è¡¨ï¼ˆä¸­æ–‡å­—æ®µåï¼‰ï¼š
- `sales_targets_a`
- `sales_campaigns_a`
- `operating_costs`
- `employees`
- `employee_targets`
- `attendance_records`
- `performance_config_a`

### c_class schemaï¼ˆè®¡ç®—æ•°æ®ï¼‰

4 å¼ è¡¨ï¼ˆä¸­æ–‡å­—æ®µåï¼‰ï¼š
- `employee_performance`
- `employee_commissions`
- `shop_commissions`
- `performance_scores_c`

### core schemaï¼ˆæ ¸å¿ƒERPè¡¨ï¼‰

çº¦ 20 å¼ è¡¨ï¼š
- `catalog_files`
- `field_mapping_*`
- `dim_*`
- ç­‰

### public schemaï¼ˆå…¬å…±è¡¨ï¼‰

ç³»ç»Ÿè¡¨å’Œå…¶ä»–è¡¨

---

## âœ… æˆåŠŸæ ‡å¿—

é…ç½®æˆåŠŸåï¼Œåœ¨ Metabase ä¸­åº”è¯¥çœ‹åˆ°ï¼š

1. âœ… `b_class` schema ä¸‹æœ‰ **26 ä¸ªæŒ‰å¹³å°åˆ†è¡¨çš„è¡¨**
2. âœ… è¡¨åæ ¼å¼ä¸º `fact_shopee_*`, `fact_tiktok_*`, `fact_miaoshou_*`
3. âœ… **ä¸åº”è¯¥çœ‹åˆ°** `fact_raw_data_*` å¼€å¤´çš„æ—§è¡¨
4. âœ… å¯ä»¥æ­£å¸¸æŸ¥è¯¢è¿™äº›è¡¨çš„æ•°æ®

---

## ğŸš« ä¸éœ€è¦çš„è„šæœ¬

ä»¥ä¸‹è„šæœ¬å·²å½’æ¡£ï¼Œä¸å†éœ€è¦ï¼š

- âŒ `scripts/init_metabase_tables.py` - ç¡¬ç¼–ç è¡¨ååˆ—è¡¨ï¼Œå·²å½’æ¡£
- âŒ `scripts/sync_dss_tables_to_metabase.py` - åŒæ­¥è„šæœ¬ï¼Œå·²å½’æ¡£
- âŒ `scripts/fix_metabase_table_cache.py` - ç¼“å­˜ä¿®å¤è„šæœ¬ï¼Œå·²å½’æ¡£
- âŒ `scripts/diagnose_metabase_schema_sync.py` - è¯Šæ–­è„šæœ¬ï¼Œå·²å½’æ¡£

**åŸå› **ï¼šMetabase ä¼šè‡ªåŠ¨å‘ç°æ‰€æœ‰è¡¨ï¼Œä¸éœ€è¦ç¡¬ç¼–ç è¡¨ååˆ—è¡¨ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/METABASE_POSTGRESQL_CONNECTION_GUIDE.md` - è¯¦ç»†çš„è¿æ¥é…ç½®æŒ‡å—
- `docs/METABASE_OLD_TABLES_FINAL_FIX.md` - æ—§è¡¨é—®é¢˜ä¿®å¤æŒ‡å—

---

**åˆ›å»ºæ—¶é—´**ï¼š2025-12-08  
**çŠ¶æ€**ï¼šâœ… ç®€åŒ–é…ç½®æŒ‡å—ï¼ŒMetabase è‡ªåŠ¨å‘ç°æ‰€æœ‰è¡¨

