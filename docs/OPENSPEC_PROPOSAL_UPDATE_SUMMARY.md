# OpenSpec提案更新总结

**日期**: 2025-02-01  
**提案ID**: `complete-data-sync-pipeline`  
**更新原因**: 反映DSS架构重构（v4.13.0）后的数据同步流程变更

---

## 📋 更新概述

根据v4.13.0 DSS架构重构，更新了`complete-data-sync-pipeline`提案，确保提案准确反映当前实现，避免后期重复开发或误解。

---

## 🔧 主要更新内容

### 1. 提案文档（`proposal.md`）更新

#### ✅ 更新数据同步流程描述
- **修改前**: 字段映射 → 数据标准化 → 业务逻辑验证 → 数据隔离
- **修改后**: 模板查找和配置 → 去重处理 → 数据入库到B类数据表 → Metabase验证

#### ✅ 添加重要架构变更说明
- DSS架构重构（v4.13.0）
- 核心原则：数据同步只做数据采集和存储
- 模板作用：只记录表头行和表头字段列表
- 新数据域处理流程
- 表头更新处理流程

#### ✅ 更新成功标准
- Phase 2: 数据同步验证（DSS架构）
- Phase 3: 数据入库验证（B类数据表，JSONB格式）
- Phase 4: Metabase集成验证（DSS架构）
- Phase 5: 端到端验证（DSS架构）
- Phase 9: 模板管理与数据同步协同机制验证（新增）

#### ✅ 更新技术细节
- 数据同步验证（DSS架构）
- 数据完整性验证（B类数据表，JSONB格式）
- Metabase集成验证（DSS架构）
- 模板管理与数据同步协同机制验证（新增）

### 2. 规格文档（`specs/data-sync/spec.md`）更新

#### ✅ 更新单文件数据同步需求
- **修改前**: 包括字段映射应用
- **修改后**: 包括模板查找和配置、去重处理、数据入库到B类数据表
- 添加DSS架构原则说明（跳过字段映射、数据标准化、业务逻辑验证和数据隔离）

#### ✅ 更新数据完整性验证需求
- **修改前**: 验证事实表（fact_orders等）
- **修改后**: 验证B类数据表（fact_raw_data_*），JSONB格式，data_hash唯一性

#### ✅ 更新数据质量验证需求
- **修改前**: 数据同步流程中验证业务逻辑，隔离问题数据
- **修改后**: Metabase中验证业务逻辑，DSS架构下不隔离数据

#### ✅ 更新Metabase集成数据要求
- **修改前**: 查询事实表，确保数据格式符合要求
- **修改后**: 查询B类数据表，JSONB格式，在Metabase中配置字段映射和业务逻辑验证规则

#### ✅ 更新端到端验证需求
- **修改前**: 数据采集 → 文件注册 → 数据同步 → 数据入库
- **修改后**: 数据采集 → 文件注册 → 模板查找和配置 → 数据入库到B类数据表 → Metabase验证

#### ✅ 更新验证工具需求
- 所有验证工具场景都更新为DSS架构版本
- 明确验证B类数据表、JSONB格式、去重机制
- 明确验证DSS架构（不再执行字段映射、数据标准化、业务逻辑验证和数据隔离）

#### ✅ 更新空文件处理需求
- 明确不写入B类数据表（而非事实表）
- 明确DSS架构下不验证业务逻辑

#### ✅ 新增模板管理与数据同步协同机制需求
- 新数据域处理流程
- 表头更新处理流程
- 模板查找和配置
- 模板版本管理

---

## 📊 更新统计

| 文档 | 更新项 | 说明 |
|------|--------|------|
| `proposal.md` | 15+处 | 流程描述、架构变更、成功标准、技术细节、风险评估 |
| `specs/data-sync/spec.md` | 25+处 | 所有需求场景都更新为DSS架构版本 |
| `tasks.md` | 15+处 | 任务描述、验证点、验收标准 |
| `design.md` | 10+处 | 技术设计、验证方法、示例数据 |
| **总计** | **65+处** | **全面反映DSS架构重构** |

---

## ✅ 关键变更点

### 1. 数据同步流程变更

**修改前**:
```
文件读取 → 字段映射应用 → 数据标准化 → 业务逻辑验证 → 数据隔离 → 数据入库到事实表
```

**修改后（DSS架构）**:
```
文件读取 → 模板查找和配置 → 元数据补充 → 去重处理 → 数据入库到B类数据表（JSONB格式） → Metabase验证
```

### 2. 模板作用变更

**修改前**:
- 模板记录字段映射关系（原始字段 → 标准字段）

**修改后（DSS架构）**:
- 模板只记录表头行（header_row）和表头字段列表（header_columns）
- 不记录字段映射（字段映射在Metabase中完成）

### 3. 数据验证变更

**修改前**:
- 数据同步流程中验证业务逻辑（如"可用库存不能大于实际库存"）
- 隔离验证失败的数据

**修改后（DSS架构）**:
- 数据同步流程中不验证业务逻辑
- 不隔离数据（quarantined_count始终为0）
- 业务逻辑验证在Metabase中完成

### 4. 数据存储变更

**修改前**:
- 数据写入事实表（fact_orders, fact_product_metrics等）
- 字段映射为标准字段名

**修改后（DSS架构）**:
- 数据写入B类数据表（fact_raw_data_orders_daily, fact_raw_data_products_snapshot等）
- JSONB格式存储（保留原始中文表头）
- 字段映射在Metabase中完成

---

## 🎯 新增内容

### 1. 模板管理与数据同步协同机制

#### 新数据域处理流程
- 无模板时跳过同步（only_with_template=True）
- 用户创建模板（选择表头行和保存表头字段列表）
- 模板创建后可以正常同步

#### 表头更新处理流程
- 检测表头变化（detect_header_changes()）
- 表头匹配率<80%时提示用户更新模板
- 模板版本管理（新版本自动归档旧版本）

#### 模板查找和配置
- 三级智能降级匹配（精确匹配 → 忽略sub_domain → 已禁用）
- 使用模板的header_row和header_columns
- 表头匹配验证（仅日志，不阻止同步）

---

## ✅ 验证结果

- ✅ **OpenSpec验证通过**: `openspec validate complete-data-sync-pipeline --strict` 无错误
- ✅ **规格完整性**: 所有需求场景都更新为DSS架构版本
- ✅ **文档一致性**: 提案文档和规格文档保持一致

---

## 📝 后续工作

1. **测试验证**: 按照更新后的提案进行端到端测试
2. **文档更新**: 更新相关技术文档，确保与提案一致
3. **培训材料**: 基于更新后的提案创建培训材料

---

**更新完成时间**: 2025-02-01  
**状态**: ✅ **已完成，OpenSpec验证通过**

