# è§’è‰²æƒé™é…ç½®æ›´æ–°è®°å½•

**æ›´æ–°æ—¥æœŸ**: 2026-01-08  
**æ›´æ–°å†…å®¹**: ç›®æ ‡ç®¡ç†å’Œæ•°æ®åŒæ­¥æƒé™é™åˆ¶ã€è¿è¥äººå‘˜è§’è‰²æè¿°ä¿®æ­£

---

## âœ… å·²å®Œæˆçš„é…ç½®

### 1. å‰ç«¯è·¯ç”±æƒé™é…ç½®

#### ç›®æ ‡ç®¡ç†ç›¸å…³è·¯ç”±

- âœ… `/target-management` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)
- âœ… `/config/sales-targets` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)

#### æ•°æ®åŒæ­¥ç›¸å…³è·¯ç”±

- âœ… `/data-sync/files` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)
- âœ… `/data-sync/file-detail/:fileId` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)
- âœ… `/data-sync/tasks` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)
- âœ… `/data-sync/history` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)
- âœ… `/data-sync/templates` - æ”¹ä¸ºä»…ç®¡ç†å‘˜å¯è®¿é—® (`roles: ['admin']`)

**ä¿®æ”¹æ–‡ä»¶**: `frontend/src/router/index.js`

---

### 2. åç«¯ API æƒé™æ£€æŸ¥

#### ç›®æ ‡ç®¡ç† API (`backend/routers/target_management.py`)

- âœ… æ·»åŠ  `require_admin` ä¾èµ–å‡½æ•°
- âœ… `GET /api/targets` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `GET /api/targets/{target_id}` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `POST /api/targets` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `PUT /api/targets/{target_id}` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `DELETE /api/targets/{target_id}` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `POST /api/targets/{target_id}/breakdown` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `GET /api/targets/{target_id}/breakdown` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- âœ… `POST /api/targets/{target_id}/calculate` - æ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥

#### æ•°æ®åŒæ­¥ API (`backend/routers/data_sync.py`)

- âš ï¸ **å¾…å®Œæˆ**: æ•°æ®åŒæ­¥ API ç«¯ç‚¹è¾ƒå¤šï¼Œéœ€è¦é€ä¸ªæ·»åŠ ç®¡ç†å‘˜æƒé™æ£€æŸ¥
- å½“å‰çŠ¶æ€: éƒ¨åˆ†ç«¯ç‚¹å·²æœ‰ `get_current_user` è®¤è¯ï¼Œä½†ç¼ºå°‘ `require_admin` æ£€æŸ¥

**å»ºè®®**: ä¸ºæ‰€æœ‰æ•°æ®åŒæ­¥ API ç«¯ç‚¹æ·»åŠ  `require_admin` ä¾èµ–

---

### 3. è¿è¥äººå‘˜è§’è‰²æè¿°ä¿®æ­£

**é—®é¢˜**: æ•°æ®åº“ä¸­"è¿è¥äººå‘˜"è§’è‰²çš„æè¿°ä¸º"é»˜è®¤è¿è¥è§’è‰²ï¼Œç”¨äºæ–°ç”¨æˆ·å®¡æ‰¹"ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºæ–°ç”¨æˆ·å®¡æ‰¹ä»…ç®¡ç†å‘˜å¯è®¿é—®ã€‚

**è§£å†³æ–¹æ¡ˆ**:

- âœ… åˆ›å»ºå¹¶æ‰§è¡Œäº† `scripts/update_operator_role_description.py` è„šæœ¬
- âœ… æ›´æ–°æ•°æ®åº“ä¸­çš„è§’è‰²æè¿°ä¸ºï¼š"æ—¥å¸¸æ“ä½œäººå‘˜è§’è‰²ï¼Œç”¨äºæ•°æ®é‡‡é›†å’Œä¸šåŠ¡æ“ä½œ"

**æ‰§è¡Œç»“æœ**:

```
[OK] è¿è¥äººå‘˜è§’è‰²æè¿°å·²æ›´æ–°
æ›´æ–°åæè¿°: æ—¥å¸¸æ“ä½œäººå‘˜è§’è‰²ï¼Œç”¨äºæ•°æ®é‡‡é›†å’Œä¸šåŠ¡æ“ä½œ
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶è¯´æ˜

### å‰ç«¯è·¯ç”±å®ˆå«ï¼ˆç¬¬ä¸€å±‚é˜²æŠ¤ï¼‰

- **ä½ç½®**: `frontend/src/router/index.js` (ç¬¬ 1051-1058 è¡Œ)
- **æœºåˆ¶**: æ£€æŸ¥ç”¨æˆ·è§’è‰²ï¼Œä¸åŒ¹é…åˆ™é‡å®šå‘åˆ° `/business-overview`
- **çŠ¶æ€**: âœ… å·²é…ç½®

### åç«¯ API æƒé™éªŒè¯ï¼ˆç¬¬äºŒå±‚é˜²æŠ¤ï¼‰

- **ä½ç½®**: å„è·¯ç”±æ–‡ä»¶ä¸­çš„ `require_admin` ä¾èµ–
- **æœºåˆ¶**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œä¸æ˜¯åˆ™è¿”å› 403 é”™è¯¯
- **çŠ¶æ€**: âœ… ç›®æ ‡ç®¡ç† API å·²é…ç½®ï¼Œâš ï¸ æ•°æ®åŒæ­¥ API å¾…å®Œæˆ

---

## ğŸ“‹ å¾…å®Œæˆå·¥ä½œ

### 1. æ•°æ®åŒæ­¥ API æƒé™æ£€æŸ¥ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**æ–‡ä»¶**: `backend/routers/data_sync.py`

éœ€è¦æ·»åŠ  `require_admin` çš„ç«¯ç‚¹ï¼š

- `GET /api/data-sync/files`
- `GET /api/data-sync/tasks`
- `GET /api/data-sync/history`
- `POST /api/data-sync/batch`
- `POST /api/data-sync/single`
- `POST /api/data-sync/batch-by-ids`
- `POST /api/data-sync/batch-all`
- `POST /api/data-sync/retry-task/{celery_task_id}`
- `DELETE /api/data-sync/cancel-task/{celery_task_id}`
- å…¶ä»–æ•°æ®åŒæ­¥ç›¸å…³ç«¯ç‚¹

**å»ºè®®**: åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  `require_admin` å‡½æ•°ï¼Œç„¶åä¸ºæ‰€æœ‰ç«¯ç‚¹æ·»åŠ  `current_user: DimUser = Depends(require_admin)` å‚æ•°ã€‚

---

## ğŸ¯ æƒé™çŸ©é˜µæ€»ç»“

### ä»…ç®¡ç†å‘˜ (admin) å¯è®¿é—®çš„æ¨¡å—

| æ¨¡å—åˆ†ç±» | å…·ä½“æ¨¡å—     | å‰ç«¯è·¯ç”±  | åç«¯ API  |
| -------- | ------------ | --------- | --------- |
| ç›®æ ‡ç®¡ç† | ç›®æ ‡ç®¡ç†     | âœ… å·²é…ç½® | âœ… å·²é…ç½® |
| ç›®æ ‡ç®¡ç† | é”€å”®ç›®æ ‡é…ç½® | âœ… å·²é…ç½® | âš ï¸ å¾…æ£€æŸ¥ |
| æ•°æ®åŒæ­¥ | æ–‡ä»¶åˆ—è¡¨     | âœ… å·²é…ç½® | âš ï¸ å¾…é…ç½® |
| æ•°æ®åŒæ­¥ | æ–‡ä»¶è¯¦æƒ…     | âœ… å·²é…ç½® | âš ï¸ å¾…é…ç½® |
| æ•°æ®åŒæ­¥ | åŒæ­¥ä»»åŠ¡     | âœ… å·²é…ç½® | âš ï¸ å¾…é…ç½® |
| æ•°æ®åŒæ­¥ | åŒæ­¥å†å²     | âœ… å·²é…ç½® | âš ï¸ å¾…é…ç½® |
| æ•°æ®åŒæ­¥ | æ¨¡æ¿ç®¡ç†     | âœ… å·²é…ç½® | âš ï¸ å¾…é…ç½® |

---

## ğŸ“ éªŒè¯æ­¥éª¤

### 1. å‰ç«¯è·¯ç”±éªŒè¯

1. ä½¿ç”¨éç®¡ç†å‘˜è´¦å·ç™»å½•
2. å°è¯•ç›´æ¥è®¿é—® `/target-management` æˆ– `/data-sync/files`
3. åº”è¯¥è¢«é‡å®šå‘åˆ° `/business-overview`

### 2. åç«¯ API éªŒè¯

1. ä½¿ç”¨éç®¡ç†å‘˜è´¦å·çš„ Token è°ƒç”¨ `GET /api/targets`
2. åº”è¯¥è¿”å› 403 é”™è¯¯ï¼š"Insufficient permissions: Admin access required"

### 3. è§’è‰²æè¿°éªŒè¯

1. ç™»å½•ç³»ç»Ÿï¼Œè¿›å…¥è§’è‰²ç®¡ç†ä¸­å¿ƒ
2. æŸ¥çœ‹"è¿è¥äººå‘˜"è§’è‰²çš„æè¿°
3. åº”è¯¥æ˜¾ç¤ºï¼š"æ—¥å¸¸æ“ä½œäººå‘˜è§’è‰²ï¼Œç”¨äºæ•°æ®é‡‡é›†å’Œä¸šåŠ¡æ“ä½œ"

---

## ğŸ”§ ç›¸å…³æ–‡ä»¶

- `frontend/src/router/index.js` - å‰ç«¯è·¯ç”±é…ç½®
- `backend/routers/target_management.py` - ç›®æ ‡ç®¡ç† API
- `backend/routers/data_sync.py` - æ•°æ®åŒæ­¥ APIï¼ˆå¾…å®Œæˆï¼‰
- `scripts/update_operator_role_description.py` - è§’è‰²æè¿°æ›´æ–°è„šæœ¬
- `scripts/update_operator_role_description.sql` - SQL æ›´æ–°è„šæœ¬

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **åŒé‡éªŒè¯**: å‰ç«¯è·¯ç”±å®ˆå«å’Œåç«¯ API æƒé™æ£€æŸ¥éƒ½æ˜¯å¿…éœ€çš„ï¼Œä¸èƒ½åªä¾èµ–å…¶ä¸­ä¸€æ–¹
2. **URL ç»•è¿‡**: å³ä½¿ç»•è¿‡å‰ç«¯è·¯ç”±å®ˆå«ï¼Œåç«¯ API ä¹Ÿä¼šæ‹¦æˆªæœªæˆæƒè®¿é—®
3. **è§’è‰²æè¿°**: è§’è‰²æè¿°åº”è¯¥å‡†ç¡®åæ˜ è§’è‰²çš„å®é™…æƒé™èŒƒå›´
4. **æ•°æ®åŒæ­¥ API**: æ•°æ®åŒæ­¥ API ç«¯ç‚¹è¾ƒå¤šï¼Œéœ€è¦ä»”ç»†æ£€æŸ¥æ¯ä¸ªç«¯ç‚¹æ˜¯å¦éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] å‰ç«¯è·¯ç”±æƒé™é…ç½®ï¼ˆç›®æ ‡ç®¡ç†ã€æ•°æ®åŒæ­¥ï¼‰
- [x] åç«¯ç›®æ ‡ç®¡ç† API æƒé™æ£€æŸ¥
- [x] è¿è¥äººå‘˜è§’è‰²æè¿°ä¿®æ­£
- [ ] åç«¯æ•°æ®åŒæ­¥ API æƒé™æ£€æŸ¥ï¼ˆå¾…å®Œæˆï¼‰
