# 角色切换功能实现记录

**更新日期**: 2026-01-08  
**更新内容**: 将角色切换从测试模式改为实际可用，根据权限矩阵配置角色权限

---

## ✅ 已完成的修改

### 1. 角色切换组件更新 (`frontend/src/components/common/SimpleAccountSwitcher.vue`)

#### 主要改进
- ✅ **移除"（测试）"标签**: 将"切换角色（测试）"改为"切换角色"
- ✅ **从后端获取真实角色**: 使用 `/auth/me` API 获取用户的真实角色列表
- ✅ **动态显示角色**: 只显示用户实际拥有的角色
- ✅ **权限矩阵配置**: 根据2026-01-08讨论的权限矩阵配置各角色的权限

#### 角色权限配置

**管理员 (admin)**
- 所有权限（包括系统管理、数据采集、目标管理、数据同步等）

**主管 (manager)**
- 业务管理、审批、配置权限
- 不包括：系统管理、数据采集、目标管理、数据同步

**操作员 (operator)**
- 基础业务操作权限
- 不包括：账号管理、目标管理、财务管理、数据同步、系统管理

**财务 (finance)**
- 财务和销售数据查看权限
- 不包括：库存管理、店铺管理、账号管理、目标管理、数据同步

### 2. 用户Store更新 (`frontend/src/stores/user.js`)

- ✅ 添加 `authApi` 导入
- ✅ `initUserInfo` 方法改为异步，从后端获取用户信息
- ✅ 支持从 `/auth/me` API 获取最新用户角色信息

### 3. 认证Store更新 (`frontend/src/stores/auth.js`)

- ✅ 登录成功后，同步用户信息到 `userStore`
- ✅ 自动设置默认激活角色（用户的第一个角色）

---

## 🔧 技术实现细节

### 角色切换机制

1. **角色获取**: 
   - 优先使用 `authStore.user.roles`
   - 降级到 `userStore.roles`
   - 如果都没有，从 `/auth/me` API 获取

2. **角色切换**:
   - 切换"当前激活的角色"（前端状态）
   - 不影响数据库中的用户角色
   - 更新 `localStorage` 中的 `activeRole`
   - 应用对应角色的权限列表

3. **权限应用**:
   - 根据 `ROLE_CONFIG` 配置应用权限
   - 更新 `userStore.permissions`
   - 保存到 `localStorage`

### 数据同步

- `authStore` 和 `userStore` 自动同步用户信息
- 使用 `watch` 监听 `authStore.user` 变化
- 登录后自动同步角色信息

---

## 📋 权限矩阵（根据2026-01-08讨论）

### 管理员 (admin)
**权限范围**: 所有模块
- ✅ 系统管理（用户、角色、权限、配置、日志、备份、维护）
- ✅ 数据管理（数据隔离、数据一致性）
- ✅ 数据采集（配置、任务、历史、组件）
- ✅ 目标管理（目标管理、销售目标配置）
- ✅ 数据同步（所有功能）
- ✅ 业务管理（所有业务模块）
- ✅ 财务模块

### 主管 (manager)
**权限范围**: 管理和审批相关模块
- ✅ 业务概览
- ✅ 销售分析、销售看板、订单管理、客户管理
- ✅ 库存看板
- ✅ 店铺管理、店铺分析
- ✅ 账号管理、账号对齐
- ✅ 采购管理（采购订单、入库单、供应商管理）
- ✅ 财务管理（财务管理、费用管理、财务报表）
- ✅ 报表中心（销售报表、库存报表、供应商报表）
- ✅ 人力资源（人力管理、员工档案、考勤管理）
- ✅ 审批中心（我的待办、我的申请、审批历史）
- ✅ 绩效管理
- ✅ 个人设置、会话管理
- ✅ 消息中心
- ❌ **不能访问**: 系统管理、数据采集、数据隔离区、目标管理、数据同步

### 操作员 (operator)
**权限范围**: 日常操作相关模块
- ✅ 业务概览
- ✅ 销售看板v3、客户管理、订单管理、销售战役管理
- ✅ 库存看板v3
- ✅ 店铺管理
- ✅ 人力资源（人力管理、绩效管理）
- ✅ 个人设置、会话管理
- ✅ 消息中心
- ❌ **不能访问**: 系统管理、数据采集、数据隔离区、账号管理、目标管理、采购管理、财务管理、报表中心、审批中心、数据同步

### 财务 (finance)
**权限范围**: 财务和销售查看相关模块
- ✅ 销售分析、销售看板、订单管理
- ✅ 财务管理（财务管理、费用管理、财务报表、财务报表详情）
- ✅ 发票管理
- ✅ 会计期间
- ✅ 个人设置、会话管理
- ✅ 消息中心
- ❌ **不能访问**: 系统管理、数据采集、数据隔离区、库存管理、店铺管理、账号管理、目标管理、数据同步、人力资源、审批中心

---

## 🔒 安全机制

### 角色验证
- ✅ 切换角色前检查用户是否拥有该角色
- ✅ 只显示用户实际拥有的角色
- ✅ 如果用户没有某个角色，切换时会提示警告

### 权限应用
- ✅ 切换角色后立即应用对应权限
- ✅ 刷新页面触发路由守卫重新检查权限
- ✅ 权限保存在 `localStorage`，页面刷新后自动恢复

---

## 📝 使用说明

### 用户操作流程

1. **登录系统**: 登录后自动获取用户角色列表
2. **查看角色**: 点击右上角用户头像，查看"切换角色"下拉菜单
3. **切换角色**: 选择要切换的角色，系统自动应用对应权限
4. **权限生效**: 页面刷新后，菜单和路由权限根据新角色生效

### 管理员操作

- 在"角色管理中心"为用户分配角色
- 用户登录后，只能切换到自己拥有的角色
- 角色切换不影响数据库，只影响前端显示和权限

---

## 🔧 相关文件

- `frontend/src/components/common/SimpleAccountSwitcher.vue` - 角色切换组件
- `frontend/src/stores/user.js` - 用户状态管理
- `frontend/src/stores/auth.js` - 认证状态管理
- `frontend/src/api/auth.js` - 认证API客户端
- `frontend/src/router/index.js` - 路由守卫（权限检查）

---

## ✅ 完成状态

- [x] 移除"（测试）"标签
- [x] 从后端获取真实角色
- [x] 动态显示用户拥有的角色
- [x] 根据权限矩阵配置角色权限
- [x] 更新用户Store，从后端获取用户信息
- [x] 登录后自动同步用户角色
- [x] 角色切换功能实际可用

---

## 📌 注意事项

1. **角色切换是前端功能**: 切换角色只影响前端显示和权限，不修改数据库
2. **权限实时生效**: 切换角色后需要刷新页面，路由守卫会重新检查权限
3. **角色验证**: 用户只能切换到已拥有的角色，不能切换到未分配的角色
4. **数据同步**: `authStore` 和 `userStore` 会自动同步，确保数据一致性

---

## 🎯 下一步建议

1. **测试验证**: 使用不同角色的用户测试角色切换功能
2. **权限验证**: 验证各角色切换后，菜单和路由权限是否正确
3. **用户体验**: 考虑添加角色切换的加载状态和错误提示
