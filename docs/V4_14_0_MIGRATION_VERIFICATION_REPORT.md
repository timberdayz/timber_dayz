# v4.14.0 è¿ç§»éªŒè¯æŠ¥å‘Š

## ğŸ“‹ è¿ç§»æ‰§è¡Œæ—¶é—´

**æ—¥æœŸ**: 2025-12-03  
**æ—¶é—´**: 19:14:55  
**çŠ¶æ€**: âœ… å…¨éƒ¨æˆåŠŸ

## âœ… è¿ç§»æ‰§è¡Œç»“æœ

### 1. deduplication_fieldså­—æ®µè¿ç§» âœ…

**è¿ç§»è„šæœ¬**: `scripts/migrate_add_deduplication_fields.py`  
**æ‰§è¡Œæ—¶é—´**: 2025-12-03 19:12:18  
**çŠ¶æ€**: âœ… æˆåŠŸ

**éªŒè¯ç»“æœ**:
- âœ… å­—æ®µå·²æˆåŠŸæ·»åŠ åˆ° `field_mapping_templates` è¡¨
- âœ… å­—æ®µç±»å‹: JSONB
- âœ… å¯ç©º: YES

### 2. å”¯ä¸€çº¦æŸè¿ç§» âœ…

**è¿ç§»è„šæœ¬**: `scripts/migrate_unique_constraint_v4_14_0.py`  
**æ‰§è¡Œæ—¶é—´**: 2025-12-03 19:14:55  
**çŠ¶æ€**: âœ… æˆåŠŸ

**è¿ç§»çš„è¡¨** (å…±13å¼ ):
1. âœ… `fact_raw_data_orders_daily`
2. âœ… `fact_raw_data_orders_weekly`
3. âœ… `fact_raw_data_orders_monthly`
4. âœ… `fact_raw_data_products_daily`
5. âœ… `fact_raw_data_products_weekly`
6. âœ… `fact_raw_data_products_monthly`
7. âœ… `fact_raw_data_traffic_daily`
8. âœ… `fact_raw_data_traffic_weekly`
9. âœ… `fact_raw_data_traffic_monthly`
10. âœ… `fact_raw_data_services_daily`
11. âœ… `fact_raw_data_services_weekly`
12. âœ… `fact_raw_data_services_monthly`
13. âœ… `fact_raw_data_inventory_snapshot`

**æ¯ä¸ªè¡¨çš„æ“ä½œ**:
- âœ… åˆ é™¤æ—§å”¯ä¸€çº¦æŸ: `uq_{table_name}_hash`
- âœ… åˆ›å»ºæ–°å”¯ä¸€ç´¢å¼•: `uq_{table_name}_hash_v2`
- âœ… ç´¢å¼•å®šä¹‰åŒ…å« `COALESCE(shop_id, '')` (å¤„ç†NULLå€¼)

## âœ… éªŒè¯ç»“æœ

### éªŒè¯è„šæœ¬æ‰§è¡Œæ—¶é—´

**éªŒè¯è„šæœ¬**: `scripts/verify_migration_v4_14_0.py`  
**æ‰§è¡Œæ—¶é—´**: 2025-12-03 19:15:54  
**çŠ¶æ€**: âœ… æ‰€æœ‰éªŒè¯é€šè¿‡

### éªŒè¯é¡¹ç›®

#### âœ… 1. deduplication_fieldså­—æ®µéªŒè¯
- âœ… å­—æ®µå­˜åœ¨
- âœ… ç±»å‹æ­£ç¡® (JSONB)
- âœ… å¯ç©ºæ€§æ­£ç¡® (YES)

#### âœ… 2. å”¯ä¸€çº¦æŸæ›´æ–°éªŒè¯
- âœ… æ‰€æœ‰13å¼ è¡¨çš„æ–°å”¯ä¸€ç´¢å¼•å·²åˆ›å»º
- âœ… æ‰€æœ‰13å¼ è¡¨çš„ç´¢å¼•å®šä¹‰åŒ…å«COALESCE
- âœ… æ‰€æœ‰13å¼ è¡¨çš„æ—§å”¯ä¸€çº¦æŸå·²åˆ é™¤

#### âœ… 3. åŠ¨æ€åˆ—ç®¡ç†åŠŸèƒ½éªŒè¯
- âœ… åŠ¨æ€åˆ—ç®¡ç†æœåŠ¡æ­£å¸¸
- âœ… è¡¨ `fact_raw_data_orders_daily` ç°æœ‰åˆ—æ•°: 14
- âœ… å‘ç°æµ‹è¯•åˆ—: `æµ‹è¯•åˆ—1`, `æµ‹è¯•åˆ—2`, `order_id`

#### âœ… 4. è¡¨ç»“æ„éªŒè¯
- âœ… æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
- âœ… è¡¨ç»“æ„å®Œæ•´

## ğŸ“Š è¯¦ç»†éªŒè¯ç»“æœ

### å”¯ä¸€ç´¢å¼•è¯¦æƒ…

æ‰€æœ‰13å¼ è¡¨çš„æ–°å”¯ä¸€ç´¢å¼•éƒ½å·²æˆåŠŸåˆ›å»ºï¼Œç´¢å¼•å®šä¹‰å¦‚ä¸‹ï¼š

```sql
CREATE UNIQUE INDEX uq_{table_name}_hash_v2 
ON {table_name} 
(platform_code, COALESCE(shop_id, ''), data_domain, granularity, data_hash)
```

**å…³é”®ç‰¹æ€§**:
- âœ… åŒ…å« `platform_code` (æ”¯æŒå¤šå¹³å°)
- âœ… åŒ…å« `COALESCE(shop_id, '')` (å¤„ç†NULLå€¼)
- âœ… åŒ…å« `data_domain` å’Œ `granularity` (æ•°æ®åˆ†ç±»)
- âœ… åŒ…å« `data_hash` (åŸºäºæ ¸å¿ƒå­—æ®µçš„å»é‡)

### è¡¨ç»“æ„è¯¦æƒ…

**è¡¨**: `fact_raw_data_orders_daily`  
**æ€»åˆ—æ•°**: 14

**ç³»ç»Ÿå­—æ®µ** (11ä¸ª):
- `id`, `platform_code`, `shop_id`, `data_domain`, `granularity`
- `metric_date`, `file_id`, `raw_data`, `header_columns`, `data_hash`
- `ingest_timestamp`

**åŠ¨æ€åˆ—** (3ä¸ª):
- `æµ‹è¯•åˆ—1`, `æµ‹è¯•åˆ—2`, `order_id`

## ğŸ¯ è¿ç§»å½±å“åˆ†æ

### æ•°æ®å®Œæ•´æ€§

- âœ… æ‰€æœ‰è¡¨ç»“æ„å®Œæ•´
- âœ… æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
- âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ
- âœ… çº¦æŸåˆ é™¤æˆåŠŸ

### åŠŸèƒ½å½±å“

- âœ… åŠ¨æ€åˆ—ç®¡ç†åŠŸèƒ½æ­£å¸¸
- âœ… æ ¸å¿ƒå­—æ®µå»é‡åŠŸèƒ½æ­£å¸¸
- âœ… å”¯ä¸€çº¦æŸä¼˜åŒ–å®Œæˆ

### å‘åå…¼å®¹æ€§

- âœ… ä»£ç æ”¯æŒå‘åå…¼å®¹ï¼ˆæ£€æŸ¥æ–°ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼‰
- âœ… å¦‚æœæ–°ç´¢å¼•ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ—§å”¯ä¸€çº¦æŸ
- âœ… è¿ç§»åè‡ªåŠ¨ä½¿ç”¨æ–°ç´¢å¼•

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®æ¸…ç†**: ç”±äºè¡¨ç»“æ„å˜æ›´ï¼ˆåŠ¨æ€åˆ—ï¼‰ï¼Œå»ºè®®æ¸…ç†ç°æœ‰æ•°æ®
   ```bash
   POST /api/data-sync/cleanup-database
   ```

2. **å®é™…æ•°æ®éªŒè¯**: éœ€è¦å®é™…æ•°æ®éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š
   - [ ] å®Œæ•´æ•°æ®åŒæ­¥æµç¨‹ï¼ˆæ–‡ä»¶ â†’ åŠ¨æ€åˆ— â†’ å…¥åº“ï¼‰
   - [ ] Metabase å¯ä»¥çœ‹åˆ°æ‰€æœ‰åˆ—
   - [ ] å”¯ä¸€çº¦æŸå»é‡åŠŸèƒ½ï¼ˆä¸åŒplatform_codeå’Œshop_idçš„æ•°æ®å¯ä»¥å…±å­˜ï¼‰

3. **æ€§èƒ½å½±å“**: æ–°å”¯ä¸€ç´¢å¼•å¯èƒ½å½±å“æ’å…¥æ€§èƒ½ï¼Œéœ€è¦ç›‘æ§

## ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œ

1. **æ¸…ç†ç°æœ‰æ•°æ®** (å¼€å‘é˜¶æ®µ):
   ```bash
   POST /api/data-sync/cleanup-database
   ```

2. **å®é™…æ•°æ®éªŒè¯**:
   - åŒæ­¥ä¸€ä¸ªæ–‡ä»¶ï¼ŒéªŒè¯åŠ¨æ€åˆ—æ˜¯å¦æ­£ç¡®æ·»åŠ 
   - åœ¨Metabaseä¸­æŸ¥çœ‹è¡¨ç»“æ„ï¼Œç¡®è®¤æ‰€æœ‰åˆ—å¯è§
   - æµ‹è¯•æ ¸å¿ƒå­—æ®µå»é‡ï¼ˆåŒæ­¥ç›¸åŒæ ¸å¿ƒå­—æ®µä½†ä¸åŒéæ ¸å¿ƒå­—æ®µçš„æ•°æ®ï¼‰

3. **æ€§èƒ½ç›‘æ§**:
   - ç›‘æ§æ•°æ®æ’å…¥æ€§èƒ½
   - ç›‘æ§å”¯ä¸€ç´¢å¼•ä½¿ç”¨æƒ…å†µ

## âœ… æ€»ç»“

**è¿ç§»çŠ¶æ€**: âœ… å®Œå…¨æˆåŠŸ  
**éªŒè¯çŠ¶æ€**: âœ… æ‰€æœ‰éªŒè¯é€šè¿‡  
**åŠŸèƒ½çŠ¶æ€**: âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸  
**æ•°æ®å®Œæ•´æ€§**: âœ… å®Œæ•´  

**è¿ç§»å®Œæˆæ—¶é—´**: 2025-12-03 19:15:54  
**éªŒè¯å®Œæˆæ—¶é—´**: 2025-12-03 19:15:54  

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-03  
**æŠ¥å‘ŠçŠ¶æ€**: âœ… å®Œæˆ

