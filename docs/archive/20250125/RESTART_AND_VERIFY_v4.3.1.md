# 字段映射系统修复后重启验证指南

**版本**: v4.3.1  
**日期**: 2025-01-24  
**预计时间**: 3分钟

---

## 🚀 重启系统

### 步骤1: 停止当前服务（如果正在运行）

**Windows PowerShell**:
```powershell
# 按 Ctrl+C 停止当前运行的 run.py
# 或者关闭运行窗口
```

### 步骤2: 重新启动系统

```bash
python run.py
```

**预期输出**:
```
✅ 后端服务启动成功: http://localhost:8001
✅ 前端服务启动成功: http://localhost:5173
🌐 自动打开浏览器...
```

---

## ✅ 验证修复效果

### 验证1: 文件扫描功能

**操作**:
1. 访问 http://localhost:5173/#/field-mapping
2. 点击 `🔍 扫描采集文件` 按钮

**期望结果** ✅:
```
✅ 文件扫描完成
   发现408个文件，新注册X个
```

**不应该看到** ❌:
```
❌ 发现undefined个文件，新注册0个  ← 这是Bug状态
```

---

### 验证2: 平台选择功能

**操作**:
1. 点击"选择平台"下拉框

**期望结果** ✅:
```
下拉框选项:
  ✅ shopee
  ✅ tiktok  
  ✅ miaoshou
```

**不应该看到** ❌:
```
❌ unknown  ← 这是Bug状态
```

---

### 验证3: 文件详情显示

**操作**:
1. 选择平台: shopee
2. 选择数据域: products
3. 选择文件: 任意一个文件

**期望结果** ✅:
```
📄 文件详情

文件名: 20250916_143844__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-15_2025-09-15.xlsx

✅ 平台: shopee  ← 从"虾皮"自动识别
✅ 数据域: products
✅ 账号: 虾皮巴西_东朗照明主体
✅ 店铺: the_king_s_lucky_shop
✅ 粒度: daily
✅ 日期范围: 2025-09-15 到 2025-09-15
✅ 文件路径: temp/outputs/shopee/.../20250916_143844...xlsx
```

**不应该看到** ❌:
```
❌ 平台: unknown
❌ 账号: N/A
❌ 店铺: N/A
❌ 文件路径: ❌ 文件未找到
```

---

### 验证4: 数据预览功能

**操作**:
1. 点击 `👁️ 预览数据` 按钮

**期望结果** ✅:
```
📊 数据预览 (共 1000 行，显示前 20 行)

┌────────┬──────────┬──────┬────────┐
│ 商品ID │ 商品名称 │ 销量 │ 价格   │
├────────┼──────────┼──────┼────────┤
│ SKU001 │ 蓝牙耳机 │  100 │  29.99 │
│ SKU002 │ 智能手表 │   80 │ 199.99 │
│ ...    │  ...     │  ... │  ...   │
└────────┴──────────┴──────┴────────┘

✅ 数据预览成功
```

**不应该看到** ❌:
```
❌ timeout of 30000ms exceeded  ← 这是Bug状态
❌ 文件未找到
```

---

### 验证5: 字段映射功能

**操作**:
1. 点击 `🔗 生成字段映射` 按钮

**期望结果** ✅:
```
🎯 智能字段映射

┌────────────┬──────────────┬──────────┬──────────┐
│ 原始字段   │ 标准字段     │ 置信度   │ 匹配方式 │
├────────────┼──────────────┼──────────┼──────────┤
│ 商品ID     │ product_id   │  95% ✓   │ 精确     │
│ 商品名称   │ product_name │  90% ✓   │ 模糊     │
│ 销量       │ sales        │  85% ⚠   │ 关键词   │
│ 价格       │ price        │  90% ✓   │ 精确     │
└────────────┴──────────────┴──────────┴──────────┘

统计: 总字段4个 | 已映射4个 | 映射率100% | 高置信度3个

✅ 字段映射生成成功
```

---

### 验证6: 数据入库功能

**操作**:
1. 点击 `✅ 确认映射并入库` 按钮
2. 在确认对话框点击"确定"

**期望结果** ✅:
```
🔄 数据入库进度

✓ 读取文件
✓ 应用字段映射
✓ 数据验证 (1000行)
  - 有效: 980行
  - 错误: 20行 → 已隔离
✓ 写入数据库
  - fact_product_metrics: 980行
✓ 更新状态

✅ 数据入库成功
```

---

## 📊 验证清单

请逐项确认以下功能：

- [ ] 文件扫描显示真实数据（不是undefined）
- [ ] 平台列表包含shopee/tiktok/miaoshou（不含unknown）
- [ ] 文件列表显示完整（不是空列表）
- [ ] 文件详情显示完整元数据（平台/账号/店铺/粒度/日期）
- [ ] 文件路径显示正确（✅标记，不是❌）
- [ ] 数据预览正常显示（不超时）
- [ ] 字段映射生成正常
- [ ] 数据入库成功

**如果全部✅** → 🎉 修复成功！系统完全正常！

**如果有❌** → 请查看下面的故障排除

---

## 🆘 故障排除

### 问题1: 重启后还是显示unknown

**可能原因**: 浏览器缓存

**解决方法**:
1. 按F12打开开发者工具
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"
4. 或者按 Ctrl+Shift+Delete 清除所有缓存

### 问题2: 扫描后还是0个文件

**可能原因**: 数据库连接问题

**解决方法**:
1. 检查后端日志是否有错误
2. 确认 `data/unified_erp_system.db` 文件存在
3. 尝试手动运行扫描:
   ```bash
   python -c "from modules.services.catalog_scanner import scan_and_register; result = scan_and_register(); print(f'发现{result.seen}个文件')"
   ```

### 问题3: 数据预览还是超时

**可能原因**: 文件路径还是错误

**解决方法**:
1. 检查浏览器控制台的错误信息
2. 检查后端日志
3. 确认temp/outputs目录下有文件
4. 尝试刷新文件信息（点击文件详情的"刷新信息"按钮）

---

## 📞 获取帮助

### 查看日志

**后端日志**:
```bash
# 查看最新日志
tail -f backend/logs/app.log

# Windows用户
Get-Content backend/logs/app.log -Tail 50 -Wait
```

**浏览器控制台**:
1. 按F12打开开发者工具
2. 选择"Console"标签
3. 查看红色错误信息

### 联系支持

如果问题仍然存在，请提供：
1. 后端日志截图
2. 浏览器控制台截图
3. 操作步骤描述
4. 数据库文件位置

---

## 🎯 成功标志

**当您看到以下画面时，说明修复成功**:

```
📄 文件详情

文件名: 20250924_185940__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-23_2025-09-23.xlsx
平台: shopee ✅        数据域: products
账号: 虾皮巴西_东朗照明主体    店铺: the_king_s_lucky_shop
粒度: daily            日期范围: 2025-09-23 到 2025-09-23
文件路径: ✅ temp/outputs/shopee/.../20250924_185940__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-23_2025-09-23.xlsx

[👁️ 预览数据]  表头行: [1]  [🔄 重新预览]

📊 数据预览 (共 1000 行，显示前 20 行)

[数据表格正常显示...]

🎯 智能字段映射

[映射表格正常显示...]
```

**关键标志**:
- ✅ 平台显示"shopee"（不是unknown）
- ✅ 文件路径显示"✅ temp/outputs/..."（不是"❌ 文件未找到"）
- ✅ 数据预览正常显示（不超时）

---

祝验证顺利！🎉

