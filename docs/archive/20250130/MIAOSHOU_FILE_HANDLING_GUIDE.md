# 妙手ERP文件处理指南

**更新日期**: 2025-10-27  
**适用版本**: v2.3+

---

## 问题说明

妙手ERP导出的某些文件存在特殊情况：

1. **扩展名为.xlsx，但实际是OLE格式**
   - 文件头检测为OLE二进制（\xD0\xCF...）
   - xlrd解析报错："Workbook corruption"
   - HTML兜底解析非常慢（11MB文件需要数分钟）

2. **大文件预览卡顿**
   - 文件>10MB时，HTML解析性能极差
   - 前端长时间无响应
   - 后端尝试多种编码导致超时

---

## 已实施的优化

### 1. 大文件保护策略

**文件大小分级处理**:
```
<5MB:   正常处理（openpyxl → xlrd → HTML兜底）
5-10MB: 限制预览50行 + 跳过规范化
>10MB:  xlrd失败后直接报错（不尝试HTML兜底）
```

**代码位置**:
- `backend/services/excel_parser.py:130-136`（大文件跳过HTML）
- `backend/routers/field_mapping.py:611-627`（预览行数限制）

### 2. HTML兜底优化

**减少尝试次数**:
- 编码：4种 → 2种（utf-8, gbk）
- 超时保护：添加文件大小检查

---

## 用户操作建议

### 方案A：转换文件格式（推荐）

**步骤**:
1. 用Excel打开妙手导出的文件
2. 另存为 → 选择"Excel工作簿（*.xlsx）"
3. 保存到`data/raw/2025/`目录
4. 在系统中点击"扫描采集文件"
5. 重新选择转换后的文件

**优点**:
- 彻底解决格式问题
- 预览速度快（1-2秒）
- 合并单元格还原正常工作

### 方案B：跳过预览直接配置（临时）

**步骤**:
1. 基于文件名判断字段结构（例如：miaoshou_products_snapshot包含商品字段）
2. 手动配置字段映射（不依赖预览）
3. 直接入库（系统会验证数据）

**限制**:
- 无法看到实际数据
- 映射可能不准确
- 入库时可能失败

### 方案C：使用小样本文件

**步骤**:
1. 打开大文件，复制前1000行
2. 粘贴到新Excel文件
3. 另存为标准.xlsx格式
4. 在系统中预览小样本文件
5. 生成字段映射
6. 应用映射到大文件

---

## 支持的文件类型

### ✅ 完全支持
- **标准XLSX**（ZIP格式）
  - 文件头：`PK\x03\x04`
  - 引擎：openpyxl
  - 性能：优秀

- **标准XLS**（小文件，<5MB）
  - 文件头：`\xD0\xCF\x11\xE0`
  - 引擎：xlrd 1.2.0
  - 性能：良好

- **HTML格式**（小文件）
  - 文件头：`<html>`或`<?xml>`
  - 引擎：pandas.read_html
  - 性能：一般

### ⚠️ 部分支持
- **损坏的OLE格式**（妙手特殊导出）
  - 特征：扩展名.xlsx但文件头为OLE
  - 处理：小文件尝试HTML兜底，大文件直接拒绝
  - **建议**：转换为标准.xlsx

---

## 故障排查

### 问题1：预览长时间无响应

**症状**:
- 点击"预览数据"后，页面一直loading
- 后端日志显示"尝试HTML兜底解析..."

**原因**:
- 大文件（>5MB）的HTML解析非常慢
- xlrd解析失败后，系统尝试HTML兜底

**解决**:
1. **立即操作**: 刷新页面，取消预览
2. **根本解决**: 用Excel重新导出为标准.xlsx
3. **临时方案**: 使用小样本文件（见方案C）

### 问题2：xlrd报错"Workbook corruption"

**症状**:
- 后端日志显示"xlrd读取失败: CompDocError"
- 文件无法预览

**原因**:
- 文件是损坏的OLE格式或HTML伪装

**解决**:
- 用Excel重新导出为标准.xlsx格式

### 问题3：文件预览成功但数据为空

**症状**:
- 预览显示0行数据
- 或显示乱码

**原因**:
- 文件实际是HTML格式
- 编码检测错误

**解决**:
- 用Excel重新导出

---

## 系统优化进展

### v2.3优化（当前版本）
- ✅ 大文件跳过HTML兜底（>5MB）
- ✅ 预览行数限制（>10MB限制50行）
- ✅ 编码尝试减少（4种→2种）

### v2.4计划（下一版本）
- 🔄 异步预览（后台处理，前端轮询）
- 🔄 预览进度条（实时显示解析进度）
- 🔄 批量文件转换工具
- 🔄 文件格式验证器（采集后立即检查）

---

## 技术支持

**遇到问题**:
1. 查看后端日志：检查详细错误信息
2. 尝试文件转换：用Excel另存为标准格式
3. 使用小样本：复制部分数据测试
4. 联系技术支持：提供文件和日志

**优化建议**:
- 采集时直接保存为.xlsx格式（避免格式问题）
- 定期清理损坏文件
- 监控大文件预览性能

---

**更新时间**: 2025-10-27  
**下一次更新**: v2.4发布时

