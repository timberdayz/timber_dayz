# 西虹ERP系统使用指南 v4.3.2

**版本**: v4.3.2  
**更新日期**: 2025-01-28  
**适用人群**: 业务用户、数据分析师、系统管理员

---

## 快速开始（3步上手）

### Step 1: 初始化数据库

```bash
# 方式A：全新安装（推荐）
python scripts/rebuild_database_v4_3_2.py --confirm

# 方式B：从旧版升级
python scripts/apply_v4_3_2_migration.py
```

### Step 2: 扫描文件

```bash
# 扫描data/raw目录（自动解析店铺）
python -c "from modules.services.catalog_scanner import scan_files; scan_files()"
```

### Step 3: 查看并入库

```bash
# 打开字段映射审核页
# 访问：http://localhost:5173/field-mapping

# 或直接入库
python -c "from modules.services.ingestion_worker import run_once; run_once()"
```

---

## 新功能使用指南

### 功能1：产品层级数据（避免重复计数）

**背景**: Shopee等平台的产品报表包含"商品汇总行+规格明细行"

**使用方法**：
1. 上传文件到`data/raw/2025/`
2. 系统自动识别层级（商品级/规格级）
3. 查询时使用`prefer_scope='auto'`避免重复计数

**查询示例**：
```python
from modules.services.data_query_service import DataQueryService

service = DataQueryService()
df = service.get_product_metrics_unified(
    platforms=['shopee'],
    start_date='2025-01-01',
    end_date='2025-01-31',
    prefer_scope='auto'  # 自动选择商品级，避免重复计数
)
```

**查看层级**：
- 前端：字段映射审核页 → 预览数据 → 查看"商品级/规格级行数"
- 后端：查看`catalog_files.file_metadata.ingest_decision`

---

### 功能2：批量指派店铺

**背景**: 所有文件都缺少店铺归属

**使用方法（前端）**：
1. 字段映射审核页
2. 筛选条件：`status='needs_shop'`
3. 勾选需要指派的文件
4. 下拉选择店铺
5. 点击"批量指派并重试入库"

**使用方法（API）**：
```bash
curl -X POST http://localhost:8001/api/field-mapping/assign-shop \
  -H "Content-Type: application/json" \
  -d '{
    "file_ids": [1, 2, 3],
    "shop_id": "shop_sg_001",
    "auto_retry_ingest": true
  }'
```

**店铺自动解析**：
- 95%+文件可自动解析shop_id
- 失败时标记`needs_shop`，需人工指派

---

### 功能3：智能日期解析

**背景**: 不同平台/粒度使用不同日期格式

**支持格式**：
- Shopee: `23/09/2025` (dd/MM/yyyy)
- TikTok: `09/23/2025` (MM/dd/yyyy)
- ISO: `2025-09-23` (yyyy-MM-dd)
- Excel序列: `44818` (自动识别)
- 区间: `26-08-2025 - 24-09-2025` (Services/agent)

**使用方法**：
- 无需手动操作
- 系统自动抽样判定`dayfirst`偏好
- 统一归一到店铺本地日期

---

### 功能4: Services子类型入库

**背景**: agent（单行区间）与ai_assistant（逐日）排版不同

**使用方法**：
1. 文件命名必须包含子类型：`shopee_services_agent_monthly_xxx.xlsx`
2. 系统自动识别`sub_domain`并分流处理
3. agent：解析日期区间，以`period_end`为锚点
4. ai_assistant：逐日入库

**查看结果**：
```sql
SELECT * FROM fact_product_metrics
WHERE platform_sku IN ('__SERVICES_AGENT__', '__SERVICES_AI__');
```

---

### 功能5：严格入库模式

**背景**: 避免无用数据污染数据库

**原理**：
- 仅入库"已映射且通过校验"的字段
- 未映射字段完全忽略
- 缺少必填字段则阻断入库

**配置字段映射**：
1. 字段映射审核页 → 选择文件
2. 点击"生成字段映射"
3. 确认或调整映射（只改"来源列"，不改"标准字段"）
4. 选择"字段组"（核心/流量/互动/评价/全部）
5. 保存为模板

**查看忽略列**：
- 入库后查看`catalog_files.validation_errors`
- 前端显示"未映射字段清单"

---

### 功能6：质量告警

**背景**: orders与products的GMV可能有差异

**自动监测**：
- 系统自动比对orders聚合 vs products报表
- 差异>5%：写入`quality_reports`
- 差异>10%：红色告警

**手动检查**：
```python
from modules.services.quality_monitor import generate_quality_report
from sqlalchemy import create_engine
import os

url = os.getenv("DATABASE_URL") or "sqlite:///data/unified_erp_system.db"
engine = create_engine(url)

report = generate_quality_report(engine)
print(f"高风险: {report['high_risk']}个")
print(f"中风险: {report['medium_risk']}个")
```

---

## 日常操作指南

### 每日文件处理流程

```bash
# 1. 扫描新文件
python -c "from modules.services.catalog_scanner import scan_files; scan_files()"

# 2. 查看需要指派店铺的文件（前端操作）
# 访问：http://localhost:5173/field-mapping
# 筛选：status='needs_shop'
# 批量指派店铺

# 3. 入库
python -c "from modules.services.ingestion_worker import run_once; run_once(limit=100)"

# 4. 查看质量报告
python -c "from modules.services.quality_monitor import generate_quality_report; from sqlalchemy import create_engine; import os; engine = create_engine(os.getenv('DATABASE_URL') or 'sqlite:///data/unified_erp_system.db'); print(generate_quality_report(engine))"
```

### 数据查询示例

```python
from modules.services.data_query_service import DataQueryService

service = DataQueryService()

# 查询Top商品（商品级，避免重复计数）
top_products = service.get_product_metrics_unified(
    platforms=['shopee', 'tiktok'],
    start_date='2025-01-01',
    end_date='2025-01-31',
    prefer_scope='auto'  # 推荐
)

# 查询规格级明细
variant_details = service.get_product_metrics_unified(
    skus=['PROD003'],
    prefer_scope='variant'  # 显式指定规格级
)

# 查询订单
orders = service.get_orders(
    platforms=['shopee'],
    start_date='2025-01-01',
    end_date='2025-01-31'
)
```

---

## 常见问题

### Q1: 文件预览失败，显示错误？

**A**: v4.3.2已增强错误提示，查看具体错误信息：
- 检查文件格式（建议用Excel重新导出为标准.xlsx）
- 查看"tried_strategies"了解已尝试的解析方法
- 按"next_action"建议操作

### Q2: 缺少店铺归属怎么办？

**A**: 两种方式：
1. 前端批量指派（推荐）：字段映射审核页 → 筛选needs_shop → 批量指派
2. 补充元数据：在文件旁创建`.meta.json`，包含`shop_id`

### Q3: 产品数据会重复计数吗？

**A**: 不会。系统已实现层级感知：
- 查询时使用`prefer_scope='auto'`
- 默认读取商品级（`sku_scope='product'`）
- 需要规格明细时，显式使用`prefer_scope='variant'`

### Q4: 日期格式不统一怎么办？

**A**: 系统自动处理：
- 抽样检测dayfirst偏好
- 支持10+种日期格式
- 统一归一到本地日期+period_end（周/月）

### Q5: 如何查看数据质量？

**A**: 
- 查看`catalog_files.quality_score`（0-100评分）
- 运行质量报告：`python -c "from modules.services.quality_monitor import generate_quality_report; ..."`
- 前端看板（待Agent B实施）

---

## 最佳实践

### 文件命名规范

**推荐格式**：
```
<platform>_<shop_id>_<domain>_<granularity>_<date>.xlsx

示例：
shopee_shop_sg_001_products_daily_20250128.xlsx
tiktok_shop_my_002_orders_monthly_20250128.xlsx
```

**为什么**：
- 自动解析shop_id（置信度0.85+）
- 自动识别平台/数据域/粒度
- 便于归档与查询

### .meta.json最佳实践

**模板**：
```json
{
  "business_metadata": {
    "shop_id": "shop_sg_001",
    "date_from": "2025-01-01",
    "date_to": "2025-01-31",
    "timezone": "Asia/Singapore"
  },
  "data_quality": {
    "quality_score": 95,
    "completeness": 0.98
  }
}
```

**位置**: `<data_file>.meta.json`（与数据文件同目录）

### 字段映射模板管理

**首次配置**：
1. 上传1个样例文件
2. 使用"智能建议"
3. 选择"核心"或"流量"字段组
4. 保存为模板v1.0

**模板优化**：
1. 发现新列需映射
2. 编辑模板（补充同义词）
3. 保存为v1.1（自动递增）
4. 同平台自动沿用

---

## 进阶功能

### 物化视图（PostgreSQL）

**创建**：
```bash
psql -d erp_db -f sql/create_materialized_views.sql
```

**定时刷新**（crontab）：
```bash
*/15 * * * * psql -d erp_db -c "REFRESH MATERIALIZED VIEW CONCURRENTLY mv_top_products;"
```

**查询**：
```sql
SELECT * FROM mv_top_products LIMIT 10;
```

### 数据血缘追溯

**查询某文件导入了哪些记录**：
```sql
SELECT * FROM fact_product_metrics
WHERE source_catalog_id = 123;
```

**反查某记录来自哪个文件**：
```sql
SELECT p.*, c.file_name, c.file_path
FROM fact_product_metrics p
JOIN catalog_files c ON p.source_catalog_id = c.id
WHERE p.platform_sku = 'ABC123';
```

### 跨时区查询

```sql
-- 按UTC日期聚合（跨时区店铺）
SELECT 
    metric_date_utc,
    SUM(sales_amount_rmb) AS total_gmv
FROM fact_product_metrics
WHERE sku_scope = 'product'
  AND metric_date_utc >= '2025-01-01'
GROUP BY metric_date_utc
ORDER BY metric_date_utc;
```

---

## 故障排查

### 问题1：入库失败 missing shop_id

**原因**: 文件无法自动解析shop_id

**解决**：
1. 查看`catalog_files.file_metadata.shop_resolution`
2. 如果`confidence < 0.9`，使用批量指派
3. 或补充`.meta.json`/`shop_aliases.yaml`

### 问题2：日期解析错误

**原因**: 格式复杂或数据损坏

**解决**：
1. 查看后端日志的日期解析决策
2. 确认文件中日期列格式一致
3. 可手动指定dayfirst偏好（待前端UI）

### 问题3：GMV差异告警

**原因**: orders与products数据源不一致

**解决**：
1. 查看`quality_reports`详情
2. 比对来源文件
3. 确认哪个数据源为准（orders优先）
4. 必要时人工调整

---

## 附录

### 相关文档

- [层级报表处理](field_mapping_v2/HIERARCHICAL_DATA_PROCESSING.md)
- [店铺与日期解析](field_mapping_v2/SHOP_AND_DATE_RESOLUTION.md)
- [严格入库模式](field_mapping_v2/STRICT_INGESTION_MODE.md)
- [快速启动](QUICK_START_V4_3_2.md)
- [交付报告](DELIVERY_REPORT_V4_3_2_20250128.md)

### 键盘快捷键（前端待实施）

- `Ctrl+Shift+S`: 扫描新文件
- `Ctrl+Shift+I`: 批量入库
- `Ctrl+Shift+Q`: 查看质量报告

---

**编写**: Cursor AI (Agent A)  
**版本**: v1.0  
**更新**: 2025-01-28

