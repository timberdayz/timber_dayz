# 📊 Analytics数据域说明文档

## 🎯 Analytics数据域的定位

根据代码分析，**analytics数据域主要用于存储流量分析数据**，而不是计算结果。

## 📋 当前实现情况

### 1. **Analytics域的实际用途**

从代码实现来看，`analytics`数据域主要用于：

- **流量表现数据导出**：Shopee/TikTok平台的流量分析页面数据
- **页面访问统计**：浏览量、访客数等基础流量指标
- **转化分析**：转化率等流量转化指标

### 2. **Analytics域的标准字段**

根据`FIELD_DICTIONARY_REFERENCE.md`，analytics域目前只有**4个标准字段**：

| 字段代码 | 中文名称 | 说明 |
|:---|:---|:---|
| `metric_date` | 日期 | ✅ 必填 |
| `conversion_rate` | 转化率 | 流量转化指标 |
| `page_views` | 浏览量 | 页面访问量 |
| `unique_visitors` | 访客数 | 独立访客数 |

### 3. **Analytics与Traffic的关系**

在代码实现中，存在一个**命名不一致**的情况：

- **数据域枚举**：`DataDomain.ANALYTICS`（枚举名称）
- **实际文件目录**：`traffic`（data_type_dir）
- **文件命名**：`shopee_traffic_*.xlsx`（不是analytics）

**说明**：
- `analytics`是数据域的逻辑名称（用于前端展示和API）
- `traffic`是实际的文件目录名（用于文件存储）
- 两者指向同一个数据源：Shopee/TikTok的流量表现页面

### 4. **数据存储位置**

根据代码分析，analytics域的流量数据可能存储在：

- **fact_product_metrics表**：通过`data_domain='analytics'`标识
- **注释说明**：`analytics(流量分析)` - 见`schema.py`第412行

## ❓ 关于计算结果存储

### 当前情况

**Analytics域目前不用于存储计算结果**（如转化率、连带率、店铺分析数据）。

### 计算结果的处理方式

系统中有专门的计算结果处理机制：

1. **物化视图（Materialized Views）**
   - 用于预计算和聚合数据
   - 例如：`mv_product_sales_trend`、`mv_profit_analysis`等
   - 这些视图会实时计算转化率、连带率等指标

2. **计算指标公式表（dim_metric_formulas）**
   - 存储计算指标的SQL表达式
   - 例如：`CTR = clicks / NULLIF(impressions, 0)`
   - 支持动态计算指标

3. **实时计算**
   - 在查询时通过SQL计算
   - 不存储计算结果，而是按需计算

### 为什么Analytics域不存储计算结果？

1. **数据一致性**：计算结果应该基于原始数据实时计算，避免数据不一致
2. **灵活性**：计算公式可能会变化，存储计算结果会导致历史数据不准确
3. **存储效率**：计算结果可以通过SQL计算，不需要额外存储空间

## 💡 建议

### 如果您需要存储计算结果

可以考虑以下方案：

1. **使用物化视图**
   - 创建专门的物化视图存储计算结果
   - 定期刷新视图以更新计算结果
   - 例如：`mv_shop_analytics`、`mv_conversion_analysis`等

2. **扩展Analytics域**
   - 如果确实需要存储计算结果，可以扩展analytics域的标准字段
   - 添加：`attach_rate`（连带率）、`shop_conversion_rate`（店铺转化率）等
   - 但需要明确：这些是**原始计算结果**还是**分析指标**

3. **创建新的分析域**
   - 如果计算结果足够复杂，可以考虑创建新的数据域
   - 例如：`analysis`域（分析结果域）
   - 但需要评估是否有必要（避免过度设计）

## 📝 总结

**Analytics数据域的当前定位**：
- ✅ 用于存储**流量分析数据**（原始数据）
- ✅ 主要用于Shopee/TikTok平台的流量表现页面数据
- ❌ **不用于存储计算结果**（转化率、连带率等）

**计算结果的处理方式**：
- ✅ 通过物化视图实时计算
- ✅ 通过计算指标公式表动态计算
- ✅ 在查询时按需计算

**如果您需要存储计算结果**：
- 💡 建议使用物化视图或创建专门的分析视图
- 💡 或者扩展analytics域的标准字段（如果确实需要）

---

**最后更新**: 2025-11-05  
**版本**: v4.10.0  
**状态**: 📋 说明文档

