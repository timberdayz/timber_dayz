# 西虹ERP系统核心流程图

**版本**: v4.9.3  
**更新时间**: 2025-11-08  
**目的**: 梳理系统核心流程，识别问题点

---

## 📊 目录

1. [系统总体架构流程](#1-系统总体架构流程)
2. [数据采集流程](#2-数据采集流程)
3. [文件扫描与注册流程](#3-文件扫描与注册流程)
4. [字段映射流程](#4-字段映射流程)
5. [自动入库流程](#5-自动入库流程)
6. [批量数据同步流程](#6-批量数据同步流程)
7. [数据入库流程](#7-数据入库流程)
8. [物化视图刷新流程](#8-物化视图刷新流程)
9. [数据治理流程](#9-数据治理流程)
10. [问题识别与修复流程](#10-问题识别与修复流程)

---

## 1. 系统总体架构流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        西虹ERP系统架构                            │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  数据采集层   │      │  数据处理层   │      │  数据展示层   │
│              │      │              │      │              │
│ • Playwright │─────▶│ • 字段映射    │─────▶│ • Vue.js前端  │
│ • 多平台支持  │      │ • 自动入库    │      │ • 数据看板    │
│ • 会话管理    │      │ • 数据清洗    │      │ • 物化视图    │
└──────────────┘      └──────────────┘      └──────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  PostgreSQL数据库 │
                    │  • 86张表        │
                    │  • 16个物化视图  │
                    └──────────────────┘
```

---

## 2. 数据采集流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据采集流程（Playwright）                    │
└─────────────────────────────────────────────────────────────────┘

开始
  │
  ▼
┌─────────────────┐
│ 选择平台和账号   │
│ • Shopee        │
│ • TikTok        │
│ • Amazon        │
│ • 妙手ERP       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 读取账号配置     │
│ • login_url     │
│ • account_name  │
│ • credentials   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 启动浏览器       │
│ • Playwright    │
│ • 反检测配置    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 自动登录         │
│ • 使用login_url │
│ • 会话持久化    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 选择数据域       │
│ • products      │
│ • orders        │
│ • traffic       │
│ • services      │
│ • finance       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 执行采集脚本     │
│ • 组件化脚本    │
│ • 稳定版回放    │
│ • 最新回放      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 下载Excel文件    │
│ • 保存到data/raw│
│ • 生成.meta.json│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 触发文件扫描     │
│ • POST /scan    │
│ • 自动注册文件   │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 3. 文件扫描与注册流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   文件扫描与注册流程                              │
└─────────────────────────────────────────────────────────────────┘

开始（POST /api/field-mapping/scan）
  │
  ▼
┌─────────────────┐
│ 扫描data/raw目录│
│ • 递归扫描      │
│ • 过滤Excel文件 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 解析文件元数据   │
│ • 文件名解析    │
│ • .meta.json读取│
│ • 提取：        │
│   - platform    │
│   - data_domain │
│   - granularity │
│   - shop_id     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查文件是否已注册│
│ • 查询catalog_files│
│ • 使用file_hash │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  已存在    新文件
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ 创建CatalogFile记录│
    │    │ • status='pending'│
    │    │ • 保存元数据      │
    │    └────────┬──────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 触发自动入库     │
    │    │ • 查找模板      │
    │    │ • 自动入库      │
    │    └────────┬──────────┘
    │             │
    └─────────────┘
         │
         ▼
┌─────────────────┐
│ 返回扫描结果     │
│ • 总文件数      │
│ • 新注册数      │
│ • 跳过数        │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 4. 字段映射流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      字段映射流程                                 │
└─────────────────────────────────────────────────────────────────┘

开始（用户选择文件）
  │
  ▼
┌─────────────────┐
│ 读取Excel文件    │
│ • ExcelParser   │
│ • 智能格式检测  │
│ • 合并单元格还原│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 提取原始字段     │
│ • 读取表头行    │
│ • 识别列名      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 查找最佳模板     │
│ • 平台匹配      │
│ • 数据域匹配    │
│ • 粒度匹配      │
│ • 子域匹配      │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  找到模板   未找到模板
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ 显示智能建议     │
    │    │ • AI驱动匹配    │
    │    │ • 置信度显示    │
    │    └────────┬──────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 用户手动映射     │
    │    │ • 选择标准字段  │
    │    │ • 调整映射      │
    │    └────────┬──────────┘
    │             │
    ▼             │
┌─────────────────┐│
│ 应用模板映射     ││
│ • 字段映射      ││
│ • 数据转换      ││
└────────┬────────┘│
         │         │
         └─────────┘
         │
         ▼
┌─────────────────┐
│ 预览映射结果     │
│ • 显示前100行   │
│ • 验证数据质量  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 用户确认         │
│ • 保存模板      │
│ • 直接入库      │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 5. 自动入库流程（单文件）

```
┌─────────────────────────────────────────────────────────────────┐
│                  自动入库流程（单文件）                            │
└─────────────────────────────────────────────────────────────────┘

开始（POST /api/field-mapping/auto-ingest/single）
  │
  ▼
┌─────────────────┐
│ 获取文件信息     │
│ • CatalogFile   │
│ • 检查文件存在   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查文件状态     │
│ • processing → 跳过│
│ • ingested → 跳过│
│ • pending → 继续│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 查找最佳模板     │
│ • TemplateMatcher│
│ • 匹配规则：     │
│   1. 精确匹配   │
│   2. 模式匹配   │
│   3. 模糊匹配   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  找到模板   未找到模板
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ 返回skipped状态  │
    │    │ • 无模板跳过    │
    │    └────────┬──────────┘
    │             │
    │             └─────────┐
    │                       │
    ▼                       │
┌─────────────────┐         │
│ 读取Excel文件    │         │
│ • 使用template  │         │
│   .header_row   │         │
│ • ExcelParser   │         │
└────────┬────────┘         │
         │                  │
         ▼                  │
┌─────────────────┐         │
│ 应用模板映射     │         │
│ • 字段映射      │         │
│ • 数据转换      │         │
└────────┬────────┘         │
         │                  │
         ▼                  │
┌─────────────────┐         │
│ 调用入库API      │         │
│ • POST /ingest  │         │
│ • 传递映射数据  │         │
└────────┬────────┘         │
         │                  │
         └──────────────────┘
         │
         ▼
┌─────────────────┐
│ 更新文件状态     │
│ • success       │
│ • quarantined   │
│ • failed        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 返回结果         │
│ • status        │
│ • message       │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 6. 批量数据同步流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  批量数据同步流程（核心流程）                      │
└─────────────────────────────────────────────────────────────────┘

开始（用户点击"开始同步"）
  │
  ▼
┌─────────────────┐
│ 前端：准备参数   │
│ • platform='*'  │
│ • limit=1000    │
│ • only_with_template=true│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ POST /api/field-mapping/auto-ingest/batch│
│ • 发送同步请求   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 后端：查询待入库文件│
│ • status='pending'│
│ • 平台筛选      │
│ • 数据域筛选    │
│ • 粒度筛选      │
│ • 时间范围筛选  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查文件数量     │
│ • total_files=0?│
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  无文件     有文件
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ 创建进度任务     │
    │    │ • task_id       │
    │    │ • ProgressTracker│
    │    └────────┬──────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 循环处理每个文件  │
    │    │ • ingest_single_file│
    │    │ • 更新进度      │
    │    └────────┬──────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 统计结果         │
    │    │ • succeeded     │
    │    │ • quarantined   │
    │    │ • failed        │
    │    │ • skipped       │
    │    └────────┬──────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 完成任务         │
    │    │ • 更新状态      │
    │    │ • 返回summary   │
    │    └────────┬──────────┘
    │             │
    └─────────────┘
         │
         ▼
┌─────────────────┐
│ 返回响应         │
│ • success       │
│ • task_id       │
│ • summary      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 前端：处理响应   │
│ • 如果有summary │
│   → 直接显示结果 │
│ • 如果有task_id │
│   → 开始轮询进度 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 显示进度对话框   │
│ • 实时更新进度  │
│ • 显示统计信息  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 轮询进度（如果异步）│
│ • GET /progress/{task_id}│
│ • 每2秒轮询一次 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 同步完成         │
│ • 显示最终结果  │
│ • 刷新统计数据  │
│ • 允许关闭对话框│
└────────┬────────┘
         │
         ▼
        结束
```

---

## 7. 数据入库流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据入库流程                                 │
└─────────────────────────────────────────────────────────────────┘

开始（POST /api/field-mapping/ingest）
  │
  ▼
┌─────────────────┐
│ 验证请求参数     │
│ • file_id       │
│ • mappings      │
│ • rows          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 读取完整Excel文件│
│ • ExcelParser   │
│ • 使用header_row│
│ • 不限制行数    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 数据规范化       │
│ • 合并单元格还原│
│ • 填充空值      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 应用字段映射     │
│ • 原始列名 → 标准字段│
│ • 数据转换      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 数据验证         │
│ • 必填字段检查  │
│ • 数据类型验证  │
│ • 业务规则验证  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  验证通过   验证失败
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ 数据隔离         │
    │    │ • 保存到quarantine│
    │    │ • 记录错误信息   │
    │    └────────┬──────────┘
    │             │
    │             └─────────┐
    │                       │
    ▼                       │
┌─────────────────┐         │
│ 根据数据域入库   │         │
│ • products →    │         │
│   FactProductMetric│      │
│ • orders →      │         │
│   FactOrder     │         │
│ • traffic →     │         │
│   FactTraffic   │         │
└────────┬────────┘         │
         │                  │
         └──────────────────┘
         │
         ▼
┌─────────────────┐
│ 更新文件状态     │
│ • success       │
│ • partial_success│
│ • quarantined   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 异步提取图片     │
│ • Celery任务    │
│ • 不阻塞响应    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 返回入库结果     │
│ • status        │
│ • rows_ingested │
│ • message       │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 8. 物化视图刷新流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    物化视图刷新流程                               │
└─────────────────────────────────────────────────────────────────┘

开始（POST /api/mv/refresh-all 或定时任务）
  │
  ▼
┌─────────────────┐
│ 分析依赖关系     │
│ • 确定刷新顺序  │
│ • 避免循环依赖  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 按顺序刷新视图   │
│ • 产品域视图    │
│ • 销售域视图    │
│ • 财务域视图    │
│ • 库存域视图    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 记录刷新历史     │
│ • 开始时间      │
│ • 结束时间      │
│ • 行数变化      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 返回刷新结果     │
│ • 成功/失败     │
│ • 耗时统计      │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 9. 数据治理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      数据治理流程                                 │
└─────────────────────────────────────────────────────────────────┘

开始
  │
  ▼
┌─────────────────┐
│ 统计待入库文件   │
│ • status='pending'│
│ • 按平台分组    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查模板覆盖度   │
│ • 平台+数据域+粒度│
│ • 识别缺失模板  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 生成治理报告     │
│ • 待入库文件数  │
│ • 模板覆盖度    │
│ • 缺失模板列表  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 用户操作         │
│ • 创建缺失模板  │
│ • 触发批量同步  │
│ • 查看隔离数据  │
└────────┬────────┘
         │
         ▼
        结束
```

---

## 10. 问题识别与修复流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  问题识别与修复流程（当前问题）                    │
└─────────────────────────────────────────────────────────────────┘

问题1：批量同步时前端显示失败，但后端仍在处理
  │
  ▼
┌─────────────────┐
│ 问题分析         │
│ • 后端同步处理   │
│ • 返回summary   │
│ • 前端未正确处理 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 修复方案         │
│ • 优先处理summary│
│ • 改进错误处理  │
│ • 确保对话框显示 │
└────────┬────────┘
         │
         ▼
        已修复 ✅

问题2：清理数据库后，待入库文件未重置
  │
  ▼
┌─────────────────┐
│ 问题分析         │
│ • 只重置特定状态 │
│ • 遗漏其他状态  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 修复方案         │
│ • 重置所有非pending│
│ • 使用SAVEPOINT │
│ • 改进错误处理  │
└────────┬────────┘
         │
         ▼
        已修复 ✅

问题3：同步进度对话框无法关闭
  │
  ▼
┌─────────────────┐
│ 问题分析         │
│ • 错误时未标记完成│
│ • 对话框逻辑问题 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 修复方案         │
│ • 错误时标记完成 │
│ • 添加关闭按钮  │
│ • 改进关闭逻辑  │
└────────┬────────┘
         │
         ▼
        已修复 ✅
```

---

## 🔍 关键流程节点说明

### 1. 文件状态流转

```
pending → processing → success/quarantined/failed
   ↑                        │
   └────────────────────────┘
    (清理数据库时重置)
```

### 2. 模板匹配优先级

```
1. 精确匹配（platform + data_domain + granularity + sub_domain）
2. 模式匹配（Pattern-based Mapping）
3. 模糊匹配（降级匹配）
```

### 3. 数据同步触发方式

```
1. 事件驱动：文件扫描后自动触发
2. 手动触发：用户点击"开始同步"
3. 定时任务：APScheduler每15分钟执行
```

### 4. 错误处理策略

```
1. 数据质量问题 → 隔离到data_quarantine
2. 无模板 → 跳过（skipped_no_template）
3. 处理失败 → 标记failed，记录错误信息
4. 并发冲突 → 跳过（文件正在处理中）
```

---

## 📝 流程问题清单

### 当前已知问题

1. ✅ **批量同步前端显示问题** - 已修复
   - 问题：后端同步处理完成，但前端显示失败
   - 原因：前端未正确处理summary响应
   - 修复：优先处理summary，改进错误处理

2. ✅ **清理数据库状态重置问题** - 已修复
   - 问题：清理后待入库文件未重置
   - 原因：只重置特定状态，遗漏其他状态
   - 修复：重置所有非pending状态

3. ✅ **同步进度对话框无法关闭** - 已修复
   - 问题：错误时对话框无法关闭
   - 原因：错误时未标记completed
   - 修复：错误时标记完成，允许关闭

### 潜在问题

1. ⚠️ **大量文件同步性能问题**
   - 当前：同步处理，可能阻塞
   - 建议：改为异步处理，使用Celery

2. ⚠️ **模板匹配准确性**
   - 当前：三级降级匹配
   - 建议：优化匹配算法，提高准确性

3. ⚠️ **数据隔离区管理**
   - 当前：数据隔离后需要手动处理
   - 建议：提供批量修复和重新处理功能

---

## 🎯 流程优化建议

### 1. 批量同步优化

```
当前流程：
同步处理 → 阻塞直到完成 → 返回结果

优化建议：
异步处理 → 立即返回task_id → 后台处理 → 轮询进度
```

### 2. 错误处理优化

```
当前流程：
错误 → 记录日志 → 返回失败

优化建议：
错误 → 分类处理 → 自动重试 → 隔离 → 通知用户
```

### 3. 模板匹配优化

```
当前流程：
查找模板 → 应用模板 → 验证结果

优化建议：
预加载模板 → 缓存匹配结果 → 批量匹配 → 提高性能
```

---

## 📊 流程性能指标

### 关键指标

| 流程 | 当前性能 | 目标性能 | 状态 |
|------|---------|---------|------|
| 文件扫描 | 60秒/1000文件 | 2秒/1000文件 | ✅ 已优化 |
| 模板匹配 | 100ms/文件 | 50ms/文件 | ⚠️ 待优化 |
| 数据入库 | 1秒/100行 | 0.5秒/100行 | ✅ 正常 |
| 批量同步 | 同步处理 | 异步处理 | ⚠️ 待优化 |
| 物化视图刷新 | 30-60秒 | 20-40秒 | ✅ 正常 |

---

## 🔧 流程调试指南

### 1. 调试文件扫描

```bash
# 检查catalog_files状态
python -c "from backend.utils.config import get_settings; from sqlalchemy import create_engine, text; settings=get_settings(); engine=create_engine(settings.DATABASE_URL); conn=engine.connect(); result=conn.execute(text('SELECT status, COUNT(*) FROM catalog_files GROUP BY status')); print(result.fetchall())"
```

### 2. 调试模板匹配

```bash
# 检查模板覆盖度
python scripts/generate_template_checklist.py
```

### 3. 调试数据同步

```bash
# 检查同步进度
# 查看后端日志
# 检查ProgressTracker状态
```

---

## 📚 相关文档

- [字段映射系统指南](docs/FIELD_MAPPING_COMPLETE_SUMMARY_20251105.md)
- [自动入库用户指南](docs/USER_GUIDE_AUTO_INGEST_v4_5_0.md)
- [物化视图管理指南](docs/MATERIALIZED_VIEW_MANAGEMENT_BEST_PRACTICES.md)
- [数据治理指南](docs/DATA_PREPARATION_GUIDE.md)

---

**文档版本**: v1.0  
**最后更新**: 2025-11-08  
**维护者**: AI Agent

