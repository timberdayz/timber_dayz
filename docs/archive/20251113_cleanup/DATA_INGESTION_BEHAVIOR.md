#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
数据重复入库行为说明文档
"""

def safe_print(text):
    """安全打印，避免Windows编码问题"""
    try:
        print(text)
    except UnicodeEncodeError:
        print(text.encode('gbk', errors='ignore').decode('gbk'))

safe_print("="*60)
safe_print("数据重复入库行为说明")
safe_print("="*60)

safe_print("\n[核心机制]")
safe_print("系统使用UPSERT（更新或插入）机制处理重复数据")

safe_print("\n[订单数据（fact_orders表）]")
safe_print("1. 主键：")
safe_print("   - platform_code (平台编码)")
safe_print("   - shop_id (店铺ID)")
safe_print("   - order_id (订单ID)")
safe_print("")
safe_print("2. 重复入库行为：")
safe_print("   - 如果订单已存在（相同的主键）：")
safe_print("     * 更新现有记录的所有非主键字段")
safe_print("     * updated_at字段更新为当前时间")
safe_print("     * 不会创建新记录（不会追加）")
safe_print("   - 如果订单不存在（新的主键组合）：")
safe_print("     * 插入新记录")
safe_print("     * created_at字段设置为当前时间")
safe_print("")
safe_print("3. 示例：")
safe_print("   第一次入库：")
safe_print("     - 订单A（tiktok, shop1, order_001）→ 插入新记录")
safe_print("     - 订单B（tiktok, shop1, order_002）→ 插入新记录")
safe_print("")
safe_print("   第二次入库相同文件：")
safe_print("     - 订单A（tiktok, shop1, order_001）→ 更新现有记录")
safe_print("     - 订单B（tiktok, shop1, order_002）→ 更新现有记录")
safe_print("     - 订单C（tiktok, shop1, order_003）→ 插入新记录（如果文件中有新订单）")

safe_print("\n[产品指标数据（fact_product_metrics表）]")
safe_print("1. 主键：")
safe_print("   - platform_code (平台编码)")
safe_print("   - shop_id (店铺ID)")
safe_print("   - platform_sku (平台SKU)")
safe_print("   - metric_date (指标日期)")
safe_print("   - granularity (粒度：daily/weekly/monthly)")
safe_print("   - sku_scope (SKU范围：product/variant等)")
safe_print("")
safe_print("2. 重复入库行为：")
safe_print("   - 如果记录已存在（相同的主键）：")
safe_print("     * 更新现有记录的所有非主键字段")
safe_print("     * updated_at字段更新为当前时间")
safe_print("   - 如果记录不存在（新的主键组合）：")
safe_print("     * 插入新记录")

safe_print("\n[重要说明]")
safe_print("1. 覆盖 vs 追加：")
safe_print("   - 系统采用覆盖策略（UPSERT），不是追加策略")
safe_print("   - 已存在的记录会被更新，不会创建重复记录")
safe_print("")
safe_print("2. 时间粒度问题：")
safe_print("   - 您提到日周月粒度使用同一套模板")
safe_print("   - 如果文件中的granularity字段不准确，可能导致：")
safe_print("     * 日粒度数据覆盖周粒度数据，或反之")
safe_print("     * 建议检查字段映射中的granularity字段是否正确映射")
safe_print("")
safe_print("3. 数据一致性：")
safe_print("   - 重复入库不会导致数据重复")
safe_print("   - 但会覆盖现有数据（使用最新文件的数据）")
safe_print("   - 如果文件数据有更新，重复入库会反映最新状态")

safe_print("\n[建议]")
safe_print("1. 模板粒度匹配：")
safe_print("   - 检查字段映射模板中的granularity字段")
safe_print("   - 确保日/周/月数据使用不同的模板")
safe_print("   - 或确保granularity字段正确映射到数据域")
safe_print("")
safe_print("2. 重复入库时机：")
safe_print("   - 如果文件数据有更新，可以重复入库更新")
safe_print("   - 如果文件数据未变化，重复入库不会造成问题（只是更新）")
safe_print("   - 如果需要保留历史版本，需要额外的时间戳或版本字段")
safe_print("")
safe_print("3. 数据审计：")
safe_print("   - updated_at字段记录最后更新时间")
safe_print("   - created_at字段记录首次创建时间")
safe_print("   - 可以通过这两个字段区分首次入库和更新")

safe_print("\n" + "="*60)
safe_print("总结")
safe_print("="*60)
safe_print("重复入库行为：覆盖（更新）已存在记录，不会追加重复记录")
safe_print("主键匹配：基于复合主键（platform_code, shop_id, order_id）判断是否已存在")
safe_print("建议：确保granularity字段正确映射，避免日/周/月数据混淆")

