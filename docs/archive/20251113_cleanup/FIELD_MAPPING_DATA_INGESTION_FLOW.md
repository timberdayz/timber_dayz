# 字段映射数据入库流程说明

## 问题回答

### 1. 标准字段包含中文会影响系统吗？

**答案：会有影响，已修复**

**问题原因**：
- 之前的翻译逻辑不完善，导致某些中文字段没有被正确翻译成英文
- 数据库中发现了274个包含中文的`field_code`

**影响**：
- **数据库兼容性**：PostgreSQL虽然支持UTF-8，但使用中文字段代码会导致：
  - 索引性能下降
  - SQL查询和代码可读性降低
  - 跨系统集成困难
- **代码维护**：中文字段代码在Python代码中难以使用，需要频繁转义
- **国际化**：未来扩展多语言支持时会有问题

**已修复**：
- ✅ 修复了翻译逻辑，确保所有`field_code`都是纯英文
- ✅ 修复了数据库中274个包含中文的`field_code`
- ✅ 未来扫描会自动生成纯英文`field_code`

### 2. 字段映射入库后，入库后的字段和标准字段显示的内容一样吗？

**答案：不完全一样，但正确使用了`field_code`**

**数据流程**：

```
原始字段 → 字段映射 → 标准字段(field_code) → 数据库列名 → 入库
```

**详细说明**：

1. **字段映射阶段**：
   - 原始字段（如"日期"）映射到标准字段（`field_code`，如`metric_date`）
   - 前端显示：用户看到的是"数据库列名层（中文）"和"标准字段（英文）"

2. **数据转换阶段**（目前的设计）：
   - 标准字段（`field_code`）直接作为数据库列名使用
   - 在`upsert_orders_v2`中，字典的键应该是数据库列名（英文）
   - 核心字段写入标准列，其他字段写入`attributes` JSONB

3. **当前实现**：
   ```python
   # backend/services/data_importer.py
   # upsert_orders_v2期望rows中的键是数据库列名（英文）
   core = {k: v for k, v in r.items() if k in _FACT_ORDER_CORE_FIELDS}
   ```
   - 要求：`rows`中的键必须是数据库列名（如`order_id`, `platform_code`等）
   - 这些列名应该与`FactOrder`表的列名一致

4. **未来改进**（如果需要）：
   - 可以使用`field_to_column_converter.py`进行转换
   - 但目前`field_code`已经是英文，可以直接使用

**关键点**：
- ✅ **标准字段（`field_code`）是纯英文**：如`metric_date`, `order_id`, `platform_code`
- ✅ **数据库列名也是英文**：与`field_code`一致（或通过映射表转换）
- ✅ **中文只在"数据库列名层"显示**：用于用户验证，不写入数据库
- ✅ **入库后**：数据库中的列名是英文的`field_code`，数据值是正确的

## 数据入库流程（简化版）

```
1. 数据采集
   ↓
2. Excel解析 → 原始字段名（中英文混合）
   ↓
3. 字段映射系统
   ├─ 原始字段 → 数据库列名层（中文，用户选择）
   └─ 数据库列名层 → 标准字段（field_code，英文，直接使用数据库列名）
   ↓
4. 数据入库（field_code直接作为数据库列名使用）
   ├─ 核心字段 → 写入标准列（order_id, platform_code等）
   └─ 其他字段 → 写入attributes JSONB
   ↓
5. 数据查询
   └─ 使用英文列名查询，中文只在显示层使用
```

**关键变化**：
- ✅ **简化流程**：不再需要"标准字段 → 数据库列名"转换步骤
- ✅ **统一命名**：field_code直接使用数据库列名（如`order_time_utc`而不是`order_ts`）
- ✅ **向后兼容**：`field_to_column_converter.py`仅作为向后兼容层，处理旧的field_code

## 总结

✅ **问题1已解决**：所有`field_code`现在都是纯英文，不会影响系统

✅ **问题2流程正确**：
- 标准字段（`field_code`）是英文
- 数据库列名是英文
- 入库后的字段名就是`field_code`（英文）
- 中文只在用户界面显示，不写入数据库

**当前状态**：
- ✅ 所有`field_code`都是纯英文（已修复274个）
- ✅ 翻译逻辑已改进，未来不会产生中文`field_code`
- ✅ 数据入库流程使用英文列名，符合PostgreSQL最佳实践

