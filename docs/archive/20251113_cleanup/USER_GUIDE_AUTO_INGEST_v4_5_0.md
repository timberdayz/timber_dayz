# v4.5.0 自动入库功能用户手册

**版本**: v4.5.0  
**更新时间**: 2025-10-30  
**状态**: ✅ 生产就绪

## 🎯 功能概述

v4.5.0实现了"采集→映射→自动入库"的完整闭环，大幅提升数据处理效率：

### 效率对比

| 场景 | v4.4.1手动模式 | v4.5.0自动模式 | 效率提升 |
|------|---------------|---------------|---------|
| 处理409个文件 | 手动操作409次 | 点击1次 | 99.7% |
| 时间消耗 | 约6-8小时 | 约5-10分钟 | 98% |
| 出错风险 | 每次手动操作 | 自动处理+隔离 | 极低 |

---

## 🚀 快速开始

### 前提条件

1. ✅ 数据已采集完成（在`data/raw/`目录）
2. ✅ 至少为一个域×粒度创建了模板
3. ✅ 后端服务运行中（`python run.py`）
4. ✅ 前端服务运行中（自动启动）

### 三步完成数据入库

#### 步骤1：打开字段映射页面

1. 访问系统首页
2. 点击"数据管理" → "字段映射"
3. 选择平台（如Shopee）

#### 步骤2：查看治理统计

系统自动显示数据治理概览：
- **待入库文件**: 409个
- **模板覆盖度**: 18.2%
- **缺少模板**: 9个域×粒度
- **今日自动入库**: 0

**缺少模板警告**：
```
缺少模板的域×粒度（9个）- 点击创建模板
[services/weekly (40个文件)]  [products/daily (38个文件)]  ...
```

#### 步骤3：一键批量同步

1. 点击"数据同步"按钮
2. 配置同步参数：
   - **同步范围**: 整个平台（推荐）
   - **时间范围**: 全部未入库
   - **处理限制**: 100个文件
   - ✅ 仅处理有模板的文件（推荐）
   - ✅ 允许隔离质量问题数据
3. 点击"开始同步"
4. 实时查看进度
5. 完成后查看汇总统计

---

## 📊 数据治理面板详解

### 4个关键指标

#### 1. 待入库文件
- **定义**: status='pending'的文件数量
- **含义**: 还有多少文件等待入库
- **操作**: 数字越大，说明需要创建更多模板或执行同步

#### 2. 模板覆盖度
- **定义**: 有模板的域×粒度 / 总域×粒度组合
- **含义**: 模板配置的完整性
- **操作**: 
  - ≥80%（绿色）：覆盖良好
  - <80%（橙色）：需要补充模板

#### 3. 缺少模板
- **定义**: 没有模板的域×粒度数量
- **含义**: 有多少个组合还需要创建模板
- **操作**: 点击标签快速切换到该域×粒度

#### 4. 今日自动入库
- **定义**: 今天通过自动入库功能入库的文件数
- **含义**: 监控自动化效果
- **操作**: 数字越大，说明自动化运行良好

### 缺少模板警告

**作用**: 告诉你哪些域×粒度还没有模板，有多少文件等待

**操作**: 
1. 点击警告标签（如`services/weekly (40个文件)`）
2. 系统自动切换到该域×粒度
3. 选择一个文件
4. 预览并创建模板
5. 再次执行批量同步，这40个文件就会被自动处理

---

## 🔄 批量数据同步详解

### 同步范围选项

#### 当前选择
- **范围**: 当前选择的 平台/数据域/粒度
- **适用场景**: 刚为某个域×粒度创建模板，只想处理这个组合的文件
- **示例**: shopee/services/monthly（处理约20-30个文件）

#### 整个数据域
- **范围**: 当前平台的某个数据域的所有粒度
- **适用场景**: 为某个数据域的多个粒度都创建了模板
- **示例**: shopee/services（包括daily/weekly/monthly）

#### 整个平台
- **范围**: 当前平台的所有数据域和粒度
- **适用场景**: 为平台配置了多个模板，想一次性处理所有有模板的文件
- **示例**: shopee（包括所有已配置模板的域×粒度）

### 时间范围选项

#### 最近24小时
- **范围**: 只处理最近24小时采集的文件
- **适用场景**: 日常增量同步，处理新采集的数据
- **性能**: 文件数少，处理快

#### 最近7天
- **范围**: 只处理最近7天采集的文件
- **适用场景**: 周度批量同步，或刚上线模板后的回填
- **性能**: 文件数中等

#### 全部未入库
- **范围**: 所有status='pending'的文件
- **适用场景**: 首次配置模板后的全量回填
- **性能**: 文件数最多，可能耗时较长（建议设置处理限制）

### 处理选项

#### 仅处理有模板的文件（推荐）
- **✅ 勾选**: 跳过无模板的文件，记录在`auto_ingest_skip_reason='no_template'`
- **❌ 不勾选**: 尝试处理所有文件（可能导致大量失败）
- **建议**: 保持勾选，安全优先

#### 允许隔离质量问题数据
- **✅ 勾选**: 验证失败的数据行自动隔离到data_quarantine表
- **❌ 不勾选**: 验证失败导致整个文件入库失败
- **建议**: 保持勾选，部分成功优于完全失败

### 处理限制

- **范围**: 1-1000个文件
- **默认**: 100个
- **建议**: 
  - 首次使用：50个（测试）
  - 日常使用：100个（平衡）
  - 大批量回填：500个（需要时间）

---

## 📈 实时进度监控

### 进度对话框详解

#### 进度条
- **绿色**: 进行中
- **成功**: 全部处理完成
- **异常**: 出现错误

#### 详细统计

| 指标 | 含义 |
|------|------|
| 总文件数 | 本次批量处理的文件总数 |
| 已处理 | 已经处理完成的文件数 |
| 进行中 | 当前正在处理的文件数（通常为1） |
| 成功 | 完全入库成功的文件数 |
| 隔离 | 部分数据隔离（partial_success）的文件数 |
| 失败 | 完全入库失败的文件数 |

#### 跳过文件提示

```
跳过 5 个文件（无模板）
```

这表示有5个文件因为没有模板而被跳过，不影响其他文件处理。

#### 最近处理的文件

显示最近10个已处理的文件：
- **success**（绿色标签）：完全成功
- **quarantined**（橙色标签）：部分数据隔离
- **failed**（红色标签）：入库失败

---

## 🎯 典型使用场景

### 场景1：日常增量同步（每天执行）

1. 选择平台：Shopee
2. 点击"数据同步"
3. 配置：
   - 同步范围：整个平台
   - 时间范围：最近24小时
   - 处理限制：100
4. 点击"开始同步"
5. 等待完成（约2-5分钟）

### 场景2：新模板回填历史数据

1. 刚为`shopee/services/weekly`创建模板
2. 点击"数据同步"
3. 配置：
   - 同步范围：整个数据域（services）
   - 时间范围：全部未入库
   - 处理限制：200
4. 点击"开始同步"
5. 等待完成（约10-15分钟）

### 场景3：首次配置后的全量回填

1. 已为所有主要域×粒度创建模板
2. 点击"数据同步"
3. 配置：
   - 同步范围：整个平台
   - 时间范围：全部未入库
   - 处理限制：500
4. 点击"开始同步"
5. 等待完成（约30-60分钟，取决于文件数）

---

## ⚠️ 注意事项

### 1. 模板配置优先

**必须先创建模板，才能自动入库**

- ❌ 没有模板的域×粒度：文件会被跳过
- ✅ 创建模板后：所有待入库文件自动处理

### 2. 数据质量检查

**自动入库不会绕过数据质量检查**

- ✅ 必填字段验证照常工作
- ✅ 数据类型验证照常工作
- ✅ 问题数据自动隔离到data_quarantine表

### 3. 并发控制

**防止同时处理同一文件**

- 文件处于`processing`状态时，自动入库会跳过
- 手动入库和自动入库不会冲突

### 4. 性能考虑

**建议的处理限制**：

- **小批量测试**: 10-50个文件（验证模板正确性）
- **日常增量**: 100个文件（5-10分钟）
- **大批量回填**: 500个文件（30-60分钟）
- **超大批量**: 分多次执行（避免一次处理过多）

### 5. 错误处理

**如果批量同步出现错误**：

1. 查看进度对话框中的"失败"数量
2. 检查后端PowerShell窗口的错误日志
3. 查看data_quarantine表的隔离数据
4. 修正问题后重新执行同步

---

## 🔧 高级功能

### 1. 缺失模板快速创建

**步骤**：
1. 查看治理面板的"缺少模板警告"
2. 点击某个警告标签（如`products/daily (38个文件)`）
3. 系统自动切换到该域×粒度
4. 选择一个文件
5. 预览并创建模板
6. 保存模板
7. 再次执行批量同步，38个文件自动处理

### 2. 模板覆盖度提升

**目标**: 提升到80%+

**方法**：
1. 查看"缺少模板"数量
2. 按文件数量优先级创建模板（先创建文件数多的）
3. 每创建一个模板，执行一次批量同步验证
4. 刷新治理统计，查看覆盖度变化

### 3. 进度监控技巧

**实时监控**：
- 进度条百分比：整体进度
- 成功数量：入库成功的文件
- 隔离数量：需要关注的文件（部分数据有问题）
- 失败数量：需要检查的文件

**完成后操作**：
1. 如果有隔离数据，检查data_quarantine表
2. 如果有失败文件，查看错误日志
3. 刷新治理统计，确认待入库文件数下降

---

## 🎓 最佳实践

### 1. 首次使用流程

**第一周**：
1. 为每个常用域×粒度创建模板（如services/monthly）
2. 小批量测试（10-20个文件）
3. 验证数据正确性
4. 逐步扩大范围

**第二周**：
1. 批量回填历史数据（100-200个文件/次）
2. 监控模板覆盖度，补充缺失模板
3. 达到80%+覆盖度

### 2. 日常使用流程

**每天上班**：
1. 数据采集完成
2. 打开字段映射页
3. 点击"数据同步"
4. 配置：整个平台 + 最近24小时 + 100个文件
5. 点击"开始同步"
6. 5分钟后查看结果

**每周一次**：
1. 检查治理统计
2. 补充缺失的模板
3. 执行全量回填（7天范围）

### 3. 模板管理建议

**优先级排序**：
1. 高频使用域（如orders/services）
2. 数据量大的域（如products）
3. 业务关键域（如finance）

**版本管理**：
1. 初版模板：测试和验证
2. v2-v3：根据实际情况调整
3. v4+：发布为正式版本（status='published'）

---

## 🔍 故障排查

### 问题1：同步启动失败

**症状**: 点击"开始同步"后显示错误

**排查**：
1. 检查后端状态指示器（页面顶部）
2. 确认后端服务运行中
3. 检查后端PowerShell窗口的错误日志
4. 尝试重启后端：`python run.py`

### 问题2：所有文件被跳过

**症状**: 同步完成，但"跳过X个文件（无模板）"

**原因**: 没有为选择的域×粒度创建模板

**解决**：
1. 查看"缺少模板警告"
2. 点击对应标签切换到该域×粒度
3. 选择文件并创建模板
4. 重新执行同步

### 问题3：大量文件隔离

**症状**: 成功数量少，隔离数量多

**原因**: 数据质量问题（如缺少必填字段）

**解决**：
1. 查看data_quarantine表的隔离数据
2. 分析错误类型和原因
3. 调整模板映射或数据源
4. 重新采集或修正数据

### 问题4：进度一直不动

**症状**: 进度条停在某个百分比不动

**排查**：
1. 等待5-10分钟（大文件处理需要时间）
2. 检查后端日志，看是否有错误
3. 检查数据库连接状态
4. 如果确实卡住，点击"取消"重新同步

---

## 📞 技术支持

### 相关文档

- **开发规范**: `.cursorrules`
- **架构状态**: `docs/FINAL_ARCHITECTURE_STATUS.md`
- **字段映射**: `docs/V4_4_0_FINANCE_DOMAIN_GUIDE.md`
- **API文档**: `http://localhost:8001/api/docs`

### 日志查看

**后端日志**：后端PowerShell窗口  
**前端日志**：浏览器开发者工具控制台  
**数据库日志**：`logs/`目录

### 常见问题

**Q: 自动入库会修改我的原始文件吗？**  
A: 不会。只读取文件，数据入库到PostgreSQL数据库

**Q: 自动入库失败会影响其他文件吗？**  
A: 不会。每个文件独立处理，失败隔离

**Q: 可以手动和自动同时入库吗？**  
A: 可以。状态机防止并发冲突

**Q: 入库后的数据可以修改吗？**  
A: 可以通过数据管理功能修改

**Q: 如何回滚自动入库的数据？**  
A: 查看auto_ingest_last_attempt字段，筛选需要回滚的文件

---

## 🎊 下期功能预告

v4.5.1计划：
- ⚠️ 采集完成自动触发入库（零人工干预）
- ⚠️ 数据看板全局同步按钮（运营视角）
- ⚠️ 定时自动同步配置（每天自动执行）
- ⚠️ 自动入库历史记录页面
- ⚠️ 失败文件重试机制

敬请期待！

