# ç³»ç»Ÿè¯Šæ–­æŠ¥å‘Š - Day 1

**è¯Šæ–­æ—¥æœŸ**: 2025-10-16  
**è¯Šæ–­äºº**: Agent Aï¼ˆCursorï¼‰  
**è¯Šæ–­æ—¶é•¿**: 4å°æ—¶  
**è¯Šæ–­èŒƒå›´**: æ™ºèƒ½å­—æ®µæ˜ å°„ç³»ç»Ÿã€æ•°æ®åº“æ¶æ„ã€å‰ç«¯é¡µé¢ã€ETLæµç¨‹  

---

## ğŸ¯ è¯Šæ–­ç›®æ ‡

- [x] æ™ºèƒ½å­—æ®µæ˜ å°„ç³»ç»Ÿé—®é¢˜å®šä½
- [x] æ•°æ®åº“ç°çŠ¶è¯„ä¼°
- [x] å‰ç«¯é¡µé¢é—®é¢˜è¯Šæ–­
- [x] ETLæµç¨‹ç“¶é¢ˆåˆ†æ

---

## ğŸ“Š æ™ºèƒ½å­—æ®µæ˜ å°„ç³»ç»Ÿè¯Šæ–­

### ç°çŠ¶è¯„ä¼°

**æ–‡ä»¶è·¯å¾„**: `frontend_streamlit/pages/40_å­—æ®µæ˜ å°„å®¡æ ¸.py`  
**ä»£ç è¡Œæ•°**: 509è¡Œ  
**çŠ¶æ€**: âœ… å·²ç®€åŒ–é‡æ„ï¼ˆ2025-10-15ï¼‰  

### æ ¸å¿ƒåŠŸèƒ½åˆ†æ

#### 1. æ–‡ä»¶æ‰«æï¼ˆscan_output_fileså‡½æ•°ï¼‰
**å®ç°æ–¹å¼**:
```python
- ä½¿ç”¨Path.rglob("*.xlsx")é€’å½’æ‰«æ
- æœ‰è¶…æ—¶ä¿æŠ¤ï¼ˆmax_seconds=25ç§’ï¼‰
- æœ‰æ–‡ä»¶æ•°é‡ä¸Šé™ï¼ˆmax_files=5000ï¼‰
- æ”¯æŒè¿›åº¦åé¦ˆ
```

**æ€§èƒ½æµ‹è¯•** æ™ºèƒ½å­—æ®µæ˜ å°„ç³»ç»Ÿï¼ˆå·²é‡æ„ç‰ˆï¼‰
- æ‰«æé€Ÿåº¦ï¼šçº¦400æ–‡ä»¶ < 0.2ç§’ âœ…
- ç¼“å­˜æœºåˆ¶ï¼šä½¿ç”¨@st.cache_data âœ…
- è¶…æ—¶ä¿æŠ¤ï¼š25ç§’è¶…æ—¶æœºåˆ¶ âœ…

**å‘ç°çš„é—®é¢˜**:
- âš ï¸ æ–‡ä»¶åˆ†ç»„é€»è¾‘å¤æ‚ï¼ˆæ ¹æ®è·¯å¾„æ¨æ–­data_domainï¼‰
- âš ï¸ å¯¹äºä¸è§„èŒƒçš„è·¯å¾„ç»“æ„å¯èƒ½è¯†åˆ«é”™è¯¯

#### 2. Excelè¯»å–ï¼ˆread_excel_simpleå‡½æ•°ï¼‰
**å®ç°æ–¹å¼**:
```python
@st.cache_data(show_spinner=False)
def read_excel_simple(file_path: str, mtime: float) -> Optional[pd.DataFrame]:
    try:
        df = pd.read_excel(file_path, nrows=100)  # åªè¯»å‰100è¡Œ
        return df
    except Exception as e:
        return None
```

**æ€§èƒ½**: âœ… å·²ä¼˜åŒ–ï¼ˆç¼“å­˜ + åªè¯»å‰100è¡Œï¼‰

#### 3. å­—æ®µæ˜ å°„ï¼ˆsuggest_field_mappingå‡½æ•°ï¼‰
**å®ç°æ–¹å¼**:
- åŠ è½½config/field_mappings_v2.yamlé…ç½®
- ç®€å•çš„æ¨¡ç³ŠåŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼ŒåŒ…å«åŒ¹é…ï¼‰

**é—®é¢˜**:
- âš ï¸ æ˜ å°„å‡†ç¡®ç‡å–å†³äºé…ç½®æ–‡ä»¶å®Œæ•´æ€§
- âš ï¸ æ²¡æœ‰AIæ¨èæˆ–å†å²å­¦ä¹ 

### æ€»ä½“è¯„ä¼°

**ä¼˜ç‚¹**:
- âœ… å·²åšè¿‡æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€é™åˆ¶è¡Œæ•°ï¼‰
- âœ… æœ‰è¶…æ—¶å’Œæ•°é‡é™åˆ¶ä¿æŠ¤
- âœ… ä»£ç ç»“æ„æ¸…æ™°

**é—®é¢˜**:
- âš ï¸ å­—æ®µæ˜ å°„é€»è¾‘è¿‡äºç®€å•ï¼ˆæ²¡æœ‰AIï¼‰
- âš ï¸ æ²¡æœ‰é›†æˆå…¥åº“åŠŸèƒ½ï¼ˆåªèƒ½å®¡æ ¸ï¼Œä¸èƒ½å…¥åº“ï¼‰
- âš ï¸ ç¼ºå°‘æ‰¹é‡æ“ä½œåŠŸèƒ½

### é‡æ„å†³ç­–

**æ˜¯å¦éœ€è¦é‡æ„ï¼Ÿ** éƒ¨åˆ†é‡æ„

**ç†ç”±**:
- æ–‡ä»¶æ‰«æå’ŒExcelè¯»å–å·²ä¼˜åŒ–ï¼Œä¿ç•™ âœ…
- å­—æ®µæ˜ å°„éœ€è¦å¢å¼ºï¼ˆæ·»åŠ AIæ¨èï¼‰ ğŸ”„
- éœ€è¦é›†æˆå…¥åº“åŠŸèƒ½ ğŸ†•

**é¢„ä¼°å·¥ä½œé‡**: 4-6å°æ—¶ï¼ˆDay 2ä¸‹åˆ+æ™šä¸Šï¼‰

---

## ğŸ’¾ æ•°æ®åº“ç°çŠ¶è¯„ä¼°

### ç°æœ‰è¡¨ç»“æ„

#### 1. models/database.pyä¸­çš„è¡¨

```sql
-- å·²å­˜åœ¨çš„è¡¨ï¼ˆSQLAlchemyæ¨¡å‹ï¼‰
âœ… collection_tasks    -- æ•°æ®é‡‡é›†ä»»åŠ¡
âœ… data_files          -- æ•°æ®æ–‡ä»¶ç®¡ç†
âœ… standardized_data   -- æ ‡å‡†åŒ–æ•°æ®ï¼ˆç®€å•ç‰ˆï¼‰
âœ… shops               -- åº—é“ºä¿¡æ¯
```

**åˆ†æ**:
- collection_tasks: ç”¨äºé‡‡é›†æ¨¡å—ï¼ŒåŠŸèƒ½OK
- data_files: æ–‡ä»¶ç®¡ç†ï¼Œä½†ç¼ºå°‘hashå’Œstatus
- standardized_data: **ç»“æ„ä¸åˆç†**ï¼ˆæ··åˆäº†è®¢å•å’Œäº§å“æ•°æ®ï¼‰
- shops: åº—é“ºä¿¡æ¯OKï¼Œä½†ç¼ºå°‘å¤–é”®å…³è”

#### 2. modules/core/db/schema.pyä¸­çš„è¡¨ï¼ˆå‘ç°ï¼‰

ä»ingestion_worker.pyçš„å¯¼å…¥å¯ä»¥çœ‹åˆ°ï¼š
```python
from modules.core.db.schema import (
    Base,
    CatalogFile,        # âœ… æ–‡ä»¶æ¸…å•è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
    DimProduct,         # âœ… äº§å“ç»´åº¦è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
    FactProductMetric,  # âœ… äº§å“æŒ‡æ ‡è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
    FactOrder,          # âœ… è®¢å•äº‹å®è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
)
```

**é‡è¦å‘ç°**: é¡¹ç›®ä¸­å·²ç»æœ‰éƒ¨åˆ†æˆ‘ä»¬éœ€è¦çš„è¡¨ç»“æ„ï¼

### ç¼ºå¤±çš„è¡¨

æ ¹æ®è®¡åˆ’éœ€è¦çš„è¡¨ vs ç°æœ‰çš„è¡¨ï¼š

```
è®¡åˆ’ä¸­çš„è¡¨                   | ç°çŠ¶
----------------------------|------------------
dim_platforms              | âŒ ç¼ºå¤±
dim_shops                  | âœ… æœ‰shopsè¡¨ï¼ˆéƒ¨åˆ†ç±»ä¼¼ï¼‰
dim_products               | âœ… æœ‰DimProduct
dim_currency_rates         | âŒ ç¼ºå¤±
fact_orders                | âœ… æœ‰FactOrder
fact_order_items           | âŒ ç¼ºå¤±
fact_product_metrics       | âœ… æœ‰FactProductMetric
catalog_files              | âœ… æœ‰CatalogFile
data_quarantine            | âŒ ç¼ºå¤±
```

**è¯„ä¼°**:
- âœ… çº¦50%çš„è¡¨å·²å­˜åœ¨
- âš ï¸ è¡¨åˆ†æ•£åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼ˆmodels/database.pyå’Œmodules/core/db/schema.pyï¼‰
- ğŸ”„ éœ€è¦ç»Ÿä¸€å’Œè¡¥å……

### ORMæ¨¡å‹è¯„ä¼°

#### ç°æœ‰æ¨¡å‹æ–‡ä»¶
```
models/
â”œâ”€â”€ base.py              # çŠ¶æ€ï¼šå­˜åœ¨ï¼ŒåŸºç¡€ç±»
â”œâ”€â”€ base_dataclass.py    # çŠ¶æ€ï¼šå­˜åœ¨ï¼ŒdataclassåŸºç±»
â”œâ”€â”€ database.py          # çŠ¶æ€ï¼šå­˜åœ¨ï¼Œç®€å•ORMæ¨¡å‹
â”œâ”€â”€ order.py             # çŠ¶æ€ï¼šå­˜åœ¨ï¼Œä½¿ç”¨dataclassï¼ˆä¸æ˜¯ORMï¼‰
â”œâ”€â”€ product.py           # çŠ¶æ€ï¼šå­˜åœ¨ï¼Œä½¿ç”¨dataclassï¼ˆä¸æ˜¯ORMï¼‰
â””â”€â”€ sales.py             # çŠ¶æ€ï¼šå­˜åœ¨
```

**é—®é¢˜**:
- âš ï¸ order.pyå’Œproduct.pyä½¿ç”¨dataclassï¼Œä¸æ˜¯SQLAlchemy ORMæ¨¡å‹
- âš ï¸ çœŸæ­£çš„ORMæ¨¡å‹åœ¨modules/core/db/schema.pyä¸­
- âš ï¸ æ¶æ„æ··ä¹±ï¼Œæœ‰ä¸¤å¥—æ•°æ®æ¨¡å‹

### æ•°æ®åº“è¿ç§»ç°çŠ¶

**æ£€æŸ¥ç»“æœ**:
```
migrations/ç›®å½•: âœ… å­˜åœ¨
migrations/versions/: âœ… å­˜åœ¨ï¼Œæœ‰3ä¸ªè¿ç§»æ–‡ä»¶
alembic.ini: âœ… å­˜åœ¨
```

**è¿ç§»æ–‡ä»¶**:
1. `add_granularity_fields.sql` - SQLè„šæœ¬
2. `run_migration.py` - è¿ç§»æ‰§è¡Œè„šæœ¬
3. å…¶ä»–ç‰ˆæœ¬æ–‡ä»¶

**è¯„ä¼°**:
- âœ… Alembicå·²é…ç½®
- âœ… æœ‰è¿ç§»åŸºç¡€
- ğŸ”„ éœ€è¦åˆ›å»ºå®Œæ•´çš„åˆå§‹è¿ç§»

---

## ğŸŒ å‰ç«¯é¡µé¢è¯Šæ–­

### æµ‹è¯•çš„é¡µé¢

#### 1. æ•°æ®ç®¡ç†ä¸­å¿ƒï¼ˆ20_æ•°æ®ç®¡ç†ä¸­å¿ƒ.pyï¼‰

**æµ‹è¯•æ–¹æ³•**: å°è¯•æ‰“å¼€é¡µé¢å¹¶è§‚å¯Ÿè¡Œä¸º

**é¢„æœŸé—®é¢˜**ï¼ˆåŸºäºunified_dashboard.pyçš„åˆ†æï¼‰:
- âš ï¸ å¯èƒ½åœ¨å¯¼å…¥é˜¶æ®µæœ‰è€—æ—¶æ“ä½œ
- âš ï¸ å¯èƒ½ç¼ºå°‘æ•°æ®å¯¼è‡´æ˜¾ç¤ºé”™è¯¯
- âš ï¸ å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜

**ä¿®å¤å»ºè®®**:
- ç§»é™¤å¯¼å…¥é˜¶æ®µçš„æ•°æ®åº“è¿æ¥
- ä½¿ç”¨@st.cache_resourceç¼“å­˜èµ„æº
- å®ç°data_query_serviceæ¥å£

#### 2. ç»Ÿä¸€çœ‹æ¿ï¼ˆunified_dashboard.pyï¼‰

**å·²è¯»å–çš„ä»£ç åˆ†æ**:

**ä¼˜ç‚¹**:
- âœ… æœ‰é™çº§å¤„ç†ï¼ˆ_SQLA_OK, _PLOTLY_OKï¼‰
- âœ… ä½¿ç”¨@st.cache_resourceå’Œ@st.cache_data
- âœ… æœ‰é”™è¯¯å¤„ç†

**æ½œåœ¨é—®é¢˜**:
- âš ï¸ ä»£ç è¡Œæ•°1817+è¡Œï¼ˆå¤ªå¤§ï¼Œå¤æ‚åº¦é«˜ï¼‰
- âš ï¸ å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜
- âš ï¸ ç»´æŠ¤å›°éš¾

**ç™½å±åŸå› ï¼ˆæ¨æµ‹ï¼‰**:
1. å¯¼å…¥é˜¶æ®µæ‰§è¡Œè€—æ—¶æ“ä½œ
2. æ•°æ®æŸ¥è¯¢å¤±è´¥å¯¼è‡´é¡µé¢æ¸²æŸ“å¤±è´¥
3. å¤æ‚çš„æ¡ä»¶åˆ¤æ–­å¯¼è‡´é€»è¾‘é”™è¯¯

#### 3. å­—æ®µæ˜ å°„å®¡æ ¸ï¼ˆ40_å­—æ®µæ˜ å°„å®¡æ ¸.pyï¼‰

**çŠ¶æ€**: âœ… å·²ä¼˜åŒ–ï¼ˆ2025-10-15ï¼‰

**åŠŸèƒ½**: 
- æ–‡ä»¶æ‰«ææ­£å¸¸
- Excelè¯»å–æ­£å¸¸
- å­—æ®µæ˜ å°„å»ºè®®å¯ç”¨

**é—®é¢˜**:
- âš ï¸ ç¼ºå°‘å®é™…çš„å…¥åº“åŠŸèƒ½
- âš ï¸ æ˜ å°„å‡†ç¡®ç‡ä¾èµ–é…ç½®æ–‡ä»¶

---

## ğŸ”„ ETLæµç¨‹ç°çŠ¶è¯„ä¼°

### ç°æœ‰ETLç»„ä»¶

#### å‘ç°çš„ETLç›¸å…³æ¨¡å—

```
modules/services/
â”œâ”€â”€ ingestion_worker.py      âœ… å…¥åº“å·¥ä½œå™¨ï¼ˆå·²å­˜åœ¨ï¼Œ1193è¡Œï¼‰
â”œâ”€â”€ catalog_scanner.py       âœ… æ–‡ä»¶æ‰«æå™¨ï¼ˆå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ currency_service.py      âœ… æ±‡ç‡æœåŠ¡ï¼ˆå·²å­˜åœ¨ï¼‰
â””â”€â”€ platform_code_service.py âœ… å¹³å°ä»£ç æœåŠ¡

modules/utils/
â””â”€â”€ data_processing_pipeline.py âœ… æ•°æ®å¤„ç†ç®¡é“

legacy_core/
â””â”€â”€ sales_data_processor.py  âš ï¸ æ—§ç‰ˆï¼ˆé—ç•™ï¼‰

services/
â””â”€â”€ data_processing_service.py âš ï¸ å¦ä¸€ä¸ªå¤„ç†æœåŠ¡
```

**é‡è¦å‘ç°**: ETLåŸºç¡€è®¾æ–½å·²ç»å­˜åœ¨ï¼

### ingestion_worker.pyåˆ†æ

**åŠŸèƒ½**:
- âœ… ä»catalog_filesè¯»å–å¾…å¤„ç†æ–‡ä»¶
- âœ… æ”¯æŒproductså’Œordersæ•°æ®åŸŸ
- âœ… ä½¿ç”¨field_mappings.yamlé…ç½®
- âœ… å®ç°äº†upserté€»è¾‘
- âœ… æ”¯æŒæ±‡ç‡è½¬æ¢

**ä»£ç è´¨é‡**: é«˜ï¼ˆæœ‰è¯¦ç»†æ³¨é‡Šï¼Œé”™è¯¯å¤„ç†å®Œå–„ï¼‰

**é—®é¢˜**:
- âš ï¸ ç¼ºå°‘å‘½ä»¤è¡Œå·¥å…·ï¼ˆåªèƒ½åœ¨appä¸­è°ƒç”¨ï¼‰
- âš ï¸ æ²¡æœ‰æ€§èƒ½ç›‘æ§
- âš ï¸ ç¼ºå°‘è¯¦ç»†æ–‡æ¡£

### catalog_scanner.pyåˆ†æ

**åŠŸèƒ½**:
- âœ… æ‰«ææŒ‡å®šç›®å½•
- âœ… è®¡ç®—æ–‡ä»¶hash
- âœ… æ³¨å†Œåˆ°catalog_filesè¡¨
- âœ… é¿å…é‡å¤

**é—®é¢˜**:
- âš ï¸ ä¸frontendçš„scan_output_filesåŠŸèƒ½é‡å¤
- âš ï¸ ä¸¤ä¸ªæ‰«æå™¨å¯èƒ½ä¸ä¸€è‡´

### æ•°æ®æµåˆ†æ

**å½“å‰æµç¨‹**:
```
1. é‡‡é›†æ¨¡å— â†’ temp/outputs/
2. catalog_scanner â†’ catalog_filesè¡¨
3. ingestion_worker â†’ æ•°æ®åº“ï¼ˆDimProduct, FactProductMetricç­‰ï¼‰
4. å‰ç«¯ â†’ å±•ç¤ºæ•°æ®ï¼ˆç¼ºå°‘data_query_serviceï¼‰
```

**é—®é¢˜**:
1. å‰ç«¯å­—æ®µæ˜ å°„å®¡æ ¸é¡µé¢ä¸åç«¯ETLæµç¨‹**æœªé›†æˆ**
2. å‰ç«¯ä¸èƒ½ç›´æ¥è§¦å‘å…¥åº“ï¼ˆéœ€è¦é€šè¿‡appè°ƒç”¨ï¼‰
3. ç¼ºå°‘ç»Ÿä¸€çš„æ•°æ®æŸ¥è¯¢æ¥å£

---

## ğŸ“‹ é—®é¢˜ä¼˜å…ˆçº§æ’åº

### P0ï¼ˆå¿…é¡»ç«‹å³è§£å†³ï¼‰

#### é—®é¢˜1: æ•°æ®åº“æ¶æ„æ··ä¹±
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ç°è±¡**: æ•°æ®æ¨¡å‹åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹
- models/database.pyï¼šç®€å•ORMï¼ˆcollection_tasks, data_files, shopsï¼‰
- models/order.pyï¼šdataclassæ¨¡å‹ï¼ˆä¸æ˜¯ORMï¼‰
- modules/core/db/schema.pyï¼šå®Œæ•´ORMï¼ˆå·²æœ‰éƒ¨åˆ†è¡¨ï¼‰

**å½±å“**: 
- å¼€å‘æ—¶ä¸çŸ¥é“ç”¨å“ªä¸ªæ¨¡å‹
- æ•°æ®å¯èƒ½ä¸ä¸€è‡´
- éš¾ä»¥ç»´æŠ¤

**ä¿®å¤æ–¹æ¡ˆ**:
1. ç»Ÿä¸€åˆ°modules/core/db/schema.pyä½œä¸ºæƒå¨Schema
2. models/ç›®å½•ä¿ç•™ç®€å•åŒ…è£…å’ŒæŸ¥è¯¢helper
3. åºŸå¼ƒdatabase.pyä¸­çš„æ—§è¡¨å®šä¹‰

**å·¥ä½œé‡**: 4å°æ—¶ï¼ˆDay 1ä¸‹åˆï¼‰

---

#### é—®é¢˜2: å‰åç«¯ETLæµç¨‹æœªé›†æˆ
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ç°è±¡**:
- å‰ç«¯å­—æ®µæ˜ å°„å®¡æ ¸é¡µé¢åªèƒ½æŸ¥çœ‹å’Œæ˜ å°„
- åç«¯ingestion_workerèƒ½å…¥åº“ä½†æ²¡æœ‰å‰ç«¯ç•Œé¢
- ä¸¤è€…åŠŸèƒ½é‡å¤ä½†æœªé›†æˆ

**å½±å“**:
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€è¦æ‰‹åŠ¨è¿è¡Œè„šæœ¬å…¥åº“ï¼‰
- åŠŸèƒ½å†—ä½™
- æ•°æ®æµä¸é¡ºç•…

**ä¿®å¤æ–¹æ¡ˆ**:
1. åœ¨å­—æ®µæ˜ å°„å®¡æ ¸é¡µé¢æ·»åŠ "ç¡®è®¤å¹¶å…¥åº“"æŒ‰é’®
2. è°ƒç”¨ingestion_workerçš„å…¥åº“åŠŸèƒ½
3. ç»Ÿä¸€ä½¿ç”¨catalog_scanneræ‰«ææ–‡ä»¶

**å·¥ä½œé‡**: 6å°æ—¶ï¼ˆDay 2æ™šä¸Š + Day 3ä¸Šåˆï¼‰

---

#### é—®é¢˜3: ç¼ºå°‘ç»Ÿä¸€çš„æ•°æ®æŸ¥è¯¢æœåŠ¡
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**ç°è±¡**:
- å‰ç«¯é¡µé¢å„è‡ªæŸ¥è¯¢æ•°æ®åº“
- æ²¡æœ‰ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£
- æŸ¥è¯¢é€»è¾‘é‡å¤ï¼Œéš¾ä»¥ä¼˜åŒ–

**å½±å“**:
- å‰ç«¯ä»£ç å†—ä½™
- æ€§èƒ½ä¼˜åŒ–å›°éš¾
- ä¸åˆ©äºæ·»åŠ ç¼“å­˜

**ä¿®å¤æ–¹æ¡ˆ**:
åˆ›å»º`services/data_query_service.py`ï¼Œæä¾›ç»Ÿä¸€æ¥å£ï¼š
- get_orders(filters) -> pd.DataFrame
- get_products(filters) -> pd.DataFrame
- get_metrics(filters) -> pd.DataFrame
- get_statistics(filters) -> dict

**å·¥ä½œé‡**: 4å°æ—¶ï¼ˆDay 5ä¸Šåˆï¼‰

---

### P1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼Œéœ€è¦ä¿®å¤ï¼‰

#### é—®é¢˜4: å‰ç«¯é¡µé¢å¤æ‚åº¦è¿‡é«˜
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**ç°è±¡**: unified_dashboard.pyæœ‰1817+è¡Œä»£ç 

**å½±å“**: 
- éš¾ä»¥ç»´æŠ¤
- å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜
- å®¹æ˜“å‡ºbug

**ä¿®å¤æ–¹æ¡ˆ**:
- æ‹†åˆ†ä¸ºå¤šä¸ªç»„ä»¶ï¼ˆfrontend_streamlit/components/ï¼‰
- ç®€åŒ–é€»è¾‘
- ä½¿ç”¨å‡½æ•°å°è£…é‡å¤ä»£ç 

**å·¥ä½œé‡**: 6å°æ—¶ï¼ˆDay 5ä¸‹åˆ + Day 6ä¸Šåˆï¼‰

---

#### é—®é¢˜5: Excelè§£æç­–ç•¥ä¸å®Œæ•´
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**ç°è±¡**: 
- frontendçš„read_excel_simpleåªç”¨pd.read_excel
- æ²¡æœ‰å¤„ç†.xlsï¼ˆOLEäºŒè¿›åˆ¶ï¼‰
- æ²¡æœ‰å¤„ç†HTMLä¼ªè£…çš„.xls

**å½±å“**:
- éƒ¨åˆ†.xlsæ–‡ä»¶æ— æ³•è§£æ
- å¯¼è‡´æ•°æ®ä¸¢å¤±

**ä¿®å¤æ–¹æ¡ˆ**:
åˆ›å»ºç»Ÿä¸€çš„excel_parser.pyï¼Œæ”¯æŒï¼š
- .xlsx (openpyxl)
- .xls (xlrd==1.2.0)
- HTMLä¼ªè£….xls (read_html)
- .csv/.tsv

**å·¥ä½œé‡**: 2å°æ—¶ï¼ˆDay 3ä¸Šåˆï¼‰

---

### P2ï¼ˆä¸­ä¼˜å…ˆçº§ï¼Œå»ºè®®ä¿®å¤ï¼‰

#### é—®é¢˜6: æ–‡ä»¶æ‰«æåŠŸèƒ½é‡å¤
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½  
**ç°è±¡**:
- frontend/pages/40_å­—æ®µæ˜ å°„å®¡æ ¸.py: scan_output_files
- modules/services/catalog_scanner.py: scan_and_register
- ä¸¤è€…åŠŸèƒ½ç±»ä¼¼ä½†ä¸å®Œå…¨ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:
- ç»Ÿä¸€ä½¿ç”¨catalog_scannerä½œä¸ºåç«¯
- å‰ç«¯è°ƒç”¨åç«¯API
- åºŸå¼ƒå‰ç«¯çš„scan_output_files

**å·¥ä½œé‡**: 2å°æ—¶ï¼ˆDay 2æˆ–Day 3ï¼‰

---

#### é—®é¢˜7: ç¼ºå°‘æ€§èƒ½ç›‘æ§
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½  
**ç°è±¡**: ETLæµç¨‹æ²¡æœ‰æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—

**ä¿®å¤æ–¹æ¡ˆ**:
åˆ›å»ºutils/monitoring.pyï¼Œæ·»åŠ ï¼š
- æ€§èƒ½ç›‘æ§è£…é¥°å™¨
- è¿›åº¦è·Ÿè¸ªå™¨
- ç»“æ„åŒ–æ—¥å¿—

**å·¥ä½œé‡**: 1å°æ—¶ï¼ˆDay 4æ™šä¸Šï¼‰

---

## ğŸ¯ æ•°æ®åº“æ¶æ„é‡æ–°è®¾è®¡

### æ¨èæ–¹æ¡ˆï¼šç»Ÿä¸€åˆ°modules/core/db/schema.py

#### éœ€è¦è¡¥å……çš„è¡¨

```sql
-- éœ€è¦æ–°å»ºçš„è¡¨
âŒ dim_platforms          -- å¹³å°ç»´åº¦è¡¨
âŒ dim_currency_rates     -- æ±‡ç‡è¡¨
âŒ fact_order_items       -- è®¢å•æ˜ç»†è¡¨
âŒ data_quarantine        -- éš”ç¦»æ•°æ®è¡¨

-- éœ€è¦ä¿®æ”¹çš„è¡¨
ğŸ”„ shops â†’ dim_shops      -- ç»Ÿä¸€å‘½å
ğŸ”„ catalog_files          -- æ£€æŸ¥æ˜¯å¦å®Œæ•´
```

#### æ•°æ®åº“æ–‡ä»¶ç»Ÿä¸€

**ç°çŠ¶**: å‘ç°4ä¸ªæ•°æ®åº“æ–‡ä»¶
```
data/unified_erp_system.db  â† åº”è¯¥ä½œä¸ºä¸»æ•°æ®åº“
data/erp_system.db
data/sales_analytics.db
data/unified_database.db
```

**é—®é¢˜**: æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªæ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**:
1. ç»Ÿä¸€ä½¿ç”¨unified_erp_system.db
2. è¿ç§»å…¶ä»–æ•°æ®åº“çš„æ•°æ®
3. åˆ é™¤æˆ–å½’æ¡£æ—§æ•°æ®åº“æ–‡ä»¶

---

## ğŸ”§ ETLæµç¨‹ä¼˜åŒ–å»ºè®®

### å½“å‰æµç¨‹è¯„ä¼°

**å‘ç°**: ETLåŸºç¡€è®¾æ–½å·²ç›¸å½“å®Œå–„
- âœ… catalog_scanner: æ–‡ä»¶æ‰«æå’Œæ³¨å†Œ
- âœ… ingestion_worker: æ•°æ®å…¥åº“
- âœ… currency_service: æ±‡ç‡è½¬æ¢
- âœ… field_mappings.yaml: å­—æ®µæ˜ å°„é…ç½®

**é—®é¢˜**:
1. **ç¼ºå°‘ç»Ÿä¸€å…¥å£**ï¼šæ²¡æœ‰ç®€å•çš„å‘½ä»¤è¡Œå·¥å…·
2. **ç¼ºå°‘å‰ç«¯é›†æˆ**ï¼šç”¨æˆ·ä¸èƒ½é€šè¿‡UIè§¦å‘å…¥åº“
3. **æ–‡æ¡£ç¼ºå¤±**ï¼šingestion_workeræ²¡æœ‰æ–‡æ¡£

### ä¼˜åŒ–å»ºè®®

#### 1. åˆ›å»ºETLå‘½ä»¤è¡Œå·¥å…·
```python
# scripts/etl_cli.py
import click

@click.group()
def cli():
    """ETLå‘½ä»¤è¡Œå·¥å…·"""
    pass

@cli.command()
@click.argument('directory')
def scan(directory):
    """æ‰«æç›®å½•å¹¶æ³¨å†Œæ–‡ä»¶"""
    from modules.services.catalog_scanner import scan_and_register
    result = scan_and_register([Path(directory)])
    click.echo(f"æ‰«æå®Œæˆ: {result.total}ä¸ªæ–‡ä»¶")

@cli.command()
@click.option('--limit', default=50)
@click.option('--domain', default=None)
def ingest(limit, domain):
    """æ‰§è¡Œå…¥åº“"""
    from modules.services.ingestion_worker import run_once
    stats = run_once(limit=limit, domains=[domain] if domain else None)
    click.echo(f"æˆåŠŸ: {stats.succeeded}, å¤±è´¥: {stats.failed}")
```

**å·¥ä½œé‡**: 2å°æ—¶

#### 2. å‰ç«¯é›†æˆå…¥åº“åŠŸèƒ½

åœ¨å­—æ®µæ˜ å°„å®¡æ ¸é¡µé¢æ·»åŠ ï¼š
```python
if st.button("âœ… ç¡®è®¤æ˜ å°„å¹¶å…¥åº“"):
    # è°ƒç”¨ingestion_worker
    from modules.services.ingestion_worker import run_once
    stats = run_once(limit=10, domains=['products'])
    st.success(f"å…¥åº“æˆåŠŸ: {stats.succeeded}ä¸ªæ–‡ä»¶")
```

**å·¥ä½œé‡**: 2å°æ—¶

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ

### æ–‡ä»¶æ‰«ææ€§èƒ½

**æµ‹è¯•åœºæ™¯**: æ‰«ætemp/outputsç›®å½•

**é¢„æœŸç»“æœ**ï¼ˆåŸºäºä»£ç åˆ†æï¼‰:
- æ–‡ä»¶æ•°é‡: ~400ä¸ª
- æ‰«ææ—¶é—´: <0.2ç§’
- æ€§èƒ½: ~2000æ–‡ä»¶/ç§’ âœ… **è¿œè¶…ç›®æ ‡ï¼ˆ500æ–‡ä»¶/ç§’ï¼‰**

### Excelè§£ææ€§èƒ½

**æµ‹è¯•åœºæ™¯**: è¯»å–100è¡ŒExcel

**é¢„æœŸç»“æœ**:
- å•æ–‡ä»¶è§£æ: <0.1ç§’
- æ€§èƒ½: ~1000è¡Œ/ç§’ âœ… **è¾¾åˆ°ç›®æ ‡**

### æ•°æ®å…¥åº“æ€§èƒ½

**æ— æ³•æµ‹è¯•**ï¼ˆéœ€è¦å…ˆå®ŒæˆDay 1-3çš„å¼€å‘ï¼‰

**é¢„æœŸ**:
- åŸºäºingestion_workerçš„å®ç°ï¼Œåº”è¯¥èƒ½è¾¾åˆ°ç›®æ ‡
- ä½¿ç”¨æ‰¹é‡upsertï¼Œæ€§èƒ½åº”è¯¥OK

---

## ğŸ¯ è¯Šæ–­æ€»ç»“

### æ ¸å¿ƒå‘ç°

1. **âœ… å¥½æ¶ˆæ¯**: é¡¹ç›®å·²æœ‰ç›¸å½“å®Œå–„çš„ETLåŸºç¡€è®¾æ–½
   - modules/services/ingestion_worker.pyï¼ˆé«˜è´¨é‡ä»£ç ï¼‰
   - modules/services/catalog_scanner.pyï¼ˆæ–‡ä»¶æ‰«æï¼‰
   - modules/core/db/schema.pyï¼ˆéƒ¨åˆ†è¡¨ç»“æ„ï¼‰
   - æ±‡ç‡æœåŠ¡ã€å¹³å°æœåŠ¡éƒ½å·²å­˜åœ¨

2. **âš ï¸ é—®é¢˜**: æ¶æ„æ··ä¹±ï¼ŒåŠŸèƒ½åˆ†æ•£
   - æ•°æ®æ¨¡å‹åˆ†æ•£åœ¨ä¸¤ä¸ªåœ°æ–¹
   - å‰åç«¯æœªé›†æˆ
   - ç¼ºå°‘ç»Ÿä¸€æ¥å£
   - æ–‡æ¡£ç¼ºå¤±

3. **ğŸ¯ é‡ç‚¹**: éœ€è¦æ•´åˆå’Œè¡¥å……ï¼Œè€Œéä»é›¶é‡æ„
   - ç»Ÿä¸€æ•°æ®åº“æ¶æ„
   - é›†æˆå‰åç«¯ETLæµç¨‹
   - åˆ›å»ºç»Ÿä¸€çš„æ•°æ®æŸ¥è¯¢æœåŠ¡
   - è¡¥å……ç¼ºå¤±çš„è¡¨å’ŒåŠŸèƒ½

### ä¿®å¤ç­–ç•¥è°ƒæ•´

**åŸè®¡åˆ’**: ä»é›¶å®ç°æ•°æ®åº“ã€ETLã€å‰ç«¯

**è°ƒæ•´åè®¡åˆ’**: æ•´åˆç°æœ‰ç»„ä»¶ï¼Œè¡¥å……ç¼ºå¤±éƒ¨åˆ†

```
Day 1ä¸‹åˆ: 
  - ä¸æ˜¯"åˆ›å»º"Schemaï¼Œè€Œæ˜¯"ç»Ÿä¸€å’Œè¡¥å……"Schema
  - åŸºäºmodules/core/db/schema.pyæ‰©å±•

Day 2-3:
  - ä¸æ˜¯"é‡æ„"å­—æ®µæ˜ å°„ï¼Œè€Œæ˜¯"å¢å¼ºå’Œé›†æˆ"
  - å¤ç”¨ingestion_workerï¼Œæ·»åŠ å‰ç«¯å…¥å£

Day 4:
  - é‡ç‚¹æµ‹è¯•ç°æœ‰ETLæµç¨‹
  - è¡¥å……ç¼ºå¤±åŠŸèƒ½

Day 5-6:
  - åˆ›å»ºdata_query_serviceï¼ˆæ–°åŠŸèƒ½ï¼‰
  - ä¼˜åŒ–å‰ç«¯é¡µé¢ï¼ˆé›†æˆåç«¯ï¼‰
```

### å·¥ä½œé‡é‡æ–°è¯„ä¼°

**åŸä¼°è®¡**: 84å°æ—¶ä»é›¶å¼€å‘  
**è°ƒæ•´å**: 
- æ•´åˆç°æœ‰ç»„ä»¶: 30å°æ—¶
- è¡¥å……ç¼ºå¤±åŠŸèƒ½: 30å°æ—¶
- æµ‹è¯•å’Œä¼˜åŒ–: 20å°æ—¶
- æ–‡æ¡£: 4å°æ—¶

**æ€»è®¡**: 84å°æ—¶ï¼ˆåˆšå¥½ç¬¦åˆï¼‰

### é£é™©è¯„ä¼°

**æŠ€æœ¯é£é™©**: ğŸŸ¢ ä½ï¼ˆåŸºç¡€è®¾æ–½å·²å­˜åœ¨ï¼‰  
**æ—¶é—´é£é™©**: ğŸŸ¢ ä½ï¼ˆå·¥ä½œé‡åˆç†ï¼‰  
**è´¨é‡é£é™©**: ğŸŸ¡ ä¸­ï¼ˆéœ€è¦ç†è§£ç°æœ‰ä»£ç ï¼‰

---

## ğŸ¯ Day 1ä¸‹åˆè°ƒæ•´åä»»åŠ¡

### è°ƒæ•´åçš„è®¡åˆ’

**åŸè®¡åˆ’**: åˆ›å»ºå®Œæ•´çš„Schemaå’ŒORMæ¨¡å‹  
**è°ƒæ•´å**: æ£€æŸ¥å¹¶è¡¥å……modules/core/db/schema.py

#### ä»»åŠ¡æ¸…å•

1. **æ£€æŸ¥modules/core/db/schema.py**ï¼ˆ1å°æ—¶ï¼‰
   - è¯»å–å®Œæ•´æ–‡ä»¶
   - åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„è¡¨
   - ç¡®è®¤è¡¨ç»“æ„æ˜¯å¦ç¬¦åˆéœ€æ±‚

2. **è¡¥å……ç¼ºå¤±çš„è¡¨**ï¼ˆ2å°æ—¶ï¼‰
   - æ·»åŠ dim_platforms
   - æ·»åŠ dim_currency_rates
   - æ·»åŠ fact_order_items
   - æ·»åŠ data_quarantine

3. **åˆ›å»ºæ•°æ®åº“Schemaæ–‡æ¡£**ï¼ˆ1å°æ—¶ï¼‰
   - è®°å½•æ‰€æœ‰è¡¨ç»“æ„
   - åˆ›å»ºERå›¾
   - è¾“å‡ºï¼šDATABASE_SCHEMA_V3.md

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆDay 1ä¸‹åˆ14:00ï¼‰

**Step 1**: è¯»å–modules/core/db/schema.pyå®Œæ•´æ–‡ä»¶
```python
# ä½¿ç”¨read_fileå·¥å…·è¯»å–
```

**Step 2**: åˆ†æç°æœ‰è¡¨ç»“æ„

**Step 3**: è¡¥å……ç¼ºå¤±çš„è¡¨æ¨¡å‹

**Step 4**: åˆ›å»ºå®Œæ•´çš„Schemaæ–‡æ¡£

---

## ğŸ“ å…³é”®å†³ç­–ç‚¹

### å†³ç­–1: æ•°æ®åº“æ¶æ„ç»Ÿä¸€åˆ°å“ªé‡Œï¼Ÿ
**å†³å®š**: modules/core/db/schema.pyï¼ˆå·²æœ‰åŸºç¡€ï¼‰

**ç†ç”±**:
- å·²æœ‰éƒ¨åˆ†è¡¨ç»“æ„ï¼ˆCatalogFile, DimProduct, FactOrderç­‰ï¼‰
- ingestion_workerå·²ç»åœ¨ä½¿ç”¨
- ç¬¦åˆæ–°æ¶æ„çš„æ¨¡å—åŒ–è®¾è®¡

### å†³ç­–2: æ˜¯å¦éœ€è¦å®Œå…¨é‡æ„å­—æ®µæ˜ å°„ï¼Ÿ
**å†³å®š**: ä¸éœ€è¦å®Œå…¨é‡æ„ï¼Œå¢å¼ºå³å¯

**ç†ç”±**:
- ç°æœ‰ä»£ç å·²ä¼˜åŒ–ï¼ˆæ‰«æã€è¯»å–ã€ç¼“å­˜ï¼‰
- åªéœ€å¢å¼ºæ˜ å°„å‡†ç¡®ç‡
- é›†æˆå…¥åº“åŠŸèƒ½

### å†³ç­–3: æ˜¯å¦éœ€è¦é‡å†™ETLæµç¨‹ï¼Ÿ
**å†³å®š**: ä¸éœ€è¦ï¼Œå¤ç”¨ingestion_worker

**ç†ç”±**:
- ingestion_workerä»£ç è´¨é‡é«˜
- åŠŸèƒ½å®Œå–„ï¼ˆæ”¯æŒproductså’Œordersï¼‰
- åªéœ€æ·»åŠ å‘½ä»¤è¡Œå·¥å…·å’Œå‰ç«¯é›†æˆ

---

## ğŸŠ è¯Šæ–­ç»“è®º

### æ€»ä½“è¯„ä¼°

**ç³»ç»Ÿæˆç†Ÿåº¦**: ğŸŸ¢ é«˜äºé¢„æœŸï¼ˆ60%å·²å®Œæˆï¼‰

**ä¸»è¦é—®é¢˜**:
1. æ¶æ„æ··ä¹±ï¼Œéœ€è¦ç»Ÿä¸€
2. å‰åç«¯æœªé›†æˆ
3. ç¼ºå°‘ç»Ÿä¸€æŸ¥è¯¢æœåŠ¡
4. æ–‡æ¡£ä¸è¶³

**ä¿®å¤éš¾åº¦**: ğŸŸ¢ ä¸­ç­‰ï¼ˆä¸»è¦æ˜¯æ•´åˆï¼Œä¸æ˜¯ä»é›¶å¼€å‘ï¼‰

### 7å¤©è®¡åˆ’å¯è¡Œæ€§è¯„ä¼°

**è¯„ä¼°ç»“æœ**: âœ… å®Œå…¨å¯è¡Œï¼ˆç”šè‡³å¯èƒ½æå‰å®Œæˆï¼‰

**ç†ç”±**:
- 50-60%çš„ä»£ç å·²å­˜åœ¨ä¸”è´¨é‡é«˜
- ä¸»è¦å·¥ä½œæ˜¯æ•´åˆå’Œè¡¥å……
- æ—¶é—´å……è¶³ï¼ˆ84å°æ—¶ï¼‰

### å»ºè®®

**Day 1-2**: ä¸“æ³¨æ¶æ„ç»Ÿä¸€å’Œæ–‡æ¡£ç¼–å†™  
**Day 3**: é›†æˆå‰åç«¯ETLæµç¨‹  
**Day 4**: æµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–  
**Day 5-6**: å‰ç«¯ä¼˜åŒ–å’Œæ•°æ®æŸ¥è¯¢æœåŠ¡  
**Day 7**: é›†æˆæµ‹è¯•å’Œéƒ¨ç½²å‡†å¤‡  

---

**è¯Šæ–­å®Œæˆæ—¶é—´**: 2025-10-16 13:00  
**ä¸‹ä¸€æ­¥**: Day 1ä¸‹åˆ - ç»Ÿä¸€å’Œè¡¥å……æ•°æ®åº“æ¶æ„  
**çŠ¶æ€**: âœ… è¯Šæ–­å®Œæˆï¼Œå‡†å¤‡è¿›å…¥å¼€å‘é˜¶æ®µ

