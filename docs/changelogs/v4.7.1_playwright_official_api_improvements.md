# v4.7.1 æ”¹è¿›æ—¥å¿— - Playwright å®˜æ–¹ API ä¼˜åŒ–

**å‘å¸ƒæ—¥æœŸ**: 2025-12-21  
**æ”¹è¿›ç±»å‹**: æŠ€æœ¯å€ºåŠ¡æ¸…ç† + å¼€å‘ä½“éªŒä¼˜åŒ–

---

## ğŸ¯ æ”¹è¿›ç›®æ ‡

æ ¹æ®ç”¨æˆ·åé¦ˆå’Œ **Playwright å®˜æ–¹æœ€ä½³å®è·µ**ï¼Œä¼˜åŒ–æ•°æ®é‡‡é›†æ¨¡å—çš„å½•åˆ¶å’Œæµ‹è¯•å·¥å…·ï¼š

1. âŒ **é—®é¢˜1**: å½•åˆ¶å·¥å…·ç”Ÿæˆ `TODO: å¡«å†™...` å ä½ç¬¦ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ï¼Œæ•ˆç‡ä½
2. âŒ **é—®é¢˜2**: å¯¼èˆªæ­¥éª¤éœ€è¦æ‰‹åŠ¨æ·»åŠ ç­‰å¾…é€»è¾‘
3. âŒ **é—®é¢˜3**: å­˜åœ¨é‡å¤çš„ `login.yaml` æ–‡ä»¶ï¼ˆåŒç»´æŠ¤é£é™©ï¼‰
4. âŒ **é—®é¢˜4**: æµ‹è¯•å·¥å…·éªŒè¯ä¸å¤Ÿä¸¥æ ¼ï¼Œæœªæ£€æµ‹å ä½ç¬¦

---

## âœ… æ”¹è¿›å†…å®¹

### 1. æ¸…ç†é‡å¤æ–‡ä»¶

**ä¿®æ”¹æ–‡ä»¶**:
- åˆ é™¤ `config/collection_components/miaoshou/login.yaml`ï¼ˆæ—§æ¨¡æ¿ï¼‰
- ä¿ç•™ `config/collection_components/miaoshou/miaoshou_login.yaml`ï¼ˆå®é™…å½•åˆ¶ï¼ŒåŒ…å«å®Œæ•´æ­¥éª¤ï¼‰
- ä¿®æ­£ name å­—æ®µï¼š`miaoshou_miaoshou_login` â†’ `miaoshou_login`

**åŸå› **: é¿å…åŒç»´æŠ¤é£é™©ï¼Œç»Ÿä¸€ä½¿ç”¨å®é™…å½•åˆ¶çš„ç»„ä»¶é…ç½®ã€‚

---

### 2. å½•åˆ¶å·¥å…·æ”¹è¿› - `tools/record_component.py`

#### 2.1 `_extract_steps()` - è‡ªåŠ¨æ·»åŠ å®˜æ–¹ç­‰å¾… â­â­â­

**æ”¹è¿›å‰**:
```python
# æ¨¡æ¿æ­¥éª¤åŒ…å« TODO å ä½ç¬¦
{
    'action': 'wait',
    'type': 'selector',
    'selector': 'TODO: å¡«å†™ç­‰å¾…çš„é€‰æ‹©å™¨',  # âŒ éœ€è¦æ‰‹åŠ¨ä¿®æ”¹
    'optional': True
}
```

**æ”¹è¿›å**:
```python
# âœ… éµå¾ª Playwright å®˜æ–¹æœ€ä½³å®è·µ
# 1. navigate æ­¥éª¤è‡ªåŠ¨ä½¿ç”¨ wait_until='domcontentloaded'
# 2. è‡ªåŠ¨æ·»åŠ  networkidle ç­‰å¾…ï¼ˆSPA åº”ç”¨æ¨èï¼‰
# 3. ä¸ç”Ÿæˆ TODO å ä½ç¬¦

if action in ['navigate', 'goto']:
    if 'wait_until' not in current_action:
        current_action['wait_until'] = 'domcontentloaded'  # å®˜æ–¹é»˜è®¤
    
    enhanced_steps.append(current_action)
    
    # è‡ªåŠ¨æ·»åŠ  networkidle ç­‰å¾…
    if not next_is_wait:
        enhanced_steps.append({
            'action': 'wait',
            'type': 'navigation',
            'wait_until': 'networkidle',
            'timeout': 30000,
            'comment': 'Auto-added: Wait for network idle (Playwright best practice for SPA)'
        })
```

**å®˜æ–¹æ–‡æ¡£å‚è€ƒ**:
- `page.goto(url, wait_until='domcontentloaded')` - ç­‰å¾… DOM åŠ è½½å®Œæˆ
- `page.wait_for_load_state('networkidle')` - ç­‰å¾…ç½‘ç»œç©ºé—²ï¼ˆSPA æ¨èï¼‰

---

#### 2.2 `_generate_success_criteria()` - ç§»é™¤ TODO å ä½ç¬¦ â­â­â­

**æ”¹è¿›å‰**:
```python
elif component_type == 'navigation':
    return [
        {
            'type': 'url_contains',
            'value': 'TODO: å¡«å†™ç›®æ ‡é¡µé¢URLç‰¹å¾',  # âŒ ç¡¬ç¼–ç  TODO
            'comment': 'å¯¼èˆªåˆ°ç›®æ ‡é¡µé¢'
        }
    ]
```

**æ”¹è¿›å**:
```python
elif component_type == 'navigation':
    # â­ å°è¯•ä»å½•åˆ¶ä¸­è‡ªåŠ¨æå– URL
    target_url_pattern = self._extract_target_url_from_actions()
    
    if target_url_pattern:
        return [
            {
                'type': 'url_contains',
                'value': target_url_pattern,  # âœ… è‡ªåŠ¨æå–
                'comment': 'Auto-extracted from recorded navigation'
            }
        ]
    else:
        # âœ… æ— æ³•æå–æ—¶è¿”å›ç©ºæ•°ç»„ï¼ˆè€Œä¸æ˜¯ TODOï¼‰
        logger.info("No target URL detected. Please add success_criteria manually.")
        return []
```

**å…³é”®æ”¹è¿›**:
- âœ… è‡ªåŠ¨ä»å½•åˆ¶ä¸­æå–å®é™… URL æ¨¡å¼
- âœ… æ— æ³•æå–æ—¶è¿”å›ç©ºæ•°ç»„ï¼Œç”±æµ‹è¯•å·¥å…·æç¤ºç”¨æˆ·
- âœ… ä½¿ç”¨å®˜æ–¹æ¨èçš„ `role=navigation` selector

---

#### 2.3 `_extract_target_url_from_actions()` - æ–°å¢è¾…åŠ©æ–¹æ³• â­

**åŠŸèƒ½**: ä»å½•åˆ¶çš„æ“ä½œä¸­æ™ºèƒ½æå–ç›®æ ‡ URL ç‰¹å¾

```python
def _extract_target_url_from_actions(self) -> Optional[str]:
    """
    ä»å½•åˆ¶çš„æ“ä½œä¸­æå–ç›®æ ‡ URL ç‰¹å¾
    
    ç¤ºä¾‹:
        è¾“å…¥: https://erp.example.com/orders/list?date=2024
        è¾“å‡º: /orders
    """
    if not self.recorded_actions:
        return None
    
    # æŸ¥æ‰¾æœ€åä¸€ä¸ª navigate åŠ¨ä½œ
    for action in reversed(self.recorded_actions):
        if action.get('action') in ['navigate', 'goto']:
            url = action.get('url', '')
            
            try:
                from urllib.parse import urlparse
                parsed = urlparse(url)
                path = parsed.path
                
                # æå–ç¬¬ä¸€ä¸ªæœ‰æ„ä¹‰çš„è·¯å¾„æ®µ
                if path and len(path) > 1:
                    parts = [p for p in path.split('/') if p]
                    if parts:
                        return '/' + parts[0]  # /orders/list â†’ /orders
            except Exception:
                pass
    
    return None
```

---

### 3. æµ‹è¯• API æ”¹è¿› - `backend/routers/component_recorder.py`

**æ”¹è¿›**: ä¸´æ—¶æµ‹è¯•ç»„ä»¶çš„ `success_criteria` ä¸ä½¿ç”¨ç¡¬ç¼–ç å ä½ç¬¦

```python
# æ”¹è¿›å‰
'success_criteria': [
    {
        'type': 'url_contains',
        'value': 'placeholder',  # âŒ ç¡¬ç¼–ç 
        'optional': True
    }
]

# æ”¹è¿›å
'success_criteria': [
    {
        'type': 'url_contains',
        'value': '',  # âœ… ç©ºå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºéœ€è¦å¡«å†™
        'optional': True,  # æ ‡è®°ä¸ºå¯é€‰ï¼Œé¿å…æµ‹è¯•å¤±è´¥
        'comment': 'ä¸´æ—¶æµ‹è¯•ï¼šå»ºè®®ä¿å­˜åè¡¥å……éªŒè¯æ¡ä»¶ï¼ˆä½¿ç”¨ Playwright Inspector æå–ï¼‰'
    }
]
```

---

### 4. æµ‹è¯•å·¥å…·å¢å¼º - `tools/test_component.py`

**æ”¹è¿›**: `_validate_component_structure()` å¢å¼ºéªŒè¯é€»è¾‘ â­â­â­

**æ–°å¢éªŒè¯**:

1. **æ£€æŸ¥ success_criteria æ˜¯å¦ä¸ºç©º**
```python
if not success_criteria:
    logger.warning("No success_criteria defined. Test will only check if steps complete without errors.")
    logger.info("Tip: Add success_criteria to verify the component achieved its goal")
```

2. **æ£€æŸ¥ TODO å ä½ç¬¦**
```python
if 'TODO' in str(value).upper():
    if criterion.get('optional', False):
        logger.warning(f"Contains TODO placeholder (optional, will be skipped)")
    else:
        logger.error(f"Contains TODO placeholder but is not marked as optional")
        logger.info(f"Fix: Either fill in the actual value OR set 'optional: true'")
        return False
```

3. **æ£€æŸ¥ç©ºå€¼**
```python
if not value and criterion_type in ['url_contains', 'element_exists', 'element_visible']:
    if not criterion.get('optional', False):
        logger.warning(f"'{criterion_type}' has empty value (not optional, may cause test to fail)")
        logger.info(f"Tip: Use Playwright Inspector to find the right selector or URL pattern")
```

4. **æ¨èä½¿ç”¨å®˜æ–¹ role-based selector** â­
```python
if selector and not any(prefix in selector for prefix in ['role=', 'text=', 'label=', 'placeholder=']):
    logger.info(f"Tip: Consider using Playwright's role-based selectors:")
    logger.info(f"     role=button[name='Login']  (recommended)")
    logger.info(f"     text='Welcome'")
    logger.info(f"     label='Email'")
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆ`temp/test_improvements.py`ï¼‰

âœ… **æµ‹è¯•1**: æ¨¡æ¿æ­¥éª¤ä¸åŒ…å« TODO å ä½ç¬¦ - **PASS**  
âœ… **æµ‹è¯•2**: å¯¼èˆªæ­¥éª¤è‡ªåŠ¨æ·»åŠ  networkidle ç­‰å¾… - **PASS**  
âœ… **æµ‹è¯•3**: success_criteria ä¸åŒ…å« TODO - **PASS**  
âœ… **æµ‹è¯•4**: URL è‡ªåŠ¨æå– `/orders` - **PASS**

**é€šè¿‡ç‡**: 4/4 (100%)

### æ¶æ„åˆè§„æ€§éªŒè¯

```bash
python scripts/verify_architecture_ssot.py
```
âœ… **SSOT åˆè§„ç‡**: 100%

```bash
python scripts/verify_contract_first.py
```
âœ… **Contract-First éªŒè¯**: é€šè¿‡ï¼ˆæ— å¤±è´¥æµ‹è¯•ï¼‰

---

## ğŸ“ Playwright å®˜æ–¹ API æœ€ä½³å®è·µæ€»ç»“

### 1. å¯¼èˆªå’Œç­‰å¾…

```python
# â­ å®˜æ–¹æ¨èï¼špage.goto() å·²å†…ç½®ç­‰å¾…
await page.goto(url, wait_until='domcontentloaded')  # åŸºç¡€ç­‰å¾…
await page.wait_for_load_state('networkidle')        # ç½‘ç»œç©ºé—²ï¼ˆSPAæ¨èï¼‰

# âŒ ä¸æ¨èï¼šæ˜¾å¼ wait_for_selectorï¼ˆæ—§APIï¼‰
await page.wait_for_selector(selector)  # å¯ç”¨ locator æ›¿ä»£
```

### 2. å…ƒç´ å®šä½

```python
# â­ å®˜æ–¹æ¨èï¼šä½¿ç”¨ Locator APIï¼ˆè‡ªå¸¦è‡ªåŠ¨ç­‰å¾…ï¼‰
await page.locator(selector).click()
await page.get_by_role("button", name="ç™»å½•").click()  # æœ€ä½³æ–¹å¼
await page.get_by_text("æ¬¢è¿").is_visible()

# âŒ ä¸æ¨èï¼šæ‰‹åŠ¨ç­‰å¾…å…ƒç´ 
await page.wait_for_selector(selector)
element = await page.query_selector(selector)
await element.click()
```

### 3. é€‰æ‹©å™¨ä¼˜å…ˆçº§

1. â­â­â­ `role=button[name='Login']` - å®˜æ–¹æ¨èï¼ˆå¯è®¿é—®æ€§å‹å¥½ï¼‰
2. â­â­ `text='Welcome'` - æ–‡æœ¬å®šä½ï¼ˆç¨³å®šï¼‰
3. â­â­ `label='Email'` - è¡¨å•å…ƒç´ ï¼ˆè¯­ä¹‰åŒ–ï¼‰
4. â­ `placeholder='Enter email'` - å ä½ç¬¦å®šä½
5. CSS/XPath - é™çº§æ–¹æ¡ˆï¼ˆæ˜“ç¢ï¼‰

---

## ğŸ“š å®˜æ–¹å·¥å…·æ¨è

### Playwright Inspectorï¼ˆå…ƒç´ æ£€æŸ¥ï¼‰
```bash
# åœ¨å½•åˆ¶è¿‡ç¨‹ä¸­ä½¿ç”¨ Inspector
playwright codegen https://erp.91miaoshou.com/login

# åŠŸèƒ½ï¼š
# - æ‚¬åœåœ¨å…ƒç´ ä¸Šè‡ªåŠ¨ç”Ÿæˆ selector
# - æ¨èæœ€ä½³çš„ role-based selector
# - å®æ—¶æµ‹è¯• selector æœ‰æ•ˆæ€§
```

### Playwright Trace Viewerï¼ˆè°ƒè¯•ï¼‰
```bash
# æµ‹è¯•å¤±è´¥æ—¶ï¼ŒæŸ¥çœ‹ trace æ–‡ä»¶
playwright show-trace trace.zip

# åŠŸèƒ½ï¼š
# - å›æ”¾æµ‹è¯•æ­¥éª¤
# - æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
# - æŸ¥çœ‹ DOM å¿«ç…§
# - å®šä½å¤±è´¥åŸå› 
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¯¹äºå¼€å‘è€…

1. **å½•åˆ¶æ–°ç»„ä»¶**:
   ```bash
   python tools/record_component.py --platform miaoshou --component orders_export
   ```
   - âœ… å¯¼èˆªæ­¥éª¤è‡ªåŠ¨åŒ…å« `wait_until` å’Œ `networkidle` ç­‰å¾…
   - âœ… ä¸ä¼šç”Ÿæˆ TODO å ä½ç¬¦
   - âœ… è‡ªåŠ¨æå– URL æ¨¡å¼åˆ° `success_criteria`

2. **æµ‹è¯•ç»„ä»¶**:
   ```bash
   python tools/test_component.py miaoshou/miaoshou_login.yaml
   ```
   - âœ… è‡ªåŠ¨æ£€æµ‹ TODO å ä½ç¬¦å’Œç©ºå€¼
   - âœ… æ¨èä½¿ç”¨å®˜æ–¹ role-based selector
   - âœ… å‹å¥½çš„é”™è¯¯æç¤º

3. **ä½¿ç”¨å‰ç«¯å½•åˆ¶å·¥å…·**:
   - å½•åˆ¶ â†’ æµ‹è¯• â†’ ä¿å­˜
   - âœ… æµ‹è¯•æ—¶ä¸ä¼šå› ç©º `success_criteria` å¤±è´¥
   - âœ… æç¤ºç”¨æˆ·è¡¥å……éªŒè¯æ¡ä»¶

### å¯¹äºæµ‹è¯•äººå‘˜

- **å¿…è¯»**: Playwright Inspector ä½¿ç”¨æŠ€å·§
- **æ¨è**: ä½¿ç”¨ role-based selectorï¼ˆ`role=button[name='ç™»å½•']`ï¼‰
- **é¿å…**: æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„ CSS selector

---

## ğŸ“ˆ æ”¹è¿›æ•ˆæœ

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| **TODO å ä½ç¬¦** | æ¯ä¸ªå¯¼èˆªç»„ä»¶ 1-2 ä¸ª | 0 | âœ… 100% |
| **æ‰‹åŠ¨é…ç½®ç­‰å¾…** | éœ€è¦æ‰‹åŠ¨æ·»åŠ  | è‡ªåŠ¨æ·»åŠ  | âœ… è‡ªåŠ¨åŒ– |
| **URL æå–** | æ‰‹åŠ¨å¡«å†™ | è‡ªåŠ¨æå– | âœ… æ™ºèƒ½åŒ– |
| **éªŒè¯ä¸¥æ ¼æ€§** | åŸºç¡€éªŒè¯ | å¢å¼ºéªŒè¯ | âœ… æå‡ |
| **å¼€å‘ä½“éªŒ** | éœ€è¦æ‰‹åŠ¨å®Œå–„ | å¼€ç®±å³ç”¨ | âœ… ä¼˜åŒ– |

---

## ğŸ”„ åç»­è®¡åˆ’

1. **Phase 1**: è¿ç§»ç°æœ‰ç»„ä»¶ä½¿ç”¨å®˜æ–¹ role-based selectorï¼ˆå¯é€‰ï¼‰
2. **Phase 2**: å¢å¼º Playwright Inspector é›†æˆï¼ˆè‡ªåŠ¨æ‰“å¼€ï¼‰
3. **Phase 3**: æ·»åŠ  Trace Viewer è‡ªåŠ¨åˆ†æï¼ˆå¤±è´¥æ—¶ï¼‰

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [Playwright å®˜æ–¹æ–‡æ¡£ - Navigation](https://playwright.dev/python/docs/navigations)
- [Playwright å®˜æ–¹æ–‡æ¡£ - Locators](https://playwright.dev/python/docs/locators)
- [é¡¹ç›®å¼€å‘è§„èŒƒ - .cursorrules](../../.cursorrules)
- [ç»„ä»¶å½•åˆ¶å·¥å…·æŒ‡å—](../guides/COMPONENT_RECORDER_GUIDE.md)

---

**æ”¹è¿›å®Œæˆæ—¶é—´**: 2025-12-21 23:32  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**åˆè§„æ€§**: âœ… 100% SSOT + Contract-First

