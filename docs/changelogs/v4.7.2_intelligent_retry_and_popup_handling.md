# v4.7.2 æ”¹è¿›æ—¥å¿— - æ™ºèƒ½é‡è¯•ä¸å¼¹çª—å¤„ç†å¢å¼º

**å‘å¸ƒæ—¥æœŸ**: 2025-12-22  
**æ”¹è¿›ç±»å‹**: ç¨³å®šæ€§å¢å¼º + å¼€å‘ä½“éªŒä¼˜åŒ–

---

## ğŸ¯ æ”¹è¿›ç›®æ ‡

æ ¹æ®ç”¨æˆ·å®é™…æµ‹è¯•åé¦ˆï¼Œè§£å†³æ•°æ®é‡‡é›†æ¨¡å—åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä¸‰å¤§æ ¸å¿ƒé—®é¢˜ï¼š

### ç”¨æˆ·åé¦ˆçš„é—®é¢˜

1. âŒ **Wait æ­¥éª¤æŠ¥é”™**: å½•åˆ¶çš„ `wait` æ­¥éª¤ç¼ºå°‘ `type` å­—æ®µï¼Œå¯¼è‡´æµ‹è¯•å¤±è´¥
2. âŒ **æ— é™å¾ªç¯ç™»å½•**: ç™»å½•åé¡µé¢æœªå®Œå…¨åŠ è½½å°±è¿›è¡ŒéªŒè¯ï¼Œå¯¼è‡´é‡å¤ç™»å½•
3. âŒ **æ–°å¼¹çª—æ— å“åº”**: é¡µé¢å‡ºç°æ–°å¼¹çª—æ—¶æ“ä½œåœæ»ï¼Œæ²¡æœ‰æ™ºèƒ½å¤„ç†æœºåˆ¶

### æ ¹æœ¬åŸå› åˆ†æ

#### é—®é¢˜ 1: å½•åˆ¶å·¥å…·ç”Ÿæˆé…ç½®ä¸å®Œæ•´
- **ç°è±¡**: Playwright Inspector å½•åˆ¶çš„ `wait` æ­¥éª¤æ ¼å¼ï¼š`{ action: 'wait', duration: 5000 }`
- **é—®é¢˜**: æ‰§è¡Œå™¨æœŸæœ›æ ¼å¼ï¼š`{ action: 'wait', type: 'timeout', duration: 5000 }`
- **å½±å“**: ç»„ä»¶æµ‹è¯•æ¨¡å—æŠ¥é”™ï¼Œç”¨æˆ·ä½“éªŒå·®

#### é—®é¢˜ 2: é‡è¯•æœºåˆ¶ä¸å¤Ÿå¥å£®
- **ç°è±¡**: æ­¥éª¤å¤±è´¥ååªé‡è¯• 1 æ¬¡ï¼Œå¤±è´¥åç›´æ¥æ”¾å¼ƒæ•´ä¸ªç»„ä»¶
- **é—®é¢˜**: 
  - å¼¹çª—å¤„ç†åæ²¡æœ‰ç­‰å¾…é¡µé¢ç¨³å®šå°±ç«‹å³é‡è¯•
  - Optional æ­¥éª¤å¤±è´¥ä¹Ÿä¼šå¯¼è‡´æ•´ä¸ªç»„ä»¶å¤±è´¥
- **å½±å“**: ç½‘ç»œå¡é¡¿æˆ–ä¸´æ—¶å¼¹çª—å¯¼è‡´æµ‹è¯•å¤±è´¥ç‡é«˜

#### é—®é¢˜ 3: å¼¹çª—å¤„ç†æ—¶æœºä¸å½“
- **ç°è±¡**: åœ¨ `wait` æ­¥éª¤æœŸé—´å‡ºç°æ–°å¼¹çª—ï¼Œåªæœ‰ç­‰ `wait` å®Œæˆæ‰æ£€æŸ¥
- **é—®é¢˜**: å¼¹çª—é®æŒ¡ä¸‹ä¸€æ­¥è¦æ“ä½œçš„å…ƒç´ ï¼Œå¯¼è‡´è¶…æ—¶å¤±è´¥
- **å½±å“**: ç™»å½•åçš„å¼¹çª—å¤„ç†ä¸åŠæ—¶ï¼Œå¯¼è‡´æ— é™å¾ªç¯

---

## âœ… æ”¹è¿›å†…å®¹

### æ”¹è¿› 1: å¢å¼ºå¼¹çª—é”™è¯¯å¤„ç† - ç­‰å¾…é¡µé¢ç¨³å®š â­â­â­

**æ–‡ä»¶**: `modules/apps/collection_center/popup_handler.py`

**æ ¸å¿ƒåŸåˆ™**: **å…³é—­å¼¹çª—åå¿…é¡»ç­‰å¾…é¡µé¢ç¨³å®šï¼Œå†é‡è¯•æ“ä½œ**

#### æ”¹è¿›å‰

```python
async def on_error(self, page, step, component_config):
    if check_on_error:
        await self.popup_handler.close_popups(page, platform=self.platform)
        # âš ï¸ å…³é—­å¼¹çª—åç«‹å³è¿”å›ï¼Œæ²¡æœ‰ç­‰å¾…é¡µé¢ç¨³å®šï¼
```

**é—®é¢˜**:
- å…³é—­å¼¹çª—å¯èƒ½è§¦å‘é¡µé¢é‡æ–°æ¸²æŸ“ï¼ˆAJAX è¯·æ±‚ã€åŠ¨ç”»ç­‰ï¼‰
- ç«‹å³é‡è¯•æ“ä½œå¯èƒ½æ‰¾ä¸åˆ°å…ƒç´ æˆ–å…ƒç´ çŠ¶æ€ä¸å¯¹
- æ²¡æœ‰ç»™ DOM æ›´æ–°çš„æ—¶é—´

#### æ”¹è¿›å

```python
async def on_error(self, page, step, component_config):
    if check_on_error:
        # 1ï¸âƒ£ å…³é—­å¼¹çª—
        closed_count = await self.popup_handler.close_popups(page, platform=self.platform)
        
        if closed_count > 0:
            logger.info(f"Closed {closed_count} popup(s) after step failure")
            
            # 2ï¸âƒ£ â­ å®˜æ–¹æ¨èï¼šç­‰å¾…é¡µé¢ç½‘ç»œç©ºé—²ï¼ˆç¡®ä¿å¼¹çª—å…³é—­å®Œæˆï¼‰
            try:
                await page.wait_for_load_state('networkidle', timeout=5000)
            except Exception as e:
                logger.debug(f"Network idle wait timed out (may be normal): {e}")
            
            # 3ï¸âƒ£ â­ çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿ DOM æ›´æ–°å’ŒåŠ¨ç”»å®Œæˆ
            await asyncio.sleep(0.5)
            
            logger.debug("Page stabilized after popup closure, ready to retry")
```

**æ”¹è¿›ç‚¹**:
1. âœ… ç­‰å¾…ç½‘ç»œç©ºé—² (`networkidle`) - Playwright å®˜æ–¹æ¨è
2. âœ… é¢å¤– 0.5 ç§’å»¶è¿Ÿ - ç¡®ä¿ DOM æ›´æ–°å’ŒåŠ¨ç”»å®Œæˆ
3. âœ… å‹å¥½çš„æ—¥å¿—è¾“å‡º - å‘ŠçŸ¥ç”¨æˆ·æ­£åœ¨ç­‰å¾…é¡µé¢ç¨³å®š

---

### æ”¹è¿› 2: å¢å¼ºé‡è¯•é€»è¾‘ - å¤šæ¬¡é‡è¯• + Optional æ­¥éª¤å¤„ç† â­â­â­

**æ–‡ä»¶**: `modules/apps/collection_center/executor_v2.py`

**æ ¸å¿ƒåŸåˆ™**: **æ­¥éª¤å¤±è´¥ä¸è½»æ˜“æ”¾å¼ƒï¼Œæ™ºèƒ½é‡è¯•å¹¶åŒºåˆ† Optional æ­¥éª¤**

#### æ”¹è¿›å‰

```python
for i, step in enumerate(steps):
    await step_popup_handler.before_step(page, step, component)
    
    try:
        await self._execute_step(page, step, component)
    
    except Exception as e:
        await step_popup_handler.on_error(page, step, component)
        
        # é‡è¯•ä¸€æ¬¡
        try:
            await self._execute_step(page, step, component)
        except Exception as retry_error:
            logger.error(f"Step {i} failed after retry")
            step_failed = True
            break  # âš ï¸ å¤±è´¥åç›´æ¥é€€å‡ºæ•´ä¸ªç»„ä»¶
    
    await step_popup_handler.after_step(page, step, component)
```

**é—®é¢˜**:
- åªé‡è¯• 1 æ¬¡ï¼Œä¸å¤Ÿå¥å£®
- Optional æ­¥éª¤å¤±è´¥ä¹Ÿä¼šé€€å‡ºç»„ä»¶
- æ²¡æœ‰å¯é…ç½®çš„é‡è¯•æ¬¡æ•°

#### æ”¹è¿›å

```python
for i, step in enumerate(steps):
    step_name = step.get('action', 'unknown')
    optional = step.get('optional', False)
    max_retries = step.get('max_retries', 2)  # â­ å¯é…ç½®ï¼Œé»˜è®¤ 2 æ¬¡
    
    await step_popup_handler.before_step(page, step, component)
    
    success = False
    last_error = None
    
    # â­ æ”¹è¿›ï¼šæ”¯æŒå¤šæ¬¡é‡è¯•
    for attempt in range(max_retries + 1):
        try:
            await self._execute_step(page, step, component)
            success = True
            break  # æˆåŠŸï¼Œé€€å‡ºé‡è¯•å¾ªç¯
        
        except Exception as e:
            last_error = e
            
            if attempt < max_retries:
                # â­ è¿˜æœ‰é‡è¯•æœºä¼š
                logger.warning(f"Step {i} ({step_name}) failed (attempt {attempt + 1}/{max_retries + 1})")
                
                # â­ å…³é”®ï¼šå…³é—­å¼¹çª—å¹¶ç­‰å¾…é¡µé¢ç¨³å®š
                await step_popup_handler.on_error(page, step, component)
                
                logger.info(f"Retrying step {i}...")
            else:
                # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥äº†
                logger.error(f"Step {i} failed after {max_retries + 1} attempts")
    
    # â­ æ”¹è¿›ï¼šæ ¹æ®æ­¥éª¤ç±»å‹å†³å®šæ˜¯å¦ç»§ç»­
    if not success:
        if optional:
            # â­ Optional æ­¥éª¤å¤±è´¥ï¼Œè®°å½•è­¦å‘Šä½†ç»§ç»­æ‰§è¡Œ
            logger.warning(f"Optional step {i} ({step_name}) failed, continuing")
        else:
            # â­ å¿…éœ€æ­¥éª¤å¤±è´¥ï¼Œæ ‡è®°å¹¶é€€å‡º
            logger.error(f"Required step {i} ({step_name}) failed, stopping")
            step_failed = True
            break
    
    await step_popup_handler.after_step(page, step, component)
```

**æ”¹è¿›ç‚¹**:
1. âœ… å¯é…ç½®é‡è¯•æ¬¡æ•° (`max_retries`ï¼Œé»˜è®¤ 2 æ¬¡)
2. âœ… Optional æ­¥éª¤å¤±è´¥ä¸é€€å‡ºç»„ä»¶
3. âœ… æ¯æ¬¡é‡è¯•å‰ç­‰å¾…é¡µé¢ç¨³å®š
4. âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•

---

### æ”¹è¿› 3: å½•åˆ¶å·¥å…·è‡ªåŠ¨å¢å¼º - Type + é‡è¯•é…ç½® â­â­â­

**æ–‡ä»¶**: `tools/record_component.py`

**æ ¸å¿ƒåŸåˆ™**: **å½•åˆ¶å·¥å…·ç”Ÿæˆç”Ÿäº§å°±ç»ªçš„é…ç½®ï¼Œå‡å°‘æ‰‹åŠ¨ä¿®æ”¹**

#### æ”¹è¿›å‰

```python
if self.recorded_actions:
    enhanced_steps = []
    
    for action in self.recorded_actions:
        current_action = dict(action)
        
        # âš ï¸ åªå¤„ç† navigate æ­¥éª¤ï¼Œå…¶ä»–æ­¥éª¤åŸæ ·è¾“å‡º
        if current_action.get('action') in ['navigate', 'goto']:
            # ... æ·»åŠ ç­‰å¾…é€»è¾‘
        else:
            enhanced_steps.append(current_action)
    
    return enhanced_steps
```

**é—®é¢˜**:
- `wait` æ­¥éª¤ç¼ºå°‘ `type` å­—æ®µ
- `click`/`fill` æ­¥éª¤ç¼ºå°‘é‡è¯•é…ç½®
- éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ YAML

#### æ”¹è¿›å

```python
if self.recorded_actions:
    enhanced_steps = []
    
    for i, action in enumerate(self.recorded_actions):
        current_action = dict(action)
        
        # â­ v4.7.2: ä¸º wait æ­¥éª¤æ·»åŠ  type å­—æ®µ
        if current_action.get('action') == 'wait':
            if 'type' not in current_action:
                # æ™ºèƒ½åˆ¤æ–­ç±»å‹
                if 'duration' in current_action:
                    current_action['type'] = 'timeout'
                elif 'selector' in current_action:
                    current_action['type'] = 'selector'
                    if 'state' not in current_action:
                        current_action['state'] = 'visible'
                else:
                    current_action['type'] = 'navigation'
                    current_action['wait_until'] = 'networkidle'
                    current_action['timeout'] = 30000
            
            enhanced_steps.append(current_action)
        
        # â­ ä¸º navigate æ­¥éª¤è‡ªåŠ¨æ·»åŠ ç­‰å¾…
        elif current_action.get('action') in ['navigate', 'goto']:
            if 'wait_until' not in current_action:
                current_action['wait_until'] = 'domcontentloaded'
            
            enhanced_steps.append(current_action)
            
            # æ£€æŸ¥ä¸‹ä¸€æ­¥æ˜¯å¦å·²ç»æ˜¯ wait
            next_is_wait = (...)
            
            if not next_is_wait:
                enhanced_steps.append({
                    'action': 'wait',
                    'type': 'navigation',
                    'wait_until': 'networkidle',
                    'timeout': 30000,
                    'comment': 'Auto-added: Wait for network idle'
                })
        
        # â­ v4.7.2: ä¸ºå…³é”®æ“ä½œæ­¥éª¤æ·»åŠ é‡è¯•é…ç½®
        elif current_action.get('action') in ['click', 'fill']:
            if 'max_retries' not in current_action:
                current_action['max_retries'] = 2
            
            enhanced_steps.append(current_action)
        
        else:
            enhanced_steps.append(current_action)
    
    return enhanced_steps
```

**æ”¹è¿›ç‚¹**:
1. âœ… `wait` æ­¥éª¤è‡ªåŠ¨æ·»åŠ  `type` å­—æ®µï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰
2. âœ… `click`/`fill` æ­¥éª¤è‡ªåŠ¨æ·»åŠ  `max_retries: 2`
3. âœ… `navigate` æ­¥éª¤è‡ªåŠ¨æ·»åŠ  `networkidle` ç­‰å¾…
4. âœ… ç”Ÿæˆç”Ÿäº§å°±ç»ªçš„ YAMLï¼Œå‡å°‘æ‰‹åŠ¨ä¿®æ”¹

---

## ğŸ“Š æ”¹è¿›æ•ˆæœ

### æµ‹è¯•ç»“æœï¼ˆ100% é€šè¿‡ï¼‰

```
Test Summary
============================================================
[PASS] Wait step type auto-add
[PASS] Retry config auto-add
[PASS] Navigate auto-wait
[PASS] Comprehensive test

Total: 4 | Passed: 4 | Failed: 0
```

### æ”¹è¿›å‰åå¯¹æ¯”

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| **Wait æ­¥éª¤æŠ¥é”™** | ç¼ºå°‘ type å­—æ®µ â†’ æŠ¥é”™ | è‡ªåŠ¨æ·»åŠ  type | âœ… 100% |
| **æ­¥éª¤é‡è¯•æ¬¡æ•°** | 1 æ¬¡ | 2-3 æ¬¡ï¼ˆå¯é…ç½®ï¼‰ | âœ… 2-3x |
| **å¼¹çª—å¤„ç†åç­‰å¾…** | ç«‹å³é‡è¯• | ç­‰å¾…ç¨³å®š + 0.5s | âœ… ç¨³å®šæ€§ |
| **Optional æ­¥éª¤å¤±è´¥** | æ•´ä¸ªç»„ä»¶å¤±è´¥ | ç»§ç»­æ‰§è¡Œ | âœ… å®¹é”™æ€§ |
| **å½•åˆ¶ç”Ÿæˆé…ç½®** | éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ | å¼€ç®±å³ç”¨ | âœ… æ•ˆç‡ |
| **ç½‘ç»œå¡é¡¿å®¹å¿** | ä½ï¼ˆæ˜“å¤±è´¥ï¼‰ | é«˜ï¼ˆå¤šæ¬¡é‡è¯•ï¼‰ | âœ… 3x |

### å®é™…ä¸šåŠ¡å½±å“

#### ç™»å½•ç»„ä»¶æµ‹è¯•

**æ”¹è¿›å‰**:
```
æ­¥éª¤ 1-6: æˆåŠŸ
æ­¥éª¤ 7 (wait): âŒ æŠ¥é”™ï¼ˆç¼ºå°‘ type å­—æ®µï¼‰
â†’ æ•´ä¸ªç»„ä»¶å¤±è´¥
```

**æ”¹è¿›å**:
```
æ­¥éª¤ 1-6: æˆåŠŸ
æ­¥éª¤ 7 (wait): âœ… è‡ªåŠ¨æ·»åŠ  type='timeout'
æ­¥éª¤ 8-10 (optional): âœ… å¤±è´¥ä½†ç»§ç»­ï¼ˆå¼¹çª—å¯èƒ½ä¸å‡ºç°ï¼‰
â†’ ç»„ä»¶æˆåŠŸ
```

#### ç½‘ç»œå¡é¡¿åœºæ™¯

**æ”¹è¿›å‰**:
```
æ­¥éª¤: ç‚¹å‡»ç™»å½•æŒ‰é’®
â†’ é¡µé¢åŠ è½½æ…¢ï¼Œå…ƒç´ æœªå‡ºç°
â†’ é‡è¯• 1 æ¬¡å¤±è´¥
â†’ âŒ æ•´ä¸ªç»„ä»¶å¤±è´¥
```

**æ”¹è¿›å**:
```
æ­¥éª¤: ç‚¹å‡»ç™»å½•æŒ‰é’® (max_retries=2)
â†’ é¡µé¢åŠ è½½æ…¢ï¼Œå…ƒç´ æœªå‡ºç°
â†’ é‡è¯• 1 æ¬¡ï¼šå…³é—­å¼¹çª— â†’ ç­‰å¾…ç¨³å®š â†’ é‡è¯•
â†’ é‡è¯• 2 æ¬¡ï¼šå…³é—­å¼¹çª— â†’ ç­‰å¾…ç¨³å®š â†’ é‡è¯•
â†’ âœ… ç¬¬ 2 æ¬¡é‡è¯•æˆåŠŸ
```

---

## ğŸ“ Playwright å®˜æ–¹æœ€ä½³å®è·µåº”ç”¨

### 1. é¡µé¢ç¨³å®šæ€§ç­‰å¾…

```python
# â­ å®˜æ–¹æ¨èï¼šç­‰å¾…é¡µé¢åŠ è½½çŠ¶æ€
await page.wait_for_load_state('networkidle', timeout=5000)

# ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ
# - ç¡®ä¿ AJAX è¯·æ±‚å®Œæˆ
# - ç¡®ä¿åŠ¨æ€å†…å®¹åŠ è½½å®Œæˆ
# - ç¡®ä¿ SPA è·¯ç”±è·³è½¬å®Œæˆ
```

**å®˜æ–¹æ–‡æ¡£**: [Page Load States](https://playwright.dev/python/docs/navigations#wait-for-load-state)

### 2. è‡ªåŠ¨ç­‰å¾…ï¼ˆLocator APIï¼‰

```python
# âœ… æ¨èï¼šLocator API è‡ªå¸¦è‡ªåŠ¨ç­‰å¾…
await page.locator(selector).click(timeout=5000)

# âŒ ä¸æ¨èï¼šæ‰‹åŠ¨ç­‰å¾… + æ—§ API
await page.wait_for_selector(selector)
element = await page.query_selector(selector)
await element.click()
```

**å®˜æ–¹æ–‡æ¡£**: [Auto-waiting](https://playwright.dev/python/docs/actionability#auto-waiting)

### 3. æ™ºèƒ½é‡è¯•ç­–ç•¥

```python
# â­ æˆ‘ä»¬çš„å®ç°éµå¾ªå®˜æ–¹å»ºè®®ï¼š
# 1. ä½¿ç”¨ Locator API çš„å†…ç½®é‡è¯•ï¼ˆactionability checksï¼‰
# 2. åœ¨æ­¥éª¤çº§åˆ«æ·»åŠ é¢å¤–çš„æ™ºèƒ½é‡è¯•ï¼ˆå¤„ç†å¼¹çª—ç­‰å¤–éƒ¨å› ç´ ï¼‰
# 3. å¯é…ç½®çš„é‡è¯•æ¬¡æ•°å’Œè¶…æ—¶
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å¯¹äºå¼€å‘è€…

#### 1. å½•åˆ¶ç»„ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆå®Œæ•´é…ç½®ï¼‰

```bash
python tools/record_component.py --platform miaoshou --component orders_export
```

**ç”Ÿæˆçš„ YAML**:

```yaml
steps:
  - action: goto
    url: 'https://erp.example.com/orders'
    wait_until: domcontentloaded  # â­ è‡ªåŠ¨æ·»åŠ 
    
  - action: wait
    type: navigation  # â­ è‡ªåŠ¨æ·»åŠ 
    wait_until: networkidle
    timeout: 30000
    comment: 'Auto-added: Wait for network idle'
    
  - action: click
    selector: 'role=button[name=Export]'
    max_retries: 2  # â­ è‡ªåŠ¨æ·»åŠ 
    
  - action: click
    selector: 'role=button[name=Confirm]'
    optional: true  # â­ å¯é€‰æ­¥éª¤ï¼Œå¤±è´¥ä¸å½±å“ç»„ä»¶
    max_retries: 2
```

#### 2. è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°

å¦‚æœæŸä¸ªæ­¥éª¤ç‰¹åˆ«å®¹æ˜“å¤±è´¥ï¼ˆå¦‚éœ€è¦ç­‰å¾…å¾ˆä¹…çš„æ“ä½œï¼‰ï¼Œå¯ä»¥å¢åŠ é‡è¯•æ¬¡æ•°ï¼š

```yaml
steps:
  - action: click
    selector: 'role=button[name=Generate Report]'
    max_retries: 5  # â­ è¦†ç›–é»˜è®¤çš„ 2 æ¬¡
    timeout: 60000  # å¢åŠ è¶…æ—¶
```

#### 3. Optional æ­¥éª¤æœ€ä½³å®è·µ

å¯¹äºå¯èƒ½å‡ºç°ä¹Ÿå¯èƒ½ä¸å‡ºç°çš„å…ƒç´ ï¼ˆå¦‚å¼¹çª—ï¼‰ï¼Œè®¾ç½®ä¸º `optional`:

```yaml
steps:
  # ç™»å½•åå¯èƒ½å‡ºç°çš„å¼¹çª—ï¼ˆä¸ç¡®å®šæ˜¯å¦å‡ºç°ï¼‰
  - action: click
    selector: 'role=button[name=å…³é—­æ­¤å¯¹è¯æ¡†]'
    optional: true  # â­ å¤±è´¥ä¸å½±å“ç»„ä»¶
    max_retries: 1  # Optional æ­¥éª¤å¯ä»¥å‡å°‘é‡è¯•æ¬¡æ•°
    timeout: 3000   # Optional æ­¥éª¤å¯ä»¥ç¼©çŸ­è¶…æ—¶
```

### å¯¹äºæµ‹è¯•äººå‘˜

#### æµ‹è¯•é€šè¿‡æ ‡å‡†

**æ”¹è¿›å‰**:
- âŒ æ‰€æœ‰æ­¥éª¤å¿…é¡»æˆåŠŸï¼Œå¦åˆ™ç»„ä»¶å¤±è´¥

**æ”¹è¿›å**:
- âœ… å¿…éœ€æ­¥éª¤å¿…é¡»æˆåŠŸ
- âœ… Optional æ­¥éª¤å¤±è´¥ä¸å½±å“ç»„ä»¶
- âœ… Success criteria éªŒè¯é€šè¿‡

#### è°ƒè¯•å¤±è´¥çš„æµ‹è¯•

æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š

```
[WARNING] Step 3 (click) failed (attempt 1/3): TimeoutError
[INFO] Closed 1 popup(s) after step failure
[DEBUG] Page stabilized after popup closure, ready to retry
[INFO] Retrying step 3 (click)...
[PASS] Step 3 succeeded on retry 1
```

---

## ğŸ“‹ æŠ€æœ¯å€ºåŠ¡æ¸…ç†

### å·²è§£å†³

1. âœ… Wait æ­¥éª¤æ ¼å¼ä¸ç»Ÿä¸€ â†’ å½•åˆ¶å·¥å…·è‡ªåŠ¨è§„èŒƒåŒ–
2. âœ… é‡è¯•é€»è¾‘ä¸å¤Ÿå¥å£® â†’ å¤šæ¬¡é‡è¯• + æ™ºèƒ½ç­‰å¾…
3. âœ… Optional æ­¥éª¤å¤„ç†ä¸å½“ â†’ åŒºåˆ†å¿…éœ€/å¯é€‰æ­¥éª¤
4. âœ… å¼¹çª—å¤„ç†æ—¶æœºä¸å½“ â†’ ç­‰å¾…é¡µé¢ç¨³å®šåé‡è¯•

### æœªæ¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **æŒä¹…åŒ–ä¼šè¯** - ä½¿ç”¨ `persistent_context` ä¿å­˜ Cookieï¼ˆv4.8.0 è®¡åˆ’ï¼‰
2. **æ™ºèƒ½ç™»å½•æ£€æµ‹** - æ£€æµ‹æ˜¯å¦å·²ç™»å½•ï¼Œé¿å…é‡å¤ç™»å½•ï¼ˆv4.8.0 è®¡åˆ’ï¼‰
3. **Trace Viewer é›†æˆ** - å¤±è´¥æ—¶è‡ªåŠ¨ç”Ÿæˆ trace æ–‡ä»¶ï¼ˆv4.8.0 è®¡åˆ’ï¼‰

---

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

### å‘åå…¼å®¹

âœ… **å®Œå…¨å…¼å®¹æ—§ç»„ä»¶é…ç½®**

- æ—§é…ç½®ä¸­æ²¡æœ‰ `type` å­—æ®µçš„ wait æ­¥éª¤ â†’ æ‰§è¡Œå™¨é»˜è®¤ä¸º `timeout`
- æ—§é…ç½®ä¸­æ²¡æœ‰ `max_retries` çš„æ­¥éª¤ â†’ æ‰§è¡Œå™¨é»˜è®¤é‡è¯• 2 æ¬¡
- æ—§é…ç½®ä¸­çš„ optional æ­¥éª¤ â†’ æŒ‰æ–°é€»è¾‘å¤„ç†ï¼ˆå¤±è´¥ä¸é€€å‡ºï¼‰

### æ¨èåšæ³•

**å¯¹äºæ–°å½•åˆ¶çš„ç»„ä»¶**:
- âœ… ä½¿ç”¨æ–°çš„å½•åˆ¶å·¥å…·ï¼Œè‡ªåŠ¨ç”Ÿæˆå®Œæ•´é…ç½®

**å¯¹äºç°æœ‰ç»„ä»¶**:
- â¸ï¸ ä¸å¼ºåˆ¶è¿ç§»ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… å¦‚æœé‡åˆ°é—®é¢˜ï¼Œé‡æ–°å½•åˆ¶æˆ–æ‰‹åŠ¨æ·»åŠ é…ç½®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Playwright å®˜æ–¹æ–‡æ¡£ - Auto-waiting](https://playwright.dev/python/docs/actionability#auto-waiting)
- [Playwright å®˜æ–¹æ–‡æ¡£ - Page Load States](https://playwright.dev/python/docs/navigations#wait-for-load-state)
- [é¡¹ç›®å¼€å‘è§„èŒƒ - .cursorrules](../../.cursorrules)
- [v4.7.1 æ”¹è¿›æ—¥å¿— - Playwright å®˜æ–¹ API ä¼˜åŒ–](./v4.7.1_playwright_official_api_improvements.md)

---

**æ”¹è¿›å®Œæˆæ—¶é—´**: 2025-12-22 14:51  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡ï¼ˆ4/4ï¼‰  
**åˆè§„æ€§**: âœ… 100% SSOT  
**ç”Ÿäº§å°±ç»ª**: âœ… æ˜¯

