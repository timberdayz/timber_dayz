# 🗺️ 跨境电商 ERP 系统 - 开发路线图

> 文档索引（推荐入口）: docs/INDEX.md

## 🚀 多Agent协作开发启动 (2025-10-16)

### Week 1（2025-10-16至2025-10-22）：多Agent协作开发冲刺

**开发模式**: 个人开发者使用Cursor（Agent A）和Augment（Agent B）串行开发  
**投入时间**: 每天12小时 × 7天 = 84小时  
**开发目标**: 完成数据库架构、ETL流程、前端优化，系统达到生产就绪  

#### Day 1: 诊断 + 数据库架构（Agent A - Cursor）
**目标**: 定位问题，搭建数据库基础设施

- [ ] 上午：系统诊断（字段映射+数据库+前端）
  - 输出：`DIAGNOSTIC_REPORT_DAY1.md`
  
- [ ] 下午：数据库Schema设计
  - 设计维度表、事实表、管理表
  - 创建ORM模型（dimensions.py, facts.py, management.py）
  - 输出：`DATABASE_SCHEMA_V3.md`
  
- [ ] 晚上：Alembic初始化
  - 配置Alembic支持SQLite和PostgreSQL
  - 创建初始迁移脚本
  - 测试迁移执行

**验收**: 
- ✅ 诊断报告完成
- ✅ ORM模型可用
- ✅ Alembic迁移测试通过

#### Day 2: 智能字段映射系统重构（Agent A - Cursor）
**目标**: 重构字段映射系统，提升性能10倍+

- [ ] 上午：分析与设计
  - 深度分析现有系统瓶颈
  - 设计新架构（scanner/reader/mapper）
  - 输出：`FIELD_MAPPING_REFACTOR_PLAN.md`
  
- [ ] 下午：核心逻辑重构
  - 实现文件扫描器（优化版）
  - 实现Excel读取器（缓存优化）
  - 实现字段映射引擎（AI+规则）
  
- [ ] 晚上：前端页面重构
  - 优化40_字段映射审核.py
  - 集成新服务层API
  - 性能测试

**验收**:
- ✅ 文件扫描速度≥500文件/秒
- ✅ 映射准确率≥90%
- ✅ 无白屏和加载问题

#### Day 3: ETL核心流程实现（Agent A - Cursor）
**目标**: 打通文件→数据库完整流程

- [ ] 上午：Excel解析与映射集成
  - 统一Excel解析器（支持多格式）
  - 集成字段映射引擎
  
- [ ] 下午：数据验证与入库
  - 实现数据验证器
  - 实现数据入库引擎（幂等性upsert）
  
- [ ] 晚上：ETL主流程编排
  - 实现ETL Pipeline
  - 创建命令行工具
  - 端到端测试

**验收**:
- ✅ 支持.xlsx/.xls/.csv解析
- ✅ 数据能成功入库SQLite
- ✅ 失败数据隔离到quarantine

#### Day 4: 性能优化与测试（Agent A - Cursor）
**目标**: 性能优化和测试覆盖

- [ ] 上午：性能优化
  - 缓存优化（三层缓存）
  - 数据库索引优化
  - 批处理优化
  
- [ ] 下午：单元测试
  - 核心模块测试（目标80%+覆盖）
  - Excel解析、字段映射、数据入库测试
  
- [ ] 晚上：汇率服务与工具
  - 实现汇率服务（Agent B的预实现）
  - 实现监控工具
  - 实现文件工具

**验收**:
- ✅ ETL性能≥1000行/秒
- ✅ 核心测试覆盖≥80%
- ✅ 汇率服务可用

#### Day 5: 数据查询 + 前端修复（Agent A→Agent B）
**目标**: 前后端打通，前端展示数据库数据

- [ ] 上午：数据查询服务（Agent A - Cursor）
  - 实现DataQueryService
  - 定义API接口契约
  
- [ ] 下午：修复数据管理中心（Agent B - Augment）⚠️ 切换工具
  - 修复白屏问题
  - 接入data_query_service
  - 添加筛选和统计
  
- [ ] 晚上：修复其他页面（Agent B - Augment）
  - 修复unified_dashboard白屏
  - 优化字段映射审核页面

**验收**:
- ✅ 数据查询服务接口完成
- ✅ 前端页面无白屏
- ✅ 能展示数据库数据

#### Day 6: 前端优化 + PostgreSQL（Agent B→Agent A）
**目标**: 前端性能优化和生产环境支持

- [ ] 上午：前端性能优化（Agent B - Augment）
  - Streamlit缓存优化
  - 添加交互式图表
  - 懒加载数据
  
- [ ] 下午：PostgreSQL支持（Agent A - Cursor）⚠️ 切换工具
  - 修改database.py支持PostgreSQL
  - Alembic PostgreSQL迁移测试
  - Upsert双数据库适配
  
- [ ] 晚上：文档编写（Agent A - Cursor）
  - 部署指南
  - API文档
  - 故障排查手册

**验收**:
- ✅ 前端首屏<2秒
- ✅ PostgreSQL支持完成
- ✅ 文档齐全

#### Day 7: 集成测试 + 生产准备（Agent A + Agent B）
**目标**: 系统生产就绪

- [ ] 上午：端到端测试（Cursor）
  - 完整流程测试（Shopee/TikTok/妙手）
  - 性能压力测试
  
- [ ] 下午：PostgreSQL生产环境（Cursor）
  - 数据迁移
  - 生产配置
  - 压力测试
  
- [ ] 晚上：收尾（Augment）
  - 补充测试
  - 完善文档
  - 代码整理

**验收**:
- ✅ 端到端测试通过
- ✅ 测试覆盖率达标
- ✅ 生产环境就绪

---

## 🎉 最新更新 (2025-10-15)

- 立即预览：去除防抖，选择后立刻读取；旧请求 request_id 取消
- 稳定 UI：占位容器管理“正在读取…”提示，读取后替换为数据
- 刷新防抖：scan_in_progress 锁，扫描期间禁用按钮，避免右上角持续转
- 清理归档：将过期测试与说明文档移至 `backups/temp_cleanup_20251015_ui/` 与 `backups/docs_archive_20251015_ui/`

### 2025-10-13 字段映射审核系统完整实现（完成）✅

#### 核心功能

- **智能字段映射**: AI 驱动的字段映射，支持模糊匹配、语义匹配、部分匹配
- **手动调整映射**: 可视化编辑界面，支持手动修改 AI 推荐的映射关系
- **数据入库**: 完整的数据验证、清洗、批量入库流程
- **批量操作**: 支持批量分析、批量确认映射、批量入库

#### 性能指标

- 文件扫描: 413 个文件 < 0.2 秒
- 字段映射: < 0.001 秒/文件
- 数据入库: 1000 行 < 5 秒
- 批量处理: 10 个文件 < 10 秒

#### 技术特性

- 三层缓存机制（文件扫描、Excel 读取、字段映射）
- 懒加载优化（只在用户操作时执行）
- 错误处理完善（友好提示和重试机制）
- 响应式设计（支持桌面、平板、移动端）

#### 文档清理

- 移动 28 个过期文档到 `backups/docs_archive_20251013/`
- 保留核心文档和最新报告
- 更新 README.md、DEVELOPMENT_ROADMAP.md、PROJECT_STATUS.md

#### 下一步

- 优化数据入库性能（支持更大数据量）
- 添加数据质量报告（统计分析、异常检测）
- 支持更多数据域（订单、财务、客服等）

---

### 2025-09-26 前端运营中心模板与销售分析 DB 开关落地（完成）

- 运营中心白屏修复：修正缩进错误与阻塞性路径，保证首屏 <2s 渲染
- 销售分析（GMV/订单量）DB 自动切换：`SALES_DATA_SOURCE=db` → 数据库；否则 → 模拟数据
  - 只读聚合查询（SUM/COUNT）、5s 超时、失败静默回退
  - 智能字段匹配：自动探查订单事实表与关键列（日期/金额/平台/店铺）
- 二级菜单全面模板化：移除“开发中”，交付统一的企业级模板（4–6 KPI + 2–3 图表 + 筛选器 + 数据来源/更新时间标识）
- 接口预留标准：`get_[module]_data(params: dict) -> pd.DataFrame`；标准参数集 `platforms, accounts, start_date, end_date, additional_filters`
- 下一步：在不改变前端签名前提下，逐维度将模拟数据替换为 DB（或 API）真实数据

### 2025-09-25 数据库与入库架构决策与计划（进行中）

- 决策摘要：

  - 入库权威=DB 清单（catalog_files），目录级月清单可选；temp/outputs 为主，支持 data/input/manual_uploads 手动上传；
  - 数据域顺序=Orders/Products → Metrics（日/周/月）；
  - 主键幂等策略：订单（platform+shop_id+order_id）、产品（platform+shop_id+platform_sku）、指标（platform+shop_id+sku+metric_date+metric_type）；
  - 汇率：exchangerate.host 每日拉取，RMB 归一，失败固定汇率兜底；
  - 数据库：Dev=SQLite，Prod=PostgreSQL；统一 DATABASE_URL，Alembic 管理迁移。

- Excel 依赖策略（解析与库选择）

  - .xlsx: openpyxl
  - .xls（OLE 二进制）: xlrd==1.2.0（固定旧版；xlrd>=2.0 不再支持 .xls）
  - .xls（HTML 伪装/导出）: pandas.read_html + lxml + beautifulsoup4 + html5lib

- 分阶段推进（DB 里程碑）：
  1. DB-0 架构与迁移（当前）
     - 定义维表：dim_platforms、dim_shops、dim_products、dim_currency_rates
     - 定义事实：fact_orders、fact_order_items、fact_product_metrics（含粒度与日期主键）
     - 建立 Alembic 初始迁移（SQLite first，Postgres-ready）
  2. DB-1 入库管道
     - 扫描 temp/outputs 与 data/input/manual_uploads；登记 catalog_files（hash/size/source）
     - manifest-first；缺失清单回填（路径/文件名+Excel 表头嗅探）；
     - 幂等 upsert + quarantine 失败记录
  3. DB-2 汇率与 RMB 归一
     - currency_service：每日抓取并缓存；入库期即算 RMB 列
     - 提供固定汇率兜底开关
  4. DB-3 生产就绪（PostgreSQL）
     - DATABASE_URL 切换、连接池参数、备份策略（每日 dump）与运维指引
  5. DB-4 验证与接入
     - 端到端冒烟：Shopee/Miaoshou/TikTok 三个样本入库校验
     - Streamlit 看板接入数据库（平台/店铺/日期/粒度切片 + 产品榜单）

## 📋 当前版本状态 (v3.2.1 - 配置注册中心上线)

### ✅ 已完成功能

- [x] **新架构重构** (v3.0.0) - 模块化架构设计完成
- [x] **Playwright 录制工具** (v3.0.1) - Inspector 修复完成，支持正常录制
- [x] **多窗口解决方案** (v3.0.1) - 邮箱验证码处理模板和指南
- [x] **账号管理系统** - 加密存储和统一管理
- [x] **基础采集框架** - Shopee、Amazon、妙手 ERP 基础支持
- [x] **Web 界面框架** - Streamlit 基础界面和路由
- [x] **账号健康检测系统** (v3.1.0) - 智能识别异常账号并自动处理
- [x] **深链接采集架构** (v3.1.0) - 登录后直达目标页面，提升采集效率
- [x] **平台适配器系统** (v3.1.0) - 统一的多平台深链接和导出接口
- [x] **流程编排器** (v3.1.0) - 自动化"登录+采集"流程编排
- [x] **采集模板生成器** (v3.1.0) - 参数化采集脚本自动生成
- [x] **智能诊断系统** (v3.1.1) - DOM 变化监控、对比诊断、MutationObserver 集成
- [x] **多选器组件支持** (v3.1.1) - 支持 Shopee 自定义 multi-selector 指标勾选
- [x] **时间戳兜底重试** (v3.1.1) - 秒/毫秒时间戳自动切换，提升导出成功率
- [x] **组件化采集框架** (v3.2.0) - 跨平台组件抽象，组件化优先执行策略
- [x] **生产级录制脚本** (v3.2.0) - 薄封装模板，50-100 行代码，跨账号复用
- [x] **配置注册中心** (v3.2.1) - 分数据域配置文件管理，菜单快捷编辑
- [x] **深链接统一维护** (v3.2.1) - 所有平台页面路径集中在 \*\_config.py 配置文件

### 2025-09-11 批量采集完成（Shopee 三大数据域）

- 核心改进：组件化导航 + DatePicker 配方 + 弹窗关闭，全链路统一，成功率 100%
- 产物规范：导出后统一生成旁文件 manifest（.xlsx.json）；目录粒度统一为 daily/weekly/monthly
- 自愈策略：新增“文件名日期区间一致性校验”，不一致自动重选并重试一次
- 资源回收：账号级 finally 收尾打印后台资源统计，确保 contexts=0, fallbacks=0
- 批量结果汇总：总任务 21 | ✅ 成功 21 | ❌ 失败 0
- 按数据域统计：服务表现 ✅ 7 | ❌ 0；商品表现 ✅ 7 | ❌ 0；流量表现 ✅ 7 | ❌ 0
- 下一步：按 Shopee 组件化设计复刻 TikTok 卖家端（优先 traffic/products），沿用相同落盘契约

### 2025-09-16 弹窗延迟适配 + 批量稳定性确认（Shopee）

- 应用预处理（步骤 3.5）与通用配方（\_close_notification_modal）双通道加入“观察-重试”机制（6–8s / 300–400ms），覆盖导航后 2s+才出现的问卷弹窗
- 精确选择器：`.survey-window-modal i.eds-modal__close` 与遮罩层 ESC 兜底；同时遍历所有 iframe
- 批量与单次一致：批量执行同样先预处理再配方执行，导出阶段仍提供二次兜底
- 结果：服务/商品/流量 三数据域批量导出 21/21 成功；后续将把该策略沉淀为跨平台标准
- 下一步：按照 Shopee 的组件化规范复刻至 TikTok（优先 traffic/products），统一输出契约和旁文件 manifest

### 2025-09-17 TikTok 服务表现 — “昨天”日期选择稳定化（进行中）

- 现象：在 service-analytics 页面选择“昨天/单日(8/16)”时，日期面板出现持续抽搐（频繁重排），区间未稳定。
- 初步诊断：快捷范围（近 7 天）active 与自定义模式切换导致受控状态震荡；同日范围对网格点击较敏感。
- 行动计划（P0 明日执行）：
  1. 显式切换到“自定义/Custom”Tab，并等待 250–400ms 稳定；
  2. 检测/解除快捷项 active 的回写干扰；
  3. “昨天=单日”优先走“受控直填 + 确认”路径，加入节流与两次值复读校验；
  4. 增加特性开关：仅对 service-analytics 的“昨天”启用 force-fill；
  5. 增强日志：输出激活 Tab、快捷项 active、两次输入值快照与确认命中；
  6. 最小契约测试：选择“昨天”后两个输入框非空且均为昨天；
- 回滚：保留“近 7 天（默认）”路径不变；特性开关可一键关闭。

### 2025-09-19 妙手 ERP 导出下载识别（进行中）

- 现象：浏览器显示“下载完成”，自动化侧未能捕获 download 事件且目录扫描未命中
- 今日动作：
  - 上下文级 expect_download 与进度轮询并行；
  - 目录扫描兜底（since_ts + 放宽后缀=接受任意后缀/无后缀）；
  - 轻量 HAR-like 响应监听（export/download/attachment 命中收集），失败时以 fetch(blob) 触发直连下载
- 下一步（P0）：
  1. 固化“HAR → 直连下载”参数提取（URL、Headers）与 Cookie 搬运；
  2. 统一落盘（路径/命名/.json 清单），补充最小契约测试；
  3. 严守变更半径：仅改动 Miaoshou 导出组件；
  4. 明确“录制模块冻结”：不再改动“1. 📊 数据采集录制”模块。

### 2025-09-20 妙手 ERP 下载事件已捕获但落盘未对齐（进行中）

- 今日已将下载监听前移并扩大覆盖范围（Page 级 + 新页补挂），并将宽限等待切换为 page.wait_for_event。
- 终端可见多次“捕获到下载事件 (tap) …”，但未归档到标准输出路径。
- 明日计划（P0）：
  1. HAR → 直连下载兜底（提取 URL/Headers/Cookie，在同一上下文 fetch(blob) 复现）；
  2. 统一输出命名与 .json 清单；
  3. 增加最小契约测试（成功=产物存在且 size>0）。

### ♻️ 2025-08-31 补充（Shopee 商品表现导出稳定性）

- [x] 下载目录修复（先计算 out_dir，再设置持久化上下文 downloads_path）
- [x] 下载事件稳定化（点击同时 expect_download，提升为 context 级监听）
- [x] 文件名一致性（保存 suggested_filename 后重命名为目标文件名）
- [x] 兜底扫描 profiles 默认下载目录（profiles/shopee/\*\*/Default/Downloads）
- [x] 自动重新生成报告（enable_auto_regenerate，可选开关）
- [ ] 指标操作前前移网络抓包，定位列偏好接口
- [ ] 若存在“列偏好保存”API，切换为直连保存；否则文档明确导出列遵循平台默认
- [ ] 指标模板与常用组合

### 🔧 当前开发重点

#### 0. 组件化“客流表现”录制（明日计划）

- 基于今日“商品表现”的稳定录制模板复用
- 仅替换导航与数据导出位置的选择器
- 录制目标：UI 导出优先（支持自动重生），禁用 API 备选
- 产出：录制脚本、.diag 网络快照与差异摘要、最小契约测试
- 导出阶段开启网络抓包，保存 pre/post 快照并输出差异摘要（前 5 条）

#### 1. 深链接采集系统 (v3.1.0 - 已完成)

- [x] 修复 Playwright Inspector 启动问题
- [x] 完成基础录制功能验证
- [x] 新增多窗口处理解决方案
- [x] 完善登录流程自动化
- [x] 账号健康检测系统实现
- [x] 深链接直达架构设计
- [x] 平台适配器系统建立
- [x] 流程编排器实现
- [x] 采集模板生成器完成

#### 2. 智能诊断与多选器支持 (v3.1.1 - 已完成)

- [x] DOM MutationObserver 集成 - 实时监控页面元素变化
- [x] 对比诊断模式 - before/after 快照自动对比
- [x] multi-selector 组件识别 - 支持 Shopee 自定义指标选择
- [x] 时间戳格式兜底 - 秒/毫秒自动切换重试
- [x] 导出尝试记录 - 失败时保存详细诊断信息
- [x] 指标勾选策略优化 - 文本锚点+祖先节点定位

#### 3. 数据采集录制优化 (进行中)

- [ ] 集成深链接采集到录制向导
- [ ] 完善 Shopee 四种数据类型采集模板
- [ ] API 导出接口录制和配置
- [ ] 批量采集功能实现
- [ ] 采集结果统计和报告
- [x] 录制规则方向确认（2025-08-30）：

  - 四段式完整流程：登录 → 选择数据类型 → 选择时间范围 → 导出下载
  - 录制向导默认 complete 类型；模板指导同步四段式
  - 统一命名：{平台}_{账号}_{数据类型}_complete_{时间戳}.py
  - 稳定版标记：支持 stable 的查看/设置/取消

- [ ] 数据质量验证机制

## 🚀 近期开发计划 (1-2 周)

### Phase 0: Shopee 卖家端子类型扩展（订单表现、财务表现）

- 输出目录与命名：data_type = orders, finance；遵循 docs/OUTPUTS_NAMING.md
- 组件与适配：
  - 新增 components/orders_export.py、components/finance_export.py（仿照 analytics_export/products_export）
  - 在 shopee adapter 中注册工厂方法 get_orders_export(), get_finance_export()
- 配置与导航：在 platforms/shopee/config 中新增深链接与选择器配置（orders/finance）
- 文件命名：统一 build_output_path/build_filename（account_slug/shop_slug/data_type/granularity）
- 契约测试：为每个组件新增最小契约测试（可模拟页面探针与导出按钮存在）
- 界面：在数据采集中心“运行录制脚本/批量采集”中加入订单、财务入口
- CI：沿用 outputs 目录健康检查，确保落盘统一

### Phase 0.5: TikTok 卖家端子类型对齐

- 复用 Shopee 组件抽象与命名规范，优先实现 traffic/products；随后 orders/finance
- 先打通登录与深链接导航，复用日期配方执行器
- 统一路径与文件名策略，先本地验证，再扩展到批量采集

### Phase 1: 录制系统完善

- [ ] **登录流程标准化**

  - [ ] 统一登录录制模板
  - [ ] 验证码自动识别
  - [ ] 登录状态保持
  - [ ] 多账号切换支持

- [ ] **数据采集录制**
  - [ ] 订单数据采集录制
  - [ ] 产品信息采集录制
  - [ ] 财务数据采集录制
  - [ ] 自定义采集流程

### Phase 2: 数据处理增强

- [ ] **实时数据同步**

  - [ ] 增量数据更新
  - [ ] 数据冲突处理
  - [ ] 同步状态监控
  - [ ] 错误恢复机制

- [ ] **数据分析功能**
  - [ ] 销售趋势分析
  - [ ] 库存预警系统
  - [ ] 利润分析报告
  - [ ] 竞品监控功能

## 🌟 中期目标 (1-2 月)

### 智能化功能

- [ ] **AI 数据分析**

  - [ ] 销售预测模型
  - [ ] 价格优化建议
  - [ ] 库存智能补货
  - [ ] 异常数据检测

- [ ] **自动化运营**
  - [ ] 定时采集任务
  - [ ] 自动报告生成
  - [ ] 异常情况预警
  - [ ] 数据备份策略

### 界面和体验优化

- [ ] **专业级界面设计**

  - [ ] 实时监控仪表盘
  - [ ] 交互式数据图表
  - [ ] 移动端适配
  - [ ] 多语言支持

- [ ] **用户体验优化**
  - [ ] 操作引导系统
  - [ ] 快捷键支持
  - [ ] 个性化设置
  - [ ] 操作历史记录

## 🎯 长期愿景 (3-6 月)

### 平台扩展

- [ ] **新平台集成**

  - [ ] Lazada 数据采集
  - [ ] TikTok Shop 集成
  - [ ] 独立站支持
  - [ ] 社交电商平台

- [ ] **企业级功能**
  - [ ] 多租户支持
  - [ ] 权限管理系统
  - [ ] 审计日志功能
  - [ ] 数据安全加密

### 技术架构升级

- [ ] **微服务架构**

  - [ ] 服务拆分设计
  - [ ] API 网关集成
  - [ ] 容器化部署
  - [ ] 服务监控系统

- [ ] **云原生支持**
  - [ ] 云平台部署
  - [ ] 弹性扩容
  - [ ] 灾备方案
  - [ ] 多地域同步

## 🔍 技术债务处理

### 代码质量优化

- [x] 清理过期测试文件
- [ ] 统一代码风格
- [ ] 增加单元测试覆盖率
- [ ] 性能瓶颈优化
- [ ] 内存使用优化

### 文档和规范

- [x] 更新开发文档
- [ ] 完善 API 文档
- [ ] 用户使用手册
- [ ] 部署指南更新
- [ ] 故障排除文档

## 📊 开发进度追踪

### 本周完成 (2025-08-26 - 2025-08-28)

- ✅ Playwright Inspector 修复
- ✅ 多窗口录制解决方案
- ✅ 文档更新和整理
- ✅ 代码清理和优化

### 本周完成 (2025-08-29)

- ✅ **开发规范优化** - 增强 .cursorrules 规则，添加 Agent 通用工作流与变更半径控制
- ✅ **模块边界强化** - 修复注册器元数据读取，避免实例化副作用，防止全局崩溃
- ✅ **契约测试体系** - 为所有应用添加类级元数据与最小契约测试
- ✅ **副作用清理** - 移除应用 **init** 中的 I/O 操作，实现惰性初始化
- ✅ **健康检查 CLI** - 创建快速验证脚本，支持本地开发与 CI 环境

### 下周计划 (2025-08-30 - 2025-09-06)

- 🎯 登录流程标准化
- 🎯 数据采集录制完善
- 🎯 Shopee 多店铺采集测试
- 🎯 界面优化和调整

### 月度里程碑

- **2025-09**: 录制系统完善，基础采集功能稳定
- **2025-10**: 智能化功能开发，界面体验优化
- **2025-11**: 企业级功能集成，性能优化
- **2025-12**: 云原生部署，多平台扩展

---

_最后更新: 2025-09-26_
_维护者: 西虹 ERP 开发团队_
