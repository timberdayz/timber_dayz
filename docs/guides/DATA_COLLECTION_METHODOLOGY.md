# 🛠️ 数据采集开发方法论

## 📋 概述

本文档记录了在开发"Shopee 商品表现数据导出"过程中形成的可复用方法论，适用于Shopee"流量表现"、TikTok等平台的数据采集开发。

## 🎯 核心理念：AI自动 + 用户手动协作

### AI自动化部分
- **HAR/HTTP快照分析**：自动抓取网络请求，分析接口、参数、响应结构
- **元素自动扫描**：自动识别页面控件（日期选择器、导出按钮等）
- **配方生成**：自动生成操作步骤和元素定位策略
- **通用弹窗检测**：自动识别并关闭各种通知弹窗
- **状态智能判断**：检测页面默认状态，避免不必要操作

### 用户手动部分
- **Playwright Inspector录制**：手动录制复杂交互流程
- **iframe处理**：解决动态容器、隐式动画、语言差异
- **具体元素提供**：提供准确的CSS选择器和文本定位
- **业务策略对齐**：确认业务逻辑（如"今日实时"默认状态处理）

## 🔧 技术工具链

### 1. 诊断模式工具
- **对比诊断**：before/after DOM快照自动对比
- **网络探针**：导出请求前后网络快照分析
- **MutationObserver**：实时监控页面元素变化
- **事件监听器**：捕获用户交互和页面响应

### 2. 配方系统
- **Recipe录制**：将操作步骤标准化为可复刻的配方
- **RecipeExecutor**：智能执行配方，支持验证和重试
- **候选选择器**：多重选择器策略，提高成功率
- **优先级动态调整**：根据目标自动调整选择器优先级

### 3. 录制脚本管理
- **Recording Registry**：脚本索引和分类管理
- **四类数据类型**：订单/商品/客流/财务统一分类
- **自动回放**：按账号和数据类型自动执行脚本

## 📊 开发流程

### Phase 1: 信息收集
1. **页面分析**：访问目标页面，了解基本结构
2. **HAR抓取**：记录完整的网络请求流程
3. **元素探测**：自动识别关键控件和交互元素
4. **业务理解**：确认数据导出的业务逻辑

### Phase 2: 录制开发
1. **启用诊断模式**：开启DOM监控和网络抓包
2. **手动录制**：使用Playwright Inspector录制关键步骤
3. **配方生成**：将录制结果转换为标准化配方
4. **验证测试**：测试配方的准确性和稳定性

### Phase 3: 优化完善
1. **异常处理**：添加弹窗检测、重试机制
2. **智能优化**：状态检测、跳过不必要操作
3. **性能调优**：减少等待时间、提高执行效率
4. **兼容性测试**：多账号、多店铺测试验证

## 🎯 关键成功要素

### 1. 分层思路
- **数据源分层**：UI层（Playwright）、网络层（HAR）、配方层（Recipe）
- **流程分层**：登录 → 导航 → 时间选择 → 导出/下载 → 验证

### 2. 双轨协作
- **AI负责通用性**：自动化分析、模式识别、配方生成
- **用户负责特殊性**：复杂交互、业务逻辑、异常处理

### 3. 安全与健壮性
- **最小干预原则**：优先检测状态，避免不必要操作
- **多重兜底策略**：配方失败时的传统方法兜底
- **非阻塞设计**：异常不影响主流程继续执行

## 🚀 应用场景

### 已验证场景
- ✅ Shopee商品表现数据导出
- ✅ 时间选择器自动化
- ✅ 导出按钮点击和下载监控
- ✅ 通知弹窗自动关闭

### 待应用场景
- 📋 Shopee流量表现数据导出
- 📋 TikTok Seller/Ads数据面板
- 📋 其他平台导出型页面

## 📈 效果评估

### 开发效率提升
- **录制时间**：从数小时缩短到数十分钟
- **调试周期**：自动诊断大幅减少人工排查时间
- **复用性**：配方可跨账号、跨店铺复用

### 稳定性提升
- **成功率**：多重选择器策略提高操作成功率
- **容错性**：智能重试和兜底机制
- **适应性**：自动适应页面变化和状态差异

## 🔄 持续改进

### 工具链扩展
- 账号/店铺自动拉取与白名单
- 网络代理策略优化
- 异常截图/视频归档
- 元素热点热力图分析

### 方法论完善
- 更多平台的验证和适配
- 复杂业务场景的处理模式
- 性能优化的最佳实践
- 团队协作的标准化流程

---

_创建时间: 2025-08-30_
_维护者: 西虹 ERP 开发团队_
