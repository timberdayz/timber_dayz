# 字段映射系统用户使用指南

**版本**: v4.3.1  
**更新日期**: 2025-01-24  
**适用场景**: 将数据采集模块采集的Excel文件映射并入库到PostgreSQL数据库

---

## 🎯 快速开始

### 系统访问

1. 启动系统: `python run.py`
2. 访问地址: http://localhost:5173
3. 点击左侧菜单"字段映射审核"

---

## 📖 完整操作流程

### 步骤1: 扫描采集文件

**操作**: 点击页面顶部的 `🔍 扫描采集文件` 按钮

**系统执行**:
- 扫描 `temp/outputs/` 目录
- 自动识别平台（支持中文识别：虾皮→shopee, 妙手→miaoshou）
- 解析文件元数据（账号、店铺、数据域、粒度）
- 写入catalog_files数据库表

**扫描结果示例**:
```
✅ 扫描完成
发现289个文件，新注册42个
```

---

### 步骤2: 选择文件

#### 2.1 选择平台
**下拉框**: 选择平台 → 例如：`shopee`

**可选平台**:
- shopee (虾皮)
- tiktok
- amazon (亚马逊)
- miaoshou (妙手)
- lazada

#### 2.2 选择数据域
**下拉框**: 选择数据域 → 例如：`products`

**可选数据域**:
- products (商品数据)
- orders (订单数据)
- analytics (流量分析)
- finance (财务数据)
- services (服务数据)

#### 2.3 选择粒度
**下拉框**: 选择粒度 → 例如：`日度`

**可选粒度**:
- 日度 (daily)
- 周度 (weekly)
- 月度 (monthly)
- 快照 (snapshot)

#### 2.4 选择文件
**下拉框**: 选择文件 → 系统会根据前面的选择自动过滤文件列表

**文件名示例**:
```
20250924_185940__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-23_2025-09-23.xlsx
```

---

### 步骤3: 查看文件详情

**选择文件后，系统自动显示**:

```
📄 文件详情

文件名: 20250924_185940__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-23_2025-09-23.xlsx
平台:   shopee ✅        数据域: products
账号:   虾皮巴西_东朗照明主体    店铺: the_king_s_lucky_shop
粒度:   daily            日期范围: 2025-09-23 到 2025-09-23
文件路径: ✅ temp/outputs/shopee/.../20250924_185940__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-23_2025-09-23.xlsx
```

**重要提示**:
- ✅ 绿色勾号表示文件存在且路径正确
- ❌ 红色叉号表示文件未找到
- 如果平台显示为 `unknown`，点击 `🔄 刷新信息` 按钮

---

### 步骤4: 预览数据

#### 4.1 设置表头行

**默认值**: 表头行 = 1

**如果表头不在第1行**:

**场景示例**:
```
Excel文件结构：
第1行：【报表名称：商品销售数据】           ← 非数据行
第2行：【日期范围：2025-01-01 to 2025-01-31】 ← 非数据行
第3行：【商品ID】【商品名称】【销量】【价格】   ← 真正的表头行
```

**操作**:
1. 将"表头行"输入框从 `1` 改为 `3`
2. 点击 `🔄 重新预览` 按钮

#### 4.2 预览数据

**操作**: 点击 `👁️ 预览数据` 按钮

**系统显示**:
```
📊 数据预览 (共 1000 行，显示前 20 行)

┌────────┬──────────┬──────┬────────┬──────┬────────┐
│ 商品ID │ 商品名称 │ 销量 │ 价格   │ 库存 │ 评分   │
├────────┼──────────┼──────┼────────┼──────┼────────┤
│ SKU001 │ 蓝牙耳机 │  100 │  29.99 │  500 │   4.5  │
│ SKU002 │ 智能手表 │   80 │ 199.99 │  300 │   4.2  │
│ ...    │  ...     │  ... │  ...   │  ... │  ...   │
└────────┴──────────┴──────┴────────┴──────┴────────┘
```

**验证步骤**:
1. ✅ 检查列名是否正确（不应该是"列1"、"列2"这种）
2. ✅ 检查数据是否对齐（不应该数据在表头行）
3. ❌ 如果不对，调整表头行并重新预览

---

### 步骤5: 生成字段映射

**操作**: 点击 `🔗 生成字段映射` 按钮

**系统执行**:
- AI自动分析原始字段
- 匹配到标准字段
- 计算置信度
- 显示匹配方式

**映射表格示例**:
```
🎯 智能字段映射

┌────────────┬──────────────┬──────────┬──────────┬──────┐
│ 原始字段   │ 标准字段     │ 置信度   │ 匹配方式 │ 操作 │
├────────────┼──────────────┼──────────┼──────────┼──────┤
│ 商品ID     │ product_id   │  95%  ✓  │ 精确     │ 编辑 │
│ 商品名称   │ product_name │  90%  ✓  │ 模糊     │ 编辑 │
│ 销量       │ sales        │  65%  ⚠  │ 关键词   │ 编辑 │
│ 价格       │ price        │  90%  ✓  │ 精确     │ 编辑 │
└────────────┴──────────────┴──────────┴──────────┴──────┘

统计: 总字段4个 | 已映射4个 | 映射率100% | 高置信度3个
```

**置信度说明**:
- ✓ 绿色 (≥80%): 高置信度，可直接使用
- ⚠ 黄色 (60-80%): 中等置信度，建议人工确认
- ✗ 红色 (<60%): 低置信度，需要人工修正

**匹配方式**:
- **精确**: 字段名完全匹配
- **模糊**: 字段名相似度高
- **关键词**: 包含关键词
- **未识别**: 无法自动匹配

---

### 步骤6: 人工审核和修正

#### 方式1: 单个编辑

**操作**:
1. 点击某行的 `✏️ 编辑` 按钮
2. 在弹出对话框中选择正确的标准字段
3. 点击 `确定`

**标准字段列表**（products数据域）:
```
product_id       - 商品ID
product_name     - 商品名称
price            - 价格
sales            - 销量
stock            - 库存
rating           - 评分
category         - 分类
brand            - 品牌
sku              - SKU编码
description      - 描述
image_url        - 图片链接
status           - 状态
```

#### 方式2: 批量修正低置信度

**操作**:
1. 点击 `⚠️ 修正低置信度` 按钮
2. 系统弹出对话框，显示所有置信度<70%的字段
3. 逐行选择正确的标准字段
4. 点击 `确认修正`

#### 方式3: 直接在下拉框选择

**操作**:
1. 在"标准字段"列的下拉框中直接选择
2. 系统自动保存

---

### 步骤7: 保存映射模板（可选）

**操作**: 点击 `💾 保存为模板` 按钮

**系统保存**:
- 平台: shopee
- 数据域: products
- 粒度: daily
- 表头行: 3
- 字段映射: {商品ID: product_id, ...}

**下次使用**:
- 遇到相同格式的文件
- 点击 `📋 套用模板` 按钮
- 自动应用表头行和字段映射
- 只需点击 `✅ 确认映射并入库`

---

### 步骤8: 确认入库

**操作**: 点击 `✅ 确认映射并入库` 按钮

**系统执行**:
```
🔄 数据入库进度

✓ 读取文件 (表头行: 3)
✓ 应用字段映射
✓ 数据验证 (1000行)
  - 有效: 980行
  - 错误: 20行 → 已隔离到data_quarantine表
✓ 写入数据库
  - fact_product_metrics: 980行
  - data_quarantine: 20行
✓ 更新catalog_files状态为"ingested"

✅ 入库完成！
```

**入库结果**:
- 有效数据 → 写入对应的事实表
  - products → `fact_product_metrics`
  - orders → `fact_sales_orders`
  - finance → `fact_finance_records`
  - analytics → `fact_traffic_metrics`
- 错误数据 → 隔离到 `data_quarantine` 表
- 文件状态 → 更新 `catalog_files` 表

---

## 🔧 常见问题

### 问题1: 平台显示为"unknown"

**症状**: 文件名包含"虾皮"，但平台显示为"unknown"

**解决方法**:
1. 点击文件详情卡片右上角的 `🔄 刷新信息` 按钮
2. 系统会重新解析文件名
3. 如果还是unknown，手动选择正确的平台

### 问题2: 文件路径显示"文件未找到"

**症状**: 文件路径显示 `❌ 文件未找到`

**原因**:
- 文件可能被移动或删除
- 文件名格式不符合标准

**解决方法**:
1. 点击 `🔍 扫描采集文件` 重新扫描
2. 检查文件是否在 `temp/outputs/` 目录
3. 如果文件在其他位置，移动到标准目录

### 问题3: 数据预览不显示

**症状**: 点击"预览数据"后无反应

**解决方法**:
1. 检查文件路径是否显示 `✅`
2. 调整表头行设置（可能不是第1行）
3. 点击 `🔄 重新预览` 按钮
4. 查看浏览器控制台是否有错误

### 问题4: 表头识别错误

**症状**: 预览数据时，表头显示为数据内容

**原因**: Excel文件的表头不在第1行

**解决方法**:
1. 打开Excel文件，确认表头在第几行
2. 在"表头行"输入框输入正确的行号
3. 点击 `🔄 重新预览`

**示例**:
```
如果Excel文件是：
第1行: 【报表名称】
第2行: 【日期范围】
第3行: 【商品ID】【商品名称】...  ← 真正的表头

则"表头行"应该设置为 3
```

### 问题5: 字段映射置信度低

**症状**: 大部分字段显示黄色或红色警告

**原因**: 原始字段名与标准字段名差异大

**解决方法**:
1. 点击 `⚠️ 修正低置信度` 批量修正
2. 或逐行点击 `✏️ 编辑` 手动修正
3. 修正后保存为模板，下次直接使用

### 问题6: 数据入库失败

**症状**: 入库时报错或有大量数据被隔离

**原因**:
- 数据格式错误（日期、数字格式不对）
- 必填字段缺失
- 数据类型不匹配

**解决方法**:
1. 查看隔离数据详情（在"数据管理"模块）
2. 检查错误原因
3. 修正Excel文件后重新导入
4. 或调整字段映射

---

## 💡 最佳实践

### 1. 文件命名规范

**推荐格式**:
```
{时间戳}__{账号}__{店铺}__{数据类型}__{粒度}__{开始日期}_{结束日期}.xlsx
```

**示例**:
```
20250924_185940__虾皮巴西_东朗照明主体__the_king_s_lucky_shop__products__daily__2025-09-23_2025-09-23.xlsx
```

### 2. 表头行设置

**Excel文件设计**:
- ✅ 推荐: 表头在第1行
- ⚠️ 可以: 表头在第2-5行（手动设置）
- ❌ 避免: 表头在第5行以后（影响预览性能）

### 3. 字段映射模板

**首次映射**:
1. 仔细确认每个字段的映射正确性
2. 保存为模板
3. 记录模板版本号

**后续使用**:
1. 直接套用模板
2. 快速检查映射是否正确
3. 确认入库

### 4. 数据验证

**入库前检查**:
- ✅ 映射率 = 100%（所有字段都已映射）
- ✅ 高置信度 ≥ 80%（大部分字段匹配度高）
- ✅ 预览数据正常（表头和数据对齐）

**入库后检查**:
- 查看入库结果统计
- 检查隔离数据数量
- 如果隔离数据过多，检查原因

---

## 📊 数据流向

```
Excel文件 (temp/outputs/)
    ↓
字段映射系统（Vue.js前端）
    ↓
FastAPI后端（/api/field-mapping/ingest）
    ↓
数据处理管道
    ├─→ 有效数据 → PostgreSQL事实表
    │   ├─→ fact_sales_orders (订单)
    │   ├─→ fact_product_metrics (商品)
    │   ├─→ fact_finance_records (财务)
    │   └─→ fact_traffic_metrics (流量)
    │
    └─→ 错误数据 → data_quarantine表
    
PostgreSQL数据库
    ├─→ 实时查询（通过API）
    ├─→ 物化视图（定时刷新）
    └─→ 前端展示（销售看板/库存管理/财务管理）
```

---

## 🆘 获取帮助

### 在线文档
- **技术文档**: `docs/FIELD_MAPPING_OPTIMIZATION_SUMMARY.md`
- **API文档**: `docs/API_DOCUMENTATION.md`
- **开发规范**: `.cursorrules`

### 问题反馈
- 检查浏览器控制台错误信息
- 查看后端日志: `backend/logs/`
- 联系系统管理员

---

**文档版本**: v1.0  
**最后更新**: 2025-01-24  
**适用系统版本**: v4.3.1+

