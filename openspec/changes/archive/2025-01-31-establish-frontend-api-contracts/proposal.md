# 变更：建立前端API契约标准

## Why

当前系统中，后端API响应格式不统一，前端API调用分散在多个文件中，缺少统一的API契约规范。这导致：

1. **API响应格式不统一**：
   - 有些API返回`{"success": True, "data": {...}}`
   - 有些API直接返回数据对象
   - 有些API返回`{"error": True, "code": 500, "message": "..."}`
   - 错误处理格式不一致，前端难以统一处理

2. **前端API调用分散**：
   - API调用分散在`frontend/src/api/index.js`、`dashboard.js`、`finance.js`等多个文件中
   - 缺少统一的API调用规范和错误处理机制
   - 难以维护和扩展

3. **缺少API契约文档**：
   - 没有OpenSpec规范文档定义API契约标准
   - 新API开发时缺少参考标准
   - 前后端协作效率低

4. **前端大量使用Mock数据**：
   - 前端多个模块使用Mock数据（dashboard、store、sales、target、hr、inventory等）
   - 缺少真实数据对接，影响系统上线
   - Mock数据开关（`USE_MOCK_DATA`）存在但未完全替换

5. **数据分类传输规范缺失**：
   - A类（用户配置数据）、B类（业务数据）、C类（计算数据）缺少明确的传输规范
   - 不清楚哪些数据应该从哪个API获取
   - 数据在前端的应用场景不清晰

**这些问题影响了前后端协作效率和代码可维护性，更重要的是阻碍了系统上线，需要建立统一的API契约标准并替换Mock数据。**

## What Changes

- **建立API响应格式标准**：
  - 统一成功响应格式：`{"success": true, "data": {...}, "message": "...", "timestamp": "..."}`
  - 统一错误响应格式：`{"success": false, "error": {...}, "message": "...", "timestamp": "..."}`
  - 统一分页响应格式：`{"success": true, "data": [...], "pagination": {...}}`
  - 统一列表响应格式：`{"success": true, "data": [...], "total": 100}`

- **建立API错误处理标准**（企业级ERP标准）：
  - 统一HTTP状态码使用（200/400/401/403/404/500）
  - 统一业务错误码体系（4位数字，按模块细分）：
    - 1xxx系统错误（1001-1099数据库、1100-1199缓存、1200-1299消息队列等）
    - 2xxx业务错误（2001-2099订单、2100-2199库存、2200-2299财务、2300-2399销售、2400-2499数据同步）
    - 3xxx数据错误（3001-3099验证、3100-3199格式、3200-3299完整性、3300-3399隔离）
    - 4xxx用户错误（4001-4099认证、4100-4199权限、4200-4299参数、4300-4399频率限制）
  - 统一错误信息格式（错误码、错误类型、错误消息、错误详情、恢复建议）

- **建立前端API调用规范**：
  - 统一API调用方法命名规范（动词+名词，如`getOrderList`、`createOrder`）
  - 统一参数传递格式（查询参数、请求体）
  - 统一错误处理机制（拦截器、错误提示）

- **建立API数据格式标准**：
  - 统一日期时间格式（ISO 8601格式，UTC时区）
  - 统一金额格式（Decimal类型，保留2位小数）
  - 统一分页参数格式（page、page_size、sort、order）
  - **统一分页响应格式**：包含`pagination`对象（page、page_size、total、total_pages、has_previous、has_next）
  - **建立API版本控制**：URL路径版本控制（/api/v1/、/api/v2/），向后兼容至少2个主要版本
  - **建立性能监控**：监控API响应时间（P50/P95/P99）、错误率、缓存命中率、QPS等关键指标

- **创建OpenSpec规范文档**：
  - 创建`specs/frontend-api-contracts/spec.md`规范文档
  - 定义API响应格式、错误处理、数据格式等标准
  - 提供API开发指南和最佳实践

- **建立数据分类传输规范**：
  - 定义A类数据（用户配置数据）的API传输规范
  - 定义B类数据（业务数据）的API传输规范
  - 定义C类数据（计算数据）的API传输规范
  - 明确各类数据在前端的应用场景
  - **建立C类数据查询策略**（分层存储 + 混合查询模式）：
    - 物化视图保留2年（730天），支持年度对比和月度对比
    - 2-5年数据从fact表查询（索引优化）
    - 5年以上数据归档为monthly粒度（长期趋势分析）
    - 智能路由：多维度判断（时间/店铺/账号/平台），自动选择最优查询方式
    - 物化视图只存储daily粒度，weekly/monthly从daily聚合计算

- **替换前端Mock数据**（3阶段快速上线计划）：
  - **阶段1（第1周）**：核心功能（Dashboard业务概览、流量排名、店铺健康度评分）
  - **阶段2（第2周）**：业务功能（店铺管理、销售战役、目标管理、库存管理）
  - **阶段3（第3周）**：辅助功能（绩效管理、HR管理等）
  - 总计2-3周完成Mock数据替换，确保系统快速上线

## Impact

- **影响的规范**：
  - 新增`specs/frontend-api-contracts/spec.md`（API契约规范）
  - 可能需要更新`specs/dashboard/spec.md`（看板API规范）
  - 可能需要更新`specs/data-collection/spec.md`（数据采集API规范）

- **影响的代码**：
  - `backend/routers/*.py`（所有API路由，统一响应格式）
  - `backend/main.py`（全局异常处理，统一错误格式）
  - `frontend/src/api/index.js`（统一API调用规范）
  - `frontend/src/api/*.js`（各模块API文件，统一调用方式）
  - `frontend/src/utils/request.js`（请求拦截器，统一错误处理）

- **影响的文档**：
  - 创建`docs/API_CONTRACTS.md`（API契约文档）
  - 更新`docs/DEVELOPMENT_RULES/API_DESIGN.md`（API设计规范）

## 非目标

- 不改变现有API接口的URL路径（保持向后兼容）
- 不改变现有API的业务逻辑（只统一响应格式）
- 不引入新的技术依赖（使用现有技术栈）
- **不保留过渡期和兼容层**（系统未上线，直接按标准实施）
- **不采用渐进式迁移**（一次性统一所有API格式）

## 已知问题和风险

### 1. 响应格式不一致问题
- **问题**：部分API返回格式不统一
  - `dashboard_api.py`的`get_overview`返回`{"kpi": {...}, "last_update": "...", "source": "..."}`
  - `auto_ingest.py`返回`{"success": True, "data": {...}}`
  - `data_flow.py`返回`{"success": True, "task_id": "...", "flow_summary": {...}}`
- **影响**：前端需要适配多种响应格式
- **解决方案**：统一所有API响应格式，一次性修改所有API，不保留兼容层

### 2. API端点确认问题
- **问题**：部分Mock数据替换时提到的API端点需要确认是否存在
  - `/api/dashboard/traffic-ranking`（流量排名）- ✅ **已存在**
  - `/api/targets/{target_id}/calculate`（目标达成情况）- ✅ **已存在**（路径为`/api/targets`，非`/api/target-management`）
  - `/api/inventory/clearance-ranking`（滞销清理排名）- ❌ **不存在**（需创建，替代方案：`/api/dashboard/inventory/clearance`）
- **影响**：Mock数据替换可能失败
- **解决方案**：创建缺失的API端点`/api/inventory/clearance-ranking`，统一库存清理排名接口

### 3. 直接按标准实施
- **优势**：系统未上线，没有现有用户，可以直接统一格式
- **策略**：一次性统一所有API响应格式，不保留过渡期
- **好处**：避免技术债务，代码更清晰，维护更容易

### 4. C类数据查询策略问题
- **问题**：C类数据如果全部从物化视图查询，会导致物化视图过大问题
  - 前端需要支持日/周/月时间维度切换
  - 前端需要支持自定义时间范围（如2025-01-01到2025-01-15）
  - 业务需要支持多年数据对比（环比去年、前年、若干年）
  - 如果存储所有粒度组合（daily/weekly/monthly），会导致存储爆炸
- **影响**：物化视图过大，存储空间浪费，无法支持灵活查询和多年对比
- **解决方案**：采用分层存储 + 混合查询策略
  - **物化视图保留2年（730天）**：支持年度对比和月度对比
  - **2-5年数据从fact表查询**：索引优化，响应时间<2s
  - **5年以上数据归档为monthly粒度**：节省存储，支持长期趋势分析
  - **智能路由**：多维度判断（时间/店铺/账号/平台），自动选择最优查询方式
  - **物化视图只存储daily粒度**：weekly/monthly从daily聚合计算，避免存储爆炸

### 5. 错误处理不一致
- **问题**：错误响应格式不统一
- **影响**：前端难以统一处理错误
- **解决方案**：统一错误响应格式，建立错误码体系

### 6. 前端空数据处理问题（开发阶段容错）
- **问题**：开发阶段需要频繁重新入库数据，前端在数据缺失时可能报错
  - API返回null/undefined时前端可能抛出错误
  - 前端访问不存在的对象属性时可能报错
  - 影响数据变化观察和开发效率
- **影响**：前端报错中断开发流程，无法观察数据变化（从"-"变为实际值）
- **解决方案**：前端统一处理空数据，显示"-"或"0"，不抛出错误
  - 创建统一的数据格式化工具函数（formatValue、formatNumber、formatDate等）
  - 数值类型显示"-"（金额、数量、百分比）
  - 字符串类型显示"-"（名称、描述）
  - 日期时间类型显示"-"
  - 列表类型显示空状态提示（"暂无数据"）
  - 对象类型使用默认值和安全访问（可选链操作符?.）
  - 便于开发阶段观察数据变化（从"-"变为实际值）

## 当前状态

- ✅ 后端API已实现（FastAPI）
- ✅ 前端API调用已实现（Axios）
- ✅ 部分API已有统一响应格式（如`auto_ingest.py`）
- ✅ 后端已有部分真实数据API（dashboard_api、store_analytics、sales_campaign、target_management等）
- ✅ **系统处于开发阶段，未上线**（可以直接按标准实施，无需过渡期）
- ❌ 缺少统一的API契约规范文档
- ❌ API响应格式不统一
- ❌ 前端API调用分散，缺少统一规范
- ❌ 前端大量使用Mock数据，未对接真实API
- ❌ 缺少数据分类传输规范（A、B、C类数据）
- ❌ 前端缺少空数据处理规范（开发阶段容错）

## 实施策略

**由于系统处于开发阶段，未上线，我们采用直接按标准实施的策略：**

1. **一次性统一所有API响应格式**：不保留过渡期，直接统一所有API
2. **不添加兼容层**：直接按照统一标准实施，避免技术债务
3. **同步更新前后端**：前后端同步更新，确保格式一致
4. **全面测试验证**：统一格式后进行全面测试，确保功能正常
5. **数据流转全自动化**：B类数据入库后自动触发物化视图刷新，物化视图刷新后自动计算C类数据
6. **快速上线计划**：3阶段Mock数据替换，2-3周完成，确保系统快速上线
7. **前端空数据处理**：统一处理空数据，显示"-"或"0"，不抛出错误，便于开发阶段观察数据变化

