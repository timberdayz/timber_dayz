# 提案漏洞审计报告

## 审计日期
2025-01-31

## 审计范围
- proposal.md
- tasks.md
- design.md
- specs/data-sync/spec.md

## 发现的潜在漏洞

### 🔴 严重漏洞

#### 漏洞1：字段名映射关系不明确
**位置**: `specs/data-sync/spec.md` 第43行

**问题**:
- 规范中提到"使用正确的字段名（succeeded/quarantined/failed）显示完成消息"
- 但实际后端API返回的字段名是`valid_rows/quarantined_rows/error_rows`
- 前端API客户端（`getAutoIngestProgress`）有字段映射逻辑，但规范中没有明确说明

**影响**:
- 可能导致开发者误解，直接使用后端字段名
- 如果API客户端映射逻辑变更，前端代码可能失效

**建议修复**:
- 在规范中明确说明字段映射关系：
  - 后端返回：`valid_rows` → 前端使用：`succeeded`
  - 后端返回：`quarantined_rows` → 前端使用：`quarantined`
  - 后端返回：`error_rows` → 前端使用：`failed`
- 或者在规范中说明"前端应使用API客户端返回的字段名（已映射）"

**代码证据**:
```371:399:backend/services/sync_progress_tracker.py
    def _task_to_dict(self, task: SyncProgressTask) -> Dict[str, Any]:
        return {
            "valid_rows": task.valid_rows,
            "error_rows": task.error_rows,
            "quarantined_rows": task.quarantined_rows,
            ...
        }
```

```630:653:frontend/src/api/index.js
  async getAutoIngestProgress(taskId) {
    const data = await this._get(`/data-sync/progress/${taskId}`)
    return {
      succeeded: data.valid_rows || 0,  // ⭐ 映射
      quarantined: data.quarantined_rows || 0,  // ⭐ 映射
      failed: data.error_rows || 0,  // ⭐ 映射
      ...
    }
  }
```

### 🟡 中等漏洞

#### 漏洞2：备用查询场景不完整
**位置**: `specs/data-sync/spec.md` 第67-72行

**问题**:
- 规范中提到"前端尝试从任务列表获取任务信息（GET /api/data-sync/tasks）"
- 但没有说明如果任务列表也返回空数组或找不到匹配任务时的处理

**影响**:
- 可能导致前端无限轮询
- 用户体验差（一直显示"正在查询进度..."）

**建议修复**:
- 添加场景：如果任务列表查询失败或找不到匹配任务，前端应：
  - 记录警告日志
  - 继续轮询，但设置最大重试次数（如10次）
  - 如果达到最大重试次数，显示"无法获取进度，请刷新页面查看最新状态"

**代码证据**:
```4417:4438:frontend/src/views/FieldMappingEnhanced.vue
        if (syncProgress.value.total === 0) {
          try {
            const tasksResponse = await api._get('/data-sync/tasks')
            if (tasksResponse && Array.isArray(tasksResponse)) {
              const task = tasksResponse.find(t => t.task_id === taskId)
              if (task && task.total_files > 0) {
                // 更新进度...
              }
            }
          } catch (e) {
            console.warn('[PollProgress] 获取任务列表失败:', e)
          }
        }
```

#### 漏洞3：重试机制细节不明确
**位置**: `specs/data-sync/spec.md` 第88-92行

**问题**:
- 规范中提到"等待一小段时间后重试查询（最多3次）"
- 但没有明确说明等待时间的具体值
- 没有说明重试失败后的最终处理

**影响**:
- 可能导致实现不一致
- 如果等待时间过短，可能无法解决临时事务错误

**建议修复**:
- 明确说明等待时间：0.1秒、0.2秒、0.3秒（递增）
- 明确说明重试失败后返回null，前端应使用备用方案

**代码证据**:
```190:209:backend/services/sync_progress_tracker.py
                if retry_count < max_retries:
                    logger.warning(f"[SyncProgress] Retrying get_task {task_id} (retry {retry_count}/{max_retries})")
                    try:
                        self.db.rollback()
                    except:
                        pass
                    time.sleep(0.1 * retry_count)  # ⭐ 递增等待时间
                    continue
```

### 🟢 轻微漏洞

#### 漏洞4：错误响应格式不完整
**位置**: `specs/data-sync/spec.md` 第20-24行

**问题**:
- 规范中提到"错误响应包含错误码、错误类型、错误详情和恢复建议"
- 但没有说明错误响应的完整结构
- 没有说明前端如何解析错误响应

**建议修复**:
- 添加错误响应格式示例
- 说明前端应如何区分"查询失败"和"任务失败"

**代码证据**:
```407:415:backend/routers/data_sync.py
        if not task_info:
            return error_response(
                code=ErrorCode.FILE_NOT_FOUND,
                message=f"任务{task_id}不存在",
                error_type=get_error_type(ErrorCode.FILE_NOT_FOUND),
                recovery_suggestion="请检查任务ID是否正确，或查看任务列表确认任务是否存在",
                status_code=404
            )
```

#### 漏洞5：数据治理概览刷新时机不明确
**位置**: `specs/data-sync/spec.md` 第50-54行

**问题**:
- 规范中提到"同步完成（status为completed或failed）时自动刷新"
- 但没有说明刷新失败时的处理
- 没有说明刷新是否应该阻塞用户操作

**建议修复**:
- 明确说明刷新失败时应记录错误日志，但不影响同步结果
- 明确说明刷新是异步的，不阻塞用户操作

**代码证据**:
```4501:4502:frontend/src/views/FieldMappingEnhanced.vue
          // 刷新治理统计
          await refreshGovernanceStats()
```

## 建议修复优先级

1. **高优先级**（必须修复）:
   - 漏洞1：字段名映射关系不明确

2. **中优先级**（建议修复）:
   - 漏洞2：备用查询场景不完整
   - 漏洞3：重试机制细节不明确

3. **低优先级**（可选修复）:
   - 漏洞4：错误响应格式不完整
   - 漏洞5：数据治理概览刷新时机不明确

## 总体评估

提案整体质量良好，核心问题已识别并修复。但存在以下改进空间：

1. **字段名映射关系**：需要明确说明后端字段名和前端字段名的映射关系
2. **边界场景处理**：需要补充更多边界场景的处理说明
3. **错误处理细节**：需要更详细的错误处理说明

## 建议

1. 立即修复漏洞1（字段名映射关系）
2. 在实施前修复漏洞2和3（边界场景和重试机制）
3. 在文档更新时补充漏洞4和5（错误响应格式和刷新时机）

