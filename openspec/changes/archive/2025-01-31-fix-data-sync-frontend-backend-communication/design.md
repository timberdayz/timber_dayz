# 设计：数据同步前后端通信改进

## 背景

数据同步功能在实际使用中暴露了严重的前后端通信设计缺陷：

1. **后端成功但前端显示错误**：数据库事务错误导致进度查询失败
2. **数据治理概览不更新**：响应格式解析错误
3. **设计层面的根本问题**：异步任务和进度查询的分离设计

## 问题分析

### 问题1：数据库事务错误导致进度查询失败

**根本原因**：
- 后台任务使用独立数据库会话（`SessionLocal()`）
- 进度查询使用API会话（`get_db()`）
- 如果之前的操作在同一事务中失败，后续查询会失败

**表现**：
- `InFailedSqlTransaction`错误
- 前端无法获取进度
- 但后台任务继续执行并成功

**解决方案**：
- 每次查询前先回滚，确保使用干净的事务
- 添加重试机制，自动处理临时事务错误
- 在API层面也添加事务回滚

### 问题2：前端错误处理不足

**根本原因**：
- 访问null对象的属性（`response.value`）
- 错误消息不够清晰，无法区分"查询失败"和"任务失败"

**表现**：
- "Cannot read properties of null (reading 'value')"错误
- 用户看到错误提示，但实际数据已同步成功

**解决方案**：
- 添加完善的null检查
- 改进错误消息显示
- 添加备用方案：从任务列表获取进度信息

### 问题3：数据治理概览不更新

**根本原因**：
- 响应拦截器已提取data字段，但前端代码仍检查`overview.success`
- 同步完成后未自动刷新数据治理概览

**表现**：
- 数据治理概览显示0（今日自动入库）
- 统计数据不更新

**解决方案**：
- 修复响应格式解析逻辑
- 同步完成后自动刷新数据治理概览

### 问题4：设计层面的根本问题

**根本原因**：
- **异步任务和进度查询的分离设计**：
  - 后台任务使用独立数据库会话
  - 进度查询使用API会话
  - 两者之间缺乏事务一致性保证
- **错误传播机制不完善**：
  - 数据库事务错误导致进度查询失败
  - 但后台任务继续执行
  - 前端无法区分"查询失败"和"任务失败"
- **状态同步机制不完善**：
  - 同步完成后，前端无法可靠地获取最终状态
  - 数据治理概览不自动刷新

**长期解决方案**：
- 考虑使用WebSocket或SSE实现实时进度推送（替代轮询）
- 改进错误传播机制，确保前端能准确区分不同错误类型
- 添加状态一致性检查机制

## 目标

- **零前端错误**：前端不再因null响应或事务错误而崩溃
- **准确的状态显示**：前端显示的状态与后端实际状态一致
- **可靠的数据更新**：数据治理概览在同步完成后自动更新
- **完善的错误处理**：区分"查询失败"和"任务失败"，提供清晰的错误消息

## 非目标

- 不改变现有API接口（保持向后兼容）
- 不引入新的技术依赖（使用现有技术栈）
- 不改变数据库结构（仅改进事务管理）
- WebSocket/SSE实时推送（作为长期改进方向，不在本次变更范围内）

## 决策

### 决策1：数据库事务管理策略

**方案**：每次查询前先回滚，确保使用干净的事务，添加重试机制

**原因**：
- 防止`InFailedSqlTransaction`错误
- 自动处理临时事务错误
- 不影响现有API接口

**考虑的替代方案**：
- 使用独立的数据库连接池（过于复杂）
- 仅运行时错误处理（无法预防问题）

**实现**：
- 在`SyncProgressTracker.get_task()`中添加事务回滚逻辑
- 添加重试机制（最多3次）
- 在API层面也添加事务回滚

### 决策2：前端错误处理策略

**方案**：添加完善的null检查，改进错误消息显示，添加备用方案

**原因**：
- 防止前端崩溃
- 提供清晰的错误消息
- 提高用户体验

**考虑的替代方案**：
- 仅运行时错误处理（无法预防问题）
- 完全重构前端代码（过于破坏性）

**实现**：
- 添加response null检查
- 改进错误消息显示
- 添加备用方案：从任务列表获取进度信息

### 决策3：数据治理概览刷新策略

**方案**：修复响应格式解析逻辑，同步完成后自动刷新

**原因**：
- 确保统计数据正确显示
- 提高用户体验

**考虑的替代方案**：
- 手动刷新（用户体验差）
- 完全重构响应格式（过于破坏性）

**实现**：
- 修复响应格式解析逻辑（直接使用overview，不检查.success）
- 同步完成后自动刷新数据治理概览

### 决策4：进度轮询机制改进策略

**方案**：查询失败时显示"正在查询进度..."状态，添加备用方案

**原因**：
- 避免进度条不动
- 提供备用方案获取进度信息
- 提高用户体验

**考虑的替代方案**：
- 仅运行时错误处理（无法预防问题）
- 完全重构轮询机制（过于破坏性）

**实现**：
- 查询失败时显示"正在查询进度..."状态
- 添加备用方案：从任务列表获取进度信息
- 使用正确的字段名计算进度

## 风险/权衡

### 风险：破坏性变更

**缓解措施**：所有变更都是向后兼容的，现有代码继续工作

### 风险：性能影响

**缓解措施**：事务回滚和重试机制的性能影响可以忽略不计（<10ms）

### 风险：复杂性增加

**缓解措施**：错误处理逻辑集中管理，代码清晰易懂

## 迁移计划

### 阶段1：立即修复（已完成）

- 修复数据库事务管理
- 修复前端错误处理
- 修复数据治理概览刷新
- 改进进度轮询机制

### 阶段2：测试验证（已完成）

- 创建测试脚本验证修复是否成功
- 测试进度查询（5次连续查询全部成功）
- 测试数据治理概览刷新

### 阶段3：长期改进（待实施）

- 分析异步任务和进度查询的分离设计问题
- 评估WebSocket/SSE实时推送方案的可行性
- 设计改进的状态同步机制
- 实现状态一致性检查机制

## 开放问题

- WebSocket/SSE实时推送是否值得实施？（需要评估性能和复杂度）
- 是否需要添加状态一致性检查机制？（需要评估必要性）
- 是否需要改进错误传播机制？（需要评估用户体验影响）

