# 变更：修复数据同步前后端通信设计问题

## Why

数据同步功能在实际使用中暴露了严重的前后端通信设计缺陷：

### 核心问题

1. **后端成功但前端显示错误**：
   - 后端日志显示"批量同步完成:成功5个,失败0个"
   - 但前端显示"启动同步失败: Cannot read properties of null (reading 'value')"
   - 进度查询时遇到`InFailedSqlTransaction`错误，导致前端无法获取进度

2. **数据治理概览不更新**：
   - 同步完成后，数据治理概览（今日自动入库）仍然显示0
   - 前端响应格式解析错误，导致统计数据无法更新

3. **设计层面的根本问题**：
   - **异步任务和进度查询的分离设计**：后台任务使用独立数据库会话，进度查询使用API会话，两者之间缺乏事务一致性保证
   - **错误传播机制不完善**：数据库事务错误导致进度查询失败，但后台任务继续执行，前端无法区分"查询失败"和"任务失败"
   - **状态同步机制不完善**：同步完成后，前端无法可靠地获取最终状态，数据治理概览不自动刷新

### 问题影响

- **用户体验差**：用户看到错误提示，但实际数据已同步成功，造成困惑
- **数据不一致**：前端显示的状态与后端实际状态不一致
- **可观测性差**：无法准确监控同步进度和结果
- **维护困难**：错误处理逻辑分散，难以调试和修复

## What Changes

### 1. 改进数据库事务管理（核心修复）

- **问题**：进度查询时遇到`InFailedSqlTransaction`错误，导致查询失败
- **解决方案**：
  - 每次查询前先回滚，确保使用干净的事务
  - 添加重试机制（最多3次），自动处理临时事务错误
  - 在API层面也添加事务回滚，确保异常时正确清理

### 2. 改进前端错误处理

- **问题**：访问null对象的属性导致前端崩溃
- **解决方案**：
  - 添加完善的null检查，避免访问null的属性
  - 改进错误消息显示，区分"查询失败"和"任务失败"
  - 添加备用方案：查询失败时从任务列表获取进度信息

### 3. 改进数据治理概览刷新机制

- **问题**：响应格式解析错误，导致统计数据不更新
- **解决方案**：
  - 修复响应格式解析逻辑（响应拦截器已提取data字段）
  - 同步完成后自动刷新数据治理概览
  - 添加错误处理和日志输出

### 4. 改进进度轮询机制

- **问题**：查询失败时进度条不动，用户无法看到进度
- **解决方案**：
  - 查询失败时显示"正在查询进度..."状态
  - 添加备用方案：从任务列表获取进度信息
  - 使用正确的字段名计算进度

### 5. 设计层面的改进（长期）

- **问题**：异步任务和进度查询的分离设计导致状态不一致
- **解决方案**：
  - 考虑使用WebSocket或SSE实现实时进度推送（替代轮询）
  - 改进错误传播机制，确保前端能准确区分不同错误类型
  - 添加状态一致性检查机制

## Impact

- **影响的规范**：
  - 更新`specs/data-sync/spec.md`（改进进度查询、错误处理、状态同步需求）
  - 可能需要更新`specs/frontend-api-contracts/spec.md`（改进错误处理标准）
- **影响的代码**：
  - `backend/services/sync_progress_tracker.py`（事务管理改进）
  - `backend/routers/data_sync.py`（API错误处理改进）
  - `frontend/src/views/FieldMappingEnhanced.vue`（前端错误处理和进度显示改进）
  - `frontend/src/api/index.js`（API响应格式处理改进）
- **影响的文档**：
  - `docs/DATA_SYNC_ARCHITECTURE.md`（更新错误处理和状态同步机制）

## 非目标

- 不改变现有API接口（保持向后兼容）
- 不引入新的技术依赖（使用现有技术栈）
- 不改变数据库结构（仅改进事务管理）
- **注意**：WebSocket/SSE实时推送作为长期改进方向，不在本次变更范围内

## 当前状态

- ✅ 数据库事务管理已修复（每次查询前回滚，添加重试机制）
- ✅ 前端错误处理已改进（添加null检查，改进错误消息）
- ✅ 数据治理概览刷新已修复（修复响应格式解析）
- ✅ 进度轮询机制已改进（添加备用方案，改进状态显示）
- ✅ 测试验证通过（5次连续查询全部成功）
- ✅ **提案漏洞审计完成**（2025-01-31）：修复了5个潜在漏洞，包括字段名映射关系、备用查询场景、重试机制细节等
- ✅ **端到端测试完成**（2025-01-31）：所有3个测试场景通过，Unicode编码问题已修复
- ✅ **文档更新完成**（2025-01-31）：架构文档、规范变更、CHANGELOG全部更新
- ✅ **代码修复完成**（2025-01-31）：修复了data_sync_service.py中的Unicode字符问题
- ❌ **设计层面的根本问题**（异步任务和进度查询的分离设计）需要长期改进（不在本次变更范围内）

## 漏洞修复记录（2025-01-31）

提案审计发现并修复了以下漏洞：

1. **字段名映射关系不明确**（已修复）
   - 问题：规范中提到使用`succeeded/quarantined/failed`，但后端返回的是`valid_rows/quarantined_rows/error_rows`
   - 修复：在规范中明确说明字段映射关系，并说明API客户端已自动完成映射

2. **备用查询场景不完整**（已修复）
   - 问题：没有说明任务列表查询失败或找不到匹配任务时的处理
   - 修复：添加了连续10次查询失败后的处理逻辑

3. **重试机制细节不明确**（已修复）
   - 问题：没有明确说明等待时间的具体值和重试失败后的处理
   - 修复：明确说明等待时间递增（0.1秒、0.2秒、0.3秒）和重试失败后的处理

4. **错误响应格式不完整**（已修复）
   - 问题：没有说明错误响应的完整结构和前端如何解析
   - 修复：添加了错误响应格式示例和前端解析说明

5. **数据治理概览刷新时机不明确**（已修复）
   - 问题：没有说明刷新失败时的处理和是否阻塞用户操作
   - 修复：明确说明刷新是异步的，不阻塞用户操作，失败时只记录日志

详细审计报告见：`VULNERABILITY_AUDIT.md`

