# 设计：前后端数据流转改进

## 背景

系统频繁出现数据加载失败，原因包括：
1. 物化视图与查询代码之间的字段名不匹配
2. 前端API方法缺失
3. API响应格式不一致
4. 错误处理不完善

### 标准定义与实施之间的差距

虽然系统已经定义了完整的API契约标准（`API_CONTRACT.md` 和 `openspec/specs/frontend-api-contracts/spec.md`），但实际实施中存在以下问题：

**标准已定义但执行不一致**：
- ✅ API响应格式标准已定义（`success_response()` / `error_response()`）
- ✅ 前端响应拦截器已实现统一处理
- ❌ 部分API仍使用 `raise HTTPException` 而非 `error_response()`
- ❌ 前端调用 `api.getProducts()` 但方法不存在
- ❌ 数据库查询字段未验证，直接使用可能不存在的字段

**缺少强制执行机制**：
- 代码审查时未强制检查是否符合标准
- 新代码开发时可能未参考标准文档
- 缺少自动化验证工具（API契约测试、字段验证）

**数据库Schema与查询代码不同步**：
- 视图定义变更后，查询代码未同步更新
- 缺少字段存在性验证机制
- SQL查询直接使用字段名，未验证是否存在

**前后端协作不同步**：
- 前端期望的方法后端未实现
- 后端实现的API前端未正确调用
- 响应格式变更时前后端未同步更新

## 目标

- **零API调用失败**：所有前端API调用应成功或提供清晰的错误消息
- **一致的响应格式**：所有API返回相同结构的数据
- **字段验证**：数据库查询在执行前验证字段存在性
- **用户友好的错误**：所有错误包含恢复建议

## 非目标

- 完整的API重新设计（仅增量修复）
- 新的数据库schema变更（仅修复现有视图）
- 前端框架变更（在Vue.js 3框架内工作）

## 决策

### 决策1：字段验证策略

**方案**：在 `MaterializedViewService` 中查询执行前添加字段存在性验证

**原因**：防止字段名不匹配导致的运行时错误

**考虑的替代方案**：
- 构建时静态SQL验证（过于复杂）
- 仅运行时错误处理（无法预防问题）

**实现**：
- 查询视图元数据获取可用字段
- 执行前验证SELECT和ORDER BY字段
- 如果字段不存在，返回清晰的错误

### 决策2：API响应格式标准化

**方案**：所有API响应使用 `success_response()` 包装器

**原因**：确保所有端点格式一致

**考虑的替代方案**：
- 每个端点自定义响应格式（过于不一致）
- 为每种格式创建前端适配器（过于复杂）

**实现**：
- 所有端点使用 `success_response(data=...)` 包装器
- 分页响应包含 `data`, `total`, `page`, `page_size`
- 错误响应使用 `error_response()` 并提供恢复建议

### 决策3：前端API方法添加

**方案**：添加缺失的 `getProducts()` 方法并改进错误处理

**原因**：前端代码期望这些方法存在

**考虑的替代方案**：
- 重构前端使用现有方法（过于破坏性）
- 移除前端调用（破坏功能）

**实现**：
- 在 `frontend/src/api/index.js` 中添加 `getProducts()` 方法
- 为所有API调用添加错误处理包装
- 提供用户友好的错误消息

## 风险/权衡

### 风险：破坏性变更
**缓解措施**：所有变更都是向后兼容的，现有代码继续工作

### 风险：性能影响
**缓解措施**：字段验证增加的开销很小（<10ms），可以缓存

### 风险：修复覆盖不完整
**缓解措施**：对所有受影响的端点和页面进行全面测试

## 迁移计划

1. **阶段1**：修复数据库字段不匹配（无破坏性变更）
2. **阶段2**：添加缺失的前端API方法（仅添加）
3. **阶段3**：标准化API响应格式（向后兼容）
4. **阶段4**：改进错误处理（增量改进）

**回滚**：如果出现问题，每个阶段可以独立回滚

## 开放问题

- 是否应该添加API版本控制以防止未来的格式不匹配？
- 是否应该实现API契约测试以及早捕获不匹配？
- 是否应该添加字段名常量以防止拼写错误？
- 如何确保新代码自动遵循标准？
- 是否应该添加pre-commit钩子来验证API响应和字段名？

## 标准执行保障机制

### 问题：标准已定义但执行不一致

**根本原因**：
1. 缺少自动化验证工具
2. 代码审查时未强制检查
3. 新代码开发时未参考标准

**解决方案**：
1. **建立自动化验证机制**：
   - API契约测试（验证响应格式）
   - 数据库字段验证（查询前检查）
   - 前端API方法存在性检查

2. **建立代码审查检查清单**：
   - [ ] API是否使用 `success_response()` / `error_response()`？
   - [ ] 前端调用的API方法是否存在？
   - [ ] 数据库查询字段是否存在于schema中？
   - [ ] 错误响应是否包含恢复建议？

3. **建立变更同步机制**：
   - Schema变更时自动检查查询代码
   - API变更时自动检查前端调用
   - 响应格式变更时同步更新前后端

### 实施优先级

**高优先级（立即修复）**：
1. 数据库字段不匹配问题（导致SQL错误）
2. 前端API方法缺失（导致运行时错误）
3. 错误处理不一致（导致错误信息不友好）

**中优先级（1-2周内）**：
1. API响应格式统一
2. 错误处理改进
3. 前端代码修复

**低优先级（2-3周内）**：
1. 自动化验证机制建立
2. 代码审查检查清单
3. 文档更新

