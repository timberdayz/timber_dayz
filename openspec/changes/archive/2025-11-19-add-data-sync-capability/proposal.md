# 变更：添加数据同步能力规范

## Why

数据同步功能是数据采集流程的关键环节，连接了数据采集和字段映射系统。虽然功能已经实现（v4.12.0），但缺少OpenSpec规范文档，导致：
1. 新开发者难以理解数据同步的完整流程和职责边界
2. 缺少明确的需求定义，影响功能扩展和维护
3. 与其他能力（数据采集、字段映射）的集成关系不清晰

## What Changes

- **新增能力规范**：在`specs/data-sync/`目录下创建完整的数据同步能力规范
- **定义核心需求**：
  - 单文件数据同步流程
  - 批量数据同步流程
  - 异步处理和并发控制
  - 进度跟踪和历史记录
  - 数据质量Gate检查
  - 错误处理和重试机制
- **明确集成关系**：与数据采集、字段映射、数据入库系统的集成点

## Impact

- **影响的规范**：
  - 新增`specs/data-sync/spec.md`（新能力）
  - 可能需要更新`specs/data-collection/spec.md`（明确数据同步是采集后的步骤）
  - 可能需要更新`specs/field-mapping/spec.md`（明确模板匹配在同步中的作用）
- **影响的代码**：
  - `backend/routers/data_sync.py`（API路由）
  - `backend/services/data_sync_service.py`（核心服务）
  - `backend/services/sync_progress_tracker.py`（进度跟踪）
  - `backend/services/data_ingestion_service.py`（数据入库）
- **影响的文档**：
  - `docs/DATA_SYNC_ARCHITECTURE.md`（架构文档，需要与规范对齐）

## 非目标

- 不修改现有实现（功能已实现，仅文档化）
- 不引入新的技术依赖（使用FastAPI BackgroundTasks，无需Celery）
- 不改变API接口（保持向后兼容）

## 当前状态和问题（v4.12.1）

### 已实现功能
- ✅ 单文件数据同步API和前端界面
- ✅ 批量数据同步API和前端界面
- ✅ 同步进度跟踪和任务日志
- ✅ 数据流转追踪
- ✅ 对比报告和丢失数据详情显示

### 存在的问题

#### 1. 数据丢失问题（持续存在）
- **问题**：数据同步精确度未达到100%，持续存在数据丢失（37行）
- **影响**：数据完整性无法保证，影响业务决策
- **优先级**：🔴 高优先级
- **状态**：需要深化解决

#### 2. 字段映射应用问题（可能未完全解决）
- **问题**：虽然已修复platform_code和shop_id，但可能还有其他字段映射问题
- **影响**：数据可能因为字段缺失或格式错误导致失败
- **优先级**：🟡 中优先级
- **状态**：需要验证和优化

#### 3. 对比报告丢失数据详情（需要验证）
- **问题**：虽然已添加功能，但需要验证是否正常工作
- **影响**：用户无法判断哪些数据丢失，难以修复问题
- **优先级**：🟡 中优先级
- **状态**：需要验证

#### 4. 数据流转追踪问题（部分未解决）
- **问题**：某些情况下显示"暂无流转数据"
- **影响**：无法追踪数据流转情况
- **优先级**：🟢 低优先级
- **状态**：需要进一步调试

### 下一步计划

1. **深化数据丢失问题调查**（v4.12.2）
   - 添加详细的数据丢失追踪日志
   - 实现数据丢失自动分析功能
   - 增强隔离机制的错误处理

2. **优化字段映射应用**（v4.12.2）
   - 优化字段映射应用流程
   - 优化Pattern Matcher的运行时机
   - 增强字段映射验证

3. **验证对比报告功能**（v4.12.2）
   - 测试对比报告API和前端显示
   - 修复发现的问题

4. **优化数据流转追踪**（v4.12.3）
   - 优化数据流转查询逻辑
   - 增强数据流转可视化

