## 1. 规范文档化

- [x] 1.1 创建变更提案（proposal.md）
- [x] 1.2 创建实施清单（tasks.md）
- [x] 1.3 创建技术设计文档（design.md）
- [x] 1.4 创建规范增量文件（specs/data-sync/spec.md）
- [x] 1.5 验证规范格式（格式验证通过，符合OpenSpec要求）

## 2. 规范内容编写

- [x] 2.1 定义单文件数据同步需求
- [x] 2.2 定义批量数据同步需求
- [x] 2.3 定义异步处理和并发控制需求
- [x] 2.4 定义进度跟踪需求
- [x] 2.5 定义数据质量Gate需求
- [x] 2.6 定义错误处理和重试需求
- [x] 2.7 为每个需求添加至少一个场景（Scenario）

## 3. 集成关系明确

- [x] 3.1 明确与数据采集系统的集成点
- [x] 3.2 明确与字段映射系统的集成点
- [x] 3.3 明确与数据入库系统的集成点
- [x] 3.4 检查是否需要更新其他能力的规范（当前不需要更新）

## 4. 验证和归档

- [x] 4.1 运行严格验证（格式验证通过）
- [x] 4.2 修复所有验证错误（无错误）
- [x] 4.3 将规范从changes移动到specs目录（已归档）
- [x] 4.4 更新openspec/README.md说明新增能力（已更新）

## 5. 实际实现和问题修复（v4.12.1）

### 5.1 后端API实现
- [x] 5.1.1 实现单文件数据同步API（/data-sync/single）
- [x] 5.1.2 实现批量数据同步API（/data-sync/batch）
- [x] 5.1.3 实现进度查询API（/data-sync/progress/{task_id}）
- [x] 5.1.4 实现任务日志API（/field-mapping/auto-ingest/task/{task_id}/logs）
- [x] 5.1.5 实现数据流转追踪API（/data-flow/trace/task/{task_id}和/data-flow/trace/file/{file_id}）

### 5.2 前端界面实现
- [x] 5.2.1 实现单文件同步界面
- [x] 5.2.2 实现批量同步配置界面
- [x] 5.2.3 实现同步进度对话框（进度概览、任务日志、数据流转）
- [x] 5.2.4 实现完成和取消按钮功能

### 5.3 数据流转追踪问题修复（v4.12.1）
- [x] 5.3.1 修复FactProductMetric.file_id字段错误（改为source_catalog_id）
- [x] 5.3.2 修复DataQuarantine.file_id字段错误（改为catalog_file_id）
- [x] 5.3.3 修复数据流转查询逻辑

### 5.4 数据库事务问题修复（v4.12.1）
- [x] 5.4.1 修复数据同步服务的事务回滚处理
- [x] 5.4.2 修复数据入库服务的事务回滚处理
- [x] 5.4.3 修复隔离数据失败时的事务处理
- [x] 5.4.4 修复文件状态更新失败时的事务处理

### 5.5 外键约束问题修复（v4.12.1）
- [x] 5.5.1 修复staging_orders表外键约束错误（验证file_id是否存在）
- [x] 5.5.2 添加file_id验证逻辑，避免引用不存在的catalog_files记录

### 5.6 表头行严格执行（v4.12.1）
- [x] 5.6.1 修复模板表头行应用逻辑（如果模板设置了表头行，严格执行，不进行自动检测）
- [x] 5.6.2 添加表头行严格执行的日志记录

### 5.7 前端交互问题修复（v4.12.1）
- [x] 5.7.1 修复完成按钮不关闭对话框的问题
- [x] 5.7.2 修复对话框关闭处理逻辑（before-close和@close事件）
- [x] 5.7.3 修复同步失败时completed状态设置，允许用户关闭对话框

### 5.8 数据库结构修复（v4.12.1）
- [x] 5.8.1 修复staging_orders表外键约束（从data_files改为catalog_files）
- [x] 5.8.2 添加staging_product_metrics表的metric_data字段
- [x] 5.8.3 修复完成按钮无法点击的问题（添加调试日志，确保对话框关闭）

### 5.9 数据入库问题修复（v4.12.1）
- [x] 5.9.1 修复upsert_orders_v2函数未设置file_id字段的问题（导致数据无法追踪到fact层）
- [x] 5.9.2 修复任务日志API查询data_quarantine时使用错误字段名的问题（file_id → catalog_file_id）

### 5.10 任务日志和数据丢失问题修复（v4.12.1）
- [x] 5.10.1 修复任务日志API缺少text导入的问题（NameError: name 'text' is not defined）
- [x] 5.10.2 修复get_file_logs函数查询data_quarantine时使用错误字段名的问题
- [x] 5.10.3 修复同步进度对话框关闭和完成按钮无法点击的问题（移除before-close，简化关闭逻辑）

### 5.11 数据丢失问题修复（v4.12.1）
- [x] 5.11.1 分析36行数据丢失的原因（692行Raw/Staging，656行Fact，丢失36行）
  - 原因：upsert_orders_v2函数在遇到错误时continue跳过，但未记录到隔离区
  - 验证通过但入库时失败（主键冲突、数据类型错误等）的订单被跳过但没有隔离
- [x] 5.11.2 实现失败订单的自动隔离机制（当upsert失败时自动隔离到data_quarantine表）

### 5.12 原始数据层和对比报告问题修复（v4.12.1）
- [x] 5.12.1 修复原始数据层查看API：跳过表头行之前的数据（使用skiprows参数）
- [x] 5.12.2 修复对比报告API：使用catalog_file_id字段查询隔离区（修复DataQuarantine.file_id错误）
- [x] 5.12.3 修复完成按钮无响应问题：确保completed状态正确设置，按钮事件绑定正确

### 5.13 字段映射和数据丢失问题修复（v4.12.1）
- [x] 5.13.1 修复字段映射应用问题：确保platform_code和shop_id从file_record获取（即使字段映射中没有这些字段）
- [x] 5.13.2 修复数据入库时platform_code和shop_id为null的问题（从file_record自动补充）
- [x] 5.13.3 增强数据丢失追踪：upsert失败时自动隔离到data_quarantine表

### 5.14 Pattern Matcher警告和数据丢失问题修复（v4.12.1）
- [x] 5.14.1 修复Pattern Matcher警告：跳过已经映射的字段，避免对已映射字段再次匹配
- [x] 5.14.2 修复shop_id处理：优先从file_record获取shop_id，避免主键为空导致数据丢失
- [x] 5.14.3 增强shop_id兜底逻辑：如果file_record没有shop_id，从文件名提取或使用时间戳

### 5.15 对比报告丢失数据详情显示（v4.12.1）
- [x] 5.15.1 修复对比报告API：添加丢失数据详情查询逻辑（Staging→Fact丢失的订单详情）
- [x] 5.15.2 修复前端显示：添加丢失数据详情表格显示，支持订单和产品数据域
- [x] 5.15.3 修复查询逻辑：添加详细日志记录和异常处理，确保查询失败时也能返回提示

### 5.16 待修复问题（v4.12.1 - 需要深化解决）

#### 5.16.1 数据丢失问题（持续存在）
- [x] **问题描述**：数据同步精确度未达到100%，持续存在数据丢失
  - 最新测试：Raw: 693行，Staging: 692行，Fact: 656行，丢失37行
  - 隔离区显示为0，说明丢失的数据没有被隔离
  - 虽然已添加自动隔离机制，但可能在某些情况下未正常工作
- [x] **可能原因**：
  1. 自动隔离机制可能在某些异常情况下失败（事务回滚、数据库连接问题等）
  2. 数据在验证阶段失败，但没有被隔离（验证失败的数据可能直接跳过）
  3. 数据在staging阶段失败，但没有被隔离（staging失败的数据可能直接跳过）
  4. 主键冲突或其他数据库约束错误导致数据丢失，但隔离机制未捕获
  5. shop_id或其他关键字段处理逻辑可能仍有问题，导致数据无法入库
- [x] **已完成的修复（v4.12.2）**：
  - [x] 增强staging阶段错误处理：`stage_orders`、`stage_product_metrics`函数添加逐条处理和自动隔离机制
  - [x] 添加数据丢失追踪日志：记录每个阶段的数据数量（Raw→Staging→Fact）
  - [x] 确保staging失败的数据被隔离：逐条处理失败时自动隔离到data_quarantine表
  - [x] 增强upsert阶段的隔离机制：已存在自动隔离机制（v4.12.1）
- [ ] **需要进一步调查**：
  - [ ] 检查自动隔离机制的日志，确认是否有隔离失败的记录
  - [ ] 检查验证阶段的错误处理，确认验证失败的数据是否被隔离
  - [ ] 检查数据库约束错误处理，确认主键冲突等错误是否被正确隔离
  - [ ] 检查对比报告中的丢失数据详情，分析丢失数据的共同特征

#### 5.16.2 字段映射应用问题（可能未完全解决）
- [ ] **问题描述**：虽然已修复platform_code和shop_id的获取，但可能还有其他字段映射问题
  - 后端日志显示Pattern Matcher警告，但模板中已有映射
  - 某些字段可能没有正确映射到标准字段
  - 数据入库时可能因为字段缺失或格式错误导致失败
- [ ] **需要调查**：
  - [ ] 检查字段映射应用的完整流程，确认所有字段是否都正确映射
  - [ ] 检查Pattern Matcher的运行时机，确认是否在字段映射之后还在运行
  - [ ] 检查数据标准化函数，确认是否正确处理所有字段
  - [ ] 检查丢失数据的字段特征，确认是否有特定字段导致数据丢失

#### 5.16.3 数据流转追踪问题（部分未解决）
- [ ] **问题描述**：数据流转追踪在某些情况下显示"暂无流转数据"
  - 虽然已修复FactProductMetric和DataQuarantine的字段引用，但可能还有其他问题
  - 某些文件的数据流转信息可能无法正确查询
- [ ] **需要调查**：
  - [ ] 检查数据流转查询逻辑，确认是否正确查询所有数据层
  - [ ] 检查file_id字段的设置，确认所有数据层都正确设置了file_id
  - [ ] 检查数据流转API的日志，确认查询失败的原因

#### 5.16.4 对比报告丢失数据详情显示（需要验证）
- [ ] **问题描述**：虽然已添加丢失数据详情显示功能，但需要验证是否正常工作
  - 用户反馈对比报告中看不到丢失数据详情
  - 需要确认查询逻辑是否正确，前端显示是否正确
- [ ] **需要验证**：
  - [ ] 测试对比报告API，确认是否正确返回丢失数据详情
  - [ ] 测试前端显示，确认是否正确显示丢失数据详情表格
  - [ ] 检查日志，确认查询逻辑是否正确执行

#### 5.16.5 文件注册流程问题（需要检查）
- [ ] **问题描述**：订单数据同步时可能出现file_id不存在的问题
  - 虽然已添加file_id验证逻辑，但可能在某些情况下仍然失败
  - 需要检查文件注册流程，确认文件是否正确注册到catalog_files表
- [ ] **需要调查**：
  - [ ] 检查文件注册流程，确认文件是否正确注册
  - [ ] 检查file_id的传递流程，确认是否正确传递到所有数据层
  - [ ] 检查文件注册的时机，确认是否在数据同步之前完成

### 5.17 深化解决方案（v4.12.2+）

#### 5.17.1 数据丢失问题深度调查
- [x] 5.17.1.1 添加详细的数据丢失追踪日志（记录每个阶段的数据数量）✅ v4.12.2完成
- [ ] 5.17.1.2 实现数据丢失自动分析功能（分析丢失数据的共同特征）
- [x] 5.17.1.3 增强隔离机制的错误处理（确保所有失败的数据都被隔离）✅ v4.12.2完成（staging阶段）
- [ ] 5.17.1.4 实现数据丢失预警机制（当数据丢失率超过阈值时告警）

#### 5.17.2 字段映射应用优化
- [ ] 5.17.2.1 优化字段映射应用流程（确保所有字段都正确映射）
- [ ] 5.17.2.2 优化Pattern Matcher的运行时机（避免重复匹配已映射字段）
- [ ] 5.17.2.3 增强字段映射验证（验证映射后的数据是否完整）
- [ ] 5.17.2.4 实现字段映射质量评分（评估字段映射的准确性）

#### 5.17.3 数据流转追踪优化
- [ ] 5.17.3.1 优化数据流转查询逻辑（确保正确查询所有数据层）
- [ ] 5.17.3.2 增强数据流转可视化（提供更直观的数据流转图表）
- [ ] 5.17.3.3 实现数据流转异常检测（检测数据流转中的异常情况）

#### 5.17.4 对比报告功能增强
- [ ] 5.17.4.1 增强丢失数据详情查询（支持更多数据域和查询条件）
- [ ] 5.17.4.2 实现丢失数据导出功能（导出丢失数据到Excel）
- [ ] 5.17.4.3 实现丢失数据分析功能（分析丢失数据的原因和模式）

