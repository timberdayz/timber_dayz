# 数据库设计规则审查报告

**生成时间**: 2025-11-19  
**审查范围**: shop_id主键约束、事实表结构、物化视图结构  
**审查方法**: 数据库统计分析、代码审查、架构分析

---

## 1. shop_id主键约束与数据源不匹配问题分析

### 1.1 当前数据库状态

根据数据库统计分析（`scripts/analyze_db_design_rules.py`）：

- **catalog_files表**：
  - 总文件数: 412
  - 有shop_id的文件数: 412 (100.0%)
  - 没有shop_id的文件数: 0 (0.0%)
  - 需要手动指派shop_id的文件数 (status='needs_shop'): 0

- **FactOrder表**：
  - 总订单数: 708
  - 有shop_id的订单数: 708 (100.0%)
  - 没有shop_id的订单数: 0 (0.0%)

- **StagingOrders表**：
  - 总staging记录数: 747
  - 有shop_id的记录数: 747 (100.0%)
  - 没有shop_id的记录数: 0 (0.0%)

### 1.2 问题分析

虽然当前数据库中所有数据都有shop_id，但这**不能说明源数据文件本身有shop_id字段**。实际情况是：

1. **数据入库流程中的shop_id处理**：
   - 在`backend/services/data_ingestion_service.py`中，有逻辑确保shop_id从`file_record`获取：
   ```python
   # ⭐ v4.12.1修复：确保platform_code和shop_id字段存在（从file_record获取）
   if not row.get("shop_id"):
       if file_record.shop_id:
           row["shop_id"] = file_record.shop_id
       else:
           logger.warning(f"[Ingest] ⚠️ shop_id为空，设置为None")
           row["shop_id"] = None  # shop_id允许为None
   ```

2. **FactOrder主键约束**：
   - `FactOrder`的主键是`(platform_code, shop_id, order_id)`
   - shop_id是主键的一部分，**不能为NULL**
   - 如果`file_record.shop_id`也为空，数据将无法入库到FactOrder

3. **源数据文件实际情况**：
   - 根据用户反馈，大量源数据文件本身**没有shop_id字段**
   - shop_id需要从路径/元数据推断或手动指派
   - 这导致数据同步时必须强制提供shop_id，即使源数据中没有

### 1.3 根本问题

**shop_id主键约束与数据源不匹配**：
- 数据库设计假设所有数据都有shop_id（作为主键的一部分）
- 但源数据文件可能没有shop_id字段
- 这导致数据同步时必须强制提供shop_id，增加了出错风险

---

## 2. 事实表结构与源数据不匹配问题分析

### 2.1 FactOrder表结构

**主键**: `(platform_code, shop_id, order_id)`

**问题**：
- shop_id是主键的一部分，不能为NULL
- 但源数据可能没有shop_id字段
- 如果file_record也没有shop_id，数据将无法入库

### 2.2 FactProductMetric表结构

**主键**: `id` (自增)  
**唯一索引**: `(platform_code, shop_id, platform_sku, metric_date)`

**注意**：
- v4.10.0更新后，platform_code和shop_id允许NULL（支持inventory域的仓库级数据）
- 但其他域（products、traffic、analytics）仍然需要shop_id

### 2.3 数据丢失情况

根据分析脚本结果：
- Staging中有但Fact中没有的订单数（shop_id不为空）: 0
- Staging中shop_id为空的记录数: 0

**注意**：这可能是因为当前数据已经处理过，或者shop_id获取逻辑已经生效。

---

## 3. 物化视图结构与字段映射输出不匹配问题分析

### 3.1 现有物化视图

系统中有20个物化视图，包括：
- `mv_sales_day_shop_sku` - 日粒度销售聚合
- `mv_pnl_shop_month` - 店铺月度P&L
- `mv_shop_product_summary` - 店铺产品汇总
- `mv_shop_traffic_day` - 店铺流量
- 等等...

### 3.2 问题分析

**物化视图都依赖shop_id字段**：
- 所有物化视图都使用`shop_id`作为聚合维度
- 如果源数据没有shop_id，物化视图可能无法正确聚合
- 物化视图的字段可能与字段映射输出不完全匹配

**需要进一步审查**：
- 对比字段映射辞典和物化视图字段
- 识别不匹配的字段和规则
- 评估是否需要调整物化视图结构

---

## 4. 数据库设计规则缺失问题

### 4.1 缺少的规则

1. **数据归属规则**：
   - 没有明确规则定义何时需要shop_id，何时不需要
   - 没有规则定义平台级数据如何处理

2. **字段必填规则**：
   - 没有明确规则定义哪些字段必填，哪些可选
   - shop_id在某些情况下必填，但在某些情况下可选（如inventory域）

3. **主键设计规则**：
   - 没有明确规则定义何时使用复合主键，何时允许NULL
   - 没有规则定义主键字段的选择原则

4. **事实表和物化视图设计规则**：
   - 没有明确规则定义事实表和物化视图应该如何设计
   - 没有规则定义如何匹配源数据和字段映射输出

### 4.2 影响

- 导致后续开发中出现不一致和问题
- 数据同步可靠性问题可能源于数据库设计规则本身
- 需要创建OpenSpec规范文档来明确这些规则

---

## 5. 优化建议

### 5.1 shop_id主键约束问题

**建议1：评估shop_id是否应该作为主键的一部分**
- 如果大量源数据没有shop_id，考虑调整主键设计
- 选项A：允许shop_id为NULL（对于平台级数据）
- 选项B：使用account_id替代shop_id
- 选项C：继续使用shop_id，但改进解析机制

**建议2：改进shop_id获取逻辑**
- 增强shop_id解析机制，提高自动解析准确率
- 改进shop_id验证逻辑，确保所有数据都有shop_id
- 添加shop_id缺失的预警机制

### 5.2 事实表结构问题

**建议1：评估是否需要调整表结构**
- 评估是否需要调整FactOrder主键设计
- 评估是否需要调整FactProductMetric的唯一索引设计

**建议2：增强数据验证**
- 在数据入库前验证shop_id是否存在
- 如果shop_id缺失，提供明确的错误提示
- 记录shop_id缺失的数据，便于后续处理

### 5.3 物化视图问题

**建议1：审查物化视图字段**
- 对比字段映射辞典和物化视图字段
- 识别不匹配的字段和规则
- 评估是否需要调整物化视图结构

**建议2：增强物化视图文档**
- 明确物化视图的字段来源
- 明确物化视图的聚合规则
- 明确物化视图与字段映射输出的关系

### 5.4 数据库设计规则文档

**建议：创建OpenSpec规范文档**
- 定义数据归属规则（shop_id、account_id等）
- 定义字段必填规则（哪些字段必填，哪些可选）
- 定义主键设计规则（何时使用复合主键，何时允许NULL）
- 定义事实表和物化视图设计规则

---

## 6. 风险评估

### 6.1 如果修改主键设计

**风险**：
- 需要修改现有数据
- 可能影响现有查询和物化视图
- 需要更新所有相关代码

**成本**：
- 高：需要大量开发和测试工作
- 需要数据迁移脚本
- 需要回滚方案

### 6.2 如果继续使用shop_id

**风险**：
- 数据同步可靠性问题可能持续存在
- 需要持续改进shop_id解析机制
- 需要处理shop_id缺失的情况

**成本**：
- 中：需要改进shop_id获取逻辑
- 需要增强数据验证
- 需要添加预警机制

---

## 7. 下一步行动

1. **创建OpenSpec规范文档**（优先级：最高）
   - 定义数据库设计规则
   - 明确数据归属规则、字段必填规则、主键设计规则

2. **评估优化方案**（优先级：高）
   - 评估shop_id是否应该作为主键的一部分
   - 评估是否需要调整表结构
   - 评估是否需要调整物化视图结构

3. **如果发现根本性问题**（优先级：中）
   - 创建数据库结构优化方案
   - 定义迁移计划和回滚方案
   - 创建单独的变更提案

---

## 8. 结论

经过审查，发现以下根本性问题：

1. **shop_id主键约束与数据源不匹配**：数据库设计假设所有数据都有shop_id，但源数据文件可能没有shop_id字段
2. **事实表和物化视图与源数据不匹配**：表结构不完全符合源数据的实际结构
3. **数据库设计缺少OpenSpec规范**：缺少明确的设计规则，导致后续开发中出现不一致和问题

**建议优先创建OpenSpec规范文档**，明确数据库设计规则，然后根据规范评估是否需要调整数据库结构。

