# 技术设计：提升数据同步可靠性

## Context

数据同步功能已经实现并归档（v4.12.0），但在实际使用中发现了一些影响数据完整性和可靠性的问题。**更重要的是，经过深入分析，我们发现这些问题的根源可能在于数据库设计规则本身**：

### 根本性问题（数据库设计规则）

1. **shop_id主键约束与数据源不匹配**：
   - `FactOrder`的主键是`(platform_code, shop_id, order_id)`，shop_id是主键的一部分，不能为NULL
   - 但大量源数据文件本身没有shop_id字段，需要从路径/元数据推断或手动指派
   - 这导致数据同步时必须强制提供shop_id，即使源数据中没有，造成数据错误或丢失
   - 虽然已有shop_id解析机制，但很多文件无法自动解析，需要手动指派，增加了出错风险

2. **事实表和物化视图与源数据不匹配**：
   - 事实表的设计（如`FactOrder`、`FactProductMetric`）不完全符合源数据的实际结构
   - 物化视图的设计可能不完全符合字段映射的输出
   - 这导致数据入库时需要大量转换和映射，增加了出错风险

3. **数据库设计缺少OpenSpec规范**：
   - 数据库设计时没有使用OpenSpec规范，导致设计规则不完善
   - 缺少明确的数据归属规则、字段必填规则、主键设计规则等
   - 这导致后续开发中出现不一致和问题

### 表现问题（数据同步可靠性）

这些问题主要集中在：

1. 数据丢失问题（37行数据丢失，隔离区显示为0）
2. 字段映射应用问题（可能还有其他字段映射问题）
3. 数据流转追踪问题（某些情况下显示"暂无流转数据"）
4. 对比报告功能问题（需要验证和增强）
5. 文件注册流程问题（file_id不存在的问题）

## Goals

- **数据库设计规则完善**（最高优先级）：
  - 审查现有数据库设计规则，识别根本性问题
  - 创建OpenSpec规范文档，明确数据库设计规则
  - 如果发现根本性问题，提出数据库结构优化方案
- **数据完整性**：确保数据同步精确度达到100%，所有失败的数据都被正确隔离
- **字段映射准确性**：确保所有字段都正确映射，避免因字段缺失或格式错误导致数据入库失败
- **数据流转可追踪性**：确保数据流转追踪功能正常工作，能够正确查询所有数据层
- **对比报告准确性**：确保对比报告功能正常工作，能够正确显示丢失数据详情
- **文件注册可靠性**：确保文件注册流程正常工作，file_id正确传递到所有数据层

## Non-Goals

- 不改变现有API接口（保持向后兼容）
- 不引入新的技术依赖（使用现有技术栈）
- 不修改数据库结构（使用现有表结构）

## Decisions

### 决策0：数据库设计规则审查优先（最高优先级）

**决策**：优先进行数据库设计规则审查，从源头解决问题

**理由**：
- 如果数据库设计规则本身有问题，修复表现问题只是治标不治本
- shop_id主键约束与数据源不匹配是根本性问题，需要优先解决
- 事实表和物化视图与源数据不匹配也是根本性问题，需要优先解决
- 创建OpenSpec规范文档可以避免未来出现类似问题

**替代方案**：
- 直接修复表现问题（可能无法解决根本问题，问题会反复出现）

### 决策1：数据丢失问题调查策略

**决策**：采用分层调查策略，从验证阶段→staging阶段→upsert阶段逐步排查

**理由**：
- 数据丢失可能发生在任何阶段
- 分层调查可以精确定位问题所在
- 已有日志记录可以辅助调查

**替代方案**：
- 一次性全面调查（工作量大，难以定位问题）

### 决策2：字段映射优化策略

**决策**：先调查问题，再优化流程

**理由**：
- 需要先了解问题的根本原因
- 避免盲目优化导致新问题
- 可以有针对性地优化

**替代方案**：
- 直接优化流程（可能无法解决根本问题）

### 决策3：数据流转追踪优化策略

**决策**：先修复查询逻辑，再增强可视化

**理由**：
- 查询逻辑是基础，必须首先修复
- 可视化是增强功能，可以在基础修复后进行

**替代方案**：
- 同时进行查询逻辑修复和可视化增强（可能分散注意力）

### 决策4：对比报告功能增强策略

**决策**：先验证现有功能，再增强功能

**理由**：
- 需要先确认现有功能是否正常工作
- 如果现有功能有问题，需要先修复
- 增强功能可以在验证通过后进行

**替代方案**：
- 直接增强功能（可能无法解决现有问题）

## Risks / Trade-offs

### 风险1：数据丢失问题可能难以完全解决

**风险**：数据丢失问题可能涉及多个层面，难以完全解决

**缓解措施**：
- 采用分层调查策略，逐步排查
- 增强日志记录，便于问题定位
- 实现数据丢失预警机制，及时发现问题

### 风险2：字段映射优化可能影响现有功能

**风险**：字段映射优化可能影响现有功能的正常工作

**缓解措施**：
- 先进行充分测试，确保不影响现有功能
- 采用渐进式优化，逐步改进
- 保留回滚机制

### 风险3：数据流转追踪优化可能影响性能

**风险**：数据流转追踪优化可能影响查询性能

**缓解措施**：
- 优化查询逻辑，减少不必要的查询
- 使用索引优化查询性能
- 进行性能测试，确保性能可接受

## Migration Plan

### 当前状态

- ✅ 数据同步功能已实现（v4.12.0）
- ✅ 部分问题已修复（v4.12.1-v4.12.2）
- ❌ 仍存在数据丢失、字段映射、数据流转追踪等问题

### 迁移步骤

0. **数据库设计规则审查和优化**（优先级：最高）
   - 审查现有数据库设计规则
   - 分析shop_id主键约束与数据源不匹配的问题
   - 分析事实表和物化视图与源数据不匹配的问题
   - 创建OpenSpec规范文档
   - 如果发现根本性问题，创建数据库结构优化方案

1. **数据丢失问题调查和修复**（优先级：高）
   - 检查自动隔离机制的日志
   - 检查验证阶段的错误处理
   - 检查数据库约束错误处理
   - 实现数据丢失自动分析功能
   - 实现数据丢失预警机制

2. **字段映射应用优化**（优先级：中）
   - 检查字段映射应用的完整流程
   - 优化字段映射应用流程
   - 实现字段映射质量评分

3. **数据流转追踪优化**（优先级：中）
   - 检查数据流转查询逻辑
   - 优化数据流转查询逻辑
   - 增强数据流转可视化

4. **对比报告功能增强**（优先级：中）
   - 验证对比报告功能
   - 增强丢失数据详情查询
   - 实现丢失数据导出功能

5. **文件注册流程问题修复**（优先级：低）
   - 检查文件注册流程
   - 修复文件注册流程中的问题

### Rollback

- 本变更主要是问题修复和功能增强，不涉及重大架构变更
- 如需回滚，可以恢复到v4.12.2版本
- 建议在修复前备份数据库

## Open Questions

- [ ] **shop_id是否应该作为主键的一部分？**
  - 如果大量源数据没有shop_id，是否应该调整主键设计？
  - 是否应该允许shop_id为NULL（对于平台级数据）？
  - 是否应该使用account_id替代shop_id？
- [ ] **事实表和物化视图是否需要调整以更好地匹配源数据？**
  - 哪些字段是源数据中常见的但事实表中缺失的？
  - 哪些字段是事实表中存在但源数据中不常见的？
  - 物化视图是否需要调整以更好地匹配字段映射输出？
- [ ] **数据库结构优化方案的风险和成本是什么？**
  - 如果修改主键设计，对现有数据的影响是什么？
  - 如果修改表结构，迁移成本是什么？
  - 是否需要创建新的变更提案来处理数据库结构优化？
- [ ] 数据丢失预警机制的阈值应该如何设置？
- [ ] 字段映射质量评分的标准是什么？
- [ ] 数据流转可视化应该采用什么图表类型？
- [ ] 丢失数据导出功能应该支持哪些格式？

