# 变更：提升数据同步可靠性

## Why

数据同步功能虽然已经实现并归档（v4.12.0），但在实际使用中发现了一些影响数据完整性和可靠性的问题。**更重要的是，经过深入分析，我们发现这些问题的根源可能在于数据库设计规则本身**：

### 根本性问题（数据库设计规则）

1. **shop_id主键约束与数据源不匹配**：
   - `FactOrder`的主键是`(platform_code, shop_id, order_id)`，shop_id是主键的一部分，不能为NULL
   - 但大量源数据文件本身没有shop_id字段，需要从路径/元数据推断或手动指派
   - 这导致数据同步时必须强制提供shop_id，即使源数据中没有，造成数据错误或丢失
   - 虽然已有shop_id解析机制，但很多文件无法自动解析，需要手动指派，增加了出错风险

2. **事实表和物化视图与源数据不匹配**：
   - 事实表的设计（如`FactOrder`、`FactProductMetric`）不完全符合源数据的实际结构
   - 物化视图的设计可能不完全符合字段映射的输出
   - 这导致数据入库时需要大量转换和映射，增加了出错风险

3. **数据库设计缺少OpenSpec规范**：
   - 数据库设计时没有使用OpenSpec规范，导致设计规则不完善
   - 缺少明确的数据归属规则、字段必填规则、主键设计规则等
   - 这导致后续开发中出现不一致和问题

### 表现问题（数据同步可靠性）

1. **数据丢失问题**：数据同步精确度未达到100%，持续存在数据丢失（37行），隔离区显示为0，说明丢失的数据没有被正确隔离
2. **字段映射问题**：虽然已修复platform_code和shop_id的获取，但可能还有其他字段映射问题，导致数据入库失败
3. **数据流转追踪问题**：数据流转追踪在某些情况下显示"暂无流转数据"，无法正确追踪数据流转情况
4. **对比报告问题**：虽然已添加丢失数据详情显示功能，但需要验证是否正常工作
5. **文件注册流程问题**：订单数据同步时可能出现file_id不存在的问题

**这些问题影响了数据同步的可靠性和用户体验，需要从源头（数据库设计规则）开始解决。**

## What Changes

- **数据库设计规则审查和优化**（优先级：最高）：
  - 审查现有数据库设计规则，特别是shop_id主键约束、字段必填规则、主键设计规则等
  - 分析shop_id主键约束与数据源不匹配的问题，评估是否需要调整主键设计
  - 分析事实表和物化视图与源数据不匹配的问题，评估是否需要调整表结构
  - 创建OpenSpec规范文档，明确数据库设计规则（数据归属规则、字段必填规则、主键设计规则等）
  - 评估shop_id是否应该作为主键的一部分，或者是否应该允许NULL（对于平台级数据）
  - 评估事实表和物化视图是否需要调整以更好地匹配源数据和字段映射输出
  - 如果发现根本性设计问题，提出数据库结构优化方案（可能需要创建新的变更提案）

- **数据丢失问题深度调查和修复**：
  - 检查自动隔离机制的日志，确认是否有隔离失败的记录
  - 检查验证阶段的错误处理，确认验证失败的数据是否被隔离
  - 检查数据库约束错误处理，确认主键冲突等错误是否被正确隔离
  - 检查对比报告中的丢失数据详情，分析丢失数据的共同特征
  - 实现数据丢失自动分析功能（分析丢失数据的共同特征）
  - 实现数据丢失预警机制（当数据丢失率超过阈值时告警）

- **字段映射应用优化**：
  - 检查字段映射应用的完整流程，确认所有字段是否都正确映射
  - 检查Pattern Matcher的运行时机，确认是否在字段映射之后还在运行
  - 检查数据标准化函数，确认是否正确处理所有字段
  - 检查丢失数据的字段特征，确认是否有特定字段导致数据丢失
  - 优化字段映射应用流程（确保所有字段都正确映射）
  - 优化Pattern Matcher的运行时机（避免重复匹配已映射字段）
  - 增强字段映射验证（验证映射后的数据是否完整）
  - 实现字段映射质量评分（评估字段映射的准确性）

- **数据流转追踪优化**：
  - 检查数据流转查询逻辑，确认是否正确查询所有数据层
  - 检查file_id字段的设置，确认所有数据层都正确设置了file_id
  - 检查数据流转API的日志，确认查询失败的原因
  - 优化数据流转查询逻辑（确保正确查询所有数据层）
  - 增强数据流转可视化（提供更直观的数据流转图表）
  - 实现数据流转异常检测（检测数据流转中的异常情况）

- **对比报告功能增强**：
  - 测试对比报告API，确认是否正确返回丢失数据详情
  - 测试前端显示，确认是否正确显示丢失数据详情表格
  - 检查日志，确认查询逻辑是否正确执行
  - 增强丢失数据详情查询（支持更多数据域和查询条件）
  - 实现丢失数据导出功能（导出丢失数据到Excel）
  - 实现丢失数据分析功能（分析丢失数据的原因和模式）

- **文件注册流程问题修复**：
  - 检查文件注册流程，确认文件是否正确注册
  - 检查file_id的传递流程，确认是否正确传递到所有数据层
  - 检查文件注册的时机，确认是否在数据同步之前完成

## Impact

- **影响的规范**：
  - 可能需要更新`specs/data-sync/spec.md`（增强数据丢失追踪、字段映射验证等需求）
- **影响的代码**：
  - `backend/services/data_ingestion_service.py`（数据入库服务，增强隔离机制）
  - `backend/services/data_importer.py`（数据导入服务，增强错误处理）
  - `backend/services/data_validator.py`（数据验证服务，增强验证逻辑）
  - `backend/routers/data_flow.py`（数据流转API，优化查询逻辑）
  - `backend/routers/raw_layer.py`（对比报告API，增强丢失数据详情查询）
  - `frontend/src/views/FieldMappingEnhanced.vue`（前端界面，增强数据丢失显示）
- **影响的文档**：
  - `docs/DATA_SYNC_ARCHITECTURE.md`（架构文档，需要更新数据丢失追踪机制）

## 非目标

- 不改变现有API接口（保持向后兼容）
- 不引入新的技术依赖（使用现有技术栈）
- **注意**：如果数据库设计规则审查发现根本性问题，可能需要修改数据库结构（这将作为单独的变更提案处理）

## 当前状态

- ✅ 数据同步功能已实现（v4.12.0）
- ✅ 部分问题已修复（v4.12.1-v4.12.2）：
  - 增强staging阶段错误处理
  - 添加数据丢失追踪日志
  - 确保staging失败的数据被隔离
- ❌ 仍存在的问题：
  - **数据库设计规则问题**（根本性问题，需要优先解决）：
    - shop_id主键约束与数据源不匹配
    - 事实表和物化视图与源数据不匹配
    - 缺少OpenSpec规范文档
  - 数据丢失问题（需要进一步调查）
  - 字段映射应用问题（需要优化）
  - 数据流转追踪问题（需要修复）
  - 对比报告功能（需要验证和增强）
  - 文件注册流程问题（需要检查）

