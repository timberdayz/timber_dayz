## ADDED Requirements

### Requirement: 数据库设计规则审查
系统应审查现有数据库设计规则，识别根本性问题，特别是shop_id主键约束、字段必填规则、主键设计规则等。

#### Scenario: 数据库设计规则审查
- **WHEN** 系统进行数据库设计规则审查
- **THEN** 系统分析shop_id主键约束与数据源不匹配的问题，分析事实表和物化视图与源数据不匹配的问题，识别缺少的规则和规范

#### Scenario: 数据库设计规则优化方案
- **WHEN** 系统发现数据库设计规则问题
- **THEN** 系统创建数据库设计规则优化方案文档，记录发现的问题和影响，提出优化方案和迁移计划

### Requirement: OpenSpec规范文档创建
系统应创建数据库设计规范OpenSpec文档，明确数据归属规则、字段必填规则、主键设计规则等。

#### Scenario: 数据库设计规范文档创建
- **WHEN** 系统创建数据库设计规范OpenSpec文档
- **THEN** 系统定义数据归属规则（shop_id、account_id等），定义字段必填规则（哪些字段必填，哪些可选），定义主键设计规则（何时使用复合主键，何时允许NULL），定义事实表和物化视图设计规则

## MODIFIED Requirements

### Requirement: 数据同步可靠性
系统应确保数据同步的可靠性，包括数据完整性、字段映射准确性、数据流转可追踪性和对比报告准确性。

#### Scenario: 数据丢失自动隔离
- **WHEN** 数据在验证、staging或upsert阶段失败
- **THEN** 系统自动将失败的数据隔离到data_quarantine表，记录错误类型和错误信息

#### Scenario: 数据丢失追踪日志
- **WHEN** 数据同步过程中
- **THEN** 系统记录每个阶段的数据数量（Raw→Staging→Fact），便于追踪数据丢失位置

#### Scenario: 数据丢失预警
- **WHEN** 数据丢失率超过预设阈值（如5%）
- **THEN** 系统发出预警，通知用户数据丢失情况

#### Scenario: 字段映射验证
- **WHEN** 字段映射应用后
- **THEN** 系统验证映射后的数据是否完整，确保所有必填字段都已正确映射

#### Scenario: 字段映射质量评分
- **WHEN** 字段映射完成后
- **THEN** 系统评估字段映射的准确性，返回质量评分和问题列表

#### Scenario: 数据流转完整追踪
- **WHEN** 查询数据流转信息
- **THEN** 系统正确查询所有数据层（Raw→Staging→Fact→Quarantine），显示完整的数据流转情况

#### Scenario: 对比报告丢失数据详情
- **WHEN** 用户查看对比报告
- **THEN** 系统显示丢失数据的详细信息，包括丢失位置、丢失原因和丢失数据内容

#### Scenario: 文件注册流程验证
- **WHEN** 文件注册时
- **THEN** 系统验证文件是否正确注册到catalog_files表，确保file_id正确传递到所有数据层

## ADDED Requirements

### Requirement: 数据丢失自动分析
系统应提供数据丢失自动分析功能，分析丢失数据的共同特征，帮助用户定位问题。

#### Scenario: 数据丢失特征分析
- **WHEN** 数据同步完成后发现数据丢失
- **THEN** 系统自动分析丢失数据的共同特征（如字段缺失、格式错误、主键冲突等），返回分析结果

### Requirement: 数据丢失预警机制
系统应提供数据丢失预警机制，当数据丢失率超过阈值时发出预警。

#### Scenario: 数据丢失率超过阈值预警
- **WHEN** 数据同步完成后，数据丢失率超过预设阈值（如5%）
- **THEN** 系统发出预警，通知用户数据丢失情况，并提供丢失数据详情

### Requirement: 字段映射质量评分
系统应提供字段映射质量评分功能，评估字段映射的准确性。

#### Scenario: 字段映射质量评分计算
- **WHEN** 字段映射完成后
- **THEN** 系统计算字段映射质量评分（基于映射覆盖率、映射准确性等指标），返回评分和问题列表

### Requirement: 数据流转异常检测
系统应提供数据流转异常检测功能，检测数据流转中的异常情况。

#### Scenario: 数据流转异常检测
- **WHEN** 数据同步完成后
- **THEN** 系统检测数据流转中的异常情况（如数据在某个阶段丢失、数据流转中断等），返回异常报告

### Requirement: 丢失数据导出功能
系统应提供丢失数据导出功能，支持将丢失数据导出到Excel。

#### Scenario: 丢失数据导出到Excel
- **WHEN** 用户请求导出丢失数据
- **THEN** 系统将丢失数据导出到Excel文件，包含丢失数据的详细信息和错误原因

### Requirement: 丢失数据分析功能
系统应提供丢失数据分析功能，分析丢失数据的原因和模式。

#### Scenario: 丢失数据原因分析
- **WHEN** 用户请求分析丢失数据
- **THEN** 系统分析丢失数据的原因和模式（如字段缺失、格式错误、主键冲突等），返回分析报告

