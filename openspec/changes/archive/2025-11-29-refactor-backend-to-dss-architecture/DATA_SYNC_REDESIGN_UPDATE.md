# 数据同步功能重设计更新总结

**日期**: 2025-01-31  
**更新内容**: 针对重新设计数据同步功能的提案更新

---

## 📋 更新概述

根据用户需求，我们重新设计了数据同步功能，核心改进包括：

1. **用户手动选择表头行**（核心要求）
2. **保留现有UI设计**（文件详情、数据预览、原始表头字段列表）
3. **模板驱动同步**（用户选择表头行 → 预览验证 → 保存模板 → 自动同步使用模板表头行）
4. **完全独立系统**（新数据同步功能完全独立于字段映射审核系统）

---

## 🔄 更新的文件

### 1. `proposal.md`

**更新内容**:
- 在"后端简化"部分添加了"数据同步功能重设计"说明
- 更新了"受影响的规格"部分，标记`data-sync`为"重大修改规格"
- 更新了"需要重构的文件"部分，添加了数据同步相关的文件
- 更新了"需要新增的文件"部分，添加了新的前端页面文件

**关键变更**:
```markdown
- **数据同步功能重设计** ⭐ **新增（2025-01-31）**：
  - **用户手动选择表头行**：大多数文件表头行不在第一行，自动检测效果不佳，必须由用户手动选择
  - **模板驱动同步**：用户选择表头行 → 预览验证 → 保存模板 → 自动同步时严格执行模板表头行
  - **完全独立系统**：新数据同步功能完全独立于字段映射审核系统，在"数据采集与管理"下新增"数据同步"二级菜单
  - **保留现有UI设计**：文件详情、数据预览、原始表头字段列表设计保留，确保用户能够判断系统识别是否正常
```

### 2. `specs/data-sync/spec.md`

**新增需求**:

#### Requirement: User-Manual Header Row Selection
- 用户必须手动选择表头行（0-10，0=Excel第1行）
- 系统不进行自动检测（如果用户未选择）
- 显示警告提示："⚠️ Important: Please manually select the correct header row!"

#### Scenario: User selects header row before preview
- 显示文件详情
- 显示表头行选择器（默认值：模板的`header_row`或0）
- 显示警告提示

#### Scenario: User previews data with selected header row
- 使用用户选择的表头行读取文件
- 显示数据预览和原始表头字段列表
- 允许用户验证和调整

#### Scenario: User saves template with header row
- 保存`header_columns`（原始表头字段列表）
- 保存`header_row`（用户选择的表头行）⭐ **关键**
- 保存其他模板信息

#### Scenario: Automatic sync uses template header row
- 查找模板（按platform+domain+granularity+sub_domain）
- 使用模板的`header_row`读取文件（严格模式，不自动检测）
- 验证表头匹配（如果匹配率<80%，记录警告但继续同步）

#### Requirement: Independent Data Sync System
- 新数据同步系统完全独立于字段映射审核系统
- 在"数据采集与管理"下新增"数据同步"二级菜单
- 移除"字段映射审核"菜单项

#### Requirement: Template Header Row Strict Enforcement
- 数据同步服务严格执行模板表头行设置
- 不进行自动检测（如果模板存在）
- 如果模板不存在，使用默认值0（提示用户创建模板）

### 3. `tasks.md`

**新增Phase 0.8: 数据同步功能重设计**

包含以下任务组：

#### 0.8.1 后端API开发（用户手动选择表头行）
- 新增文件预览API（支持表头行参数）
- 优化模板保存API（保存表头行）
- 重构数据同步服务（严格执行模板表头行）
- 新增文件列表API

#### 0.8.2 前端页面开发（独立数据同步系统）
- 创建数据同步文件列表页面
- 创建数据同步文件详情页面（核心页面，包含文件详情、表头行选择器、数据预览、原始表头字段列表）
- 创建数据同步任务管理页面
- 创建数据同步历史记录页面
- 创建数据同步模板管理页面

#### 0.8.3 菜单结构更新
- 更新菜单配置（新增"数据同步"二级菜单）
- 更新路由配置

#### 0.8.4 测试验证
- 测试表头行选择功能
- 测试自动同步使用模板表头行
- 测试UI功能

#### 0.8.5 Phase 0.8验收
- 用户手动选择表头行功能正常
- 模板保存表头行功能正常
- 自动同步严格执行模板表头行
- 新数据同步系统完全独立
- 菜单结构更新完成

---

## ✅ 验证结果

**OpenSpec验证**: ✅ **通过**

```bash
openspec validate refactor-backend-to-dss-architecture --strict
# 结果: Change 'refactor-backend-to-dss-architecture' is valid
```

---

## 🎯 核心设计要点

### 1. 用户手动选择表头行（核心要求）

**原因**:
- 大多数文件表头行不在第一行（row 0）
- 自动检测效果不佳，容易出错
- 用户手动选择可以确保准确性

**实现**:
- 表头行选择器：0-10（0=Excel第1行，1=Excel第2行...）
- 默认值：如果有模板，使用模板的`header_row`；否则为0
- 警告提示：提醒用户手动选择正确的表头行

### 2. 模板驱动同步

**流程**:
```
用户选择文件 → 手动选择表头行 → 预览验证 → 保存模板 → 自动同步使用模板表头行
```

**关键点**:
- 模板保存时保存`header_row`（用户选择的表头行）
- 自动同步时严格执行模板表头行（不自动检测）
- 如果表头匹配率<80%，记录警告但继续同步

### 3. 完全独立系统

**菜单结构**:
```
数据采集与管理
├── 采集配置
├── 采集任务
├── 采集历史
├── 数据同步 ⭐ 新增（独立二级菜单）
│   ├── 文件列表
│   ├── 同步任务
│   ├── 同步历史
│   └── 模板管理
├── 数据隔离区
├── 数据浏览器
└── 数据一致性验证
```

**移除**: `字段映射审核`（完全废弃）

### 4. 保留现有UI设计

**文件详情页面包含**:
1. **文件详情区域**：文件基本信息、可用模板状态
2. **表头行选择器**：输入框、警告提示
3. **数据预览区域**：预览按钮、数据预览表格
4. **原始表头字段列表区域**：序号、原始表头字段、示例数据

**原因**: 确保用户能够判断系统识别是否正常

---

## 📝 下一步行动

1. **实施Phase 0.8任务**：
   - 后端API开发（文件预览API、模板保存API、数据同步服务重构）
   - 前端页面开发（文件列表、文件详情、任务管理、历史记录、模板管理）
   - 菜单结构更新
   - 测试验证

2. **验证功能**：
   - 用户手动选择表头行功能
   - 模板保存表头行功能
   - 自动同步使用模板表头行功能
   - UI功能完整性

3. **文档更新**：
   - 更新用户文档（说明新的数据同步流程）
   - 更新开发文档（说明新的API和UI设计）

---

## 🔗 相关文档

- [提案文档](proposal.md)
- [数据同步规范](specs/data-sync/spec.md)
- [任务清单](tasks.md)

---

**状态**: ✅ **提案更新完成，已验证通过**

