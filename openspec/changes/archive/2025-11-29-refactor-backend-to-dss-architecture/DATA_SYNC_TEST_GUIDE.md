# 数据同步功能测试指南

**日期**: 2025-01-31  
**测试页面**: http://localhost:5173/#/field-mapping

---

## ✅ 服务状态

- ✅ **后端服务**: http://localhost:8001（运行中）
- ✅ **前端服务**: http://localhost:5173（运行中）
- ✅ **浏览器**: 已打开字段映射审核页面

---

## 🧪 测试步骤

### 1. 选择文件

1. 在字段映射审核页面中，选择平台（如Shopee）
2. 选择数据域（如orders/products/traffic/services）
3. 选择日期和文件
4. 点击文件，查看文件详情

### 2. 预览数据

1. 点击"预览数据"按钮
2. 查看Excel文件的前100行数据
3. 确认数据格式和表头字段（应该是中文表头）

### 3. 应用模板（如果有）

1. 如果文件有匹配的模板，系统会自动应用
2. 如果没有模板，可以手动设置表头行
3. 确认表头行设置正确

### 4. 同步数据

1. 点击"同步数据"或"批量同步"按钮
2. 观察同步进度（如果有进度条）
3. 查看同步结果（成功/失败/部分成功）

### 5. 验证数据

1. 在Metabase中查看数据（http://localhost:3000）
2. 导航到对应的表（如`b_class.fact_raw_data_orders_daily`）
3. 验证：
   - ✅ 数据是否正确写入
   - ✅ JSONB格式是否正确
   - ✅ 中文字段名是否保留
   - ✅ header_columns字段是否保存

---

## 🔍 验证要点

### 1. JSONB格式验证

在Metabase中查看`raw_data`字段：
- ✅ 应该是JSONB格式
- ✅ 键应该是原始中文表头字段名（如"订单号"、"订单日期"）
- ✅ 值应该是原始数据值

### 2. 中文字段名验证

在Metabase中查看`header_columns`字段：
- ✅ 应该是JSONB数组
- ✅ 包含所有原始表头字段名（中文）
- ✅ 字段顺序应该与Excel文件一致

### 3. 数据完整性验证

- ✅ 行数应该与Excel文件一致（排除重复数据）
- ✅ 关键字段应该有值（如订单号、日期等）
- ✅ 数据应该按data_domain+granularity正确分表

### 4. 去重功能验证

- ✅ 重复文件应该被跳过（文件级去重）
- ✅ 重复行应该被跳过（行级去重）
- ✅ 去重日志应该显示正确

---

## 📋 测试检查清单

- [ ] 选择文件并预览数据
- [ ] 应用模板（如果有）
- [ ] 执行数据同步
- [ ] 查看同步进度和结果
- [ ] 在Metabase中验证数据
- [ ] 验证JSONB格式
- [ ] 验证中文字段名
- [ ] 验证数据完整性
- [ ] 验证去重功能

---

## ⚠️ 注意事项

1. **PowerShell curl问题**: 
   - PowerShell的`curl`是`Invoke-WebRequest`的别名
   - 使用Python requests或浏览器直接访问测试API

2. **代理问题**: 
   - 如果遇到代理错误，检查系统代理设置
   - 可能需要禁用代理或配置代理

3. **服务日志**: 
   - 查看后端服务窗口的日志，了解详细运行状态
   - 查看前端浏览器控制台（F12），了解前端错误

---

## 🐛 问题排查

### 如果同步失败

1. **检查后端日志**: 查看后端服务窗口的错误信息
2. **检查前端控制台**: 按F12打开浏览器控制台，查看错误
3. **检查数据库连接**: 确认PostgreSQL服务正常运行
4. **检查文件路径**: 确认Excel文件路径正确且可访问

### 如果数据未写入

1. **检查表是否存在**: 确认`fact_raw_data_*`表已创建
2. **检查数据验证**: 确认数据通过验证（查看隔离区）
3. **检查去重逻辑**: 确认数据未被误判为重复

---

**状态**: ✅ **服务已启动，可以开始测试**

**测试页面**: http://localhost:5173/#/field-mapping

