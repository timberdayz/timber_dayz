# DSS架构说明：字段映射字典 vs 模板功能

**日期**: 2025-01-31  
**问题**: 用户询问字段映射字典和模板功能在DSS架构中的角色

---

## 📋 问题分析

### 问题1: 字段映射字典是否还需要？

**答案**: ❌ **不再需要字段映射字典功能**

**原因**:
- DSS架构中，数据直接保存原始中文表头到JSONB格式
- 不再需要将中文表头映射到标准字段（英文字段名）
- 字段映射字典是旧架构的产物，用于标准字段映射

**需要修改**:
- 前端：移除"加载辞典"按钮和相关功能
- 前端：移除自动加载辞典的逻辑
- 前端：移除字段映射建议功能（基于字典）

### 问题2: 模板功能是否还需要？

**答案**: ✅ **仍然需要模板功能**

**原因**:
- 模板用于**文件匹配**（识别文件类型）
- 模板保存**原始表头字段列表**（header_columns）
- 模板用于**自动识别**文件是否已有配置

**DSS架构中的模板作用**:
1. **文件匹配**: 根据platform + data_domain + granularity匹配模板
2. **表头识别**: 使用header_columns识别文件表头是否变化
3. **自动应用**: 如果表头匹配，自动应用模板配置（如表头行）

**模板结构**（DSS架构）:
```json
{
  "platform": "miaoshou",
  "data_domain": "inventory",
  "granularity": "daily",
  "header_columns": ["商品SKU", "商品名称", "库存总量", ...],  // 原始中文表头
  "header_row": 0,  // 表头行位置
  "status": "published"
}
```

---

## 🔧 需要修改的内容

### 1. 移除字段映射字典功能

**前端修改** (`frontend/src/views/FieldMappingEnhanced.vue`):
- [ ] 移除"加载辞典"按钮
- [ ] 移除`loadDictionary()`函数调用
- [ ] 移除`dictionaryFields`相关状态
- [ ] 移除字段映射建议功能（基于字典）

**后端修改**（可选，保留API但不使用）:
- 保留API（向后兼容）
- 但前端不再调用

### 2. 修复模板保存功能

**问题**: 保存模板失败

**可能原因**:
1. API路径错误
2. 请求参数格式错误
3. 后端验证失败

**需要检查**:
- [ ] 前端API调用路径是否正确
- [ ] 后端API是否正常
- [ ] 请求参数是否符合后端要求

### 3. 明确数据同步流程

**新数据域或表头字段更新时的流程**:

#### 场景1: 新数据域（首次使用）

1. **上传文件** → 系统自动识别platform/data_domain/granularity
2. **预览数据** → 查看原始表头字段列表
3. **保存模板** → 保存header_columns和配置（表头行等）
4. **数据同步** → 使用RawDataImporter写入JSONB格式

#### 场景2: 表头字段更新（已有模板）

1. **上传文件** → 系统自动匹配模板
2. **检测变化** → 比较当前表头与模板header_columns
3. **提示更新** → 如果表头变化，提示更新模板
4. **更新模板** → 保存新的header_columns
5. **数据同步** → 使用RawDataImporter写入JSONB格式

#### 场景3: 自动数据同步（已有模板）

1. **文件扫描** → 系统自动扫描新文件
2. **模板匹配** → 自动匹配模板（platform + data_domain + granularity）
3. **表头验证** → 验证表头是否匹配模板header_columns
4. **自动同步** → 如果匹配，自动同步数据（使用RawDataImporter）

---

## 📝 数据同步流程（DSS架构）

### 手动数据同步

```
1. 选择文件
   ↓
2. 预览数据（查看原始表头）
   ↓
3. 应用模板（如果有，自动匹配）
   ↓
4. 保存模板（可选，如果表头变化）
   ↓
5. 点击"数据同步"按钮
   ↓
6. 后端处理：
   - 读取Excel文件
   - 保留原始中文表头
   - 计算data_hash
   - 使用RawDataImporter写入fact_raw_data_*表（JSONB格式）
   ↓
7. 完成（显示同步结果）
```

### 自动数据同步

```
1. 定时扫描新文件
   ↓
2. 自动匹配模板（platform + data_domain + granularity）
   ↓
3. 验证表头（比较header_columns）
   ↓
4. 如果匹配 → 自动同步
   ↓
5. 如果不匹配 → 标记为"需要人工审核"
```

---

## ✅ 修改清单

### 前端修改

- [ ] 移除"加载辞典"按钮和相关UI
- [ ] 移除`loadDictionary()`函数
- [ ] 移除字段映射建议功能
- [ ] 修复模板保存功能（检查API调用）
- [ ] 保留模板功能（保存header_columns）

### 后端修改

- [ ] 检查模板保存API是否正常
- [ ] 确认模板保存逻辑（保存header_columns）
- [ ] 确认数据同步逻辑（使用RawDataImporter）

---

**状态**: ⏳ **需要修改前端，移除字段映射字典功能，修复模板保存功能**

