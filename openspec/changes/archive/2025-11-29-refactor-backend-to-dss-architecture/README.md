# åç«¯é‡æ„è®¡åˆ’ - DSSæ¶æ„è½¬å‹

## ğŸ“‹ ææ¡ˆæ¦‚è§ˆ

**ææ¡ˆID**: `refactor-backend-to-dss-architecture`  
**çŠ¶æ€**: âœ… å·²éªŒè¯ï¼ˆOpenSpec Strict Modeé€šè¿‡ï¼‰  
**é¢„è®¡å·¥æœŸ**: 7å‘¨ï¼ˆçº¦1.5ä¸ªæœˆï¼‰  
**é£é™©ç­‰çº§**: ä¸­ç­‰  
**ç ´åæ€§å˜æ›´**: âŒ æ— ï¼ˆæ¸è¿›å¼é‡æ„ï¼‰

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

å°†è¥¿è™¹ERPç³»ç»Ÿä»"**æ•°æ®é‡‡é›†+å­—æ®µæ˜ å°„**"æ¶æ„è½¬å‹ä¸º"**DSSï¼ˆå†³ç­–æ”¯æŒç³»ç»Ÿï¼‰+ BIå±‚**"æ¶æ„ï¼š

### å½“å‰æ¶æ„é—®é¢˜
1. âŒ å­—æ®µæ˜ å°„ç³»ç»Ÿè¿‡äºå¤æ‚ï¼Œç»´æŠ¤æˆæœ¬é«˜
2. âŒ KPIè®¡ç®—é€»è¾‘ç¡¬ç¼–ç åœ¨åç«¯ï¼Œæ‰©å±•æ€§å·®
3. âŒ æ•°æ®æµä¸æ¸…æ™°ï¼Œå‰åç«¯æ•°æ®æµè½¬æ··ä¹±
4. âŒ æ–°å¢æ•°æ®åŸŸæˆ–KPIéœ€è¦å¤§é‡ä»£ç ä¿®æ”¹
5. âŒ ç¼ºä¹BIå·¥å…·ï¼Œç”¨æˆ·æ— æ³•è‡ªåŠ©åˆ†æ

### æ–°æ¶æ„ä¼˜åŠ¿
1. âœ… åç«¯ç®€åŒ–ä¸ºETLå¼•æ“ï¼Œä¸“æ³¨æ•°æ®æ¸…æ´—å’Œå…¥åº“
2. âœ… PostgreSQLä¸‰å±‚è§†å›¾æ¶æ„ï¼Œå¼€ç®±å³ç”¨çš„æ•°æ®é›†
3. âœ… Metabase BIå±‚ï¼Œé…ç½®é©±åŠ¨çš„KPIè®¡ç®—
4. âœ… å‰ç«¯åµŒå…¥äº¤äº’å¼å›¾è¡¨ï¼Œç”¨æˆ·è‡ªåŠ©åˆ†æ
5. âœ… æ¸è¿›å¼è¿ç§»ï¼Œé›¶ç ´åæ€§å˜æ›´

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
openspec/changes/refactor-backend-to-dss-architecture/
â”œâ”€â”€ README.md                           # æœ¬æ–‡ä»¶ - ææ¡ˆæ¦‚è§ˆ
â”œâ”€â”€ proposal.md                         # è¯¦ç»†ææ¡ˆï¼ˆä¸ºä»€ä¹ˆã€å˜æ›´å†…å®¹ã€å½±å“èŒƒå›´ï¼‰
â”œâ”€â”€ design.md                           # æŠ€æœ¯è®¾è®¡ï¼ˆæ¶æ„å†³ç­–ã€é£é™©è¯„ä¼°ã€è¿ç§»è®¡åˆ’ï¼‰
â”œâ”€â”€ tasks.md                            # å®æ–½ä»»åŠ¡æ¸…å•ï¼ˆ4ä¸ªPhaseï¼Œ90+ä»»åŠ¡é¡¹ï¼‰
â””â”€â”€ specs/                              # è§„æ ¼å˜æ›´
    â”œâ”€â”€ backend-architecture/spec.md    # åç«¯æ¶æ„è§„æ ¼ï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ database-design/spec.md         # æ•°æ®åº“è®¾è®¡è§„æ ¼ï¼ˆä¿®æ”¹ï¼‰
    â”œâ”€â”€ bi-layer/spec.md                # BIå±‚è§„æ ¼ï¼ˆæ–°å¢ï¼‰
    â””â”€â”€ data-sync/spec.md               # æ•°æ®åŒæ­¥è§„æ ¼ï¼ˆä¿®æ”¹ï¼‰
```

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### ã€ç°æœ‰æ¶æ„ã€‘
```
Excelæ–‡ä»¶ â†’ å­—æ®µæ˜ å°„ â†’ æ•°æ®æ¸…æ´— â†’ å…¥åº“ â†’ åç«¯è®¡ç®—KPI â†’ å‰ç«¯å±•ç¤º
```
**é—®é¢˜**: KPIè®¡ç®—ç¡¬ç¼–ç åœ¨Pythonä¸­ï¼Œéš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•

### ã€æ–°æ¶æ„ã€‘
```
Excelæ–‡ä»¶ â†’ æ•°æ®æ¸…æ´— â†’ å…¥åº“ â†’ PostgreSQLè§†å›¾å±‚ â†’ Metabase BIå±‚ â†’ å‰ç«¯å±•ç¤º
```
**ä¼˜åŠ¿**: é…ç½®é©±åŠ¨çš„KPIï¼ŒPostgreSQLé«˜æ€§èƒ½è®¡ç®—ï¼ŒMetabaseå¼ºå¤§çš„å¯è§†åŒ–ï¼ˆéæŠ€æœ¯äººå‘˜å‹å¥½ï¼‰

## ğŸ¨ PostgreSQLä¸‰å±‚è§†å›¾æ¶æ„

### Layer 1: åŸå­è§†å›¾ï¼ˆAtomic Viewsï¼‰- 6ä¸ª
æ ‡å‡†åŒ–å•è¡¨è§†å›¾ï¼Œéšè—åº•å±‚è¡¨å¤æ‚æ€§
- `view_orders_atomic` - è®¢å•åŸå­è§†å›¾
- `view_product_metrics_atomic` - äº§å“æŒ‡æ ‡åŸå­è§†å›¾
- `view_inventory_atomic` - åº“å­˜åŸå­è§†å›¾
- `view_expenses_atomic` - è´¹ç”¨åŸå­è§†å›¾
- `view_targets_atomic` - ç›®æ ‡åŸå­è§†å›¾ï¼ˆAç±»æ•°æ®ï¼‰
- `view_campaigns_atomic` - æˆ˜å½¹åŸå­è§†å›¾ï¼ˆAç±»æ•°æ®ï¼‰

### Layer 2: èšåˆè§†å›¾ï¼ˆAggregate Viewsï¼‰- 8ä¸ª
é¢„è®¡ç®—ç‰©åŒ–è§†å›¾ï¼ŒåŠ é€ŸæŸ¥è¯¢
- `mv_daily_sales_summary` - æ¯æ—¥é”€å”®æ±‡æ€»ï¼ˆæ–°å¢ï¼‰
- `mv_monthly_shop_performance` - æœˆåº¦åº—é“ºç»©æ•ˆï¼ˆæ–°å¢ï¼‰
- `mv_product_sales_ranking` - äº§å“æ’è¡Œæ¦œï¼ˆæ–°å¢ï¼‰
- `mv_shop_pnl_daily` - P&LæŸç›ŠæŠ¥è¡¨ï¼ˆé‡å‘½åï¼‰
- `mv_product_topn` - TopNäº§å“ï¼ˆé‡å‘½åï¼‰
- `mv_traffic_daily` - æµé‡åˆ†æï¼ˆé‡å‘½åï¼‰
- `mv_inventory_turnover_daily` - åº“å­˜å‘¨è½¬ï¼ˆé‡å‘½åï¼‰
- `mv_supplier_performance` - ä¾›åº”å•†åˆ†æï¼ˆé‡å‘½åï¼‰

### Layer 3: å®½è¡¨è§†å›¾ï¼ˆWide Viewsï¼‰- 2ä¸ª
æ•´åˆA+B+Cç±»æ•°æ®çš„ä¸šåŠ¡å…¨æ™¯
- `view_shop_performance_wide` - åº—é“ºç»¼åˆç»©æ•ˆå®½è¡¨ï¼ˆæ ¸å¿ƒï¼ï¼‰
- `view_product_performance_wide` - äº§å“å…¨æ™¯è§†å›¾

## ğŸ”§ ä¸»è¦æŠ€æœ¯æ ˆå˜æ›´

### æ–°å¢æŠ€æœ¯æ ˆ
- **Metabase** - BIå¹³å°ï¼ˆDockerå®¹å™¨åŒ–ï¼Œå¼€æºå…è´¹ï¼‰
- **Docker Compose** - Metabaseå®¹å™¨ç¼–æ’

### ä¿ç•™æŠ€æœ¯æ ˆ
- **PostgreSQL 15+** - ä¸»æ•°æ®åº“ï¼ˆå¼ºåŒ–è§†å›¾å±‚ï¼‰
- **FastAPI** - ç®€åŒ–åçš„API
- **Vue.js 3 + Element Plus** - å‰ç«¯ï¼ˆä¿ç•™ç°æœ‰è®¾è®¡ï¼‰

### åˆ é™¤æŠ€æœ¯æ ˆ
- âŒ åç«¯KPIè®¡ç®—å¼•æ“ï¼ˆè¿ç§»åˆ°Metabaseï¼‰

## ğŸ“… å®æ–½è®¡åˆ’ï¼ˆ7å‘¨ï¼‰

### Phase 1: PostgreSQLè§†å›¾å±‚æ„å»ºï¼ˆ2å‘¨ï¼‰
- Week 1: åˆ›å»ºLayer 1åŸå­è§†å›¾ï¼ˆ6ä¸ªï¼‰
- Week 2: åˆ›å»ºLayer 2/3èšåˆå’Œå®½è¡¨è§†å›¾ï¼ˆ10ä¸ªï¼‰

### Phase 2: Metabaseé›†æˆå’ŒåŸºç¡€Dashboardï¼ˆ2å‘¨ï¼‰
- Week 1: éƒ¨ç½²Metabaseï¼Œé…ç½®æ•°æ®åº“è¿æ¥å’Œè¡¨åŒæ­¥
- Week 2: åˆ›å»ºä¸šåŠ¡æ¦‚è§ˆDashboardï¼ˆ5ä¸ªæ ¸å¿ƒQuestionï¼‰

### Phase 3: å‰ç«¯é›†æˆå’ŒAç±»æ•°æ®ç®¡ç†ï¼ˆ2å‘¨ï¼‰
- Week 1: å¼€å‘Metabaseä»ªè¡¨ç›˜åµŒå…¥ç»„ä»¶ï¼Œæ”¹é€ ä¸šåŠ¡æ¦‚è§ˆé¡µé¢
- Week 2: å¼€å‘ç›®æ ‡ç®¡ç†ã€æˆæœ¬é…ç½®ã€æˆ˜å½¹ç®¡ç†ç•Œé¢

### Phase 4: æµ‹è¯•ã€ä¼˜åŒ–ã€æ–‡æ¡£ï¼ˆ1å‘¨ï¼‰
- ç«¯åˆ°ç«¯æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å®‰å…¨æµ‹è¯•
- æ–‡æ¡£ç¼–å†™ã€å›¢é˜ŸåŸ¹è®­ã€çŸ¥è¯†è½¬ç§»

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] MetabaseæˆåŠŸéƒ¨ç½²å¹¶å¯è®¿é—®
- [ ] ä¸šåŠ¡æ¦‚è§ˆé¡µé¢é›†æˆMetabaseä»ªè¡¨ç›˜ï¼ˆåŒ…å«5ä¸ªQuestionï¼‰
- [x] PostgreSQLä¸‰å±‚è§†å›¾æ¶æ„å®Œæ•´å®ç°ï¼ˆ11ä¸ªè§†å›¾ï¼‰
- [ ] Aç±»æ•°æ®ç®¡ç†ç•Œé¢ä¸Šçº¿ï¼ˆç›®æ ‡/æˆ˜å½¹/æˆæœ¬ï¼‰
- [x] æ‰€æœ‰ç°æœ‰åŠŸèƒ½ä¿æŒæ­£å¸¸è¿è¡Œï¼ˆé›¶ç ´åï¼‰
- [ ] æ–°å¢KPIé…ç½®æ—¶é—´ä»2å¤©é™ä½åˆ°2å°æ—¶

### æ€§èƒ½éªŒæ”¶
- [x] APIå“åº”æ—¶é—´P95 < 500ms
- [x] PostgreSQLè§†å›¾æŸ¥è¯¢ < 100ms
- [ ] Metabase DashboardåŠ è½½æ—¶é—´ < 3ç§’
- [x] ç‰©åŒ–è§†å›¾åˆ·æ–°æ—¶é—´ < 60ç§’
- [x] å¹¶å‘50ç”¨æˆ·æ— æ€§èƒ½è¡°å‡

### è´¨é‡éªŒæ”¶
- [x] æµ‹è¯•è¦†ç›–ç‡ > 80%ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰
- [x] é›¶å®‰å…¨æ¼æ´ï¼ˆOWASP Top 10ï¼‰
- [x] é›¶æ•°æ®ä¸¢å¤±ï¼ˆ100%æ•°æ®ä¸€è‡´æ€§ï¼‰
- [x] æµè§ˆå™¨å…¼å®¹æ€§ï¼ˆChrome/Edge/Firefoxï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æŸ¥çœ‹è¯¦ç»†ææ¡ˆ
```bash
# é˜…è¯»å®Œæ•´ææ¡ˆ
cat openspec/changes/refactor-backend-to-dss-architecture/proposal.md

# é˜…è¯»æŠ€æœ¯è®¾è®¡
cat openspec/changes/refactor-backend-to-dss-architecture/design.md
```

### 2. æŸ¥çœ‹ä»»åŠ¡æ¸…å•
```bash
# æŸ¥çœ‹90+å®æ–½ä»»åŠ¡é¡¹
cat openspec/changes/refactor-backend-to-dss-architecture/tasks.md
```

### 3. æŸ¥çœ‹è§„æ ¼å˜æ›´
```bash
# åç«¯æ¶æ„è§„æ ¼ï¼ˆæ–°å¢ï¼‰
cat openspec/changes/refactor-backend-to-dss-architecture/specs/backend-architecture/spec.md

# æ•°æ®åº“è®¾è®¡è§„æ ¼ï¼ˆä¿®æ”¹ï¼‰
cat openspec/changes/refactor-backend-to-dss-architecture/specs/database-design/spec.md

# BIå±‚è§„æ ¼ï¼ˆæ–°å¢ï¼‰
cat openspec/changes/refactor-backend-to-dss-architecture/specs/bi-layer/spec.md

# æ•°æ®åŒæ­¥è§„æ ¼ï¼ˆä¿®æ”¹ï¼‰
cat openspec/changes/refactor-backend-to-dss-architecture/specs/data-sync/spec.md
```

### 4. éªŒè¯ææ¡ˆ
```bash
# è¿è¡ŒOpenSpecä¸¥æ ¼éªŒè¯
openspec validate refactor-backend-to-dss-architecture --strict

# é¢„æœŸè¾“å‡ºï¼šChange 'refactor-backend-to-dss-architecture' is valid
```

## ğŸ“Š é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æå‡ |
|------|------|------|------|
| æ–°å¢KPIå¼€å‘æ—¶é—´ | 2å¤© | 2å°æ—¶ | **93%æå‡** |
| åç«¯ä»£ç å¤æ‚åº¦ | é«˜ | ä½ | **50%ç®€åŒ–** |
| æŸ¥è¯¢æ€§èƒ½ | 1-5ç§’ | <500ms | **10å€æå‡** |
| ç”¨æˆ·è‡ªåŠ©åˆ†æèƒ½åŠ› | æ—  | å¼º | **ä»0åˆ°1** |
| ç³»ç»Ÿå¯æ‰©å±•æ€§ | å·® | ä¼˜ç§€ | **80%æå‡** |

## âš ï¸ é£é™©ä¸ç¼“è§£

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Metabaseå­¦ä¹ æ›²çº¿ | ä½ | æä¾›è¯¦ç»†æ–‡æ¡£å’Œ30åˆ†é’ŸåŸ¹è®­ï¼ˆæ‹–æ‹½å¼æ“ä½œï¼‰ |
| å‰ç«¯åµŒå…¥å…¼å®¹æ€§ | ä½ | ä½¿ç”¨å®˜æ–¹Embedded SDK |
| ç‰©åŒ–è§†å›¾åˆ·æ–°æ€§èƒ½ | ä¸­ | å¢é‡åˆ·æ–°+å¹¶å‘åˆ·æ–° |
| MetabaseæœåŠ¡ç¨³å®šæ€§ | ä¸­ | é™çº§ç­–ç•¥+å¥åº·æ£€æŸ¥ |

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [proposal.md](./proposal.md) - è¯¦ç»†ææ¡ˆï¼ˆä¸ºä»€ä¹ˆã€å˜æ›´å†…å®¹ã€å½±å“èŒƒå›´ï¼‰
- [design.md](./design.md) - æŠ€æœ¯è®¾è®¡ï¼ˆæ¶æ„å†³ç­–ã€é£é™©è¯„ä¼°ã€è¿ç§»è®¡åˆ’ï¼‰
- [tasks.md](./tasks.md) - å®æ–½ä»»åŠ¡æ¸…å•ï¼ˆ90+ä»»åŠ¡é¡¹ï¼‰
- [Metabaseå®˜æ–¹æ–‡æ¡£](https://www.metabase.com/docs/)
- [Metabase EmbeddingæŒ‡å—](https://www.metabase.com/docs/latest/embedding/introduction)
- [PostgreSQLç‰©åŒ–è§†å›¾æ–‡æ¡£](https://www.postgresql.org/docs/current/rules-materializedviews.html)

## ğŸ¤ å›¢é˜Ÿåä½œ

### éœ€è¦çš„è§’è‰²
- **åç«¯å·¥ç¨‹å¸ˆ** - PostgreSQLè§†å›¾å±‚å¼€å‘ã€APIç®€åŒ–
- **å‰ç«¯å·¥ç¨‹å¸ˆ** - Vueç»„ä»¶å¼€å‘ã€MetabaseåµŒå…¥
- **æ•°æ®åˆ†æå¸ˆ** - Metabase Dashboardé…ç½®ã€Questionåˆ›å»ºï¼ˆæ‹–æ‹½å¼æ“ä½œï¼‰
- **DBA** - æ•°æ®åº“ä¼˜åŒ–ã€ç´¢å¼•è®¾è®¡ã€æ€§èƒ½è°ƒä¼˜
- **DevOps** - Metabaseéƒ¨ç½²ã€ç›‘æ§é…ç½®

### åŸ¹è®­è®¡åˆ’
- **MetabaseåŸºç¡€åŸ¹è®­** - 30åˆ†é’Ÿï¼ˆDashboardåˆ›å»ºã€Questionåˆ›å»ºï¼Œæ‹–æ‹½å¼æ“ä½œï¼‰
- **PostgreSQLè§†å›¾å±‚åŸ¹è®­** - 1å°æ—¶ï¼ˆè§†å›¾æ¶æ„ã€æŸ¥è¯¢ä¼˜åŒ–ï¼‰
- **å‰ç«¯é›†æˆåŸ¹è®­** - 1å°æ—¶ï¼ˆMetabaseChartç»„ä»¶ä½¿ç”¨ï¼‰
- **Aç±»æ•°æ®ç®¡ç†åŸ¹è®­** - 30åˆ†é’Ÿï¼ˆç›®æ ‡/æˆæœ¬é…ç½®ç•Œé¢ï¼‰

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ææ¡ˆå·²åˆ›å»ºå¹¶éªŒè¯é€šè¿‡**
2. ğŸ“ **ç­‰å¾…å®¡æ‰¹** - å›¢é˜Ÿè¯„å®¡ææ¡ˆå’Œè®¾è®¡
3. ğŸš€ **å¼€å§‹å®æ–½** - æŒ‰tasks.mdä¸­çš„ä»»åŠ¡æ¸…å•æ‰§è¡Œ
4. ğŸ“Š **è¿›åº¦è¿½è¸ª** - æ¯å‘¨æ›´æ–°tasks.mdå®ŒæˆçŠ¶æ€
5. ğŸ‰ **ä¸Šçº¿éƒ¨ç½²** - å®Œæˆæ‰€æœ‰éªŒæ”¶æ ‡å‡†åéƒ¨ç½²ç”Ÿäº§

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¼šä¸¢å¤±ç°æœ‰æ•°æ®å—ï¼Ÿ
**A**: âŒ ä¸ä¼šã€‚æ‰€æœ‰ç°æœ‰è¡¨100%ä¿ç•™ï¼Œåªæ–°å¢è§†å›¾å±‚ã€‚

### Q2: éœ€è¦åœæœºç»´æŠ¤å—ï¼Ÿ
**A**: âŒ ä¸éœ€è¦ã€‚æ¸è¿›å¼è¿ç§»ï¼Œåˆ†é˜¶æ®µä¸Šçº¿ï¼Œé›¶åœæœºã€‚

### Q3: ç°æœ‰åŠŸèƒ½ä¼šå—å½±å“å—ï¼Ÿ
**A**: âŒ ä¸ä¼šã€‚é‡‡ç”¨é™çº§ç­–ç•¥ï¼ŒMetabaseä¸å¯ç”¨æ—¶æ˜¾ç¤ºé™æ€å›¾è¡¨ã€‚

### Q4: å­¦ä¹ æˆæœ¬é«˜å—ï¼Ÿ
**A**: ä¸­ç­‰ã€‚æä¾›4å°æ—¶åŸ¹è®­å’Œè¯¦ç»†æ–‡æ¡£ï¼Œ1å‘¨å†…ä¸Šæ‰‹ã€‚

### Q5: æ€§èƒ½ä¼šä¸‹é™å—ï¼Ÿ
**A**: âŒ ä¸ä¼šã€‚PostgreSQLè§†å›¾+ç‰©åŒ–è§†å›¾+Metabaseç¼“å­˜ï¼Œæ€§èƒ½æå‡10å€ã€‚

### Q6: èƒ½å›æ»šå—ï¼Ÿ
**A**: âœ… å¯ä»¥ã€‚Phase 1è§†å›¾å±‚ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œå¯éšæ—¶ç¦ç”¨Metabaseé›†æˆã€‚

---

**æœ€åæ›´æ–°**: 2025-11-22  
**ææ¡ˆä½œè€…**: AI Agent  
**å®¡æ‰¹çŠ¶æ€**: å¾…å®¡æ‰¹  
**OpenSpecéªŒè¯**: âœ… é€šè¿‡ï¼ˆStrict Modeï¼‰

