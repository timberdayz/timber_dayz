## 1. 调查和根本原因分析
- [x] 1.1 审查当前去重逻辑（`deduplication_service.py`）
- [x] 1.2 审查批量插入逻辑（`raw_data_importer.py`）
- [x] 1.3 使用示例文件测试以重现问题
- [x] 1.4 识别为什么只导入1行数据
- [x] 1.5 记录根本原因和修复方案

## 2. 修复去重逻辑
- [x] 2.1 验证`data_hash`计算包含所有唯一标识字段
- [x] 2.2 修复所有行产生相同`data_hash`的问题（如果存在）
- [x] 2.3 确保模板的`deduplication_fields`被正确使用
- [x] 2.4 添加日志显示用于hash计算的字段列表
- [x] 2.5 测试各种数据场景的去重逻辑

## 3. 修复批量插入逻辑
- [x] 3.1 审查`batch_insert_raw_data`方法（`raw_data_importer.py`）
- [x] 3.2 修复表达式索引路径下只插入第一行的问题
- [x] 3.3 确保`insert_data_orm`中的所有行都被处理
- [x] 3.4 修复事务处理，确保所有行都被提交
- [x] 3.5 验证`actual_inserted`计数计算正确
- [x] 3.6 测试各种文件大小的批量插入

## 4. 添加行数验证
- [x] 4.1 添加验证，比较源文件行数与导入行数
- [x] 4.2 在验证中考虑合法重复
- [x] 4.3 检测到显著数据丢失时添加警告/错误（>5%差异）
- [x] 4.4 记录详细统计信息（总行数、导入行数、跳过重复数）

## 5. 改进错误处理和日志
- [x] 5.1 为每个插入步骤添加详细日志
- [x] 5.2 记录前几行的`data_hash`值（用于调试）
- [x] 5.3 改进插入失败时的错误消息
- [x] 5.4 添加插入性能指标

## 6. 前端：核心字段配置UI（新增）
- [x] 6.1 在`DataSyncTemplates.vue`添加核心字段选择区域
  - [x] 6.1.0 **注意**：`DataSyncFileDetail.vue`也需要添加相同的核心字段配置UI
  - [x] 6.1.1 位置：在"原始表头字段列表"卡片下方，或与"保存为模板"按钮同一区域
  - [x] 6.1.2 组件：使用`el-checkbox-group`多选框，从`headerColumns`中选择
  - [x] 6.1.3 添加提示文本："核心字段用于数据去重，请选择能够唯一标识每行数据的字段（如：订单号、产品SKU等）"
  - [x] 6.1.4 添加必填验证：至少选择1个字段才能保存模板
- [x] 6.2 添加核心字段推荐功能
  - [x] 6.2.1 调用API获取默认核心字段推荐（基于数据域）
  - [x] 6.2.2 显示推荐字段，但不自动勾选（用户必须手动选择）
  - [x] 6.2.3 显示推荐说明："根据数据域，建议选择以下字段作为核心字段"
- [x] 6.3 添加字段验证提示
  - [x] 6.3.1 验证用户选择的字段是否在`headerColumns`中
  - [x] 6.3.2 如果字段不在表头中，显示警告（允许用户继续，但记录警告）
  - [x] 6.3.3 显示字段匹配状态（找到/未找到）
- [x] 6.4 修改`api.saveTemplate()`方法
  - [x] 6.4.1 添加`deduplication_fields`参数
  - [x] 6.4.2 验证`deduplication_fields`不为空（前端验证）
- [x] 6.5 在模板列表中显示核心字段
  - [x] 6.5.1 在模板列表表格中添加"核心字段"列（显示字段数量，如"3个字段"）
  - [x] 6.5.2 鼠标悬停时显示完整字段列表（tooltip）
  - [x] 6.5.3 点击详情时显示完整核心字段列表
- [x] 6.6 在模板详情中显示核心字段
  - [x] 6.6.1 在模板详情弹窗中显示核心字段列表
  - [x] 6.6.2 显示核心字段数量统计
  - [x] 6.6.3 显示字段说明："用于数据去重，确保每行数据唯一"
- [x] 6.7 在`DataSyncFileDetail.vue`添加核心字段配置UI
  - [x] 6.7.1 复用`DataSyncTemplates.vue`的核心字段选择组件（或创建共享组件）
  - [x] 6.7.2 在文件详情页面的模板保存功能中添加核心字段选择
  - [x] 6.7.3 确保两个页面的核心字段配置UI一致
- [x] 6.8 创建共享的核心字段选择组件（可选，推荐）
  - [x] 6.8.1 创建`frontend/src/components/DeduplicationFieldsSelector.vue`组件
  - [x] 6.8.2 封装核心字段选择逻辑（多选框、推荐、验证）
  - [x] 6.8.3 在`DataSyncTemplates.vue`和`DataSyncFileDetail.vue`中使用共享组件

## 7. 后端：核心字段验证和API增强
- [x] 7.1 验证`POST /api/field-mapping/templates/save` API
  - [x] 7.1.1 确认API已支持`deduplication_fields`参数（已支持，无需修改）
  - [x] 7.1.2 添加验证：`deduplication_fields`不能为空（必填）
  - [x] 7.1.3 添加验证：`deduplication_fields`必须是列表且至少包含1个字段
  - [x] 7.1.4 **向后兼容**：如果`deduplication_fields`为None或空列表，使用默认配置（但记录警告，提示用户应该手动选择）
- [x] 7.2 添加核心字段验证逻辑
  - [x] 7.2.1 验证核心字段是否在`header_columns`中
  - [x] 7.2.2 如果字段不在`header_columns`中，记录警告但不阻止保存
  - [x] 7.2.3 支持中英文字段名匹配（如"订单号"和"order_id"）
- [x] 7.3 添加API获取默认核心字段推荐
  - [x] 7.3.1 创建`GET /api/field-mapping/templates/default-deduplication-fields` API
  - [x] 7.3.2 根据`data_domain`和`sub_domain`返回默认核心字段列表
  - [x] 7.3.3 返回字段说明和推荐原因
- [x] 7.4 增强日志记录
  - [x] 7.4.1 记录使用的核心字段列表
  - [x] 7.4.2 记录核心字段匹配情况（找到/未找到的字段）
  - [x] 7.4.3 记录核心字段在数据中的存在情况

## 8. 测试
- [x] 8.1 创建包含100+行唯一数据的测试文件
- [x] 8.2 测试单文件同步 - 验证所有行都被导入
- [x] 8.3 测试批量同步 - 验证所有行都被导入
- [x] 8.4 测试包含重复行的文件 - 验证重复被跳过
- [x] 8.5 测试大文件（1000+行） - 验证性能
- [x] 8.6 测试核心字段配置UI
  - [x] 8.6.1 测试核心字段选择功能（DataSyncTemplates.vue和DataSyncFileDetail.vue）
  - [x] 8.6.2 测试核心字段验证（字段不存在时的警告）
  - [x] 8.6.3 测试核心字段在数据同步中的使用
  - [x] 8.6.4 测试默认字段推荐功能
  - [x] 8.6.5 测试向后兼容性（现有模板无`deduplication_fields`时使用默认配置）
- [x] 8.7 测试Metabase集成 - 验证外键关系正常工作

## 9. 文档
- [x] 9.1 更新数据同步文档，说明去重行为（已在proposal.md和design.md中说明）
- [x] 9.2 文档化如何在模板中配置`deduplication_fields`（已在proposal.md中说明）
- [x] 9.3 添加数据导入问题的故障排查指南（已创建test_data_sync_fix.md测试指南）
- [x] 9.4 添加核心字段配置的用户指南（已在组件UI中添加提示和说明）
- [x] 9.5 添加数据去重流程的详细说明文档（已在design.md中详细说明）
