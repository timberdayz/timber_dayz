# 变更：优化数据同步以适应实际工作场景

## 问题背景

数据同步功能已能创建模板和同步数据，但在实际场景中遇到两个问题：

### 问题1：货币代码导致的表头变化误报

**现状**：
- 系统严格要求表头行的任何变化都必须用户手动确认
- 电商平台导出的源数据会根据当地货币在表头中添加货币代码（如BRL、COP等）
- 例如："销售额（已付款订单）(BRL)" vs "销售额（已付款订单）(COP)"
- 这些字段语义相同（都是"销售额（已付款订单）"），只是货币不同
- 但系统将其识别为不同的字段，触发表头变化检测，阻止同步

**影响**：
- 用户需要频繁更新模板，即使业务逻辑未变
- 全球业务场景下，同一数据域可能有多种货币变体
- 降低数据同步效率，增加维护成本

### 问题2：库存数据的重复记录

**现状**：
- 系统使用`data_hash`（基于核心字段）判断重复数据
- 库存数据的核心字段：`['product_sku', 'warehouse_id', 'platform_code', 'shop_id']`
- 如果同一商品（product_sku相同）在不同时间点库存数量不同（如1 vs 2）
- 由于数量字段不在核心字段中，`data_hash`不同，导致两条记录都入库
- 最终数据库中同一商品存在多条记录，库存数量不一致

**影响**：
- 库存数据不准确，无法正确反映当前库存状态
- 查询时需要额外去重或聚合逻辑
- 影响库存分析和决策

## 变更内容

### 核心优化

#### 1. 智能表头变化检测和货币代码提取

- **货币变体识别**：系统识别表头中的货币代码变体（如BRL、COP、SGD等），将其视为同一字段的不同变体
- **模式匹配增强**：使用正则表达式识别货币代码模式（如`(BRL)`, `(COP)`, `(SGD)`等）
- **字段名归一化**：在表头变化检测前，将货币变体字段归一化为基础字段名（移除货币代码）
- **货币代码提取**：从字段名中提取货币代码，存储到`currency_code`系统字段（String(3)）
- **智能匹配策略**：
  - 如果只有货币代码差异，视为匹配（不触发变化检测）
  - 如果还有其他字段变化，正常触发变化检测
  - 多货币字段处理：如果一行数据有多个货币字段，提取第一个货币字段的货币代码（方案A）
- **数据存储优化**：
  - `raw_data` JSONB中字段名归一化（不含货币代码）：`"销售额（已付款订单）": 100.50`
  - `currency_code`字段存储货币代码：`"BRL"`
  - Metabase查询更简洁：字段名不含货币代码，货币作为独立维度字段

#### 2. 库存数据更新策略

- **UPSERT策略**：对于库存数据域，使用UPSERT（INSERT ... ON CONFLICT ... UPDATE）而非INSERT ... ON CONFLICT DO NOTHING
- **更新字段配置**：定义哪些字段在冲突时应该更新（如`raw_data`, `ingest_timestamp`, `file_id`, `header_columns`）
- **时间戳管理**：更新时保留`created_at`（如果存在），更新`ingest_timestamp`和`file_id`
- **数据域特定策略**：为不同数据域配置不同的去重策略（inventory使用UPSERT，其他域使用INSERT）

### 增强功能

- **货币代码配置**：支持配置货币代码模式（默认支持180+货币，ISO 4217标准）
- **更新字段配置**：在配置中定义哪些字段在冲突时应该更新（统一配置，保持一致性）
- **策略选择**：根据数据域自动选择去重策略（INSERT vs UPSERT）
- **向后兼容**：现有模板和数据保持现有行为（orders/products等仍使用INSERT策略）

## 影响范围

- **受影响的能力规范**：`data-sync`能力
- **受影响的代码**：
  - `backend/services/template_matcher.py` - 表头变化检测逻辑
  - `backend/services/data_ingestion_service.py` - 数据入库逻辑
  - `backend/services/raw_data_importer.py` - 批量插入/UPSERT逻辑
  - `backend/services/deduplication_service.py` - 去重策略选择
  - `backend/services/deduplication_fields_config.py` - 策略和更新字段配置
- **数据库影响**：
  - 需要添加`currency_code`字段（String(3), nullable=True, index=True）到所有`fact_raw_data_*`表
  - 无需修改其他表结构（所有表已有`ingest_timestamp`字段）
  - 无需添加`created_at`字段（`ingest_timestamp`已足够）
  - 无需迁移历史数据（开发环境）
- **API影响**：无（内部逻辑优化）
- **前端影响**：可能需要添加货币变体识别提示（可选）

## 成功标准

1. ✅ 货币代码变体不再触发表头变化检测（如果只有货币差异）
2. ✅ 货币代码正确提取并存储到`currency_code`字段
3. ✅ 字段名归一化正确（`raw_data`中字段名不含货币代码）
4. ✅ 库存数据更新而非重复插入（同一商品+仓库只有一条记录）
5. ✅ 其他数据域保持现有行为（orders/products使用INSERT策略）
6. ✅ 向后兼容现有模板和数据
7. ✅ 性能不受影响（写入性能影响<0.5%，查询性能提升10-100倍）
8. ✅ 系统字段配置统一（所有数据域都有统一的更新字段配置）

