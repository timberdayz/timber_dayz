# Design: æ•°æ®é‡‡é›†æ¨¡å—é‡æ„ - æ–¹æ¡ˆBï¼šç»„ä»¶é©±åŠ¨æ¶æ„

## Context

### èƒŒæ™¯

è¥¿è™¹ERPç³»ç»Ÿçš„æ•°æ®é‡‡é›†æ¨¡å—æ˜¯æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œè´Ÿè´£ä»å¤šä¸ªç”µå•†å¹³å°ï¼ˆShopeeã€TikTokã€å¦™æ‰‹ERPï¼‰è‡ªåŠ¨åŒ–é‡‡é›†æ•°æ®ã€‚å½“å‰å®ç°ä¸º CLI äº¤äº’å¼å·¥å…·ï¼Œé‡‡ç”¨å®Œæ•´è„šæœ¬å½•åˆ¶æ–¹å¼ï¼Œå­˜åœ¨å¯ç»´æŠ¤æ€§å·®ã€æ— æ³•ä¸å‰ç«¯å¯¹æ¥ç­‰é—®é¢˜ã€‚

### çº¦æŸæ¡ä»¶

1. **å®‰å…¨çº¦æŸ**ï¼šè´¦å·å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯å¿…é¡»ä¿æŒåœ¨ `local_accounts.py`ï¼Œä¸èƒ½å…¥åº“
2. **æƒé™çº¦æŸ**ï¼šé‡‡é›†åŠŸèƒ½ä»…é™ç®¡ç†å‘˜ä½¿ç”¨
3. **æŠ€æœ¯çº¦æŸ**ï¼š
   - å‰ç«¯ä½¿ç”¨ Vue.js 3 + Element Plus
   - åç«¯ä½¿ç”¨ FastAPI
   - æ•°æ®åº“ä½¿ç”¨ PostgreSQL
   - é‡‡é›†ä½¿ç”¨ Playwrightï¼ˆé Seleniumï¼‰
4. **éƒ¨ç½²çº¦æŸ**ï¼šæœªæ¥éœ€è¦åœ¨äº‘ç«¯ Docker å®¹å™¨ä¸­è¿è¡Œ headless æµè§ˆå™¨
5. **å½•åˆ¶çº¦æŸ**ï¼šæ‰€æœ‰å¹³å°å’Œæ•°æ®åŸŸå°†é‡æ–°å½•åˆ¶ï¼Œå¯ä»¥é‡‡ç”¨å…¨æ–°æ¶æ„

### åˆ©ç›Šç›¸å…³è€…

- **ç®¡ç†å‘˜**ï¼šéœ€è¦é€šè¿‡ Web ç•Œé¢é…ç½®å’Œç›‘æ§é‡‡é›†ä»»åŠ¡
- **ç³»ç»Ÿ**ï¼šéœ€è¦å®šæ—¶è‡ªåŠ¨æ‰§è¡Œé‡‡é›†ä»»åŠ¡
- **å¼€å‘è€…**ï¼šéœ€è¦åœ¨ç½‘ç«™æ›´æ–°æ—¶å¿«é€Ÿä¿®å¤é‡‡é›†ç»„ä»¶

## Goals / Non-Goals

### Goals

- G1: è®¾è®¡ç»„ä»¶åŒ–é‡‡é›†æ¶æ„ï¼Œæé«˜å¯ç»´æŠ¤æ€§
- G2: å®ç°ç»„ä»¶å½•åˆ¶å·¥å…·ï¼Œé™ä½å½•åˆ¶é—¨æ§›
- G3: å®ç°å‰ç«¯é‡‡é›†é…ç½®ç®¡ç†ç•Œé¢
- G4: å®ç°å‰ç«¯é‡‡é›†ä»»åŠ¡ç®¡ç†å’Œå®æ—¶ç›‘æ§
- G5: å®ç°å®šæ—¶è‡ªåŠ¨é‡‡é›†åŠŸèƒ½
- G6: å®ç° WebSocket å®æ—¶çŠ¶æ€æ¨é€
- G7: é¢„ç•™ä»£ç†IPæ¥å£ï¼Œæ”¯æŒåç»­åå°ç¦å¢å¼º
- G8: å®Œæˆ Docker headless æ¨¡å¼é€‚é…

### Non-Goals

- NG1: ä¸åœ¨å‰ç«¯å®ç° Playwright å½•åˆ¶åŠŸèƒ½
- NG2: ä¸è¿ç§»è´¦å·æ•æ„Ÿä¿¡æ¯åˆ°æ•°æ®åº“
- NG3: ä¸å®ç°ä»£ç†IPæ± æœåŠ¡ï¼ˆä»…é¢„ç•™æ¥å£ï¼‰
- NG4: ä¸æ”¯æŒ Amazon å¹³å°

## Decisions

### D1: ç»„ä»¶é©±åŠ¨æ¶æ„è®¾è®¡

**å†³ç­–**ï¼šé‡‡ç”¨ YAML é…ç½®é©±åŠ¨çš„ç»„ä»¶åŒ–æ¶æ„

**æ¶æ„å¯¹æ¯”**ï¼š

| ç»´åº¦ | æ–¹æ¡ˆCï¼ˆè„šæœ¬é©±åŠ¨ï¼‰ | æ–¹æ¡ˆBï¼ˆç»„ä»¶é©±åŠ¨ï¼‰ |
|------|-------------------|-------------------|
| å½•åˆ¶å•ä½ | å®Œæ•´é‡‡é›†æµç¨‹ | ç‹¬ç«‹åŠŸèƒ½ç»„ä»¶ |
| å½•åˆ¶æ•°é‡ | 45+ ä¸ªè„šæœ¬ | ~24 ä¸ªç»„ä»¶ |
| æ–‡ä»¶æ ¼å¼ | Python (.py) | YAML (.yaml) |
| å¤ç”¨æ€§ | ä½ï¼ˆç‹¬ç«‹è„šæœ¬ï¼‰ | é«˜ï¼ˆç»„ä»¶å¤ç”¨ï¼‰ |
| ç»´æŠ¤æˆæœ¬ | é«˜ï¼ˆæ”¹å¤šä¸ªæ–‡ä»¶ï¼‰ | ä½ï¼ˆæ”¹å•ä¸ªç»„ä»¶ï¼‰ |
| Agentå‹å¥½åº¦ | ä½ | é«˜ï¼ˆç»“æ„åŒ–é…ç½®ï¼‰ |

**ç»„ä»¶ç±»å‹å®šä¹‰**ï¼š

```yaml
# ç»„ä»¶ç±»å‹æšä¸¾
component_types:
  - login          # ç™»å½•ç»„ä»¶ï¼šå¤„ç†å¹³å°ç™»å½•æµç¨‹
  - navigation     # å¯¼èˆªç»„ä»¶ï¼šå¯¼èˆªåˆ°ç‰¹å®šé¡µé¢
  - date_picker    # æ—¥æœŸé€‰æ‹©ç»„ä»¶ï¼šè®¾ç½®æ—¥æœŸèŒƒå›´
  - export         # å¯¼å‡ºç»„ä»¶ï¼šæ‰§è¡Œæ•°æ®å¯¼å‡ºæ“ä½œ
  - verification   # éªŒè¯ç å¤„ç†ç»„ä»¶ï¼šå¤„ç†2FA/æ»‘å—éªŒè¯
```

**å„å¹³å°ç»„ä»¶æ•°é‡ä¼°ç®—**ï¼š

| å¹³å° | login | navigation | date_picker | export (6åŸŸ) | åˆè®¡ |
|------|-------|------------|-------------|--------------|------|
| Shopee | 1 | 1 | 1 | 6 | 9 |
| TikTok | 1 | 1 | 1 | 6 | 9 |
| å¦™æ‰‹ERP | 1 | 1 | 1 | 6 | 9 |
| **æ€»è®¡** | 3 | 3 | 3 | 18 | **27** |

> æ³¨ï¼šexport ç»„ä»¶è¦†ç›– 6 ä¸ªæ•°æ®åŸŸï¼šorders, products, services, analytics, finance, inventory

### D2: Playwrightä½¿ç”¨è§„èŒƒï¼ˆ2025-12-17æ–°å¢ï¼‰â­â­â­

**å†³ç­–**ï¼šä¼˜å…ˆä½¿ç”¨Playwrightå®˜æ–¹APIå’Œå®˜æ–¹å·¥å…·ï¼Œä¸è‡ªå·±å®ç°

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **å®˜æ–¹APIä¼˜å…ˆ**: ä½¿ç”¨Playwrightæä¾›çš„å®˜æ–¹APIï¼Œä¸åˆ›å»ºè‡ªå®šä¹‰å®ç°
2. **å®˜æ–¹å·¥å…·ä¼˜å…ˆ**: ä½¿ç”¨Inspectorã€Codegenç­‰å®˜æ–¹å·¥å…·ï¼Œä¸å¼€å‘æ›¿ä»£å·¥å…·
3. **å®Œæ•´ç­‰å¾…æœºåˆ¶**: å®ç°ä¸‰çº§ç­‰å¾…ï¼ˆDOM â†’ ç½‘ç»œ â†’ æ¸²æŸ“ï¼‰ç¡®ä¿é¡µé¢å°±ç»ª
4. **å…ƒç´ å¯è§æ€§æ£€æŸ¥**: äº¤äº’å‰éªŒè¯å…ƒç´ å¯è§å¹¶æ»šåŠ¨åˆ°è§†å›¾

**å…ƒç´ å®šä½ä¼˜å…ˆçº§**ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ï¼š
```python
# 1. â­â­â­ get_by_role - å®˜æ–¹æ¨èï¼Œæœ€ç¨³å®š
page.get_by_role("textbox", name="æ‰‹æœºå·/å­è´¦å·/é‚®ç®±")

# 2. â­â­ get_by_label - è¡¨å•å…ƒç´ é¦–é€‰
page.get_by_label("å¯†ç ")

# 3. â­â­ get_by_text - æ–‡æœ¬å®šä½
page.get_by_text("ç«‹å³ç™»å½•")

# 4. â­ get_by_placeholder/title - å…¶ä»–è¯­ä¹‰åŒ–å®šä½
page.get_by_placeholder("è¯·è¾“å…¥ç”¨æˆ·å")

# 5. locator - é€šç”¨é™çº§æ–¹æ¡ˆï¼ˆCSS/XPathï¼‰
page.locator(".login-button")
```

**å®Œæ•´ç­‰å¾…æµç¨‹**ï¼ˆå¿…é¡»å®ç°ï¼‰ï¼š
```python
# é¡µé¢åŠ è½½ä¸‰çº§ç­‰å¾…
page.goto(url, wait_until='domcontentloaded')     # 1. DOMåŠ è½½
page.wait_for_load_state('networkidle', timeout=10000)  # 2. ç½‘ç»œç©ºé—²
page.wait_for_timeout(1000)                       # 3. JavaScriptæ¸²æŸ“

# å…ƒç´ äº¤äº’å‰ç­‰å¾…
locator = page.get_by_role("button", name="ç™»å½•")
locator.wait_for(state='visible', timeout=30000)  # ç­‰å¾…å¯è§
locator.scroll_into_view_if_needed()              # æ»šåŠ¨åˆ°è§†å›¾
locator.click()                                    # ç‚¹å‡»
```

**ç¦æ­¢è¡Œä¸º**ï¼ˆé›¶å®¹å¿ï¼‰ï¼š
- âŒ åˆ›å»º`_fix_selector()`æ–¹æ³•ä¿®å¤é€‰æ‹©å™¨
- âŒ åˆ›å»º`_get_smart_locator()`å¤šç­–ç•¥é™çº§
- âŒ æ‰‹åŠ¨è½¬æ¢`role=xxx[name=yyy]`ä¸ºCSS selector
- âŒ è‡ªå·±å®ç°XPathé™çº§é€»è¾‘
- âŒ ç»•è¿‡å®˜æ–¹APIç›´æ¥æ“ä½œåº•å±‚

**å†å²æ•™è®­**ï¼ˆ2025-12-17ï¼‰ï¼š
- **é—®é¢˜**: ç»„ä»¶æµ‹è¯•å¤±è´¥ç‡é«˜ï¼Œæ“ä½œæ‰§è¡Œæ—¶å…ƒç´ æœªåŠ è½½
- **åŸå› **: è‡ªå®šä¹‰äº†é€‰æ‹©å™¨å¤„ç†é€»è¾‘ï¼Œç¼ºå°‘å®Œæ•´ç­‰å¾…æœºåˆ¶
- **è§£å†³**: åˆ é™¤è‡ªå®šä¹‰å®ç°ï¼Œä½¿ç”¨å®˜æ–¹API + ä¸‰çº§ç­‰å¾…
- **å‚è€ƒ**: `tools/test_component.py` - `_get_playwright_locator()` å’Œ `_execute_step()`

### D3: ç»„ä»¶ YAML æ ¼å¼è®¾è®¡

**å†³ç­–**ï¼šä½¿ç”¨ç»“æ„åŒ– YAML æè¿° Playwright æ“ä½œæ­¥éª¤

**ç»„ä»¶é…ç½®æ ¼å¼**ï¼š

```yaml
# config/collection_components/shopee/login.yaml
name: shopee_login
platform: shopee
type: login
version: "1.0"
description: "Shopeeå–å®¶ä¸­å¿ƒç™»å½•ç»„ä»¶"

# ç»„ä»¶å…ƒæ•°æ®
metadata:
  author: "admin"
  created_at: "2025-01-08"
  updated_at: "2025-01-08"
  stable: true

# å‰ç½®æ¡ä»¶
prerequisites:
  - page_url_pattern: "seller.shopee.*/account/signin"

# æ‰§è¡Œæ­¥éª¤
steps:
  - id: input_username
    action: fill
    selector: "input[name='loginKey']"
    value: "{{account.username}}"
    wait_after: 500

  - id: input_password
    action: fill
    selector: "input[name='password']"
    value: "{{account.password}}"
    wait_after: 500

  - id: click_login
    action: click
    selector: "button.shopee-button--primary"
    wait_after: 2000

  - id: wait_for_dashboard
    action: wait_for_selector
    selector: ".seller-center-dashboard"
    timeout: 30000

# æˆåŠŸåˆ¤å®š
success_criteria:
  - type: url_contains
    value: "seller.shopee"
  - type: selector_visible
    selector: ".seller-center-dashboard"

# é”™è¯¯å¤„ç†
error_handlers:
  - trigger: selector_visible
    selector: ".verification-code-dialog"
    action: pause_for_manual
    message: "æ£€æµ‹åˆ°éªŒè¯ç ï¼Œè¯·æ‰‹åŠ¨å®ŒæˆéªŒè¯"
```

**å¯¼å‡ºç»„ä»¶æ ¼å¼**ï¼š

```yaml
# config/collection_components/shopee/orders_export.yaml
name: shopee_orders_export
platform: shopee
type: export
version: "1.0"
description: "Shopeeè®¢å•æ•°æ®å¯¼å‡ºç»„ä»¶"
data_domain: orders

metadata:
  author: "admin"
  created_at: "2025-01-08"
  stable: true

# å‰ç½®æ¡ä»¶ï¼šå¿…é¡»å·²ç™»å½•å¹¶åœ¨è®¢å•é¡µé¢
prerequisites:
  - page_url_pattern: "seller.shopee.*/portal/sale/*"

# å‚æ•°å®šä¹‰
parameters:
  - name: date_from
    type: date
    required: true
  - name: date_to
    type: date
    required: true
  - name: granularity
    type: enum
    values: [daily, weekly, monthly]
    default: daily

steps:
  - id: click_export_button
    action: click
    selector: "button:has-text('å¯¼å‡º')"
    wait_after: 1000

  - id: select_date_range
    action: component_call
    component: shopee_date_picker
    params:
      date_from: "{{params.date_from}}"
      date_to: "{{params.date_to}}"

  - id: click_confirm_export
    action: click
    selector: "button:has-text('ç¡®è®¤å¯¼å‡º')"
    wait_after: 2000

  - id: wait_for_download
    action: wait_for_download
    timeout: 120000
    filename_pattern: "è®¢å•*.xlsx"

success_criteria:
  - type: download_completed
    filename_pattern: "è®¢å•*.xlsx"

output:
  type: file
  naming:
    platform: shopee
    data_domain: orders
    granularity: "{{params.granularity}}"
```

### D3: ç»„ä»¶å½•åˆ¶å·¥å…·è®¾è®¡

**å†³ç­–**ï¼šå¼€å‘ CLI ç»„ä»¶å½•åˆ¶å·¥å…·ï¼Œè¾“å‡º YAML é…ç½®

**å·¥å…·ä½¿ç”¨æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1ï¼šå¯åŠ¨å½•åˆ¶                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ > python tools/record_component.py                               â”‚
â”‚     --platform shopee                                            â”‚
â”‚     --component orders_export                                    â”‚
â”‚     --account MyStore_SG                                         â”‚
â”‚                                                                  â”‚
â”‚ ç³»ç»Ÿæ“ä½œï¼š                                                        â”‚
â”‚   1. åŠ è½½è´¦å·ä¿¡æ¯                                                 â”‚
â”‚   2. å¯åŠ¨æµè§ˆå™¨ï¼ˆheadedæ¨¡å¼ï¼‰                                      â”‚
â”‚   3. è‡ªåŠ¨æ‰§è¡Œ login å’Œ navigation ç»„ä»¶ï¼ˆå¦‚å·²å­˜åœ¨ï¼‰                 â”‚
â”‚   4. å¯¼èˆªåˆ°ç›®æ ‡é¡µé¢                                               â”‚
â”‚   5. å¼€å¯ Playwright Inspector è¿›å…¥å½•åˆ¶æ¨¡å¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2ï¼šæ‰‹åŠ¨å½•åˆ¶æ“ä½œ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Inspector çª—å£ä¸­ï¼š                                                â”‚
â”‚   - ç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼ˆè‡ªåŠ¨è®°å½• selectorï¼‰                           â”‚
â”‚   - é€‰æ‹©æ—¥æœŸèŒƒå›´ï¼ˆè‡ªåŠ¨è®°å½•æ“ä½œï¼‰                                   â”‚
â”‚   - ç‚¹å‡»ç¡®è®¤å¯¼å‡ºï¼ˆè‡ªåŠ¨è®°å½•ï¼‰                                       â”‚
â”‚   - ç­‰å¾…ä¸‹è½½å®Œæˆï¼ˆè‡ªåŠ¨è®°å½•ï¼‰                                       â”‚
â”‚                                                                  â”‚
â”‚ å®ŒæˆåæŒ‰ Resume æˆ–å…³é—­ Inspector                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3ï¼šç”Ÿæˆ YAML é…ç½®                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥å…·è‡ªåŠ¨ï¼š                                                        â”‚
â”‚   1. è§£æå½•åˆ¶çš„æ“ä½œåºåˆ—                                           â”‚
â”‚   2. è½¬æ¢ä¸ºç»“æ„åŒ– YAML æ ¼å¼                                       â”‚
â”‚   3. æ·»åŠ å…ƒæ•°æ®ï¼ˆä½œè€…ã€æ—¶é—´ç­‰ï¼‰                                    â”‚
â”‚   4. ä¿å­˜åˆ° config/collection_components/shopee/orders_export.yamlâ”‚
â”‚                                                                  â”‚
â”‚ è¾“å‡ºï¼š                                                            â”‚
â”‚   âœ… ç»„ä»¶å½•åˆ¶å®Œæˆ                                                 â”‚
â”‚   ğŸ“ ä¿å­˜åˆ°: config/collection_components/shopee/orders_export.yamlâ”‚
â”‚   ğŸ“ è¯·æ£€æŸ¥å¹¶è¡¥å……å‚æ•°å®šä¹‰å’ŒæˆåŠŸåˆ¤å®šæ¡ä»¶                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å½•åˆ¶å·¥å…·æ ¸å¿ƒä»£ç ç»“æ„**ï¼š

```python
# tools/record_component.py
class ComponentRecorder:
    """ç»„ä»¶å½•åˆ¶å™¨"""
    
    def __init__(self, platform: str, component: str, account: str):
        self.platform = platform
        self.component = component
        self.account = account
        
    async def start_recording(self):
        """å¯åŠ¨å½•åˆ¶"""
        # 1. å¯åŠ¨æµè§ˆå™¨
        browser = await self._launch_browser(headless=False)
        
        # 2. é¢„æ‰§è¡Œå‰ç½®ç»„ä»¶ï¼ˆlogin, navigationï¼‰
        await self._execute_prerequisites(browser)
        
        # 3. å¼€å¯ Inspector å½•åˆ¶æ¨¡å¼
        await browser.page.pause()  # è§¦å‘ Playwright Inspector
        
        # 4. ç­‰å¾…ç”¨æˆ·å®Œæˆå½•åˆ¶
        recorded_actions = await self._collect_recorded_actions()
        
        # 5. è½¬æ¢ä¸º YAML
        yaml_config = self._convert_to_yaml(recorded_actions)
        
        # 6. ä¿å­˜é…ç½®
        self._save_component(yaml_config)
```

### D4: é‡‡é›†æ‰§è¡Œå¼•æ“è®¾è®¡

**å†³ç­–**ï¼šå®ç°ç»„ä»¶ç»„è£…æ‰§è¡Œå¼•æ“ `CollectionExecutorV2`

**æ‰§è¡Œæµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‡é›†æ‰§è¡Œå¼•æ“ V2                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¥æ”¶ä»»åŠ¡å‚æ•°                                                  â”‚
â”‚    - platform: shopee                                           â”‚
â”‚    - account_id: MyStore_SG                                     â”‚
â”‚    - data_domains: [orders, products]                           â”‚
â”‚    - date_range: {from: "2025-01-07", to: "2025-01-07"}         â”‚
â”‚    - granularity: daily                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åŠ è½½ç»„ä»¶é…ç½®                                                  â”‚
â”‚    ComponentLoader.load("shopee/login.yaml")                    â”‚
â”‚    ComponentLoader.load("shopee/navigation.yaml")               â”‚
â”‚    ComponentLoader.load("shopee/date_picker.yaml")              â”‚
â”‚    ComponentLoader.load("shopee/orders_export.yaml")            â”‚
â”‚    ComponentLoader.load("shopee/products_export.yaml")          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡                                              â”‚
â”‚    - åŠ è½½è´¦å·å¯¹åº”çš„ browser profile                              â”‚
â”‚    - åº”ç”¨è®¾å¤‡æŒ‡çº¹ï¼ˆUAã€viewportã€localeï¼‰                        â”‚
â”‚    - åº”ç”¨ä»£ç†é…ç½®ï¼ˆå¦‚æœ‰ï¼‰                                        â”‚
â”‚    - æ³¨å…¥åæ£€æµ‹è„šæœ¬                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æŒ‰åºæ‰§è¡Œç»„ä»¶                                                  â”‚
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚    â”‚   login    â”‚ -> â”‚ navigation â”‚ -> â”‚date_picker â”‚          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                                   â”‚                  â”‚
â”‚          â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚          â”‚          â”‚                                           â”‚
â”‚          â”‚          â–¼                                           â”‚
â”‚          â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚          â”‚    â”‚ å¾ªç¯æ¯ä¸ªæ•°æ®åŸŸ â”‚                                 â”‚
â”‚          â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚          â”‚          â”‚                                           â”‚
â”‚          â”‚          â”œâ”€â–¶ orders_export                           â”‚
â”‚          â”‚          â”œâ”€â–¶ products_export                         â”‚
â”‚          â”‚          â””â”€â–¶ ...                                     â”‚
â”‚          â”‚                                                      â”‚
â”‚    æ¯ä¸ªæ­¥éª¤æ‰§è¡Œåï¼š                                               â”‚
â”‚    - æ›´æ–°æ•°æ®åº“è¿›åº¦                                              â”‚
â”‚    - é€šè¿‡ WebSocket æ¨é€çŠ¶æ€                                     â”‚
â”‚    - æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ–‡ä»¶å¤„ç†                                                      â”‚
â”‚    - ä» temp/downloads/{task_uuid}/ è¯»å–ä¸‹è½½æ–‡ä»¶                 â”‚
â”‚    - ä½¿ç”¨ file_naming.StandardFileName ç”Ÿæˆæ ‡å‡†æ–‡ä»¶å            â”‚
â”‚    - ç§»åŠ¨åˆ° data/raw/YYYY/                                      â”‚
â”‚    - ç”Ÿæˆ .meta.json ä¼´ç”Ÿæ–‡ä»¶                                   â”‚
â”‚    - è°ƒç”¨ register_single_file() æ³¨å†Œåˆ° catalog_files           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å®Œæˆä»»åŠ¡                                                      â”‚
â”‚    - æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º completed                                    â”‚
â”‚    - è®°å½•é‡‡é›†æ–‡ä»¶æ•°é‡                                            â”‚
â”‚    - é€šè¿‡ WebSocket æ¨é€å®Œæˆé€šçŸ¥                                 â”‚
â”‚    - å…³é—­æµè§ˆå™¨ä¸Šä¸‹æ–‡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰§è¡Œå¼•æ“æ ¸å¿ƒä»£ç ç»“æ„**ï¼š

```python
# modules/apps/collection_center/executor_v2.py
class CollectionExecutorV2:
    """ç»„ä»¶é©±åŠ¨çš„é‡‡é›†æ‰§è¡Œå¼•æ“"""
    
    def __init__(
        self,
        component_loader: ComponentLoader,
        browser_manager: PersistentBrowserManager,
        status_callback: Callable[[str, int, str], None]
    ):
        self.component_loader = component_loader
        self.browser_manager = browser_manager
        self.status_callback = status_callback
        
    async def execute(
        self,
        task_id: str,
        platform: str,
        account_id: str,
        data_domains: List[str],
        date_range: Dict[str, str],
        granularity: str
    ) -> CollectionResult:
        """æ‰§è¡Œé‡‡é›†ä»»åŠ¡"""
        
        # 1. åŠ è½½ç»„ä»¶
        login_component = self.component_loader.load(f"{platform}/login.yaml")
        nav_component = self.component_loader.load(f"{platform}/navigation.yaml")
        
        # 2. åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡
        context = await self.browser_manager.get_context(account_id)
        
        # 3. æ‰§è¡Œç™»å½•
        self._update_status(task_id, 10, "æ­£åœ¨ç™»å½•...")
        await self._execute_component(context, login_component)
        
        # 4. æ‰§è¡Œå¯¼èˆª
        self._update_status(task_id, 20, "æ­£åœ¨å¯¼èˆª...")
        await self._execute_component(context, nav_component)
        
        # 5. å¾ªç¯æ‰§è¡Œå„æ•°æ®åŸŸå¯¼å‡º
        collected_files = []
        for i, domain in enumerate(data_domains):
            progress = 20 + int(70 * (i + 1) / len(data_domains))
            self._update_status(task_id, progress, f"æ­£åœ¨é‡‡é›† {domain}...")
            
            export_component = self.component_loader.load(
                f"{platform}/{domain}_export.yaml"
            )
            file_path = await self._execute_export(
                context, export_component, date_range, granularity
            )
            collected_files.append(file_path)
            
        # 6. å¤„ç†æ–‡ä»¶
        self._update_status(task_id, 95, "æ­£åœ¨å¤„ç†æ–‡ä»¶...")
        processed_files = await self._process_files(
            collected_files, platform, data_domains, granularity
        )
        
        return CollectionResult(
            task_id=task_id,
            status="completed",
            files_collected=len(processed_files)
        )
```

### D5: é…ç½®å­˜å‚¨æ–¹æ¡ˆ

**å†³ç­–**ï¼šé‡‡ç”¨æ··åˆå­˜å‚¨æ–¹æ¡ˆ

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | ç†ç”± |
|---------|----------|------|
| è´¦å·æ•æ„Ÿä¿¡æ¯ | `local_accounts.py` | å®‰å…¨æ€§ï¼Œä¸å…¥åº“ |
| ç»„ä»¶é…ç½® | `config/collection_components/` YAML æ–‡ä»¶ | ç‰ˆæœ¬æ§åˆ¶ã€Gitç®¡ç† |
| é‡‡é›†ä»»åŠ¡é…ç½® | æ•°æ®åº“ `collection_configs` è¡¨ | æ”¯æŒå‰ç«¯ CRUD |
| ä»»åŠ¡æ‰§è¡Œè®°å½• | æ•°æ®åº“ `collection_tasks` è¡¨ | ä¾¿äºæŸ¥è¯¢ç»Ÿè®¡ |
| ä»»åŠ¡è¯¦ç»†æ—¥å¿— | æ•°æ®åº“ `collection_task_logs` è¡¨ | ä¾¿äºæ’æŸ¥é—®é¢˜ |

### D6: å®æ—¶çŠ¶æ€æ¨é€æ–¹æ¡ˆ

**å†³ç­–**ï¼šä½¿ç”¨ FastAPI å†…ç½® WebSocket

**ç†ç”±**ï¼š
- é‡‡é›†æ¨¡å—ä»…ç®¡ç†å‘˜ä½¿ç”¨ï¼Œå¹¶å‘é‡ä½
- æ— éœ€å¼•å…¥ Redisï¼Œé™ä½æ¶æ„å¤æ‚åº¦
- FastAPI å†…ç½® WebSocket å¼€å‘å¿«é€Ÿ

**WebSocket æ¶ˆæ¯æ ¼å¼**ï¼š

```json
// è¿›åº¦æ›´æ–°
{
  "type": "progress",
  "task_id": "uuid",
  "progress": 50,
  "current_step": "æ­£åœ¨å¯¼å‡ºè®¢å•æ•°æ®...",
  "status": "running"
}

// æ—¥å¿—æ¶ˆæ¯
{
  "type": "log",
  "task_id": "uuid",
  "level": "info",
  "message": "æ–‡ä»¶ä¸‹è½½å®Œæˆ: orders_20250108.xlsx",
  "timestamp": "2025-01-08T14:30:22Z"
}

// å®Œæˆé€šçŸ¥
{
  "type": "complete",
  "task_id": "uuid",
  "status": "completed",
  "files_collected": 5,
  "duration_seconds": 180
}

// é”™è¯¯é€šçŸ¥
{
  "type": "error",
  "task_id": "uuid",
  "status": "failed",
  "error_message": "ç™»å½•å¤±è´¥ï¼šå¯†ç é”™è¯¯",
  "error_code": "AUTH_FAILED"
}

// éªŒè¯ç æš‚åœ
{
  "type": "verification_required",
  "task_id": "uuid",
  "status": "paused",
  "message": "æ£€æµ‹åˆ°éªŒè¯ç ï¼Œè¯·æ‰‹åŠ¨å®ŒæˆéªŒè¯åç»§ç»­",
  "screenshot_url": "/api/collection/tasks/{task_id}/screenshot"
}
```

### D7: å®šæ—¶è°ƒåº¦æ–¹æ¡ˆ

**å†³ç­–**ï¼šä½¿ç”¨ APScheduler

**ç†ç”±**ï¼š
- é¡¹ç›®å·²æœ‰ APScheduler ä¾èµ–ï¼ˆç‰©åŒ–è§†å›¾åˆ·æ–°ä½¿ç”¨ï¼‰
- æ”¯æŒ Cron è¡¨è¾¾å¼
- å¯æŒä¹…åŒ–åˆ°æ•°æ®åº“

**å®ç°ç»†èŠ‚**ï¼š
- ä½¿ç”¨ `AsyncIOScheduler`
- Job Store ä½¿ç”¨ SQLAlchemyï¼ˆä¸ä¸»æ•°æ®åº“å…±äº«ï¼‰
- **é‡è¦**ï¼šAPScheduler ä¼šè‡ªåŠ¨åˆ›å»º `apscheduler_jobs` è¡¨ï¼Œä¸éœ€è¦åœ¨ `schema.py` ä¸­æ‰‹åŠ¨å®šä¹‰
- æ”¯æŒæš‚åœ/æ¢å¤/åˆ é™¤å®šæ—¶ä»»åŠ¡

**å®ç°ä»£ç **ï¼š

```python
# backend/services/collection_scheduler.py

from apscheduler.jobstores.sqlalchemy import SQLAlchemyJobStore
from apscheduler.schedulers.asyncio import AsyncIOScheduler

# ä½¿ç”¨ä¸»æ•°æ®åº“è¿æ¥
jobstore = SQLAlchemyJobStore(url=DATABASE_URL, tablename='apscheduler_jobs')

scheduler = AsyncIOScheduler(
    jobstores={'default': jobstore},
    timezone='Asia/Shanghai'
)
```

### D8: æ–‡ä»¶å­˜å‚¨ä¸å‘½åæ–¹æ¡ˆ

**å†³ç­–**ï¼šé‡‡ç”¨ `data/raw/YYYY/` + æ ‡å‡†å‘½å + å…ƒæ•°æ®æ–‡ä»¶

**ç›®å½•ç»“æ„**ï¼š

```
xihong_erp/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ raw/
â”‚       â””â”€â”€ 2025/
â”‚           â”œâ”€â”€ shopee_orders_daily_20250108_143022.xlsx
â”‚           â”œâ”€â”€ shopee_orders_daily_20250108_143022.meta.json
â”‚           â”œâ”€â”€ shopee_products_monthly_20250108_143022.xlsx
â”‚           â”œâ”€â”€ shopee_products_monthly_20250108_143022.meta.json
â”‚           â””â”€â”€ ...
â”‚
â”œâ”€â”€ temp/
â”‚   â””â”€â”€ downloads/
â”‚       â””â”€â”€ {task_uuid}/
â”‚           â””â”€â”€ (æµè§ˆå™¨ä¸‹è½½çš„åŸå§‹æ–‡ä»¶ï¼Œå¤„ç†ååˆ é™¤)
â”‚
â””â”€â”€ config/
    â””â”€â”€ collection_components/
        â”œâ”€â”€ shopee/
        â”‚   â”œâ”€â”€ login.yaml
        â”‚   â”œâ”€â”€ navigation.yaml
        â”‚   â”œâ”€â”€ date_picker.yaml
        â”‚   â”œâ”€â”€ orders_export.yaml
        â”‚   â””â”€â”€ products_export.yaml
        â”œâ”€â”€ tiktok/
        â”‚   â””â”€â”€ ...
        â””â”€â”€ miaoshou/
            â””â”€â”€ ...
```

**æ–‡ä»¶å‘½åæ ¼å¼**ï¼š

```
{platform}_{domain}[_{subdomain}]_{granularity}_{timestamp}.{ext}
```

**å…ƒæ•°æ®æ–‡ä»¶æ ¼å¼**ï¼š

```json
{
  "source_platform": "shopee",
  "data_domain": "orders",
  "sub_domain": null,
  "granularity": "daily",
  "account": "MyStore_SG",
  "shop_id": "12345678",
  "date_from": "2025-01-07",
  "date_to": "2025-01-07",
  "collection_task_id": "uuid-xxxx",
  "collected_at": "2025-01-08T14:30:22Z",
  "original_filename": "è®¢å•å¯¼å‡º_20250108.xlsx",
  "file_size_bytes": 102400,
  "row_count": 1500
}
```

### D9: å‰ç«¯ç»„ä»¶è®¾è®¡

**å†³ç­–**ï¼šåŸºäº Element Plus å®ç°ï¼Œæœ€å°åŒ–è‡ªå®šä¹‰

**ç»„ä»¶ç»“æ„**ï¼š

```
CollectionConfig.vue
â”œâ”€â”€ ConfigList (é…ç½®åˆ—è¡¨è¡¨æ ¼)
â”œâ”€â”€ ConfigForm (é…ç½®ç¼–è¾‘å¼¹çª—)
â”‚   â”œâ”€â”€ AccountSelector (è´¦å·å¤šé€‰)
â”‚   â”œâ”€â”€ DataDomainSelector (æ•°æ®åŸŸå¤šé€‰)
â”‚   â”œâ”€â”€ SubDomainSelector (å­åŸŸé€‰æ‹©ï¼ŒæœåŠ¡åŸŸæ—¶æ˜¾ç¤º)
â”‚   â”œâ”€â”€ GranularitySelector (ç²’åº¦é€‰æ‹©)
â”‚   â”œâ”€â”€ DateRangeSelector (æ—¥æœŸèŒƒå›´)
â”‚   â””â”€â”€ ScheduleConfig (å®šæ—¶é…ç½®)
â””â”€â”€ QuickActions (å¿«é€Ÿæ“ä½œæŒ‰é’®)

CollectionTasks.vue
â”œâ”€â”€ QuickStartPanel (å¿«é€Ÿé‡‡é›†é¢æ¿)
â”‚   â”œâ”€â”€ PlatformSelector (å¹³å°é€‰æ‹©)
â”‚   â”œâ”€â”€ AccountCheckboxes (è´¦å·å‹¾é€‰)
â”‚   â”œâ”€â”€ DataDomainCheckboxes (æ•°æ®åŸŸå‹¾é€‰)
â”‚   â”œâ”€â”€ GranularityRadio (ç²’åº¦é€‰æ‹©)
â”‚   â””â”€â”€ DateRangePresets (æ—¥æœŸé¢„è®¾)
â”œâ”€â”€ TaskList (ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼)
â”œâ”€â”€ TaskProgress (å®æ—¶è¿›åº¦ç»„ä»¶)
â”‚   â”œâ”€â”€ ProgressBar (è¿›åº¦æ¡)
â”‚   â”œâ”€â”€ CurrentStep (å½“å‰æ­¥éª¤)
â”‚   â””â”€â”€ LogStream (æ—¥å¿—æµ)
â””â”€â”€ TaskActions (ä»»åŠ¡æ“ä½œæŒ‰é’®)

CollectionHistory.vue
â”œâ”€â”€ HistoryFilter (ç­›é€‰æ¡ä»¶)
â”œâ”€â”€ HistoryList (å†å²åˆ—è¡¨è¡¨æ ¼)
â”œâ”€â”€ StatisticsChart (ç»Ÿè®¡å›¾è¡¨)
â””â”€â”€ LogDetailDialog (æ—¥å¿—è¯¦æƒ…å¼¹çª—)
```

### D10: ä»£ç†IPæ¥å£è®¾è®¡

**å†³ç­–**ï¼šå®šä¹‰ `ProxyProvider` æŠ½è±¡æ¥å£ï¼Œå…·ä½“å®ç°åç»­æ·»åŠ 

```python
# modules/utils/proxy_provider.py
from abc import ABC, abstractmethod
from typing import Optional, Dict

class ProxyProvider(ABC):
    """ä»£ç†IPæä¾›è€…æŠ½è±¡æ¥å£"""
    
    @abstractmethod
    async def get_proxy(self, platform: str, region: str) -> Optional[Dict[str, str]]:
        """
        è·å–ä»£ç†IP
        
        Args:
            platform: å¹³å°åç§° (shopee/tiktok/miaoshou)
            region: åœ°åŒºä»£ç  (MY/SG/TH/VNç­‰)
            
        Returns:
            ä»£ç†é…ç½® {"server": "http://...", "username": "...", "password": "..."}
            æˆ– Noneï¼ˆä¸ä½¿ç”¨ä»£ç†ï¼‰
        """
        pass
    
    @abstractmethod
    async def report_failure(self, proxy: Dict[str, str], reason: str) -> None:
        """æŠ¥å‘Šä»£ç†å¤±è´¥"""
        pass

class NoProxyProvider(ProxyProvider):
    """ç©ºå®ç°ï¼Œä¸ä½¿ç”¨ä»£ç†"""
    async def get_proxy(self, platform: str, region: str) -> None:
        return None
    
    async def report_failure(self, proxy: Dict, reason: str) -> None:
        pass
```

### D11: å¤šè´¦å·æ‰¹é‡é‡‡é›†ç­–ç•¥

**å†³ç­–**ï¼šåŒä¸€å¹³å°é¡ºåºæ‰§è¡Œï¼Œä¸åŒå¹³å°å¯å¹¶è¡Œ

**ç­–ç•¥**ï¼š

| åœºæ™¯ | æ‰§è¡Œæ–¹å¼ | ç†ç”± |
|------|----------|------|
| åŒä¸€å¹³å°å¤šè´¦å· | é¡ºåºæ‰§è¡Œ | é¿å…ç™»å½•çŠ¶æ€å¹²æ‰°ã€é™ä½å°ç¦é£é™© |
| ä¸åŒå¹³å° | å¯å¹¶è¡Œ | ç›¸äº’ç‹¬ç«‹ï¼Œæ— å¹²æ‰° |

**å¹¶å‘æ§åˆ¶**ï¼š
- ç¯å¢ƒå˜é‡ `MAX_COLLECTION_TASKS=3` é™åˆ¶å¹¶å‘æ•°
- ä»»åŠ¡é˜Ÿåˆ—ï¼šè¶…å‡ºå¹¶å‘æ•°çš„ä»»åŠ¡è¿›å…¥ç­‰å¾…é˜Ÿåˆ—
- è´¦å·é”ï¼šåŒä¸€è´¦å·åŒæ—¶åªå…è®¸ä¸€ä¸ªä»»åŠ¡è¿è¡Œ

**å®ç°**ï¼š
```python
# ä»»åŠ¡åˆ›å»ºæ—¶æ£€æŸ¥
async def create_task(request: CreateTaskRequest):
    # æ£€æŸ¥è´¦å·æ˜¯å¦æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡
    running = await get_running_tasks_by_account(request.account_id)
    if running:
        raise HTTPException(400, f"è´¦å· {request.account_id} å·²æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡")
    
    # æ£€æŸ¥å¹¶å‘æ•°
    total_running = await get_total_running_tasks()
    if total_running >= MAX_COLLECTION_TASKS:
        # åˆ›å»ºä¸º queued çŠ¶æ€ï¼Œç­‰å¾…æ‰§è¡Œ
        return await create_queued_task(request)
    
    return await create_and_start_task(request)
```

### D12: é•¿æ—¶é—´ä»»åŠ¡å¤„ç†ç­–ç•¥

**å†³ç­–**ï¼šå®ç°è¶…æ—¶æ§åˆ¶ã€æ–­ç‚¹æ¢å¤ã€æœåŠ¡é‡å¯æ¢å¤

**è¶…æ—¶é…ç½®**ï¼š

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `COMPONENT_TIMEOUT` | 300s (5åˆ†é’Ÿ) | å•ä¸ªç»„ä»¶æ‰§è¡Œè¶…æ—¶ |
| `TASK_TIMEOUT` | 1800s (30åˆ†é’Ÿ) | å•ä¸ªä»»åŠ¡æ€»è¶…æ—¶ |
| `DOWNLOAD_TIMEOUT` | 120s (2åˆ†é’Ÿ) | æ–‡ä»¶ä¸‹è½½è¶…æ—¶ |

**è¶…æ—¶å¤„ç†**ï¼š
```python
async def execute_with_timeout(component, timeout: int):
    try:
        async with asyncio.timeout(timeout):
            return await execute_component(component)
    except asyncio.TimeoutError:
        await save_screenshot(f"timeout_{component.name}")
        raise ComponentTimeoutError(f"ç»„ä»¶ {component.name} æ‰§è¡Œè¶…æ—¶")
```

**æœåŠ¡é‡å¯æ¢å¤**ï¼š
```python
# åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ
async def recover_interrupted_tasks():
    """æ¢å¤è¢«ä¸­æ–­çš„ä»»åŠ¡"""
    running_tasks = await db.query(CollectionTask).filter(
        CollectionTask.status == "running"
    ).all()
    
    for task in running_tasks:
        task.status = "interrupted"
        task.error_message = "æœåŠ¡é‡å¯å¯¼è‡´ä»»åŠ¡ä¸­æ–­"
        await log_task(task.id, "warning", "ä»»åŠ¡è¢«æœåŠ¡é‡å¯ä¸­æ–­")
    
    await db.commit()
```

**ä»»åŠ¡çŠ¶æ€æœº**ï¼š
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   pending    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ start
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   running    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚ cancel         â”‚                 â”‚ error/timeout
         â–¼                â”‚ verify_required â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â–¼         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cancelled   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    failed    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    paused    â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ retry
                          â”‚ verify/resume  â”‚
                          â–¼                â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   running    â”‚  â”‚   pending    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ complete
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  completed   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   
ç‰¹æ®ŠçŠ¶æ€ï¼š
- interrupted: æœåŠ¡é‡å¯å¯¼è‡´ä¸­æ–­ï¼Œå¯æ‰‹åŠ¨ retry
- queued: ç­‰å¾…æ‰§è¡Œï¼ˆå¹¶å‘æ•°å·²æ»¡ï¼‰
```

### D13: è¿œç¨‹éªŒè¯ç å¤„ç†æµç¨‹

**å†³ç­–**ï¼šå®ç° WebSocket é€šçŸ¥ + æˆªå›¾ + å‰ç«¯è¾“å…¥ + API æ³¨å…¥

**å¤„ç†æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æµ‹éªŒè¯ç                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰§è¡Œå¼•æ“æ£€æµ‹åˆ°éªŒè¯ç å…ƒç´ å‡ºç°                                      â”‚
â”‚   - Shopee: æ»‘å—éªŒè¯ã€çŸ­ä¿¡éªŒè¯ã€å›¾ç‰‡éªŒè¯                          â”‚
â”‚   - TikTok: æ‹¼å›¾éªŒè¯ã€çŸ­ä¿¡éªŒè¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¿å­˜æˆªå›¾                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ await page.screenshot(path=f"temp/screenshots/{task_id}/verify.png")â”‚
â”‚ æ›´æ–°ä»»åŠ¡çŠ¶æ€: status = "paused"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. WebSocket é€šçŸ¥å‰ç«¯                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                               â”‚
â”‚   "type": "verification_required",                              â”‚
â”‚   "task_id": "uuid",                                            â”‚
â”‚   "verification_type": "sms_code",  // æˆ– slider, image         â”‚
â”‚   "message": "è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ",                                  â”‚
â”‚   "screenshot_url": "/api/collection/tasks/{id}/screenshot",    â”‚
â”‚   "input_required": true  // æ˜¯å¦éœ€è¦ç”¨æˆ·è¾“å…¥                     â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‰ç«¯æ˜¾ç¤ºéªŒè¯ç å¤„ç†å¼¹çª—                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VerificationDialog.vue:                                         â”‚
â”‚   - æ˜¾ç¤ºæˆªå›¾                                                     â”‚
â”‚   - æ ¹æ® verification_type æ˜¾ç¤ºä¸åŒäº¤äº’ï¼š                        â”‚
â”‚     * sms_code/email_code/2fa: æ˜¾ç¤ºè¾“å…¥æ¡†                       â”‚
â”‚     * slider/image: æ˜¾ç¤º"å·²æ‰‹åŠ¨å®Œæˆ"æŒ‰é’®                         â”‚
â”‚   - å€’è®¡æ—¶è¶…æ—¶æç¤ºï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼Œå¯é…ç½® VERIFICATION_TIMEOUTï¼‰   â”‚
â”‚   - æ“ä½œæŒ‰é’®ï¼šæäº¤éªŒè¯ç  / å·²æ‰‹åŠ¨å®Œæˆ / è·³è¿‡ / å–æ¶ˆä»»åŠ¡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ç”¨æˆ·æäº¤éªŒè¯                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/collection/tasks/{id}/verify                          â”‚
â”‚ {                                                               â”‚
â”‚   "verification_code": "123456",  // çŸ­ä¿¡éªŒè¯ç                   â”‚
â”‚   "action": "submit"  // æˆ– "skip"ï¼ˆè·³è¿‡ï¼‰, "manual_done"ï¼ˆæ‰‹åŠ¨å®Œæˆï¼‰â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åç«¯æ³¨å…¥éªŒè¯ç å¹¶ç»§ç»­                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ if action == "submit":                                          â”‚
â”‚     await page.fill("input.verify-code", verification_code)     â”‚
â”‚     await page.click("button.submit")                           â”‚
â”‚ elif action == "manual_done":                                   â”‚
â”‚     # ç”¨æˆ·å·²åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨å®Œæˆï¼Œç›´æ¥ç»§ç»­                           â”‚
â”‚     pass                                                        â”‚
â”‚ elif action == "skip":                                          â”‚
â”‚     # ç”¨æˆ·é€‰æ‹©è·³è¿‡ï¼Œæ ‡è®°ä»»åŠ¡ä¸ºå¤±è´¥                                â”‚
â”‚     task.status = "failed"                                      â”‚
â”‚     task.error_message = "ç”¨æˆ·è·³è¿‡éªŒè¯ç "                        â”‚
â”‚     return                                                      â”‚
â”‚                                                                 â”‚
â”‚ task.status = "running"                                         â”‚
â”‚ continue_execution()                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**éªŒè¯ç ç±»å‹æ”¯æŒ**ï¼š

| ç±»å‹ | å¤„ç†æ–¹å¼ | å‰ç«¯äº¤äº’ | è¶…æ—¶ç­–ç•¥ |
|------|---------|---------|---------|
| sms_code | ç”¨æˆ·è¾“å…¥ | æ˜¾ç¤ºè¾“å…¥æ¡† | 5åˆ†é’Ÿè¶…æ—¶ï¼Œä¿æŒpaused |
| email_code | ç”¨æˆ·è¾“å…¥ | æ˜¾ç¤ºè¾“å…¥æ¡† | 5åˆ†é’Ÿè¶…æ—¶ï¼Œä¿æŒpaused |
| slider | ç”¨æˆ·æ‰‹åŠ¨å®Œæˆ | æ˜¾ç¤º"å·²æ‰‹åŠ¨å®Œæˆ"æŒ‰é’® | 5åˆ†é’Ÿè¶…æ—¶ï¼Œä¿æŒpaused |
| image | ç”¨æˆ·æ‰‹åŠ¨å®Œæˆ | æ˜¾ç¤º"å·²æ‰‹åŠ¨å®Œæˆ"æŒ‰é’® | 5åˆ†é’Ÿè¶…æ—¶ï¼Œä¿æŒpaused |
| 2fa | ç”¨æˆ·è¾“å…¥ | æ˜¾ç¤ºè¾“å…¥æ¡† | 5åˆ†é’Ÿè¶…æ—¶ï¼Œä¿æŒpaused |

**è¶…æ—¶å¤„ç†ç­–ç•¥**ï¼š
- è¶…æ—¶æ—¶é—´ï¼š5åˆ†é’Ÿï¼ˆå¯é…ç½® `VERIFICATION_TIMEOUT=300`ï¼‰
- è¶…æ—¶åï¼šä»»åŠ¡çŠ¶æ€ä¿æŒ `paused`ï¼Œä¸è‡ªåŠ¨æ ‡è®°ä¸º `failed`
- ç”¨æˆ·é€‰æ‹©ï¼šç»§ç»­ç­‰å¾… / è·³è¿‡ï¼ˆæ ‡è®°å¤±è´¥ï¼‰/ å–æ¶ˆä»»åŠ¡
```

**API è®¾è®¡**ï¼š

```python
@router.post("/tasks/{task_id}/verify")
async def verify_task(
    task_id: str,
    request: VerifyRequest
):
    """
    æäº¤éªŒè¯ç å¹¶ç»§ç»­ä»»åŠ¡
    
    Args:
        verification_code: éªŒè¯ç ï¼ˆçŸ­ä¿¡/å›¾ç‰‡éªŒè¯æ—¶ï¼‰
        action: submit | skip | manual_done
    """
    task = await get_task(task_id)
    if task.status != "paused":
        raise HTTPException(400, "ä»»åŠ¡ä¸åœ¨æš‚åœçŠ¶æ€")
    
    # é€šçŸ¥æ‰§è¡Œå¼•æ“ç»§ç»­
    await executor.resume_with_verification(
        task_id,
        request.verification_code,
        request.action
    )
    
    return {"message": "éªŒè¯å·²æäº¤ï¼Œä»»åŠ¡ç»§ç»­æ‰§è¡Œ"}


@router.get("/tasks/{task_id}/screenshot")
async def get_task_screenshot(task_id: str):
    """è·å–ä»»åŠ¡æˆªå›¾ï¼ˆç”¨äºéªŒè¯ç æ˜¾ç¤ºï¼‰"""
    screenshot_path = f"temp/screenshots/{task_id}/verify.png"
    if not Path(screenshot_path).exists():
        raise HTTPException(404, "æˆªå›¾ä¸å­˜åœ¨")
    return FileResponse(screenshot_path, media_type="image/png")
```

### D14: ä»»åŠ¡æ¢å¤ API è®¾è®¡

**å†³ç­–**ï¼šæä¾› retry/resume API æ”¯æŒä»»åŠ¡æ¢å¤

**API ç«¯ç‚¹**ï¼š

```
POST /api/collection/tasks/{id}/retry   - é‡è¯•å¤±è´¥/ä¸­æ–­çš„ä»»åŠ¡
POST /api/collection/tasks/{id}/resume  - ç»§ç»­æš‚åœçš„ä»»åŠ¡
POST /api/collection/tasks/{id}/verify  - æäº¤éªŒè¯ç å¹¶ç»§ç»­
```

**å®ç°**ï¼š

```python
@router.post("/tasks/{task_id}/retry")
async def retry_task(task_id: str, background_tasks: BackgroundTasks):
    """
    é‡è¯•å¤±è´¥æˆ–ä¸­æ–­çš„ä»»åŠ¡
    
    å…è®¸çš„çŠ¶æ€: failed, interrupted, cancelled
    """
    task = await get_task(task_id)
    if task.status not in ["failed", "interrupted", "cancelled"]:
        raise HTTPException(400, f"ä»»åŠ¡çŠ¶æ€ {task.status} ä¸å…è®¸é‡è¯•")
    
    # åˆ›å»ºæ–°ä»»åŠ¡ï¼Œå¤åˆ¶åŸä»»åŠ¡å‚æ•°
    new_task = await create_task_from_existing(task)
    background_tasks.add_task(execute_collection_task, new_task.id)
    
    return {"message": "ä»»åŠ¡é‡è¯•å·²å¯åŠ¨", "new_task_id": new_task.id}


@router.post("/tasks/{task_id}/resume")
async def resume_task(task_id: str, background_tasks: BackgroundTasks):
    """
    ç»§ç»­æš‚åœçš„ä»»åŠ¡ï¼ˆééªŒè¯ç æš‚åœï¼‰
    
    å…è®¸çš„çŠ¶æ€: paused
    """
    task = await get_task(task_id)
    if task.status != "paused":
        raise HTTPException(400, "ä»»åŠ¡ä¸åœ¨æš‚åœçŠ¶æ€")
    
    task.status = "running"
    await db.commit()
    
    # é€šçŸ¥æ‰§è¡Œå¼•æ“ç»§ç»­
    await executor.resume_task(task_id)
    
    return {"message": "ä»»åŠ¡å·²ç»§ç»­æ‰§è¡Œ"}
```

### D15: ç»„ä»¶çƒ­åŠ è½½æœºåˆ¶

**å†³ç­–**ï¼šç”Ÿäº§æ¨¡å¼ç¼“å­˜ï¼Œæ”¯æŒæ‰‹åŠ¨åˆ·æ–°

**åŠ è½½ç­–ç•¥**ï¼š

| æ¨¡å¼ | è¡Œä¸º | é…ç½® |
|------|------|------|
| å¼€å‘æ¨¡å¼ | æ¯æ¬¡æ‰§è¡Œæ—¶é‡æ–°åŠ è½½ | `COMPONENT_HOT_RELOAD=true` |
| ç”Ÿäº§æ¨¡å¼ | å¯åŠ¨æ—¶åŠ è½½å¹¶ç¼“å­˜ | `COMPONENT_HOT_RELOAD=false` |

**æ‰‹åŠ¨åˆ·æ–° API**ï¼ˆå¯é€‰ï¼‰ï¼š

```python
@router.post("/components/reload")
async def reload_components():
    """å¼ºåˆ¶é‡æ–°åŠ è½½æ‰€æœ‰ç»„ä»¶é…ç½®"""
    component_loader.clear_cache()
    await component_loader.load_all()
    return {"message": "ç»„ä»¶é…ç½®å·²é‡æ–°åŠ è½½"}
```

## æ•°æ®åº“æ¨¡å‹è®¾è®¡

### collection_configs è¡¨

```sql
CREATE TABLE collection_configs (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,           -- é…ç½®åç§°
    platform VARCHAR(50) NOT NULL,        -- å¹³å°ï¼šshopee/tiktok/miaoshou
    account_ids JSONB NOT NULL,           -- è´¦å·IDåˆ—è¡¨
    data_domains JSONB NOT NULL,          -- æ•°æ®åŸŸåˆ—è¡¨
    sub_domain VARCHAR(50),               -- å­åŸŸï¼ˆæœåŠ¡åŸŸä½¿ç”¨ï¼‰
    granularity VARCHAR(20) DEFAULT 'daily',  -- ç²’åº¦ï¼šdaily/weekly/monthly
    date_range_type VARCHAR(20) DEFAULT 'yesterday',  -- today/yesterday/last_7_days/custom
    custom_date_start DATE,               -- è‡ªå®šä¹‰å¼€å§‹æ—¥æœŸ
    custom_date_end DATE,                 -- è‡ªå®šä¹‰ç»“æŸæ—¥æœŸ
    schedule_enabled BOOLEAN DEFAULT false,
    schedule_cron VARCHAR(50),            -- Cronè¡¨è¾¾å¼
    retry_count INT DEFAULT 3,            -- é‡è¯•æ¬¡æ•°
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by VARCHAR(100)
);

CREATE INDEX idx_collection_configs_platform ON collection_configs(platform);
CREATE INDEX idx_collection_configs_active ON collection_configs(is_active);
```

### collection_tasks è¡¨ï¼ˆå¢å¼ºï¼‰

> æ³¨ï¼šå¤ç”¨ç°æœ‰ `account` å­—æ®µï¼Œä¸æ–°å¢ `account_id`

```sql
-- å¢å¼ºç°æœ‰ collection_tasks è¡¨
-- ç°æœ‰å­—æ®µ: id, task_id, platform, account, status, created_at, updated_at

ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS config_id INT REFERENCES collection_configs(id);
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS progress INT DEFAULT 0;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS current_step VARCHAR(200);
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS files_collected INT DEFAULT 0;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS trigger_type VARCHAR(20) DEFAULT 'manual';  -- manual/scheduled/retry
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS data_domains JSONB;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS sub_domain VARCHAR(50);
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS granularity VARCHAR(20);
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS date_range JSONB;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS error_message TEXT;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS error_screenshot_path VARCHAR(500);
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS duration_seconds INT;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS retry_count INT DEFAULT 0;
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS parent_task_id INT;  -- é‡è¯•æ—¶å…³è”åŸä»»åŠ¡
ALTER TABLE collection_tasks ADD COLUMN IF NOT EXISTS verification_type VARCHAR(50);  -- éªŒè¯ç ç±»å‹

-- æ›´æ–° status å­—æ®µæ”¯æŒæ–°çŠ¶æ€
-- å¯é€‰å€¼: pending, queued, running, paused, completed, failed, cancelled, interrupted
```

### collection_task_logs è¡¨

```sql
CREATE TABLE collection_task_logs (
    id SERIAL PRIMARY KEY,
    task_id UUID REFERENCES collection_tasks(id) ON DELETE CASCADE,
    level VARCHAR(10) NOT NULL,           -- info/warning/error
    message TEXT NOT NULL,
    details JSONB,                         -- é¢å¤–è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰
    timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_collection_task_logs_task ON collection_task_logs(task_id);
CREATE INDEX idx_collection_task_logs_level ON collection_task_logs(level);
CREATE INDEX idx_collection_task_logs_time ON collection_task_logs(timestamp);
```

## API è®¾è®¡

### é…ç½®ç®¡ç† API

```
GET    /api/collection/configs           - è·å–é…ç½®åˆ—è¡¨
POST   /api/collection/configs           - åˆ›å»ºé…ç½®
GET    /api/collection/configs/{id}      - è·å–é…ç½®è¯¦æƒ…
PUT    /api/collection/configs/{id}      - æ›´æ–°é…ç½®
DELETE /api/collection/configs/{id}      - åˆ é™¤é…ç½®
```

### è´¦å· API

```
GET    /api/collection/accounts          - è·å–è´¦å·åˆ—è¡¨ï¼ˆè„±æ•ï¼‰
GET    /api/collection/accounts/{platform} - è·å–æŒ‡å®šå¹³å°è´¦å·
```

### ä»»åŠ¡ API

```
POST   /api/collection/tasks             - åˆ›å»ºä»»åŠ¡ï¼ˆç«‹å³æ‰§è¡Œï¼‰
GET    /api/collection/tasks             - è·å–ä»»åŠ¡åˆ—è¡¨
GET    /api/collection/tasks/{id}        - è·å–ä»»åŠ¡è¯¦æƒ…
DELETE /api/collection/tasks/{id}        - å–æ¶ˆä»»åŠ¡
GET    /api/collection/tasks/{id}/logs   - è·å–ä»»åŠ¡æ—¥å¿—
GET    /api/collection/tasks/{id}/screenshot - è·å–é”™è¯¯æˆªå›¾
```

### å†å² API

```
GET    /api/collection/history           - è·å–å†å²è®°å½•ï¼ˆåˆ†é¡µï¼‰
GET    /api/collection/history/stats     - è·å–ç»Ÿè®¡æ•°æ®
```

### ç»„ä»¶ APIï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰

```
GET    /api/collection/components        - è·å–ç»„ä»¶åˆ—è¡¨
GET    /api/collection/components/{platform}/{name} - è·å–ç»„ä»¶è¯¦æƒ…
POST   /api/collection/components/test   - æµ‹è¯•å•ä¸ªç»„ä»¶
```

### WebSocket

```
WS     /ws/collection/{task_id}          - è®¢é˜…ä»»åŠ¡çŠ¶æ€
```

## Risks / Trade-offs

### R1: ç»„ä»¶ YAML æ ¼å¼è®¾è®¡é£é™©

**é£é™©**ï¼šYAML æ ¼å¼è®¾è®¡ä¸å½“ï¼Œæ— æ³•è¦†ç›–å¤æ‚åœºæ™¯

**ç¼“è§£æªæ–½**ï¼š
- å…ˆå®ç° Shopee å¹³å°æ‰€æœ‰ç»„ä»¶ï¼ŒéªŒè¯æ ¼å¼åå†æ‰©å±•
- æ”¯æŒç»„ä»¶åµŒå¥—è°ƒç”¨ï¼ˆ`action: component_call`ï¼‰
- æ”¯æŒæ¡ä»¶åˆ¤æ–­ï¼ˆ`if` æ¡ä»¶å—ï¼‰
- æ”¯æŒå¾ªç¯ï¼ˆ`loop` å—ï¼‰
- ä¿ç•™ Python å‡½æ•°è°ƒç”¨ä½œä¸ºå…œåº•ï¼ˆ`action: python_call`ï¼‰

### R2: Playwright headless æ¨¡å¼åæ£€æµ‹

**é£é™©**ï¼šheadless æ¨¡å¼æ›´å®¹æ˜“è¢«ç”µå•†ç½‘ç«™æ£€æµ‹

**ç¼“è§£æªæ–½**ï¼š
- ä½¿ç”¨ `--disable-blink-features=AutomationControlled` å‚æ•°
- æ³¨å…¥åæ£€æµ‹è„šæœ¬ï¼ˆå·²æœ‰ `_setup_anti_detection`ï¼‰
- ä¿ç•™ headed æ¨¡å¼ä½œä¸ºå¤‡é€‰ï¼ˆæœ¬åœ°å¼€å‘ä½¿ç”¨ï¼‰
- æ‰©å±•æŒ‡çº¹åº“ï¼ˆå¢åŠ  UAã€åˆ†è¾¨ç‡ç­‰ï¼‰

### R3: å½•åˆ¶å·¥å…·å­¦ä¹ æ›²çº¿

**é£é™©**ï¼šç»„ä»¶å½•åˆ¶éœ€è¦å­¦ä¹ æˆæœ¬

**ç¼“è§£æªæ–½**ï¼š
- æä¾›è¯¦ç»†çš„å½•åˆ¶æ–‡æ¡£å’Œç¤ºä¾‹
- å½•åˆ¶å·¥å…·è‡ªåŠ¨è¡¥å…¨ç»„ä»¶æ¨¡æ¿
- æä¾›ç»„ä»¶æµ‹è¯•å·¥å…·éªŒè¯å½•åˆ¶ç»“æœ

### R4: éªŒè¯ç å¤„ç†

**é£é™©**ï¼šç”µå•†ç½‘ç«™è§¦å‘éªŒè¯ç ï¼Œé˜»æ–­è‡ªåŠ¨åŒ–æµç¨‹

**ç¼“è§£æªæ–½**ï¼š
- ç»„ä»¶æ”¯æŒ `pause_for_manual` åŠ¨ä½œï¼Œæš‚åœç­‰å¾…äººå·¥å¤„ç†
- WebSocket æ¨é€éªŒè¯ç é€šçŸ¥ï¼Œæˆªå›¾æ˜¾ç¤º
- å‰ç«¯æ˜¾ç¤ºæš‚åœçŠ¶æ€ï¼Œæä¾›"ç»§ç»­"æŒ‰é’®
- åˆ©ç”¨ç°æœ‰ `ShopeeVerificationHandler` å¤„ç†å¸¸è§éªŒè¯

## Migration Plan

### Phase 1: ç»„ä»¶ç³»ç»ŸåŸºç¡€ï¼ˆé¢„è®¡ 3 å¤©ï¼‰

1. å®šä¹‰ç»„ä»¶ YAML æ ¼å¼è§„èŒƒ
2. å®ç° `ComponentLoader` ç»„ä»¶åŠ è½½å™¨
3. å®ç° `CollectionExecutorV2` æ‰§è¡Œå¼•æ“
4. åˆ›å»ºæ•°æ®åº“æ¨¡å‹å’Œè¿ç§»è„šæœ¬
5. å®ç°åŸºç¡€ APIï¼ˆé…ç½®ã€ä»»åŠ¡ã€è´¦å·ï¼‰

### Phase 2: å½•åˆ¶å·¥å…·ä¸ç»„ä»¶ï¼ˆé¢„è®¡ 4 å¤©ï¼‰

1. å®ç° `tools/record_component.py` å½•åˆ¶å·¥å…·
2. å®ç° `tools/test_component.py` æµ‹è¯•å·¥å…·
3. å½•åˆ¶ Shopee å¹³å°æ ¸å¿ƒç»„ä»¶ï¼ˆlogin, navigation, date_picker, exportsï¼‰
4. éªŒè¯ Shopee å¹³å°ç«¯åˆ°ç«¯é‡‡é›†æµç¨‹

### Phase 3: å‰ç«¯å®ç°ï¼ˆé¢„è®¡ 3 å¤©ï¼‰

1. å®ç° `frontend/src/api/collection.js` API å°è£…
2. å®ç° `CollectionConfig.vue` é…ç½®ç®¡ç†
3. å®ç° `CollectionTasks.vue` ä»»åŠ¡ç®¡ç†å’Œå¿«é€Ÿé‡‡é›†
4. å®ç° WebSocket é›†æˆå’Œå®æ—¶è¿›åº¦æ˜¾ç¤º

### Phase 4: è°ƒåº¦ä¸å†å²ï¼ˆé¢„è®¡ 2 å¤©ï¼‰

1. å®ç° APScheduler å®šæ—¶è°ƒåº¦
2. å®ç° Cron å¯è§†åŒ–é…ç½®ç»„ä»¶
3. å®ç° `CollectionHistory.vue` å†å²è®°å½•
4. å®ç°ç»Ÿè®¡å›¾è¡¨

### Phase 5: å…¶ä»–å¹³å°ä¸äº‘é€‚é…ï¼ˆé¢„è®¡ 3 å¤©ï¼‰

1. å½•åˆ¶ TikTok å¹³å°ç»„ä»¶
2. å½•åˆ¶å¦™æ‰‹ERPå¹³å°ç»„ä»¶
3. ä»£ç†IPæ¥å£å®ç°
4. Docker headless æµ‹è¯•
5. æŒ‡çº¹åº“æ‰©å±•

### å›æ»šæ–¹æ¡ˆ

- æ¯ä¸ª Phase ç‹¬ç«‹æäº¤ï¼Œå¯å•ç‹¬å›æ»š
- ä¿ç•™ç°æœ‰ CLI åŠŸèƒ½ï¼Œä¸å½±å“æœ¬åœ°å¼€å‘
- æ–°æ—§æ‰§è¡Œå¼•æ“å¯å¹¶å­˜ï¼Œé€æ­¥è¿ç§»

### D16: å¼¹çª—å¤„ç†æ–¹æ¡ˆè®¾è®¡

**å†³ç­–**ï¼šé‡‡ç”¨ä¸‰å±‚å¼¹çª—å¤„ç†æœºåˆ¶ï¼ˆé€šç”¨ + å¹³å°ç‰¹å®š + ç»„ä»¶çº§ï¼‰

**æ¶æ„è®¾è®¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸‰å±‚å¼¹çª—å¤„ç†æœºåˆ¶                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: é€šç”¨å¼¹çª—å¤„ç†å™¨ (UniversalPopupHandler)            â”‚
â”‚   - å¤„ç†æ‰€æœ‰å¹³å°çš„å¸¸è§å¼¹çª—                                  â”‚
â”‚   - 30+ é€šç”¨å…³é—­é€‰æ‹©å™¨                                      â”‚
â”‚   - æ”¯æŒ iframeã€ESC é”®å…œåº•ã€è½®è¯¢ç­–ç•¥                        â”‚
â”‚                                                             â”‚
â”‚ Layer 2: å¹³å°ç‰¹å®šå¼¹çª—é…ç½® (popup_config.yaml)              â”‚
â”‚   - æ¯ä¸ªå¹³å°ä¸€ä¸ªé…ç½®æ–‡ä»¶                                    â”‚
â”‚   - å¹³å°ç‰¹å®šé€‰æ‹©å™¨                                          â”‚
â”‚   - å¹³å°ç‰¹å®šè½®è¯¢ç­–ç•¥                                        â”‚
â”‚                                                             â”‚
â”‚ Layer 3: ç»„ä»¶çº§å¼¹çª—å¤„ç† (ç»„ä»¶YAMLé…ç½®)                      â”‚
â”‚   - popup_handling é…ç½®æ®µ                                   â”‚
â”‚   - æ­¥éª¤çº§å¼¹çª—å¤„ç†                                          â”‚
â”‚   - è‡ªåŠ¨/æ‰‹åŠ¨æ§åˆ¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é€šç”¨å¼¹çª—å¤„ç†å™¨**ï¼š

```python
# modules/apps/collection_center/popup_handler.py
class UniversalPopupHandler:
    """é€šç”¨å¼¹çª—å¤„ç†å™¨ - å¤„ç†æ‰€æœ‰å¹³å°çš„å¸¸è§å¼¹çª—"""
    
    UNIVERSAL_CLOSE_SELECTORS = [
        '[aria-label="Close"]', '[aria-label="å…³é—­"]',
        '.modal-close', '.close-btn', '.dialog-close',
        'button:has-text("å…³é—­")', 'button:has-text("å–æ¶ˆ")',
        'button:has-text("ç¨åå†è¯´")', 'button:has-text("æˆ‘çŸ¥é“äº†")',
        # ... 30+ é€šç”¨é€‰æ‹©å™¨
    ]
    
    async def close_popups(self, page: Page, max_rounds=20, interval_ms=300, watch_ms=8000) -> int:
        """å…³é—­æ‰€æœ‰å¼¹çª—ï¼ˆé€šç”¨ + å¹³å°ç‰¹å®šï¼‰"""
        # 1. åˆå¹¶é€‰æ‹©å™¨åˆ—è¡¨ï¼ˆé€šç”¨ + å¹³å°ç‰¹å®šï¼‰
        # 2. è·å–æ‰€æœ‰ frameï¼ˆä¸»é¡µé¢ + iframeï¼‰
        # 3. è½®è¯¢å°è¯•å…³é—­ï¼ˆç‚¹å‡»å…³é—­æŒ‰é’® + ESCé”®ï¼‰
        # 4. è¿”å›å…³é—­çš„å¼¹çª—æ•°é‡
```

**å¹³å°ç‰¹å®šé…ç½®**ï¼š

```yaml
# config/collection_components/shopee/popup_config.yaml
name: shopee_popup_config
platform: shopee

close_selectors:
  - 'i.eds-icon.eds-modal__close'
  - '.eds-modal__close'
  - '.survey-window-modal i.eds-modal__close'

overlay_selectors:
  - '.eds-modal__mask'
  - '.eds-modal__overlay'

poll_strategy:
  max_rounds: 20
  interval_ms: 300
  watch_ms: 8000
```

**ç»„ä»¶çº§é…ç½®**ï¼š

```yaml
# ç»„ä»¶YAMLä¸­çš„popup_handlingé…ç½®
popup_handling:
  auto_close: true              # æ˜¯å¦è‡ªåŠ¨å…³é—­å¼¹çª—
  check_before_steps: true      # æ¯ä¸ªæ­¥éª¤å‰æ£€æŸ¥å¼¹çª—
  check_after_steps: true       # æ¯ä¸ªæ­¥éª¤åæ£€æŸ¥å¼¹çª—
  check_on_error: true          # é”™è¯¯æ—¶æ£€æŸ¥å¼¹çª—

steps:
  - id: close_popups_init
    action: close_popups
  
  - id: click_export
    action: click
    selector: "button:has-text('å¯¼å‡º')"
    popup_handling:
      check_after: true  # æ­¥éª¤çº§å¼¹çª—å¤„ç†
```

**æ‰§è¡Œå¼•æ“é›†æˆ**ï¼š

- ç»„ä»¶æ‰§è¡Œå‰ï¼šè‡ªåŠ¨æ£€æŸ¥å¹¶å…³é—­å¼¹çª—ï¼ˆå¦‚æœé…ç½®äº† `check_before_steps`ï¼‰
- æ­¥éª¤æ‰§è¡Œä¸­ï¼šæ¯ä¸ªæ­¥éª¤å‰åæ£€æŸ¥å¼¹çª—ï¼ˆå¦‚æœæ­¥éª¤é…ç½®äº† `popup_handling`ï¼‰
- é”™è¯¯å¤„ç†ï¼šé”™è¯¯æ—¶æ£€æŸ¥å¼¹çª—ï¼ˆå¯èƒ½æ˜¯å¼¹çª—é®æŒ¡å¯¼è‡´å¤±è´¥ï¼‰
- ç»„ä»¶æ‰§è¡Œåï¼šæœ€ç»ˆæ£€æŸ¥å¹¶å…³é—­å¼¹çª—ï¼ˆå¦‚æœé…ç½®äº† `check_after_steps`ï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… **é€šç”¨æ€§**ï¼šé€šç”¨é€‰æ‹©å™¨è¦†ç›–å¸¸è§å¼¹çª—
- âœ… **å¯æ‰©å±•æ€§**ï¼šå¹³å°é…ç½®æ”¯æŒå¹³å°ç‰¹å®šå¼¹çª—
- âœ… **çµæ´»æ€§**ï¼šç»„ä»¶çº§é…ç½®æ”¯æŒç²¾ç»†æ§åˆ¶
- âœ… **è‡ªåŠ¨åŒ–**ï¼šé»˜è®¤è‡ªåŠ¨å¤„ç†ï¼Œå‡å°‘æ‰‹åŠ¨å¹²é¢„
- âœ… **å®¹é”™æ€§**ï¼šå¤šç­–ç•¥å…œåº•ï¼ˆæŒ‰é’®ç‚¹å‡» + ESCé”® + è½®è¯¢ï¼‰

### D17: è´¦å·é…ç½®æ¥æºè®¾è®¡

**å†³ç­–**ï¼šç›´æ¥ä» `local_accounts.py` è¯»å–ï¼ŒAPIè¿”å›è„±æ•ä¿¡æ¯

**è®¾è®¡åŸåˆ™**ï¼š
- `local_accounts.py` æ˜¯å”¯ä¸€çœŸå®æ•°æ®æºï¼ˆç§å¯†æ–‡ä»¶ï¼Œä¸æäº¤Gitï¼‰
- `accounts.json` ä»…ä½œä¸ºè¿è¡Œæ—¶ç¼“å­˜ï¼Œä¸ç”¨äºAPIè¯»å–
- APIè¿”å›æ—¶ç§»é™¤æ•æ„Ÿå­—æ®µï¼ˆusername, passwordç­‰ï¼‰
- é‡‡é›†æ‰§è¡Œæ—¶è¯»å–å®Œæ•´å‡­è¯ï¼ˆåŒ…å«å¯†ç ï¼‰

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
# backend/routers/collection.py

def _load_local_accounts() -> List[Dict[str, Any]]:
    """ä» local_accounts.py åŠ è½½è´¦å·ï¼ˆè„±æ•ï¼‰"""
    import importlib.util
    spec = importlib.util.spec_from_file_location("local_accounts", "local_accounts.py")
    local_accounts_mod = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(local_accounts_mod)
    
    # è„±æ•å¤„ç†
    sanitized = {
        "account_id": account.get("account_id"),
        "platform": account.get("platform"),
        "store_name": account.get("store_name"),
        # ä¸åŒ…å«ï¼šusername, password, Email account/password
    }
    return sanitized_accounts

@router.get("/accounts")
async def get_collection_accounts(platform: Optional[str] = None):
    """è·å–è´¦å·åˆ—è¡¨ï¼ˆè„±æ•ï¼‰"""
    accounts = _load_local_accounts()
    # æŒ‰å¹³å°ç­›é€‰ï¼ˆå¦‚æœæŒ‡å®šï¼‰
    return success_response(data=accounts)
```

**é‡‡é›†æ‰§è¡Œæ—¶**ï¼š

```python
# modules/apps/collection_center/executor_v2.py

def _load_account_credentials(account_id: str) -> Dict[str, Any]:
    """åŠ è½½è´¦å·å®Œæ•´å‡­è¯ï¼ˆåŒ…å«å¯†ç ï¼‰- ç”¨äºé‡‡é›†æ‰§è¡Œ"""
    # ç›´æ¥è¯»å– local_accounts.pyï¼Œä¸è„±æ•
    # è¿”å›å®Œæ•´è´¦å·ä¿¡æ¯ï¼ˆåŒ…å«username, passwordï¼‰
```

### D18: éªŒè¯ç å¤„ç†è¯¦ç»†è®¾è®¡

**å†³ç­–**ï¼šæ”¯æŒå¤šç§éªŒè¯ç ç±»å‹ï¼Œ5åˆ†é’Ÿè¶…æ—¶ï¼Œä¿æŒpausedçŠ¶æ€

**éªŒè¯ç ç±»å‹**ï¼š

| ç±»å‹ | å¤„ç†æ–¹å¼ | å‰ç«¯äº¤äº’ |
|------|---------|---------|
| sms_code | ç”¨æˆ·è¾“å…¥ | æ˜¾ç¤ºè¾“å…¥æ¡† |
| email_code | ç”¨æˆ·è¾“å…¥ | æ˜¾ç¤ºè¾“å…¥æ¡† |
| slider | ç”¨æˆ·æ‰‹åŠ¨å®Œæˆ | æ˜¾ç¤º"å·²æ‰‹åŠ¨å®Œæˆ"æŒ‰é’® |
| image | ç”¨æˆ·æ‰‹åŠ¨å®Œæˆ | æ˜¾ç¤º"å·²æ‰‹åŠ¨å®Œæˆ"æŒ‰é’® |
| 2fa | ç”¨æˆ·è¾“å…¥ | æ˜¾ç¤ºè¾“å…¥æ¡† |

**è¶…æ—¶é…ç½®**ï¼š

```python
VERIFICATION_TIMEOUT = 300  # 5åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
```

**è¶…æ—¶ç­–ç•¥**ï¼š
- è¶…æ—¶åï¼šä»»åŠ¡çŠ¶æ€ä¿æŒ `paused`ï¼Œä¸è‡ªåŠ¨æ ‡è®°ä¸º `failed`
- ç”¨æˆ·é€‰æ‹©ï¼šç»§ç»­ç­‰å¾… / è·³è¿‡ï¼ˆæ ‡è®°å¤±è´¥ï¼‰/ å–æ¶ˆä»»åŠ¡

**å‰ç«¯äº¤äº’**ï¼š

```vue
<!-- VerificationDialog.vue -->
<el-dialog v-model="visible" title="éªŒè¯ç å¤„ç†">
  <img :src="screenshotUrl" />
  
  <!-- æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒè¾“å…¥ -->
  <el-input v-if="needsInput" v-model="verificationCode" />
  
  <!-- æ“ä½œæŒ‰é’® -->
  <el-button @click="handleSubmit">æäº¤éªŒè¯ç </el-button>
  <el-button @click="handleManualDone" v-if="!needsInput">æˆ‘å·²æ‰‹åŠ¨å®Œæˆ</el-button>
  <el-button @click="handleSkip">è·³è¿‡ï¼ˆæ ‡è®°å¤±è´¥ï¼‰</el-button>
  <el-button @click="handleCancel">å–æ¶ˆä»»åŠ¡</el-button>
  
  <!-- å€’è®¡æ—¶æç¤º -->
  <el-alert v-if="timeoutCountdown > 0" :title="`å‰©ä½™æ—¶é—´: ${timeoutCountdown}ç§’`" />
</el-dialog>
```

### D19: ä»»åŠ¡æ¢å¤è¡Œä¸ºè¯¦ç»†è®¾è®¡

**å†³ç­–**ï¼šResumeä»æš‚åœç‚¹ç»§ç»­ï¼ŒRetryé‡æ–°å¼€å§‹

**Resumeï¼ˆç»§ç»­æš‚åœä»»åŠ¡ï¼‰**ï¼š
- **è¡Œä¸º**ï¼šä»æš‚åœçš„æ­¥éª¤ç»§ç»­æ‰§è¡Œï¼ˆä¸æ˜¯é‡æ–°å¼€å§‹ï¼‰
- **å®ç°**ï¼šä¿å­˜æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå½“å‰ç»„ä»¶ã€æ­¥éª¤ç´¢å¼•ã€æµè§ˆå™¨çŠ¶æ€ï¼‰
- **é™åˆ¶**ï¼šä»…æ”¯æŒéªŒè¯ç æš‚åœï¼Œä¸æ”¯æŒä»»æ„æš‚åœ

**Retryï¼ˆé‡è¯•å¤±è´¥/ä¸­æ–­ä»»åŠ¡ï¼‰**ï¼š
- **è¡Œä¸º**ï¼šåˆ›å»ºæ–°ä»»åŠ¡ï¼Œé‡æ–°å¼€å§‹æ•´ä¸ªæµç¨‹
- **å®ç°**ï¼šå¤åˆ¶åŸä»»åŠ¡å‚æ•°ï¼Œåˆ›å»ºæ–°ä»»åŠ¡è®°å½•
- **å…³è”**ï¼šæ–°ä»»åŠ¡çš„ `parent_task_id` æŒ‡å‘åŸä»»åŠ¡

**å®ç°ä»£ç **ï¼š

```python
# executor_v2.py

class TaskContext:
    """ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡"""
    task_id: str
    current_component: str
    current_step_index: int
    browser_context: BrowserContext
    status: str  # running, paused
    pause_reason: str  # verification_required, ...

async def resume_task(self, task_id: str, verification_code: str = None):
    """ç»§ç»­æš‚åœçš„ä»»åŠ¡"""
    context = self._task_contexts.get(task_id)
    # ä»æš‚åœç‚¹ç»§ç»­
    if context.pause_reason == "verification_required":
        await self._inject_verification_code(context, verification_code)
    await self._continue_execution(context)

async def retry_task(self, task_id: str):
    """é‡è¯•å¤±è´¥/ä¸­æ–­çš„ä»»åŠ¡"""
    original_task = await get_task(task_id)
    # åˆ›å»ºæ–°ä»»åŠ¡ï¼Œå¤åˆ¶æ‰€æœ‰å‚æ•°
    new_task = await create_task(..., parent_task_id=original_task.id)
    await self.execute(new_task.id, ...)
```

### D20: æ•°æ®æ¨¡å—æ¸…ç†è®¡åˆ’

**å†³ç­–**ï¼šåˆ†ä¸¤é˜¶æ®µæ¸è¿›å¼æ¸…ç†

**Phase 1: æ–°ç³»ç»Ÿä¸Šçº¿åï¼ˆPhase 2å®Œæˆåï¼‰**
- å½’æ¡£æ—§ç‰ˆå®Œæ•´è„šæœ¬å½•åˆ¶æ–‡ä»¶åˆ° `backups/2025XX_collection_legacy_scripts/`
- ä¿ç•™ `handlers.py` çš„CLIåŠŸèƒ½ï¼ˆæ ‡è®°ä¸ºdeprecatedï¼‰
- æ›´æ–°æ–‡æ¡£è¯´æ˜ï¼šCLIåŠŸèƒ½å·²åºŸå¼ƒï¼Œæ¨èä½¿ç”¨Web API

**Phase 2: ç¨³å®šè¿è¡Œ1ä¸ªæœˆåï¼ˆPhase 4å®Œæˆåï¼‰**
- è¯„ä¼°CLIåŠŸèƒ½ä½¿ç”¨æƒ…å†µ
- å¦‚æœæ–°ç³»ç»Ÿç¨³å®šï¼Œç§»é™¤CLIå½•åˆ¶å‘å¯¼ä»£ç 
- å½’æ¡£ `handlers.py` ä¸­çš„legacyæ–¹æ³•åˆ° `backups/`
- æ›´æ–°CHANGELOG.mdè®°å½•æ¸…ç†å†…å®¹

**æ¸…ç†åŸåˆ™**ï¼š
- âœ… ä¿ç•™å…¼å®¹æ€§ï¼šæ–°ç³»ç»Ÿä¸Šçº¿åä¿ç•™CLIåŠŸèƒ½1ä¸ªæœˆ
- âœ… æ¸è¿›å¼æ¸…ç†ï¼šåˆ†é˜¶æ®µæ¸…ç†ï¼Œç¡®ä¿ä¸å½±å“ç°æœ‰ç”¨æˆ·
- âœ… å®Œæ•´å½’æ¡£ï¼šæ‰€æœ‰æ¸…ç†çš„ä»£ç å¿…é¡»å½’æ¡£åˆ° `backups/` ç›®å½•
- âœ… æ–‡æ¡£æ›´æ–°ï¼šæ¸…ç†åæ›´æ–°ç›¸å…³æ–‡æ¡£å’ŒCHANGELOG

### D21: èµ„æºæ¸…ç†æœºåˆ¶è®¾è®¡

**å†³ç­–**ï¼šå®ç°å®šæ—¶æ¸…ç†ä»»åŠ¡å’Œå¯åŠ¨æ—¶æ¸…ç†

**ä¸´æ—¶æ–‡ä»¶æ¸…ç†**ï¼š

| æ–‡ä»¶ç±»å‹ | ä¿ç•™æ—¶é—´ | æ¸…ç†æ—¶é—´ | é…ç½®é¡¹ |
|---------|---------|---------|--------|
| ä¸‹è½½æ–‡ä»¶ (temp/downloads/) | 7å¤© | æ¯å¤©å‡Œæ™¨3ç‚¹ | `DOWNLOADS_RETENTION_DAYS=7` |
| æˆªå›¾æ–‡ä»¶ (temp/screenshots/) | 30å¤© | æ¯å¤©å‡Œæ™¨3ç‚¹ | `SCREENSHOTS_RETENTION_DAYS=30` |

**å®ç°ä»£ç **ï¼š

```python
# backend/services/cleanup_service.py

class CleanupService:
    """ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœåŠ¡"""
    
    async def cleanup_downloads(self, retention_days: int = 7):
        """æ¸…ç†è¿‡æœŸä¸‹è½½æ–‡ä»¶"""
        cutoff = datetime.now() - timedelta(days=retention_days)
        downloads_dir = Path("temp/downloads")
        
        for task_dir in downloads_dir.iterdir():
            if task_dir.is_dir():
                mtime = datetime.fromtimestamp(task_dir.stat().st_mtime)
                if mtime < cutoff:
                    shutil.rmtree(task_dir)
                    logger.info(f"å·²æ¸…ç†è¿‡æœŸä¸‹è½½ç›®å½•: {task_dir}")
    
    async def cleanup_screenshots(self, retention_days: int = 30):
        """æ¸…ç†è¿‡æœŸæˆªå›¾æ–‡ä»¶"""
        cutoff = datetime.now() - timedelta(days=retention_days)
        screenshots_dir = Path("temp/screenshots")
        
        for task_dir in screenshots_dir.iterdir():
            if task_dir.is_dir():
                mtime = datetime.fromtimestamp(task_dir.stat().st_mtime)
                if mtime < cutoff:
                    shutil.rmtree(task_dir)
                    logger.info(f"å·²æ¸…ç†è¿‡æœŸæˆªå›¾ç›®å½•: {task_dir}")
```

**æµè§ˆå™¨è¿›ç¨‹æ¸…ç†**ï¼š

```python
# modules/apps/collection_center/executor_v2.py

async def cleanup_orphan_browsers(self):
    """æ¸…ç†å­¤å„¿æµè§ˆå™¨è¿›ç¨‹"""
    import psutil
    
    # è·å–å½“å‰ç®¡ç†çš„æµè§ˆå™¨è¿›ç¨‹ID
    managed_pids = set(self.browser_manager.get_active_pids())
    
    # æŸ¥æ‰¾æ‰€æœ‰chromium/chromeè¿›ç¨‹
    for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
        try:
            if 'chromium' in proc.info['name'].lower() or 'chrome' in proc.info['name'].lower():
                # æ£€æŸ¥æ˜¯å¦æ˜¯Playwrightå¯åŠ¨çš„
                cmdline = ' '.join(proc.info['cmdline'] or [])
                if '--remote-debugging-port' in cmdline:
                    if proc.info['pid'] not in managed_pids:
                        proc.kill()
                        logger.warning(f"å·²æ¸…ç†å­¤å„¿æµè§ˆå™¨è¿›ç¨‹: PID={proc.info['pid']}")
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            pass
```

**å®šæ—¶ä»»åŠ¡é…ç½®**ï¼š

```python
# åœ¨APSchedulerä¸­æ³¨å†Œæ¸…ç†ä»»åŠ¡
scheduler.add_job(
    cleanup_service.cleanup_all,
    'cron',
    hour=3,  # æ¯å¤©å‡Œæ™¨3ç‚¹
    id='cleanup_temp_files',
    replace_existing=True
)

# å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡å­¤å„¿è¿›ç¨‹æ¸…ç†
await executor.cleanup_orphan_browsers()
```

### D22: å¹¶å‘å®‰å…¨æœºåˆ¶è®¾è®¡

**å†³ç­–**ï¼šä½¿ç”¨ä¹è§‚é”å’Œé˜Ÿåˆ—è§¦å‘æœºåˆ¶

**ä»»åŠ¡çŠ¶æ€ä¹è§‚é”**ï¼š

```python
# backend/services/task_service.py

async def update_task_status(
    task_id: str, 
    new_status: str, 
    expected_status: str = None,
    **extra_fields
) -> bool:
    """
    ä½¿ç”¨ä¹è§‚é”æ›´æ–°ä»»åŠ¡çŠ¶æ€
    
    Args:
        task_id: ä»»åŠ¡ID
        new_status: æ–°çŠ¶æ€
        expected_status: æœŸæœ›çš„å½“å‰çŠ¶æ€ï¼ˆä¹è§‚é”æ¡ä»¶ï¼‰
        extra_fields: å…¶ä»–è¦æ›´æ–°çš„å­—æ®µ
    
    Returns:
        bool: æ›´æ–°æ˜¯å¦æˆåŠŸ
    """
    query = update(CollectionTask).where(
        CollectionTask.id == task_id
    )
    
    # æ·»åŠ ä¹è§‚é”æ¡ä»¶
    if expected_status:
        query = query.where(CollectionTask.status == expected_status)
    
    query = query.values(
        status=new_status,
        updated_at=datetime.utcnow(),
        **extra_fields
    )
    
    result = await db.execute(query)
    
    if result.rowcount == 0:
        logger.warning(f"ä»»åŠ¡çŠ¶æ€æ›´æ–°å¤±è´¥ï¼ˆä¹è§‚é”å†²çªï¼‰: task_id={task_id}, expected={expected_status}")
        return False
    
    return True
```

**æ’é˜Ÿä»»åŠ¡è‡ªåŠ¨å¯åŠ¨**ï¼š

```python
# backend/services/task_queue_service.py

class TaskQueueService:
    """æ’é˜Ÿä»»åŠ¡ç®¡ç†æœåŠ¡"""
    
    async def on_task_complete(self, completed_task_id: str):
        """
        ä»»åŠ¡å®Œæˆæ—¶çš„å›è°ƒï¼Œæ£€æŸ¥å¹¶å¯åŠ¨æ’é˜Ÿä»»åŠ¡
        """
        # è·å–å½“å‰è¿è¡Œä¸­çš„ä»»åŠ¡æ•°
        running_count = await self.get_running_task_count()
        max_concurrent = int(os.getenv('MAX_COLLECTION_TASKS', 3))
        
        if running_count < max_concurrent:
            # è·å–ä¸‹ä¸€ä¸ªæ’é˜Ÿä»»åŠ¡ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰
            next_task = await self.get_next_queued_task()
            
            if next_task:
                # ä½¿ç”¨ä¹è§‚é”æ›´æ–°çŠ¶æ€ä¸ºrunning
                success = await update_task_status(
                    next_task.id,
                    new_status='running',
                    expected_status='queued'
                )
                
                if success:
                    # å¯åŠ¨ä»»åŠ¡æ‰§è¡Œ
                    await self.start_task_execution(next_task)
                    logger.info(f"å·²å¯åŠ¨æ’é˜Ÿä»»åŠ¡: {next_task.id}")
    
    async def get_next_queued_task(self) -> Optional[CollectionTask]:
        """è·å–ä¸‹ä¸€ä¸ªæ’é˜Ÿä»»åŠ¡"""
        return await db.query(CollectionTask).filter(
            CollectionTask.status == 'queued'
        ).order_by(CollectionTask.created_at.asc()).first()
```

**å®šæ—¶ä»»åŠ¡å†²çªå¤„ç†**ï¼š

```python
# backend/services/collection_scheduler.py

async def execute_scheduled_task(config_id: int):
    """æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆå¸¦å†²çªæ£€æµ‹ï¼‰"""
    config = await get_config(config_id)
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡
    running_task = await get_running_task_by_config(config_id)
    if running_task:
        logger.warning(f"é…ç½® {config_id} å·²æœ‰è¿è¡Œä¸­ä»»åŠ¡ {running_task.id}ï¼Œè·³è¿‡æœ¬æ¬¡è°ƒåº¦")
        return
    
    # åˆ›å»ºå¹¶å¯åŠ¨ä»»åŠ¡
    await create_and_start_task(config)
```

### D23: WebSocketè®¤è¯è®¾è®¡

**å†³ç­–**ï¼šä½¿ç”¨JWT Tokenè¿›è¡ŒWebSocketè¿æ¥è®¤è¯

**è®¤è¯æµç¨‹**ï¼š

```
1. å‰ç«¯è·å–JWT Tokenï¼ˆç™»å½•æ—¶è·å¾—ï¼‰
2. è¿æ¥WebSocketæ—¶åœ¨URLå‚æ•°ä¸­ä¼ é€’Token
3. åç«¯éªŒè¯Tokenæœ‰æ•ˆæ€§
4. Tokenæ— æ•ˆåˆ™å…³é—­è¿æ¥ï¼ˆcode=4001ï¼‰
```

**å®ç°ä»£ç **ï¼š

```python
# backend/routers/collection_websocket.py

from fastapi import WebSocket, WebSocketDisconnect, Query
from jose import jwt, JWTError

@router.websocket("/ws/collection/{task_id}")
async def websocket_endpoint(
    websocket: WebSocket, 
    task_id: str, 
    token: str = Query(...)
):
    """WebSocketç«¯ç‚¹ï¼ˆå¸¦è®¤è¯ï¼‰"""
    
    # 1. éªŒè¯Token
    try:
        payload = jwt.decode(
            token, 
            settings.SECRET_KEY, 
            algorithms=["HS256"]
        )
        user_id = payload.get("sub")
        if user_id is None:
            await websocket.close(code=4001, reason="Invalid token")
            return
    except JWTError:
        await websocket.close(code=4001, reason="Token verification failed")
        return
    
    # 2. éªŒè¯ä»»åŠ¡è®¿é—®æƒé™ï¼ˆå¯é€‰ï¼šæ£€æŸ¥ä»»åŠ¡æ˜¯å¦å±äºè¯¥ç”¨æˆ·ï¼‰
    task = await get_task(task_id)
    if not task:
        await websocket.close(code=4004, reason="Task not found")
        return
    
    # 3. æ¥å—è¿æ¥
    await websocket.accept()
    
    # 4. æ³¨å†Œåˆ°è¿æ¥ç®¡ç†å™¨
    connection_manager.connect(task_id, websocket)
    
    try:
        while True:
            # æ¥æ”¶å¿ƒè·³æˆ–å‘½ä»¤
            data = await websocket.receive_text()
            if data == "ping":
                await websocket.send_text("pong")
    except WebSocketDisconnect:
        connection_manager.disconnect(task_id, websocket)
```

**å‰ç«¯è¿æ¥ç¤ºä¾‹**ï¼š

```javascript
// frontend/src/composables/useCollectionStatus.js

export function useCollectionStatus(taskId) {
  const token = localStorage.getItem('token')
  const wsUrl = `ws://localhost:8001/ws/collection/${taskId}?token=${token}`
  
  const ws = new WebSocket(wsUrl)
  
  ws.onopen = () => {
    console.log('WebSocket connected')
    // å¿ƒè·³ä¿æ´»
    setInterval(() => ws.send('ping'), 30000)
  }
  
  ws.onclose = (event) => {
    if (event.code === 4001) {
      console.error('WebSocket authentication failed')
      // è·³è½¬åˆ°ç™»å½•é¡µ
    }
  }
  
  return { ws }
}
```

### D24: ç³»ç»Ÿå¥åº·æ£€æŸ¥è®¾è®¡

**å†³ç­–**ï¼šæä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œè¿”å›ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

**å®ç°ä»£ç **ï¼š

```python
# backend/routers/collection.py

@router.get("/health")
async def health_check():
    """
    ç³»ç»Ÿå¥åº·æ£€æŸ¥
    
    è¿”å›ï¼šè¿è¡Œä¸­ä»»åŠ¡æ•°ã€æ’é˜Ÿä»»åŠ¡æ•°ã€æµè§ˆå™¨æ± çŠ¶æ€
    """
    try:
        # ä»»åŠ¡ç»Ÿè®¡
        running_count = await db.query(func.count(CollectionTask.id)).filter(
            CollectionTask.status == 'running'
        ).scalar()
        
        queued_count = await db.query(func.count(CollectionTask.id)).filter(
            CollectionTask.status == 'queued'
        ).scalar()
        
        # æµè§ˆå™¨æ± çŠ¶æ€
        browser_stats = browser_manager.get_stats() if browser_manager else {}
        
        return {
            "status": "healthy",
            "timestamp": datetime.utcnow().isoformat(),
            "tasks": {
                "running": running_count,
                "queued": queued_count,
                "max_concurrent": int(os.getenv('MAX_COLLECTION_TASKS', 3))
            },
            "browser_pool": browser_stats,
            "cleanup": {
                "last_run": cleanup_service.last_run_time,
                "next_run": cleanup_service.next_run_time
            }
        }
    except Exception as e:
        return {
            "status": "unhealthy",
            "error": str(e),
            "timestamp": datetime.utcnow().isoformat()
        }
```

### D25: æ–‡ä»¶æ³¨å†ŒåŸå­æ€§è®¾è®¡

**å†³ç­–**ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯æ–‡ä»¶ç§»åŠ¨å’Œæ³¨å†Œçš„åŸå­æ€§

**å®ç°ä»£ç **ï¼š

```python
# backend/services/file_processing_service.py

async def process_collected_file(
    temp_file_path: str,
    metadata: Dict[str, Any]
) -> str:
    """
    å¤„ç†é‡‡é›†åˆ°çš„æ–‡ä»¶ï¼ˆåŸå­æ“ä½œï¼‰
    
    1. ç”Ÿæˆæ ‡å‡†æ–‡ä»¶å
    2. ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
    3. æ³¨å†Œåˆ°catalog_files
    
    å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œå›æ»šæ‰€æœ‰æ“ä½œ
    """
    temp_path = Path(temp_file_path)
    target_dir = Path(f"data/raw/{datetime.now().year}")
    target_dir.mkdir(parents=True, exist_ok=True)
    
    # ç”Ÿæˆæ ‡å‡†æ–‡ä»¶å
    standard_name = StandardFileName.generate(
        platform=metadata['platform'],
        data_domain=metadata['data_domain'],
        granularity=metadata['granularity'],
        date=metadata['date']
    )
    target_path = target_dir / standard_name
    
    # ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
    async with db.transaction():
        try:
            # 1. ç§»åŠ¨æ–‡ä»¶
            shutil.move(str(temp_path), str(target_path))
            
            # 2. ç”Ÿæˆå…ƒæ•°æ®æ–‡ä»¶
            meta_path = target_path.with_suffix(target_path.suffix + '.meta.json')
            with open(meta_path, 'w', encoding='utf-8') as f:
                json.dump(metadata, f, ensure_ascii=False, indent=2)
            
            # 3. æ³¨å†Œåˆ°catalog
            await register_single_file(
                file_path=str(target_path),
                source='collection',
                platform=metadata['platform'],
                data_domain=metadata['data_domain'],
                granularity=metadata['granularity']
            )
            
            return str(target_path)
            
        except Exception as e:
            # å›æ»šæ–‡ä»¶æ“ä½œ
            if target_path.exists():
                shutil.move(str(target_path), str(temp_path))
            if meta_path.exists():
                meta_path.unlink()
            raise FileProcessingError(f"æ–‡ä»¶å¤„ç†å¤±è´¥: {e}")
```

## Open Questions

### OQ1: é‡‡é›†ä»»åŠ¡å¹¶å‘æ•°é™åˆ¶

**é—®é¢˜**ï¼šæ˜¯å¦éœ€è¦é™åˆ¶åŒæ—¶è¿è¡Œçš„é‡‡é›†ä»»åŠ¡æ•°ï¼Ÿ

**å»ºè®®**ï¼š
- é»˜è®¤é™åˆ¶ 3 ä¸ªå¹¶å‘ä»»åŠ¡
- å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½® `MAX_COLLECTION_TASKS=3`

### OQ2: ä»»åŠ¡æ—¥å¿—ä¿ç•™ç­–ç•¥

**é—®é¢˜**ï¼šä»»åŠ¡æ—¥å¿—ä¿ç•™å¤šä¹…ï¼Ÿ

**å»ºè®®**ï¼š
- é»˜è®¤ä¿ç•™ 30 å¤©
- å¯é€šè¿‡é…ç½®æ–‡ä»¶è°ƒæ•´
- æä¾›æ‰‹åŠ¨æ¸…ç† API

### OQ3: ç»„ä»¶ç‰ˆæœ¬ç®¡ç†

**é—®é¢˜**ï¼šç»„ä»¶æ›´æ–°åå¦‚ä½•ç®¡ç†ç‰ˆæœ¬ï¼Ÿ

**å»ºè®®**ï¼š
- ç»„ä»¶ YAML åŒ…å« `version` å­—æ®µ
- é€šè¿‡ Git ç®¡ç†ç‰ˆæœ¬å†å²
- æ‰§è¡Œæ—¶è®°å½•ä½¿ç”¨çš„ç»„ä»¶ç‰ˆæœ¬
