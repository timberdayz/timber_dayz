# ç°ä»£åŒ–è®¤è¯ç³»ç»Ÿæ”¹è¿› - æ¼æ´ä¿®å¤è®°å½•

**ä¿®å¤æ—¥æœŸ**: 2026-01-03  
**ä¿®å¤èŒƒå›´**: æ‰€æœ‰ P0 å’Œ P1 çº§åˆ«æ¼æ´

## ä¿®å¤æ‘˜è¦

| æ¼æ´ç¼–å· | ä¸¥é‡çº§åˆ« | çŠ¶æ€ | ä¿®å¤æ–‡ä»¶ |
|---------|---------|------|---------|
| Vulnerability 1 | P0 | âœ… å·²ä¿®å¤ | `backend/services/auth_service.py`, `backend/routers/auth.py` |
| Vulnerability 2 | P0 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 3 | P0 | âœ… å·²ä¿®å¤ | `frontend/src/stores/auth.js`, `backend/routers/auth.py` |
| Vulnerability 4 | P1 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 5 | P1 | âœ… å·²ä¿®å¤ | `frontend/src/api/index.js` |
| Vulnerability 6 | P1 | âœ… å·²ä¿®å¤ | `frontend/src/stores/auth.js`, `backend/routers/auth.py`, `backend/schemas/auth.py` |
| Vulnerability 10 | P2 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 11 | P1 | âœ… å·²ä¿®å¤ | `frontend/src/stores/auth.js` |
| Vulnerability 14 | P1 | âœ… å·²ä¿®å¤ | `frontend/src/stores/auth.js` |
| Vulnerability 15 | P0 | âœ… å·²ä¿®å¤ | `backend/services/auth_service.py`, `backend/routers/auth.py` |
| Vulnerability 16 | P1 | âœ… å·²ä¿®å¤ | `frontend/src/stores/auth.js` |
| Vulnerability 17 | P1 | âœ… å·²ä¿®å¤ | `frontend/src/api/index.js` |
| Vulnerability 18 | P2 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 19 | P1 | âœ… å·²ä¿®å¤ | `backend/services/auth_service.py` |
| Vulnerability 20 | P1 | âœ… å·²ä¿®å¤ | `backend/services/auth_service.py` |
| Vulnerability 21 | P2 | âœ… å·²ä¿®å¤ | `frontend/src/api/index.js` |
| Vulnerability 22 | P2 | âœ… å·²ä¿®å¤ | `backend/services/auth_service.py` |
| Vulnerability 23 | P2 | âœ… å·²ä¿®å¤ | `frontend/src/api/index.js` |
| Vulnerability 24 | P0 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 25 | P2 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 26 | P2 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 27 | P2 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 28 | P2 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py` |
| Vulnerability 29 | P0 | âœ… å·²ä¿®å¤ | `backend/routers/auth.py`, `backend/routers/users.py`, `backend/schemas/auth.py` |

---

## è¯¦ç»†ä¿®å¤è®°å½•

### Vulnerability 1: åˆ·æ–° Token åæœªæ›´æ–° Refresh Token Cookie âœ…

**ä¿®å¤å†…å®¹**:

1. **æ–°å¢æ–¹æ³•**: `backend/services/auth_service.py`
   ```python
   def refresh_token_pair(self, refresh_token: str) -> Dict[str, str]:
       """ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„ä»¤ç‰Œå¯¹ï¼ˆè®¿é—®ä»¤ç‰Œ + åˆ·æ–°ä»¤ç‰Œï¼‰"""
       # æ”¯æŒ Refresh Token è½®æ¢
   ```

2. **ä¿®æ”¹åˆ·æ–°æ¥å£**: `backend/routers/auth.py`
   - ä½¿ç”¨ `refresh_token_pair()` æ›¿ä»£ `refresh_access_token()`
   - åŒæ—¶æ›´æ–° `access_token` å’Œ `refresh_token` Cookie

**æµ‹è¯•å»ºè®®**:
- éªŒè¯åˆ·æ–°åï¼Œrefresh token Cookie æ˜¯å¦æ›´æ–°
- éªŒè¯å¤šæ¬¡åˆ·æ–°åï¼Œtoken æ˜¯å¦ä»ç„¶æœ‰æ•ˆ

---

### Vulnerability 2: ç™»å‡ºæ¥å£æœªæ¸…é™¤ Cookie âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹ç™»å‡ºæ¥å£**: `backend/routers/auth.py`
   ```python
   @router.post("/logout")
   async def logout(request: Request, current_user: DimUser = Depends(get_current_user)):
       # æ¸…é™¤æ‰€æœ‰è®¤è¯ç›¸å…³çš„ Cookie
       response.delete_cookie(key="access_token", path="/")
       response.delete_cookie(key="refresh_token", path="/")
   ```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å‡ºåï¼ŒCookie æ˜¯å¦è¢«æ¸…é™¤
- éªŒè¯ç™»å‡ºåï¼Œæ— æ³•ä½¿ç”¨æ—§ Cookie è®¿é—®å—ä¿æŠ¤èµ„æº

---

### Vulnerability 3: å‰ç«¯ Token å­˜å‚¨åŒé‡æœºåˆ¶å¯¼è‡´ä¸ä¸€è‡´ âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹åˆ·æ–° Token æ–¹æ³•**: `frontend/src/stores/auth.js`
   - åˆ·æ–°æˆåŠŸåï¼ŒåŒæ­¥æ›´æ–° localStorage ä¸­çš„ refresh_token
   - å¦‚æœå“åº”ä¸­åŒ…å« refresh_tokenï¼Œä¹ŸåŒæ­¥æ›´æ–°

2. **ä¿®æ”¹åˆ·æ–°æ¥å£å“åº”**: `backend/routers/auth.py`
   - å“åº”ä¸­åŒ…å« `refresh_token` å­—æ®µ
   - å‰ç«¯å¯ä»¥åŒæ­¥æ›´æ–° localStorage

3. **ä¿®æ”¹å“åº”æ¨¡å‹**: `backend/schemas/auth.py`
   - `RefreshTokenResponse` æ·»åŠ å¯é€‰çš„ `refresh_token` å­—æ®µ

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ Cookie å’Œ localStorage ä¸­çš„ token æ˜¯å¦ä¸€è‡´
- éªŒè¯åˆ·æ–°åï¼Œä¸¤è€…æ˜¯å¦åŒæ­¥æ›´æ–°

---

### Vulnerability 4: Refresh Token æ¥å£è¯·æ±‚ä½“å‚æ•°å¯èƒ½ä¸º None âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹æ¥å£å‚æ•°**: `backend/routers/auth.py`
   ```python
   async def refresh_token(
       http_request: Request,
       request_body: Optional[RefreshTokenRequest] = None  # æ˜ç¡®å¤„ç† None
   ):
   ```

2. **æ·»åŠ å¯¼å…¥**: `backend/routers/auth.py`
   ```python
   from typing import List, Optional
   ```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯å‘é€ç©ºè¯·æ±‚ä½“æ—¶ï¼Œæ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯ä» Cookie è¯»å– refresh token æ˜¯å¦æ­£å¸¸

---

### Vulnerability 5: å‰ç«¯åˆ·æ–° Token é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æœªå¤„ç†å¤±è´¥æƒ…å†µ âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹å“åº”æ‹¦æˆªå™¨**: `frontend/src/api/index.js`
   - åˆ·æ–°å¤±è´¥æ—¶ï¼Œæ‹’ç»é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰è¯·æ±‚
   - ç¡®ä¿é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ä¸ä¼šæ°¸è¿œæŒ‚èµ·

**å…³é”®ä»£ç **:
```javascript
// åˆ·æ–°å¤±è´¥æ—¶ï¼Œæ‹’ç»é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰è¯·æ±‚
if (!refreshed) {
  const refreshError = new Error("Token refresh failed");
  failedQueue.forEach(({ reject }) => {
    reject(refreshError);
  });
  failedQueue = [];
  // ... æ¸…é™¤ token å¹¶è·³è½¬ç™»å½•é¡µ
}
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯åˆ·æ–°å¤±è´¥æ—¶ï¼Œé˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ˜¯å¦è¢«æ­£ç¡®æ‹’ç»
- éªŒè¯å¤šä¸ªå¹¶å‘è¯·æ±‚çš„åˆ·æ–°æµç¨‹

---

### Vulnerability 6: å‰ç«¯åˆ·æ–° Token åæ— æ³•è·å–æ–°çš„ Cookie âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹åˆ·æ–° Token æ–¹æ³•**: `frontend/src/stores/auth.js`
   - å¦‚æœå“åº”ä¸­åŒ…å« refresh_tokenï¼ŒåŒæ­¥æ›´æ–° localStorage

2. **ä¿®æ”¹åˆ·æ–°æ¥å£å“åº”**: `backend/routers/auth.py`
   - å“åº”ä¸­åŒ…å« `refresh_token` å­—æ®µ

3. **ä¿®æ”¹å“åº”æ¨¡å‹**: `backend/schemas/auth.py`
   - `RefreshTokenResponse` æ·»åŠ å¯é€‰çš„ `refresh_token` å­—æ®µ

**æµ‹è¯•å»ºè®®**:
- éªŒè¯åˆ·æ–°åï¼Œå‰ç«¯æ˜¯å¦èƒ½æ­£ç¡®è·å–æ–°çš„ token
- éªŒè¯ localStorage æ˜¯å¦åŒæ­¥æ›´æ–°

---

## ä¿®å¤éªŒè¯æ¸…å•

### åç«¯éªŒè¯

- [ ] åˆ·æ–° token åï¼Œaccess_token å’Œ refresh_token Cookie éƒ½æ›´æ–°
- [ ] ç™»å‡ºåï¼Œæ‰€æœ‰è®¤è¯ç›¸å…³çš„ Cookie éƒ½è¢«æ¸…é™¤
- [ ] åˆ·æ–°æ¥å£å“åº”ä¸­åŒ…å« refresh_token å­—æ®µ
- [ ] åˆ·æ–°æ¥å£å¯ä»¥å¤„ç† None è¯·æ±‚ä½“

### å‰ç«¯éªŒè¯

- [ ] åˆ·æ–° token åï¼ŒlocalStorage ä¸­çš„ token åŒæ­¥æ›´æ–°
- [ ] åˆ·æ–°å¤±è´¥æ—¶ï¼Œé˜Ÿåˆ—ä¸­çš„è¯·æ±‚è¢«æ­£ç¡®æ‹’ç»
- [ ] Cookie å’Œ localStorage ä¸­çš„ token ä¿æŒä¸€è‡´

### é›†æˆéªŒè¯

- [ ] å¤šæ¬¡åˆ·æ–° token åï¼Œç³»ç»Ÿä»ç„¶æ­£å¸¸å·¥ä½œ
- [ ] ç™»å‡ºåï¼Œæ— æ³•ä½¿ç”¨æ—§ Cookie è®¿é—®å—ä¿æŠ¤èµ„æº
- [ ] å¤šä¸ªå¹¶å‘è¯·æ±‚çš„åˆ·æ–°æµç¨‹æ­£å¸¸

---

## ç¬¬äºŒè½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 10: Cookie åˆ é™¤æ—¶æœªæŒ‡å®š domain âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹ç™»å‡ºæ¥å£**: `backend/routers/auth.py`
   - åœ¨ `delete_cookie` æ—¶æ˜ç¡®æŒ‡å®š `domain=None` å’Œ `samesite="lax"`
   - æ·»åŠ æ³¨é‡Šè¯´æ˜å¦‚æœå°†æ¥è®¾ç½®äº† domainï¼Œåˆ é™¤æ—¶ä¹Ÿéœ€è¦æŒ‡å®š

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å‡ºåï¼ŒCookie æ˜¯å¦è¢«æ­£ç¡®æ¸…é™¤
- å¦‚æœå°†æ¥è®¾ç½®äº† domainï¼ŒéªŒè¯åˆ é™¤æ—¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

### Vulnerability 11: å‰ç«¯åˆ·æ–° Token æ—¶ç¼ºå°‘ refreshToken çš„å¤„ç† âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹åˆ·æ–° Token æ–¹æ³•**: `frontend/src/stores/auth.js`
   - æ”¹è¿›é”™è¯¯å¤„ç†ï¼Œå³ä½¿ localStorage ä¸­æ²¡æœ‰ refreshToken ä¹Ÿå°è¯•åˆ·æ–°ï¼ˆåç«¯ä¼šä» Cookie è¯»å–ï¼‰
   - æ·»åŠ è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯æç¤º
   - æ”¹è¿›å“åº”æ ¼å¼å¤„ç†ï¼Œæ”¯æŒå¤šç§å“åº”æ ¼å¼

**å…³é”®ä»£ç **:
```javascript
// å³ä½¿ localStorage ä¸­æ²¡æœ‰ refreshTokenï¼Œä¹Ÿå°è¯•åˆ·æ–°ï¼ˆåç«¯ä¼šä» Cookie è¯»å–ï¼‰
if (!refreshToken.value) {
  console.warn('[Auth] localStorage ä¸­æ²¡æœ‰ refreshTokenï¼Œå°è¯•ä» Cookie åˆ·æ–°')
}

// å¤„ç†å¤šç§å“åº”æ ¼å¼
const accessToken = response?.access_token || response?.data?.access_token
const newRefreshToken = response?.refresh_token || response?.data?.refresh_token
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ localStorage ä¸­æ²¡æœ‰ refreshToken æ—¶ï¼Œæ˜¯å¦ä»èƒ½æ­£å¸¸åˆ·æ–°ï¼ˆä» Cookie è¯»å–ï¼‰
- éªŒè¯å“åº”æ ¼å¼å¤„ç†æ˜¯å¦æ­£ç¡®

---

### Vulnerability 14: å‰ç«¯å“åº”æ‹¦æˆªå™¨å¯èƒ½å½±å“åˆ·æ–° Token çš„å“åº”æ ¼å¼ âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹åˆ·æ–° Token æ–¹æ³•**: `frontend/src/stores/auth.js`
   - æ”¹è¿›å“åº”æ ¼å¼å¤„ç†ï¼Œæ”¯æŒç›´æ¥å¯¹è±¡å’ŒåŒ…è£…åœ¨ data ä¸­çš„æ ¼å¼
   - æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

**æµ‹è¯•å»ºè®®**:
- éªŒè¯åˆ·æ–° token çš„å“åº”æ ¼å¼å¤„ç†æ˜¯å¦æ­£ç¡®
- éªŒè¯ä¸åŒå“åº”æ ¼å¼ä¸‹ï¼Œtoken æ˜¯å¦èƒ½æ­£ç¡®æ›´æ–°

---

## ç¬¬ä¸‰è½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 15: Refresh Token é‡ç”¨æ”»å‡» âœ…

**ä¿®å¤å†…å®¹**:

1. **å®ç° Refresh Token é»‘åå•æœºåˆ¶**: `backend/services/auth_service.py`
   - æ·»åŠ  `_is_refresh_token_blacklisted()` å¼‚æ­¥æ–¹æ³•ï¼Œæ£€æŸ¥ token æ˜¯å¦åœ¨é»‘åå•ä¸­
   - æ·»åŠ  `_add_refresh_token_to_blacklist()` å¼‚æ­¥æ–¹æ³•ï¼Œå°† token åŠ å…¥é»‘åå•
   - ä¿®æ”¹ `refresh_token_pair()` ä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œåœ¨åˆ·æ–°å‰æ£€æŸ¥é»‘åå•ï¼Œåˆ·æ–°åå°†æ—§ token åŠ å…¥é»‘åå•
   - ä½¿ç”¨ Redis å­˜å‚¨é»‘åå•ï¼Œé”®æ ¼å¼ï¼š`xihong_erp:refresh_token_blacklist:{token_hash}`
   - é»‘åå•è¿‡æœŸæ—¶é—´ç­‰äº refresh token çš„å‰©ä½™è¿‡æœŸæ—¶é—´

2. **ä¿®æ”¹è·¯ç”±è°ƒç”¨**: `backend/routers/auth.py`
   - ä¿®æ”¹ `refresh_token` ç«¯ç‚¹ï¼Œä½¿ç”¨ `await auth_service.refresh_token_pair()`

**å…³é”®ä»£ç **:
```python
# æ£€æŸ¥é»‘åå•
if await self._is_refresh_token_blacklisted(refresh_token):
    raise HTTPException(status_code=401, detail="Refresh token has been revoked")

# å°†æ—§ token åŠ å…¥é»‘åå•
await self._add_refresh_token_to_blacklist(refresh_token, expire_seconds)
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯åˆ·æ–° token åï¼Œæ—§çš„ refresh token æ— æ³•å†æ¬¡ä½¿ç”¨
- éªŒè¯é»‘åå•è¿‡æœŸæ—¶é—´æ˜¯å¦æ­£ç¡®
- éªŒè¯ Redis ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿæ˜¯å¦æ­£å¸¸é™çº§

---

### Vulnerability 16: å‰ç«¯ç™»å½•å“åº”æ ¼å¼å¤„ç†é”™è¯¯ âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®æ”¹ç™»å½•æ–¹æ³•**: `frontend/src/stores/auth.js`
   - å…¼å®¹å¤šç§å“åº”æ ¼å¼ï¼š`response.access_token` æˆ– `response.data?.access_token`
   - æ·»åŠ å“åº”æ ¼å¼éªŒè¯ï¼Œç¡®ä¿ token å­˜åœ¨

**å…³é”®ä»£ç **:
```javascript
// å…¼å®¹å¤šç§å“åº”æ ¼å¼
const accessToken = response.access_token || response.data?.access_token
const refreshTokenValue = response.refresh_token || response.data?.refresh_token
const userInfo = response.user_info || response.data?.user_info

if (!accessToken || !refreshTokenValue) {
  throw new Error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ token')
}
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å½•åï¼Œtoken æ˜¯å¦æ­£ç¡®ä¿å­˜
- éªŒè¯ä¸åŒå“åº”æ ¼å¼ä¸‹ï¼Œç™»å½•æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

### Vulnerability 17: å¤šæ ‡ç­¾é¡µç«æ€æ¡ä»¶ âœ…

**ä¿®å¤å†…å®¹**:

1. **å®ç°å¤šæ ‡ç­¾é¡µåŒæ­¥æœºåˆ¶**: `frontend/src/api/index.js`
   - ä½¿ç”¨ `BroadcastChannel` API åœ¨æ ‡ç­¾é¡µä¹‹é—´åŒæ­¥åˆ·æ–°çŠ¶æ€
   - ç›‘å¬å…¶ä»–æ ‡ç­¾é¡µçš„åˆ·æ–°äº‹ä»¶ï¼ˆ`refresh_started`, `refresh_completed`, `refresh_failed`ï¼‰
   - å½“å…¶ä»–æ ‡ç­¾é¡µåˆ·æ–°å®Œæˆæ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æœ¬åœ° token å¹¶å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
   - é™çº§å¤„ç†ï¼šå¦‚æœ `BroadcastChannel` ä¸æ”¯æŒï¼Œé™çº§ä¸ºå•æ ‡ç­¾é¡µæ¨¡å¼

**å…³é”®ä»£ç **:
```javascript
// åˆ›å»º BroadcastChannel
refreshChannel = new BroadcastChannel('token_refresh_channel');

// é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µå¼€å§‹åˆ·æ–°
refreshChannel.postMessage({ type: 'refresh_started' });

// é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µåˆ·æ–°å®Œæˆ
refreshChannel.postMessage({ type: 'refresh_completed', token: newToken });
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯å¤šä¸ªæ ‡ç­¾é¡µåŒæ—¶æ‰“å¼€æ—¶ï¼Œåªæœ‰ä¸€ä¸ªæ ‡ç­¾é¡µå‘èµ·åˆ·æ–°è¯·æ±‚
- éªŒè¯åˆ·æ–°å®Œæˆåï¼Œæ‰€æœ‰æ ‡ç­¾é¡µçš„ token æ˜¯å¦åŒæ­¥æ›´æ–°
- éªŒè¯ `BroadcastChannel` ä¸æ”¯æŒæ—¶ï¼Œç³»ç»Ÿæ˜¯å¦æ­£å¸¸é™çº§

---

### Vulnerability 18: Cookie secure æ ‡å¿—åˆ¤æ–­ä¸å‡†ç¡® âœ…

**ä¿®å¤å†…å®¹**:

1. **æ”¹è¿› Cookie secure åˆ¤æ–­**: `backend/routers/auth.py`
   - æ£€æŸ¥è¯·æ±‚æ˜¯å¦æ˜¯ HTTPSï¼š`request.url.scheme == "https"`
   - ç»“åˆç¯å¢ƒå˜é‡åˆ¤æ–­ï¼š`secure_cookie = is_https or is_production`
   - åœ¨ `login` å’Œ `refresh_token` ç«¯ç‚¹ä¸­åº”ç”¨æ–°çš„åˆ¤æ–­é€»è¾‘

**å…³é”®ä»£ç **:
```python
# æ›´å‡†ç¡®åœ°åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ secure Cookie
is_https = request.url.scheme == "https"
is_production = os.getenv("ENVIRONMENT", "development") == "production"
secure_cookie = is_https or is_production
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ HTTPS è¿æ¥æ—¶ï¼ŒCookie çš„ `secure` æ ‡å¿—æ˜¯å¦æ­£ç¡®
- éªŒè¯ HTTP è¿æ¥æ—¶ï¼ŒCookie çš„ `secure` æ ‡å¿—æ˜¯å¦æ­£ç¡®
- éªŒè¯ä¸åŒç¯å¢ƒå˜é‡é…ç½®ä¸‹ï¼ŒCookie è®¾ç½®æ˜¯å¦æ­£ç¡®

---

## ç¬¬å››è½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 19: Refresh Token é»‘åå•æœºåˆ¶çš„ç«æ€æ¡ä»¶ âœ…

**ä¿®å¤å†…å®¹**:

1. **å®ç°åŸå­æ“ä½œ**: `backend/services/auth_service.py`
   - å°† `_add_refresh_token_to_blacklist` æ”¹ä¸º `_add_refresh_token_to_blacklist_atomic`
   - ä½¿ç”¨ Redis `SETNX` åŸå­æ“ä½œï¼ˆ`set(key, value, ex=expire_seconds, nx=True)`ï¼‰
   - å¦‚æœè¿”å› `False`ï¼Œè¯´æ˜ token å·²åœ¨é»‘åå•ä¸­ï¼ˆé‡å¤ä½¿ç”¨ï¼‰ï¼Œæ‹’ç»è¯·æ±‚
   - ä¿®æ”¹ `refresh_token_pair` æ–¹æ³•ï¼Œä½¿ç”¨åŸå­æ“ä½œå¹¶æ£€æŸ¥è¿”å›å€¼

**å…³é”®ä»£ç **:
```python
# ä½¿ç”¨ SETNX åŸå­æ“ä½œ
result = await redis_client.set(blacklist_key, "1", ex=expire_seconds, nx=True)

if not result:
    # å·²åœ¨é»‘åå•ä¸­ï¼ˆé‡å¤ä½¿ç”¨ï¼‰ï¼Œæ‹’ç»è¯·æ±‚
    raise HTTPException(status_code=401, detail="Refresh token has been revoked (reuse detected)")
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒåŒä¸€ä¸ª refresh token åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- éªŒè¯åŸå­æ“ä½œæ˜¯å¦æ­£ç¡®é˜²æ­¢ç«æ€æ¡ä»¶

---

### Vulnerability 20: Redis è¿æ¥å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥ä¸å®‰å…¨ âœ…

**ä¿®å¤å†…å®¹**:

1. **æ”¹è¿›é™çº§ç­–ç•¥**: `backend/services/auth_service.py`
   - åœ¨ `_is_refresh_token_blacklisted` ä¸­ï¼ŒRedis ä¸å¯ç”¨æ—¶è®°å½•ä¸¥é‡è­¦å‘Š
   - åœ¨ `_add_refresh_token_to_blacklist_atomic` ä¸­ï¼ŒRedis ä¸å¯ç”¨æ—¶è®°å½•è­¦å‘Š
   - æ˜ç¡®è¯´æ˜è¿™æ˜¯å®‰å…¨é£é™©ï¼Œå»ºè®®ç¡®ä¿ Redis å¯ç”¨æ€§

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ Redis ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿæ˜¯å¦è®°å½•è­¦å‘Š
- éªŒè¯é™çº§ç­–ç•¥æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

### Vulnerability 21: BroadcastChannel æ¶ˆæ¯ä¸¢å¤±æˆ–å»¶è¿Ÿ âœ…

**ä¿®å¤å†…å®¹**:

1. **æ·»åŠ è¶…æ—¶æœºåˆ¶**: `frontend/src/api/index.js`
   - æ·»åŠ  `refreshTimeout` å˜é‡ï¼Œç”¨äºè·Ÿè¸ªè¶…æ—¶å®šæ—¶å™¨
   - åœ¨æ”¶åˆ° `refresh_started` æ¶ˆæ¯æ—¶ï¼Œè®¾ç½® 30 ç§’è¶…æ—¶
   - å¦‚æœè¶…æ—¶ï¼Œé‡ç½® `isRefreshing` çŠ¶æ€
   - åœ¨åˆ·æ–°å®Œæˆæˆ–å¤±è´¥æ—¶ï¼Œæ¸…é™¤è¶…æ—¶å®šæ—¶å™¨

**å…³é”®ä»£ç **:
```javascript
// è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼ˆ30ç§’ï¼‰
refreshTimeout = setTimeout(() => {
  console.warn('[Auth] BroadcastChannel æ¶ˆæ¯è¶…æ—¶ï¼Œé‡ç½®åˆ·æ–°çŠ¶æ€');
  isRefreshing = false;
  refreshTimeout = null;
}, 30000);
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯æ¶ˆæ¯ä¸¢å¤±æ—¶ï¼Œè¶…æ—¶æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯åˆ·æ–°å®Œæˆåï¼Œè¶…æ—¶å®šæ—¶å™¨æ˜¯å¦è¢«æ¸…é™¤

---

### Vulnerability 22: Token è¿‡æœŸæ—¶é—´è®¡ç®—è¾¹ç•Œæƒ…å†µ âœ…

**ä¿®å¤å†…å®¹**:

1. **æ”¹è¿›è¾¹ç•Œæƒ…å†µå¤„ç†**: `backend/services/auth_service.py`
   - æ£€æŸ¥ `expire_seconds` æ˜¯å¦ä¸ºè´Ÿæ•°æˆ–0
   - æ£€æŸ¥ `expire_seconds` æ˜¯å¦å¼‚å¸¸å¤§ï¼ˆè¶…è¿‡ refresh token çš„æœ€å¤§è¿‡æœŸæ—¶é—´ï¼‰
   - å¦‚æœå¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–è·³è¿‡é»‘åå•è®¾ç½®

**å…³é”®ä»£ç **:
```python
if expire_seconds <= 0:
    # Token å·²è¿‡æœŸæˆ–å³å°†è¿‡æœŸï¼Œè·³è¿‡é»‘åå•
    logger.debug(f"[Auth] Refresh Token å·²è¿‡æœŸæˆ–å³å°†è¿‡æœŸï¼Œè·³è¿‡é»‘åå•: expire_seconds={expire_seconds}")
elif expire_seconds > self.refresh_token_expire_days * 24 * 60 * 60:
    # è¿‡æœŸæ—¶é—´å¼‚å¸¸å¤§ï¼Œä½¿ç”¨é»˜è®¤å€¼
    logger.warning(f"[Auth] Refresh Token è¿‡æœŸæ—¶é—´å¼‚å¸¸: {expire_seconds}ç§’ï¼Œä½¿ç”¨é»˜è®¤å€¼")
    expire_seconds = self.refresh_token_expire_days * 24 * 60 * 60
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯è¾¹ç•Œæƒ…å†µä¸‹ï¼Œé»‘åå•è®¾ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯å¼‚å¸¸å€¼æ˜¯å¦è¢«æ­£ç¡®å¤„ç†

---

### Vulnerability 23: å‰ç«¯ BroadcastChannel ç›‘å¬å™¨ä¸­çš„é”™è¯¯å¤„ç†ä¸å®Œå–„ âœ…

**ä¿®å¤å†…å®¹**:

1. **æ”¹è¿›é”™è¯¯å¤„ç†**: `frontend/src/api/index.js`
   - åœ¨ `refresh_completed` æ¶ˆæ¯å¤„ç†ä¸­ï¼ŒåŒæ—¶æ›´æ–° `refreshToken`
   - æ”¹è¿›é”™è¯¯å¤„ç†ï¼Œç¡®ä¿ `token` å’Œ `refreshToken` åŒæ­¥æ›´æ–°
   - åœ¨å‘é€ `refresh_completed` æ¶ˆæ¯æ—¶ï¼ŒåŒæ—¶å‘é€ `refresh_token`

**å…³é”®ä»£ç **:
```javascript
// åŒæ—¶æ›´æ–° refreshToken
if (newRefreshToken) {
  store.refreshToken = newRefreshToken;
  localStorage.setItem('refresh_token', newRefreshToken);
}

// å‘é€æ¶ˆæ¯æ—¶åŒ…å« refresh_token
refreshChannel.postMessage({ 
  type: 'refresh_completed', 
  token: newToken,
  refresh_token: newRefreshToken
});
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ `token` å’Œ `refreshToken` æ˜¯å¦åŒæ­¥æ›´æ–°
- éªŒè¯å¤šæ ‡ç­¾é¡µä¹‹é—´ï¼Œ`refreshToken` æ˜¯å¦åŒæ­¥

---

## ç¬¬äº”è½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 24: settings å˜é‡æœªå¯¼å…¥ âœ…

**ä¿®å¤å†…å®¹**:

1. **æ·»åŠ  settings å¯¼å…¥**: `backend/routers/auth.py`
   - æ·»åŠ  `from backend.utils.config import get_settings`
   - åˆ›å»º `settings = get_settings()` å®ä¾‹
   - ç¡®ä¿æ‰€æœ‰ä½¿ç”¨ `settings` çš„åœ°æ–¹éƒ½èƒ½æ­£å¸¸å·¥ä½œ

**å…³é”®ä»£ç **:
```python
from backend.utils.config import get_settings  # â­ v6.0.0ä¿®å¤ï¼šå¯¼å…¥ settings

# â­ v6.0.0ä¿®å¤ï¼šè·å–é…ç½®å®ä¾‹
settings = get_settings()
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å½•æ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯åˆ·æ–° token æ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯ Cookie è¿‡æœŸæ—¶é—´è®¾ç½®æ˜¯å¦æ­£ç¡®

---

## ç¬¬å…­è½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 25: ç™»å½•æˆåŠŸæ—¶ IP å’Œ User-Agent ç¡¬ç¼–ç  âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®å¤ç™»å½•æˆåŠŸæ—¶çš„å®¡è®¡æ—¥å¿—**: `backend/routers/auth.py`
   - ä» request è·å–çœŸå® IP åœ°å€ï¼ˆè€ƒè™‘ä»£ç†ï¼‰
   - ä» request è·å–çœŸå® User-Agent
   - ä¸ç™»å½•å¤±è´¥æ—¶çš„å¤„ç†ä¿æŒä¸€è‡´

**å…³é”®ä»£ç **:
```python
# è·å–çœŸå®IPï¼ˆè€ƒè™‘ä»£ç†ï¼‰
ip_address = request.client.host if request.client else "127.0.0.1"
forwarded_for = request.headers.get("X-Forwarded-For")
if forwarded_for:
    ip_address = forwarded_for.split(",")[0].strip()

# è·å–User-Agent
user_agent = request.headers.get("User-Agent", "Unknown")
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å½•æˆåŠŸæ—¶ï¼Œå®¡è®¡æ—¥å¿—ä¸­æ˜¯å¦è®°å½•äº†çœŸå® IP å’Œ User-Agent

---

### Vulnerability 26: remember_me å­—æ®µå¼•ç”¨é”™è¯¯ âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®å¤ remember_me å­—æ®µå¼•ç”¨**: `backend/routers/auth.py`
   - å°† `request.remember_me` æ”¹ä¸º `credentials.remember_me`
   - ç¡®ä¿æ­£ç¡®è·å–ç™»å½•è¯·æ±‚ä¸­çš„ `remember_me` å€¼

**å…³é”®ä»£ç **:
```python
details={"remember_me": credentials.remember_me}  # ä¿®å¤ï¼šä½¿ç”¨ credentials.remember_me
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å½•æ—¶ï¼Œå®¡è®¡æ—¥å¿—ä¸­æ˜¯å¦æ­£ç¡®è®°å½•äº† `remember_me` å€¼

---

### Vulnerability 27: å…¶ä»–å®¡è®¡æ—¥å¿—ä¸­ IP å’Œ User-Agent ç¡¬ç¼–ç  âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®å¤ logout å‡½æ•°**: `backend/routers/auth.py`
   - ä» request è·å–çœŸå® IP å’Œ User-Agent

2. **ä¿®å¤ update_current_user å‡½æ•°**: `backend/routers/auth.py`
   - æ·»åŠ  `request: Request` å‚æ•°
   - ä» request è·å–çœŸå® IP å’Œ User-Agent

3. **ä¿®å¤ change_password å‡½æ•°**: `backend/routers/auth.py`
   - æ·»åŠ  `http_request: Request` å‚æ•°ï¼ˆé‡å‘½åé¿å…ä¸ `ChangePasswordRequest` å†²çªï¼‰
   - å°† `request` å‚æ•°é‡å‘½åä¸º `password_request` é¿å…å†²çª
   - ä» request è·å–çœŸå® IP å’Œ User-Agent

**å…³é”®ä»£ç **:
```python
# è·å–çœŸå®IPï¼ˆè€ƒè™‘ä»£ç†ï¼‰
ip_address = request.client.host if request.client else "127.0.0.1"
forwarded_for = request.headers.get("X-Forwarded-For")
if forwarded_for:
    ip_address = forwarded_for.split(",")[0].strip()

# è·å–User-Agent
user_agent = request.headers.get("User-Agent", "Unknown")
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å‡ºã€æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç æ—¶ï¼Œå®¡è®¡æ—¥å¿—ä¸­æ˜¯å¦è®°å½•äº†çœŸå® IP å’Œ User-Agent

---

## ç¬¬ä¸ƒè½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 28: user.id å’Œ user.user_id æ··ç”¨ âœ…

**ä¿®å¤å†…å®¹**:

1. **ç»Ÿä¸€ä½¿ç”¨ user.user_id**: `backend/routers/auth.py`
   - å°†æ‰€æœ‰ `user.id` æ”¹ä¸º `user.user_id`
   - å°†æ‰€æœ‰ `current_user.id` æ”¹ä¸º `current_user.user_id`
   - ç¡®ä¿ä»£ç ä¸€è‡´æ€§ï¼Œæ˜ç¡®ä½¿ç”¨ä¸»é”®å­—æ®µå

**ä¿®å¤ä½ç½®**:
- `login` å‡½æ•°ï¼šåˆ›å»º token æ—¶ä½¿ç”¨ `user.user_id`
- `login` å‡½æ•°ï¼šå®¡è®¡æ—¥å¿—ä¸­ä½¿ç”¨ `user.user_id`
- `login` å‡½æ•°ï¼šå“åº”æ•°æ®ä¸­ä½¿ç”¨ `user.user_id`
- `logout` å‡½æ•°ï¼šå®¡è®¡æ—¥å¿—ä¸­ä½¿ç”¨ `current_user.user_id`
- `get_current_user_info` å‡½æ•°ï¼šå“åº”æ•°æ®ä¸­ä½¿ç”¨ `current_user.user_id`
- `update_current_user` å‡½æ•°ï¼šå®¡è®¡æ—¥å¿—å’Œå“åº”æ•°æ®ä¸­ä½¿ç”¨ `current_user.user_id`
- `change_password` å‡½æ•°ï¼šå®¡è®¡æ—¥å¿—ä¸­ä½¿ç”¨ `current_user.user_id`

**å…³é”®ä»£ç **:
```python
# ä¿®å¤å‰
user_id=user.id

# ä¿®å¤å
user_id=user.user_id  # â­ v6.0.0ä¿®å¤ï¼šä½¿ç”¨ user.user_id è€Œä¸æ˜¯ user.idï¼ˆVulnerability 28ï¼‰
```

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å½•ã€ç™»å‡ºã€æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€ä¿®æ”¹å¯†ç ç­‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯å®¡è®¡æ—¥å¿—ä¸­æ˜¯å¦æ­£ç¡®è®°å½•äº†ç”¨æˆ·ID

---

## ç¬¬å…«è½®ä¿®å¤è®°å½•ï¼ˆ2026-01-03ï¼‰

### Vulnerability 29: last_login_at å­—æ®µåä¸åŒ¹é… âœ…

**ä¿®å¤å†…å®¹**:

1. **ä¿®å¤å­—æ®µåä¸åŒ¹é…**: `backend/routers/auth.py`
   - å°† `user.last_login_at` æ”¹ä¸º `user.last_login`
   - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ•°æ®åº“å­—æ®µå

2. **ä¿®å¤å“åº”å­—æ®µæ˜ å°„**: `backend/routers/auth.py` å’Œ `backend/routers/users.py`
   - å°† `current_user.last_login_at` æ”¹ä¸º `current_user.last_login`
   - API å“åº”ä¿æŒ `last_login_at` å­—æ®µåä»¥ä¿æŒä¸€è‡´æ€§ï¼ˆå‰ç«¯å¯èƒ½ä¾èµ–æ­¤å­—æ®µåï¼‰

3. **æ›´æ–° Schema æ³¨é‡Š**: `backend/schemas/auth.py`
   - æ·»åŠ æ³¨é‡Šè¯´æ˜æ•°æ®åº“å­—æ®µåæ˜¯ `last_login`ï¼Œä½† API å“åº”ä½¿ç”¨ `last_login_at`

**å…³é”®ä»£ç **:
```python
# ä¿®å¤å‰
user.last_login_at = datetime.utcnow()

# ä¿®å¤å
user.last_login = datetime.utcnow()  # â­ v6.0.0ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„å­—æ®µå last_loginï¼ˆVulnerability 29ï¼‰
```

**ä¿®å¤ä½ç½®**:
- `backend/routers/auth.py` - `login` å‡½æ•°ï¼ˆç¬¬153è¡Œï¼‰ï¼š`user.last_login_at` â†’ `user.last_login`
- `backend/routers/auth.py` - `get_current_user_info` å‡½æ•°ï¼ˆç¬¬385è¡Œï¼‰ï¼š`current_user.last_login_at` â†’ `current_user.last_login`
- `backend/routers/auth.py` - `update_current_user` å‡½æ•°ï¼ˆç¬¬434è¡Œï¼‰ï¼š`current_user.last_login_at` â†’ `current_user.last_login`
- `backend/routers/users.py` - æ‰€æœ‰ä½¿ç”¨ `last_login_at` çš„åœ°æ–¹ï¼š`user.last_login_at` â†’ `user.last_login`
- `backend/schemas/auth.py` - `UserResponse` schemaï¼šæ·»åŠ æ³¨é‡Šè¯´æ˜æ•°æ®åº“å­—æ®µåæ˜¯ `last_login`ï¼Œä½† API å“åº”ä½¿ç”¨ `last_login_at` ä¿æŒä¸€è‡´æ€§

**æµ‹è¯•å»ºè®®**:
- éªŒè¯ç™»å½•åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
- éªŒè¯ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æ˜¯å¦æ­£å¸¸è¿”å› `last_login_at` å­—æ®µ
- éªŒè¯æœ€åç™»å½•æ—¶é—´æ˜¯å¦æ­£ç¡®æ›´æ–°

---

## åç»­å·¥ä½œ

1. âœ… æ‰€æœ‰ P0 å’Œ P1 æ¼æ´å·²ä¿®å¤ï¼ˆå…«è½®å®¡æŸ¥ï¼Œå…± 29 ä¸ªæ¼æ´ï¼‰
2. âœ… ç¬¬å…«è½®å®¡æŸ¥å‘ç°çš„æ‰€æœ‰æ¼æ´å·²ä¿®å¤
3. âš ï¸ P2 æ¼æ´ï¼ˆVulnerability 8, 9, 12ï¼‰å°†åœ¨ Phase 3/4 ä¸­è§£å†³æˆ–å½“å‰å®ç°å·²åˆç†
4. ğŸ“ å»ºè®®è¿›è¡Œå…¨é¢æµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰ä¿®å¤æ­£å¸¸å·¥ä½œ
5. ğŸ“ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼ŒéªŒè¯ Refresh Token é»‘åå•æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
6. ğŸ“ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼ŒéªŒè¯ Redis å¯ç”¨æ€§å’Œé»‘åå•æœºåˆ¶çš„åŸå­æ“ä½œ
7. ğŸ“ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼ŒéªŒè¯ç™»å½•å’Œåˆ·æ–° token åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
8. ğŸ“ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼ŒéªŒè¯å®¡è®¡æ—¥å¿—æ˜¯å¦è®°å½•äº†çœŸå® IP å’Œ User-Agent
9. ğŸ“ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼ŒéªŒè¯ç”¨æˆ·IDæ˜¯å¦æ­£ç¡®è®°å½•å’Œä½¿ç”¨
10. ğŸ“ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼ŒéªŒè¯æœ€åç™»å½•æ—¶é—´æ˜¯å¦æ­£ç¡®æ›´æ–°

