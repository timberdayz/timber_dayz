# 恢复 Celery 任务队列并优化生产环境架构

## 提案概述

本提案旨在解决当前系统在 **50-100 人生产环境**下的架构问题，通过恢复 Celery 任务队列来实现：
1. **任务持久化**：服务器重启后任务自动恢复
2. **资源隔离**：任务在独立的 worker 进程中执行，不影响 API 服务
3. **水平扩展**：可以通过增加 worker 来扩展处理能力
4. **用户隔离**：实现用户级别的任务数量限制

## 文件结构

- `proposal.md` - 提案概述（Why, What Changes, Impact）
- `design.md` - 技术设计细节
- `tasks.md` - 实施任务清单
- `specs/data-sync/` - 规范变更（如果需要）

## 实施阶段

### Phase 1: 恢复 Celery 任务队列（P0 - 高优先级）
- 创建数据同步任务模块
- 更新 Celery 配置
- 更新 API 路由
- 实现任务持久化和恢复

### Phase 2: 添加 Nginx 反向代理和限流（P1）
- 配置 Nginx 反向代理
- 实现 API 限流
- 实现用户级别任务数量限制

### Phase 3: 添加 Redis 缓存层（P2）
- 实现缓存策略
- 创建缓存服务
- 更新相关 API 使用缓存

### Phase 4: 任务优先级和用户隔离（P3）
- 实现任务优先级队列
- 实现用户任务配额机制

## 关键决策

1. **使用 Celery + Redis**：已有基础设施，成熟稳定
2. **JSON 序列化**：可读性好，易于调试
3. **任务重试策略**：默认重试 3 次，指数退避
4. **并发控制**：使用 Celery worker 并发控制，替代 `asyncio.Semaphore`

## 预期效果

| 指标 | 当前 | 迁移后 | 提升 |
|------|------|--------|------|
| 任务持久化 | ❌ | ✅ | 100% |
| 资源隔离 | ❌ | ✅ | 完全隔离 |
| 水平扩展 | ❌ | ✅ | 无限扩展 |
| 用户隔离 | ❌ | ✅ | 完全隔离 |

## 风险评估

| 风险 | 严重程度 | 缓解措施 |
|------|---------|---------|
| Celery Worker 崩溃 | 高 | 自动重启机制 |
| Redis 连接失败 | 高 | 连接重试机制 |
| 任务序列化失败 | 中 | JSON 序列化，参数验证 |
| 任务重复执行 | 中 | 任务 ID 去重 |

## 下一步

1. 审查提案（`proposal.md`）
2. 审查技术设计（`design.md`）
3. 审查实施任务（`tasks.md`）
4. 批准后开始实施 Phase 1

