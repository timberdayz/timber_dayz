# æ¼æ´å®¡æŸ¥æŠ¥å‘Šï¼šç”¨æˆ·æ³¨å†Œå’Œå®¡æ‰¹æµç¨‹

> **å®¡æŸ¥æ—¥æœŸ**: 2026-01-05ï¼ˆæœ€æ–°æ›´æ–°ï¼‰  
> **çŠ¶æ€**: éƒ¨åˆ†å·²ä¿®å¤  
> **ä¼˜å…ˆçº§**: P0-P2  
> **æ€»æ¼æ´æ•°**: 68ï¼ˆP0: 13, P1: 34, P2: 21ï¼‰  
> **å·²ä¿®å¤**: Phase 6-7 P0/P1 å®‰å…¨è¦æ±‚ï¼ˆ53-68å·æ¼æ´ï¼‰

## ä¿®å¤è¿›åº¦ï¼ˆ2026-01-05ï¼‰

### å·²ä¿®å¤çš„ P0/P1 å®‰å…¨æ¼æ´

| ç¼–å· | æ¼æ´æè¿° | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| 53 | å¯†ç é‡ç½®åæœªå¼ºåˆ¶æ’¤é”€ä¼šè¯ | P0 | âœ… å·²ä¿®å¤ |
| 54 | å¯†ç é‡ç½®åæœªå‘é€é€šçŸ¥ | P1 | âœ… å·²ä¿®å¤ |
| 55 | update_user ä¸­ status å’Œ is_active ä¸ä¸€è‡´ | P1 | âœ… å·²ä¿®å¤ |
| 56 | ç”¨æˆ·æš‚åœåæœªå¼ºåˆ¶æ’¤é”€ä¼šè¯ | P0 | âœ… å·²ä¿®å¤ |
| 57 | ç”¨æˆ·æš‚åœåæœªå‘é€é€šçŸ¥ | P1 | âœ… å·²ä¿®å¤ |
| 58 | è´¦æˆ·é”å®šåæœªå¼ºåˆ¶æ’¤é”€ä¼šè¯ | P0 | âœ… å·²ä¿®å¤ |
| 59 | è´¦æˆ·é”å®šåæœªå‘é€é€šçŸ¥ | P1 | âœ… å·²ä¿®å¤ |
| 60 | è´¦æˆ·è§£é”åæœªå‘é€é€šçŸ¥ | P1 | âœ… å·²ä¿®å¤ |
| 61 | NotificationType ç¼ºå°‘ ACCOUNT_LOCKED | P1 | âœ… å·²ä¿®å¤ |
| 62 | NotificationType ç¼ºå°‘ ACCOUNT_UNLOCKED | P1 | âœ… å·²ä¿®å¤ |
| 63 | ç¼ºå°‘ notify_account_locked å‡½æ•° | P1 | âœ… å·²ä¿®å¤ |
| 64 | ç¼ºå°‘ notify_account_unlocked å‡½æ•° | P1 | âœ… å·²ä¿®å¤ |
| 65 | ç¼ºå°‘ notify_user_suspended å‡½æ•° | P1 | âœ… å·²ä¿®å¤ |
| 66 | Token åˆ·æ–° API ç¼ºå°‘è´¦æˆ·çŠ¶æ€æ£€æŸ¥ | P0 | âœ… å·²ä¿®å¤ |
| 67 | get_current_user ç¼ºå°‘ status å­—æ®µæ£€æŸ¥ | P1 | âœ… å·²ä¿®å¤ |
| 68 | ä¼šè¯æ›´æ–°æ—¶æ²¡æœ‰æ£€æŸ¥è´¦æˆ·çŠ¶æ€ | P1 | âœ… å·²ä¿®å¤ |

### ä¿®å¤å†…å®¹æ±‡æ€»

1. **æ–°å¢é€šç”¨å‡½æ•°**ï¼š`revoke_all_user_sessions(db, user_id, reason)`
2. **æ–°å¢é€šçŸ¥å‡½æ•°**ï¼š`notify_account_locked`, `notify_account_unlocked`, `notify_user_suspended`
3. **NotificationType æ‰©å±•**ï¼šæ·»åŠ  `ACCOUNT_LOCKED`, `ACCOUNT_UNLOCKED`
4. **ä¿®å¤ API**ï¼š
   - `reset_user_password`ï¼šæ·»åŠ ä¼šè¯æ’¤é”€ + é€šçŸ¥
   - `login`ï¼ˆè´¦æˆ·é”å®šæ—¶ï¼‰ï¼šæ·»åŠ ä¼šè¯æ’¤é”€ + é€šçŸ¥
   - `login`ï¼ˆè‡ªåŠ¨è§£é”æ—¶ï¼‰ï¼šæ·»åŠ è§£é”é€šçŸ¥
   - `unlock_user_account`ï¼šæ·»åŠ è§£é”é€šçŸ¥
   - `update_user`ï¼šæ·»åŠ  status ä¸€è‡´æ€§ + ä¼šè¯æ’¤é”€ + é€šçŸ¥
   - `refresh_token`ï¼šæ·»åŠ è´¦æˆ·çŠ¶æ€æ£€æŸ¥ + ä¼šè¯æ’¤é”€æ£€æŸ¥
   - `get_current_user`ï¼šæ·»åŠ  status å­—æ®µæ£€æŸ¥

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº† `add-user-registration-approval` ææ¡ˆä¸­å‘ç°çš„æ‰€æœ‰å®‰å…¨æ¼æ´å’Œè®¾è®¡é—®é¢˜ã€‚

## å‘ç°çš„æ¼æ´

### P0 ä¸¥é‡æ¼æ´ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

#### 1. æ³¨å†ŒAPIç¼ºå°‘é™æµä¿æŠ¤ âš ï¸

**é—®é¢˜**ï¼š
- æ³¨å†ŒAPI (`POST /api/auth/register`) æ²¡æœ‰é€Ÿç‡é™åˆ¶
- æ”»å‡»è€…å¯ä»¥æ— é™æ¬¡æ³¨å†Œï¼Œå¯èƒ½å¯¼è‡´ï¼š
  - æ•°æ®åº“å­˜å‚¨ç©ºé—´è€—å°½
  - ç®¡ç†å‘˜å®¡æ‰¹åˆ—è¡¨è¢«åƒåœ¾æ•°æ®å¡«æ»¡
  - æœåŠ¡å™¨èµ„æºè¢«æ¶ˆè€—

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´DoSæ”»å‡»
- æ•°æ®åº“å¯èƒ½è¢«æ¶æ„æ³¨å†Œæ•°æ®å¡«æ»¡

**ä¿®å¤å»ºè®®**ï¼š
```python
# åœ¨æ³¨å†ŒAPIä¸Šæ·»åŠ é™æµ
from backend.middleware.rate_limiter import limiter

@router.post("/register", response_model=RegisterResponse)
@limiter.limit("5/minute")  # æ¯IPæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡æ³¨å†Œ
async def register(...):
    ...
```

**å‚è€ƒ**ï¼šç™»å½•APIå·²æœ‰ `5æ¬¡/åˆ†é’Ÿ` çš„é™æµï¼Œæ³¨å†ŒAPIåº”è¯¥åŒæ ·é™åˆ¶

---

#### 2. require_adminæƒé™æ£€æŸ¥ä¸ä¸¥æ ¼ âš ï¸

**é—®é¢˜**ï¼š
- `require_admin()` å‡½æ•°åªæ£€æŸ¥è§’è‰²åï¼Œä¸æ£€æŸ¥ `is_superuser` æ ‡å¿—
- ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µåï¼ˆ`role.name` åº”ä¸º `role.role_name`ï¼‰
- å¦‚æœè§’è‰²ç³»ç»Ÿè¢«ç ´åï¼Œå¯èƒ½ç»•è¿‡æƒé™æ£€æŸ¥

**å½“å‰ä»£ç **ï¼ˆ`backend/routers/users.py:22`ï¼‰ï¼š
```python
if not any(role.name == "admin" for role in current_user.roles):
    raise HTTPException(status_code=403, detail="Insufficient permissions")
```

**é—®é¢˜åˆ†æ**ï¼š
- åº”è¯¥åŒæ—¶æ£€æŸ¥ `is_superuser` æ ‡å¿—
- åº”è¯¥æ£€æŸ¥ `role_code` å’Œ `role_name`ï¼ˆå­—æ®µåé”™è¯¯ï¼‰

**ä¿®å¤å»ºè®®**ï¼š
```python
async def require_admin(current_user: DimUser = Depends(get_current_user)):
    """è¦æ±‚ç®¡ç†å‘˜æƒé™"""
    # ä¼˜å…ˆæ£€æŸ¥ is_superuser æ ‡å¿—
    if current_user.is_superuser:
        return current_user
    
    # æ£€æŸ¥è§’è‰²ï¼ˆä½¿ç”¨ role_code æˆ– role_nameï¼‰
    is_admin = any(
        (hasattr(role, "role_code") and role.role_code == "admin") or
        (hasattr(role, "role_name") and role.role_name == "admin")
        for role in current_user.roles
    )
    
    if not is_admin:
        raise HTTPException(
            status_code=403,
            detail="Insufficient permissions"
        )
    return current_user
```

**æ³¨æ„**ï¼šè¿™ä¸ªä¿®å¤åº”è¯¥ä¸ææ¡ˆå®æ–½åŒæ—¶è¿›è¡Œï¼Œå› ä¸ºè¿™æ˜¯ç°æœ‰ä»£ç çš„é—®é¢˜

---

#### 3. ç”¨æˆ·å/é‚®ç®±æšä¸¾æ”»å‡»é£é™© âš ï¸

**é—®é¢˜**ï¼š
- æ³¨å†Œæ—¶å¦‚æœç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨ï¼Œè¿”å›ä¸åŒçš„é”™è¯¯æ¶ˆæ¯
- æ”»å‡»è€…å¯ä»¥é€šè¿‡é”™è¯¯æ¶ˆæ¯åˆ¤æ–­ç”¨æˆ·å/é‚®ç®±æ˜¯å¦å­˜åœ¨
- å¯èƒ½æ³„éœ²ç³»ç»Ÿä¸­çš„ç”¨æˆ·ä¿¡æ¯

**å½“å‰è®¾è®¡**ï¼š
```python
# è®¾è®¡æ–‡æ¡£ä¸­çš„é”™è¯¯å¤„ç†
if existing_user:
    return error_response(code=REGISTER_USERNAME_EXISTS, ...)
if existing_email:
    return error_response(code=REGISTER_EMAIL_EXISTS, ...)
```

**ä¿®å¤å»ºè®®**ï¼š
- **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šç»Ÿä¸€é”™è¯¯æ¶ˆæ¯
  ```python
  # æ£€æŸ¥ç”¨æˆ·åå’Œé‚®ç®±æ˜¯å¦å­˜åœ¨ï¼ˆåˆå¹¶æ£€æŸ¥ï¼‰
  from sqlalchemy import or_
  
  result = await db.execute(
      select(DimUser).where(
          or_(DimUser.username == username, DimUser.email == email)
      )
  )
  existing = result.scalar_one_or_none()
  
  if existing:
      # ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼Œä¸æ³„éœ²æ˜¯ç”¨æˆ·åè¿˜æ˜¯é‚®ç®±é‡å¤
      return error_response(
          code=ErrorCode.DATA_UNIQUE_CONSTRAINT_VIOLATION,
          message="ç”¨æˆ·åæˆ–é‚®ç®±å·²è¢«ä½¿ç”¨",
          status_code=400
      )
  ```

- **æ–¹æ¡ˆ2**ï¼šå»¶è¿Ÿæ£€æŸ¥ï¼ˆåœ¨åˆ›å»ºç”¨æˆ·æ—¶æ£€æŸ¥ï¼Œä½†é”™è¯¯æ¶ˆæ¯ç»Ÿä¸€ï¼‰

**å‚è€ƒæ ‡å‡†**ï¼šä¸šç•Œæœ€ä½³å®è·µæ˜¯ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼Œé¿å…ä¿¡æ¯æ³„éœ²

---

#### 4. é”™è¯¯ç ç¼–å·å†²çª âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆä¸­çš„é”™è¯¯ç ç¼–å·ä¸ç°æœ‰é”™è¯¯ç å†²çª
- ç°æœ‰é”™è¯¯ç ï¼š`AUTH_REQUIRED = 4001`, `AUTH_TOKEN_INVALID = 4002`, `AUTH_TOKEN_EXPIRED = 4003`, `AUTH_CREDENTIALS_INVALID = 4004`
- ææ¡ˆä¸­çš„é”™è¯¯ç ï¼š`AUTH_ACCOUNT_PENDING = 4001`ï¼ˆå†²çªï¼ï¼‰

**ä¿®å¤å»ºè®®**ï¼š
```python
# ä½¿ç”¨æœªä½¿ç”¨çš„é”™è¯¯ç ç¼–å·ï¼ˆ4005-4008ï¼‰
AUTH_ACCOUNT_PENDING = 4005
AUTH_ACCOUNT_REJECTED = 4006
AUTH_ACCOUNT_SUSPENDED = 4007
AUTH_ACCOUNT_INACTIVE = 4008
# æ³¨æ„ï¼šç”±äºé‡‡ç”¨ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ–¹æ¡ˆï¼Œä¸éœ€è¦å•ç‹¬çš„ç”¨æˆ·å/é‚®ç®±é”™è¯¯ç 
```

**å†³ç­–**ï¼šé‡‡ç”¨ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ–¹æ¡ˆï¼Œåˆ é™¤ 4009/4010 é”™è¯¯ç 

---

#### 5. Open Redirect æ¼æ´ï¼ˆç™»å½•åé‡å®šå‘ï¼‰âš ï¸ ã€æ–°å¢ã€‘

**é—®é¢˜**ï¼š
- ç™»å½•æˆåŠŸåé‡å®šå‘åˆ° `redirect` å‚æ•°æŒ‡å®šçš„è·¯å¾„
- æ²¡æœ‰éªŒè¯ `redirect` å‚æ•°æ˜¯å¦æ˜¯åˆæ³•çš„å†…éƒ¨è·¯å¾„
- æ”»å‡»è€…å¯èƒ½æ„é€ æ¶æ„é“¾æ¥ï¼š`/login?redirect=https://evil.com`

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´é’“é±¼æ”»å‡»
- ç”¨æˆ·ç™»å½•åè¢«é‡å®šå‘åˆ°æ¶æ„ç½‘ç«™

**ä¿®å¤å»ºè®®**ï¼š
```javascript
// âš ï¸ éªŒè¯redirectæ˜¯å¦æ˜¯åˆæ³•çš„å†…éƒ¨è·¯å¾„ï¼ˆé˜²æ­¢Open Redirectæ¼æ´ï¼‰
const isValidRedirect = (url) => {
  if (!url) return false;
  // ç¦æ­¢åè®®ï¼ˆhttp:, https:, javascript:, data: ç­‰ï¼‰
  if (/^[a-z]+:/i.test(url)) return false;
  // ç¦æ­¢åè®®ç›¸å¯¹URLï¼ˆ//evil.comï¼‰
  if (url.startsWith('//')) return false;
  // ç¦æ­¢åæ–œæ ï¼ˆæŸäº›æµè§ˆå™¨ä¼šè½¬æ¢ï¼‰
  if (url.includes('\\')) return false;
  // åªå…è®¸ä»¥ / å¼€å¤´
  if (!url.startsWith('/')) return false;
  // é˜²æ­¢ /\/evil.com è¿™ç§ç»•è¿‡ï¼ˆç¬¬äºŒä¸ªå­—ç¬¦æ˜¯ / æˆ– \ï¼‰
  if (url.length > 1 && (url[1] === '/' || url[1] === '\\')) return false;
  return true;
};

const handleLoginSuccess = () => {
  const redirect = route.query.redirect;
  if (redirect && isValidRedirect(redirect)) {
    router.push(redirect);
  } else {
    router.push('/business-overview');
  }
};
```

---

### P1 ä¸­ä¸¥é‡æ¼æ´ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 6. é»˜è®¤è§’è‰²ä¸å­˜åœ¨æ—¶å®¡æ‰¹å¤±è´¥ âš ï¸

**é—®é¢˜**ï¼š
- å®¡æ‰¹æ—¶å¦‚æœæœªæŒ‡å®š `role_ids`ï¼Œç³»ç»Ÿä¼šåˆ†é…é»˜è®¤ `operator` è§’è‰²
- ä½†å¦‚æœ `operator` è§’è‰²ä¸å­˜åœ¨ï¼Œå®¡æ‰¹ä¼šå¤±è´¥
- æ²¡æœ‰é™çº§å¤„ç†æœºåˆ¶

**ä¿®å¤å»ºè®®**ï¼š
```python
# æ–¹æ¡ˆ1ï¼šç¡®ä¿operatorè§’è‰²å­˜åœ¨ï¼ˆæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼‰
# æ–¹æ¡ˆ2ï¼šå®¡æ‰¹æ—¶å¿…é¡»æŒ‡å®šè§’è‰²ï¼ˆä¸å…è®¸é»˜è®¤ï¼‰
# æ–¹æ¡ˆ3ï¼ˆæ¨èï¼‰ï¼šé™çº§å¤„ç†
if not role_ids:
    result = await db.execute(
        select(DimRole).where(DimRole.role_code == "operator")
    )
    default_role = result.scalar_one_or_none()
    if not default_role:
        raise HTTPException(
            status_code=500,
            detail="é»˜è®¤è§’è‰²(operator)ä¸å­˜åœ¨ï¼Œè¯·æŒ‡å®šè§’è‰²æˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜"
        )
    user.roles = [default_role]
```

---

#### 7. çŠ¶æ€åŒæ­¥æœºåˆ¶ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- `status` å’Œ `is_active` å­—æ®µéœ€è¦æ‰‹åŠ¨åŒæ­¥
- æ²¡æœ‰æ•°æ®åº“çº¦æŸæˆ–è§¦å‘å™¨ç¡®ä¿ä¸€è‡´æ€§
- å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´ï¼ˆå¦‚ `status="active"` ä½† `is_active=False`ï¼‰

**ä¿®å¤å»ºè®®**ï¼š
- **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨
  ```sql
  CREATE OR REPLACE FUNCTION sync_user_status()
  RETURNS TRIGGER AS $$
  BEGIN
      IF NEW.status = 'active' THEN
          NEW.is_active = true;
      ELSE
          NEW.is_active = false;
      END IF;
      RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;

  CREATE TRIGGER trigger_sync_user_status
  BEFORE INSERT OR UPDATE ON dim_users
  FOR EACH ROW
  EXECUTE FUNCTION sync_user_status();
  ```

- **æ–¹æ¡ˆ2**ï¼šåœ¨ä»£ç ä¸­æ‰€æœ‰æ›´æ–°statusçš„åœ°æ–¹éƒ½åŒæ­¥æ›´æ–°is_active
- **æ–¹æ¡ˆ3**ï¼šä½¿ç”¨SQLAlchemyçš„ `@validates` è£…é¥°å™¨è‡ªåŠ¨åŒæ­¥

---

#### 8. rejectedçŠ¶æ€ç”¨æˆ·é‡æ–°æ³¨å†Œé—®é¢˜ âš ï¸

**é—®é¢˜**ï¼š
- è¢«æ‹’ç»çš„ç”¨æˆ·ï¼ˆ`status="rejected"`ï¼‰æ˜¯å¦å¯ä»¥é‡æ–°æ³¨å†Œï¼Ÿ
- å¦‚æœé‚®ç®±å·²è¢«æ‹’ç»ï¼Œå†æ¬¡æ³¨å†Œæ—¶ä¼šè¢«é˜»æ­¢ï¼ˆé‚®ç®±å·²å­˜åœ¨ï¼‰
- ç”¨æˆ·æ— æ³•é‡æ–°æäº¤æ³¨å†Œ

**åœºæ™¯**ï¼š
1. ç”¨æˆ·æ³¨å†Œ â†’ `status="pending"`
2. ç®¡ç†å‘˜æ‹’ç» â†’ `status="rejected"`
3. ç”¨æˆ·ä¿®æ­£ä¿¡æ¯åæƒ³é‡æ–°æ³¨å†Œ â†’ é‚®ç®±å·²å­˜åœ¨ï¼Œæ³¨å†Œå¤±è´¥

**ä¿®å¤å»ºè®®**ï¼š
- **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šå…è®¸ rejected ç”¨æˆ·é‡æ–°æ³¨å†Œï¼ˆåˆ é™¤æˆ–æ ‡è®°æ—§è®°å½•ï¼‰
  ```python
  # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
  result = await db.execute(
      select(DimUser).where(DimUser.email == email)
  )
  existing = result.scalar_one_or_none()
  
  if existing:
      # å¦‚æœæ˜¯rejectedçŠ¶æ€ï¼Œå…è®¸é‡æ–°æ³¨å†Œï¼ˆåˆ é™¤æ—§è®°å½•æˆ–æ›´æ–°ï¼‰
      if existing.status == "rejected":
          await db.delete(existing)
          await db.flush()  # ç»§ç»­æ³¨å†Œæµç¨‹
      else:
          return error_response(...)  # å…¶ä»–çŠ¶æ€ä¸å…è®¸
  ```

- **æ–¹æ¡ˆ2**ï¼šç®¡ç†å‘˜å¯ä»¥é‡æ–°æ¿€æ´» rejected ç”¨æˆ·ï¼ˆæ·»åŠ é‡æ–°æ¿€æ´»APIï¼‰
- **æ–¹æ¡ˆ3**ï¼šrejected ç”¨æˆ·çš„é‚®ç®±å¯ä»¥é‡æ–°ä½¿ç”¨ï¼ˆåˆ é™¤æ—§è®°å½•ï¼‰

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆ1 + æ–¹æ¡ˆ2ï¼ˆå…è®¸é‡æ–°æ³¨å†Œ + ç®¡ç†å‘˜å¯é‡æ–°æ¿€æ´»ï¼‰

---

#### 9. å®¡æ‰¹APIçŠ¶æ€æ£€æŸ¥ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- å®¡æ‰¹APIåº”è¯¥åªå…è®¸ `pending` çŠ¶æ€çš„ç”¨æˆ·è¢«å®¡æ‰¹
- ä½†è®¾è®¡ä¸­æ²¡æœ‰æ˜ç¡®è¯´æ˜æ˜¯å¦å…è®¸ `rejected` ç”¨æˆ·è¢«é‡æ–°å®¡æ‰¹

**ä¿®å¤å»ºè®®**ï¼š
```python
# å®¡æ‰¹APIï¼šåªå…è®¸pendingçŠ¶æ€
if user.status != "pending":
    raise HTTPException(
        400, 
        f"ç”¨æˆ·çŠ¶æ€ä¸º {user.status}ï¼Œåªèƒ½å®¡æ‰¹å¾…å®¡æ‰¹(pending)çŠ¶æ€çš„ç”¨æˆ·"
    )

# å¯é€‰ï¼šæ·»åŠ é‡æ–°æ¿€æ´»rejectedç”¨æˆ·çš„API
@router.post("/users/{user_id}/reactivate")
async def reactivate_rejected_user(...):
    """é‡æ–°æ¿€æ´»è¢«æ‹’ç»çš„ç”¨æˆ·"""
    if user.status != "rejected":
        raise HTTPException(400, "åªèƒ½é‡æ–°æ¿€æ´»è¢«æ‹’ç»(rejected)çŠ¶æ€çš„ç”¨æˆ·")
    user.status = "pending"  # é‡æ–°å˜ä¸ºå¾…å®¡æ‰¹
    ...
```

---

### P2 ä½ä¸¥é‡æ€§é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

#### 10. å¯†ç å¼ºåº¦è¦æ±‚å¯èƒ½ä¸å¤Ÿä¸¥æ ¼ âš ï¸

**é—®é¢˜**ï¼š
- å½“å‰è®¾è®¡ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—
- æ²¡æœ‰è¦æ±‚å¤§å†™å­—æ¯æˆ–ç‰¹æ®Šå­—ç¬¦
- å¼±å¯†ç å¯èƒ½è¢«æš´åŠ›ç ´è§£

**å»ºè®®**ï¼š
- å½“å‰å¼ºåº¦å¯¹äºå†…éƒ¨ç³»ç»Ÿå¯æ¥å—
- æœªæ¥å¯å¢å¼ºä¸ºï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
- æˆ–ä½¿ç”¨å¯†ç å¼ºåº¦è¯„åˆ†ï¼ˆå¼±/ä¸­/å¼ºï¼‰

---

#### 11. å®¡æ‰¹æ—¥å¿—è¡¨è®¾è®¡ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- `UserApprovalLog` è¡¨è®¾è®¡ä¸ºå¯é€‰
- å¦‚æœæœªå®ç°ï¼Œå®¡è®¡è¿½è¸ªä¸å®Œæ•´
- æ— æ³•æŸ¥è¯¢å®¡æ‰¹å†å²

**å»ºè®®**ï¼š
- å»ºè®®å°† `UserApprovalLog` è¡¨è®¾ä¸ºå¿…éœ€ï¼ˆéå¯é€‰ï¼‰
- ç¡®ä¿å®¡æ‰¹æ“ä½œå¯è¿½æº¯

---

#### 12. é”™è¯¯ç ä½¿ç”¨ä¸ä¸€è‡´ âš ï¸

**é—®é¢˜**ï¼š
- å¦‚æœä½¿ç”¨ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼ˆä¿®å¤æ¼æ´3ï¼‰ï¼Œåˆ™ `REGISTER_USERNAME_EXISTS` å’Œ `REGISTER_EMAIL_EXISTS` é”™è¯¯ç å¯èƒ½ä¸éœ€è¦

**å»ºè®®**ï¼š
- å¦‚æœé‡‡ç”¨ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ–¹æ¡ˆï¼Œåªä¿ç•™ `DATA_UNIQUE_CONSTRAINT_VIOLATION` é”™è¯¯ç 
- ç®€åŒ–é”™è¯¯ç è®¾è®¡

---

## ä¿®å¤å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆP0ï¼‰

1. **æ·»åŠ æ³¨å†ŒAPIé™æµ**
   - åœ¨ `POST /api/auth/register` æ·»åŠ  `@limiter.limit("5/minute")`
   - ä½¿ç”¨IPé™æµï¼ˆæœªè®¤è¯ç”¨æˆ·ï¼‰

2. **ä¿®å¤require_adminå‡½æ•°**
   - æ£€æŸ¥ `is_superuser` æ ‡å¿—
   - ä¿®å¤å­—æ®µåï¼ˆ`role.name` â†’ `role.role_name`ï¼‰

3. **ç»Ÿä¸€æ³¨å†Œé”™è¯¯æ¶ˆæ¯**
   - åˆå¹¶ç”¨æˆ·åå’Œé‚®ç®±æ£€æŸ¥
   - ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼Œé¿å…ä¿¡æ¯æ³„éœ²

4. **ä¿®å¤é”™è¯¯ç ç¼–å·å†²çª**
   - ä½¿ç”¨æœªä½¿ç”¨çš„é”™è¯¯ç ç¼–å·ï¼ˆ4005-4008ï¼‰

### å»ºè®®ä¿®å¤ï¼ˆP1ï¼‰

5. **é»˜è®¤è§’è‰²å¤„ç†**
   - ç¡®ä¿operatorè§’è‰²å­˜åœ¨ï¼ˆæ•°æ®åº“åˆå§‹åŒ–ï¼‰
   - æˆ–è¦æ±‚å®¡æ‰¹æ—¶å¿…é¡»æŒ‡å®šè§’è‰²

6. **çŠ¶æ€åŒæ­¥æœºåˆ¶**
   - ä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨æˆ–ä»£ç å±‚é¢å¼ºåˆ¶åŒæ­¥

7. **rejectedç”¨æˆ·é‡æ–°æ³¨å†Œ**
   - å…è®¸rejectedç”¨æˆ·é‡æ–°æ³¨å†Œï¼ˆåˆ é™¤æ—§è®°å½•ï¼‰
   - æˆ–æ·»åŠ é‡æ–°æ¿€æ´»API

8. **å®¡æ‰¹çŠ¶æ€æ£€æŸ¥å®Œå–„**
   - æ˜ç¡®åªå…è®¸pendingçŠ¶æ€
   - å¯é€‰ï¼šæ·»åŠ é‡æ–°æ¿€æ´»API

### å¯é€‰ä¼˜åŒ–ï¼ˆP2ï¼‰

9. **å¯†ç å¼ºåº¦å¢å¼º**ï¼ˆæœªæ¥ï¼‰
10. **å®¡æ‰¹æ—¥å¿—è¡¨è®¾ä¸ºå¿…éœ€**
11. **é”™è¯¯ç ç®€åŒ–**ï¼ˆå¦‚æœä½¿ç”¨ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯ï¼‰

## æµ‹è¯•å»ºè®®

### å®‰å…¨æµ‹è¯•

- [ ] æ³¨å†ŒAPIé™æµæµ‹è¯•ï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰
- [ ] ç”¨æˆ·åæšä¸¾æ”»å‡»æµ‹è¯•
- [ ] é‚®ç®±æšä¸¾æ”»å‡»æµ‹è¯•
- [ ] æƒé™ç»•è¿‡æµ‹è¯•ï¼ˆrequire_adminï¼‰
- [ ] çŠ¶æ€ä¸ä¸€è‡´æµ‹è¯•ï¼ˆstatus vs is_activeï¼‰

### åŠŸèƒ½æµ‹è¯•

- [ ] é»˜è®¤è§’è‰²ä¸å­˜åœ¨åœºæ™¯æµ‹è¯•
- [ ] rejectedç”¨æˆ·é‡æ–°æ³¨å†Œæµ‹è¯•
- [ ] å®¡æ‰¹çŠ¶æ€æ£€æŸ¥æµ‹è¯•
- [ ] çŠ¶æ€åŒæ­¥æµ‹è¯•

## æ–°å¢æ¨¡å—çš„å®‰å…¨è€ƒè™‘

### å‰ç«¯è·¯ç”±å®ˆå«å®‰å…¨

**æ½œåœ¨é—®é¢˜**ï¼š
- è·¯ç”±å®ˆå«éœ€è¦æ­£ç¡®æ£€æŸ¥ç™»å½•çŠ¶æ€
- å…¬å¼€è·¯ç”±é…ç½®éœ€è¦æ­£ç¡®ç»´æŠ¤

**å»ºè®®**ï¼š
- ä½¿ç”¨é›†ä¸­é…ç½®çš„å…¬å¼€è·¯ç”±åˆ—è¡¨
- ç¡®ä¿æ‰€æœ‰éœ€è¦è®¤è¯çš„è·¯ç”±éƒ½å—åˆ°ä¿æŠ¤
- æµ‹è¯•æœªç™»å½•ç”¨æˆ·è®¿é—®å—ä¿æŠ¤è·¯ç”±çš„åœºæ™¯

### ç™»å½•é¡µé¢å®‰å…¨

**æ½œåœ¨é—®é¢˜**ï¼š
- ç™»å½•è¡¨å•éœ€è¦é˜²æ­¢CSRFæ”»å‡»
- ç™»å½•å¤±è´¥æ¬¡æ•°éœ€è¦é™åˆ¶ï¼ˆä¸è´¦æˆ·é”å®šæœºåˆ¶é…åˆï¼‰

**å»ºè®®**ï¼š
- ä½¿ç”¨CSRF Tokenï¼ˆå¦‚æœå¯ç”¨äº†CSRFä¿æŠ¤ï¼‰
- å®æ–½ç™»å½•é™æµï¼ˆå·²å®ç°ï¼š5æ¬¡/åˆ†é’Ÿï¼‰
- ä¸è´¦æˆ·é”å®šæœºåˆ¶é…åˆä½¿ç”¨

## æ€»ç»“

å‘ç°äº† **5ä¸ªP0ä¸¥é‡æ¼æ´**ã€**6ä¸ªP1ä¸­ä¸¥é‡æ¼æ´** å’Œ **6ä¸ªP2ä½ä¸¥é‡æ€§é—®é¢˜**ã€‚

**å¿…é¡»ç«‹å³ä¿®å¤çš„æ¼æ´**ï¼š
1. æ³¨å†ŒAPIé™æµï¼ˆå®‰å…¨å…³é”®ï¼‰
2. require_adminæƒé™æ£€æŸ¥ï¼ˆå®‰å…¨å…³é”®ï¼‰
3. ç”¨æˆ·å/é‚®ç®±æšä¸¾æ”»å‡»ï¼ˆä¿¡æ¯æ³„éœ²ï¼‰
4. é”™è¯¯ç ç¼–å·å†²çªï¼ˆä»£ç é”™è¯¯ï¼‰
5. Open Redirectæ¼æ´ï¼ˆé’“é±¼æ”»å‡»é£é™©ï¼‰ã€æ–°å¢ã€‘

**å»ºè®®ä¿®å¤çš„é—®é¢˜**ï¼š
- é»˜è®¤è§’è‰²å¤„ç†
- çŠ¶æ€åŒæ­¥æœºåˆ¶
- rejectedç”¨æˆ·é‡æ–°æ³¨å†Œ
- å®¡æ‰¹çŠ¶æ€æ£€æŸ¥å®Œå–„

**æ–°å¢æ¨¡å—çš„å®‰å…¨è€ƒè™‘**ï¼š
- å‰ç«¯è·¯ç”±å®ˆå«éœ€è¦æ­£ç¡®å®æ–½ç™»å½•æ£€æŸ¥
- ç™»å½•é¡µé¢éœ€è¦é…åˆCSRFä¿æŠ¤å’Œé™æµæœºåˆ¶
- å¯†ç é‡ç½®åŠŸèƒ½ï¼ˆå¦‚æœå®ç°ï¼‰éœ€è¦è€ƒè™‘å®‰å…¨è®¾è®¡

---

### P1 ä¸­ä¸¥é‡é—®é¢˜ï¼ˆæ–°å¢æ¨¡å—ï¼‰

#### 13. Storeä½¿ç”¨ä¸ä¸€è‡´é—®é¢˜ âš ï¸

**é—®é¢˜**ï¼š
- ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªStoreï¼š`useUserStore` å’Œ `useAuthStore`
- å½“å‰è·¯ç”±å®ˆå«ä½¿ç”¨ `useUserStore()`
- ä½† `useAuthStore` æ›´å®Œæ•´ï¼ˆæœ‰ç™»å½•ã€ç™»å‡ºã€åˆ·æ–°tokenç­‰åŠŸèƒ½ï¼‰
- ä¸¤ä¸ªStoreçš„tokenå­—æ®µåä¸ä¸€è‡´ï¼š
  - `useUserStore`: `token` (localStorage.getItem('token'))
  - `useAuthStore`: `access_token` (localStorage.getItem('access_token'))

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´è·¯ç”±å®ˆå«åˆ¤æ–­é”™è¯¯
- ä»£ç æ··ä¹±ï¼Œç»´æŠ¤å›°éš¾
- å¦‚æœä½¿ç”¨ä¸åŒçš„Storeï¼Œç™»å½•çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´

**ä¿®å¤å»ºè®®**ï¼š
- **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šç»Ÿä¸€ä½¿ç”¨ `useAuthStore`
  - åŠŸèƒ½æ›´å®Œæ•´ï¼ˆç™»å½•ã€ç™»å‡ºã€åˆ·æ–°tokenï¼‰
  - æ›´æ–°è·¯ç”±å®ˆå«ä½¿ç”¨ `useAuthStore`
  - æ›´æ–°ç›¸å…³ç»„ä»¶ä½¿ç”¨ `useAuthStore`
  - å¦‚æœ `useUserStore` ä»åœ¨ä½¿ç”¨ï¼Œæ˜ç¡®èŒè´£åˆ†å·¥

- **æ–¹æ¡ˆ2**ï¼šç»§ç»­ä½¿ç”¨ `useUserStore`
  - éœ€è¦åœ¨ `useUserStore` ä¸­è¡¥å……ç™»å½•ã€ç™»å‡ºåŠŸèƒ½
  - éœ€è¦åŒæ­¥tokenå­˜å‚¨æœºåˆ¶
  - éœ€è¦ç¡®ä¿ä¸åç«¯Cookieå­˜å‚¨æœºåˆ¶å…¼å®¹

**å»ºè®®**ï¼šåœ¨å®æ–½Phase 4ä¹‹å‰ï¼Œå…ˆç¡®å®šStoreä½¿ç”¨ç­–ç•¥ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªStore

---

#### 14. isLoggedInåˆ¤æ–­é€»è¾‘é—®é¢˜ âš ï¸

**é—®é¢˜**ï¼š
- `useUserStore.isLoggedIn` åªæ£€æŸ¥ `token.value`
- åç«¯ä½¿ç”¨ httpOnly Cookie å­˜å‚¨tokenï¼ˆæ›´å®‰å…¨ï¼‰
- å¦‚æœåªä½¿ç”¨Cookieï¼ŒlocalStorageå¯èƒ½ä¸ºç©ºï¼Œå¯¼è‡´åˆ¤æ–­é”™è¯¯

**å½“å‰ä»£ç **ï¼š
```javascript
// useUserStore
const token = ref(localStorage.getItem('token') || '')
const isLoggedIn = computed(() => !!token.value)

// useAuthStore
const token = ref(localStorage.getItem('access_token') || '')
const user = ref(null)
const isLoggedIn = computed(() => !!token.value && !!user.value)
```

**ä¿®å¤å»ºè®®**ï¼š
- **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šä½¿ç”¨ `useAuthStore` çš„é€»è¾‘ï¼ˆåŒæ—¶æ£€æŸ¥tokenå’Œuserï¼‰
  - `isLoggedIn = computed(() => !!token.value && !!user.value)`
  - æ›´å¯é ï¼Œç¡®ä¿ç”¨æˆ·ä¿¡æ¯å·²åŠ è½½

- **æ–¹æ¡ˆ2**ï¼šå¦‚æœä½¿ç”¨Cookieå­˜å‚¨ï¼Œåˆå§‹åŒ–æ—¶ä»åç«¯éªŒè¯token
  - åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ `/auth/me` éªŒè¯token
  - å¦‚æœæœ‰æ•ˆï¼ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯å¹¶è®¾ç½®ç™»å½•çŠ¶æ€
  - å¦‚æœæ— æ•ˆï¼Œæ¸…é™¤çŠ¶æ€

**å»ºè®®**ï¼šç»Ÿä¸€ä½¿ç”¨ `useAuthStore`ï¼Œå…¶é€»è¾‘æ›´å®Œå–„

---

### P2 ä½ä¸¥é‡æ€§é—®é¢˜ï¼ˆæ–°å¢æ¨¡å—ï¼‰

#### 15. å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢çš„å¤„ç† âš ï¸

**é—®é¢˜**ï¼š
- å½“å‰è·¯ç”±å®ˆå«ä»£ç ä¸­ï¼Œå·²ç™»å½•ç”¨æˆ·è®¿é—® `/login` ä¼šç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥ç™»å½•é¡µé¢
- åº”è¯¥é‡å®šå‘åˆ°é»˜è®¤é¡µé¢

**ä¿®å¤å»ºè®®**ï¼š
```javascript
// å¦‚æœå·²ç™»å½•ï¼Œè®¿é—®ç™»å½•/æ³¨å†Œé¡µé¢åº”è¯¥é‡å®šå‘
if (authStore.isLoggedIn && publicRoutes.includes(to.path)) {
  next('/business-overview') // æˆ–ä½¿ç”¨é»˜è®¤é¡µé¢
  return
}
```

---

#### 16. ç™»å½•æˆåŠŸåçš„é‡å®šå‘å¤„ç† âš ï¸

**é—®é¢˜**ï¼š
- è·¯ç”±å®ˆå«ä¿å­˜äº† `redirect` å‚æ•°
- ä½†ç™»å½•é¡µé¢éœ€è¦å¤„ç†è¿™ä¸ªå‚æ•°å¹¶é‡å®šå‘

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ç™»å½•é¡µé¢ç»„ä»¶ä¸­è¯»å– `$route.query.redirect`
- ç™»å½•æˆåŠŸåé‡å®šå‘åˆ°è¯¥è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤é¡µé¢
- ä»£ç ç¤ºä¾‹ï¼š
  ```javascript
  // ç™»å½•æˆåŠŸå
  const redirect = route.query.redirect || '/business-overview'
  router.push(redirect)
  ```

---

#### 17. å…¬å¼€è·¯ç”±é…ç½®ç»´æŠ¤ âš ï¸

**é—®é¢˜**ï¼š
- å…¬å¼€è·¯ç”±åˆ—è¡¨åœ¨è·¯ç”±å®ˆå«ä¸­ç¡¬ç¼–ç 
- å¦‚æœè·¯ç”±è·¯å¾„å˜åŒ–ï¼Œéœ€è¦ä¿®æ”¹å¤šä¸ªåœ°æ–¹

**ä¿®å¤å»ºè®®**ï¼š
- **æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰**ï¼šåœ¨è·¯ç”±metaä¸­æ ‡è®° `public: true`
  ```javascript
  {
    path: '/login',
    meta: { public: true }
  }
  
  // è·¯ç”±å®ˆå«ä¸­
  if (to.meta.public || publicRoutes.includes(to.path)) {
    next()
    return
  }
  ```

- **æ–¹æ¡ˆ2**ï¼šä½¿ç”¨é›†ä¸­é…ç½®æ–‡ä»¶
  ```javascript
  // config/publicRoutes.js
  export const PUBLIC_ROUTES = ['/login', '/register', ...]
  ```

---

## ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“ï¼ˆæ›´æ–°ï¼‰

| æ¼æ´ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| æ³¨å†ŒAPIé™æµç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| require_adminæ£€æŸ¥ä¸ä¸¥æ ¼ | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ï¼ˆç°æœ‰ä»£ç é—®é¢˜ï¼‰ |
| ç”¨æˆ·å/é‚®ç®±æšä¸¾æ”»å‡» | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é”™è¯¯ç ç¼–å·å†²çª | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| **Open Redirectæ¼æ´** | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| Storeä½¿ç”¨ä¸ä¸€è‡´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| isLoggedInåˆ¤æ–­é€»è¾‘ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é»˜è®¤è§’è‰²ä¸å­˜åœ¨å¤„ç† | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| çŠ¶æ€åŒæ­¥æœºåˆ¶ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| rejectedç”¨æˆ·é‡æ–°æ³¨å†Œ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹APIçŠ¶æ€æ£€æŸ¥ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å·²ç™»å½•ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| ç™»å½•åé‡å®šå‘ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| å…¬å¼€è·¯ç”±é…ç½® | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| å¯†ç å¼ºåº¦è¦æ±‚ | P2 | å¯é€‰ä¿®å¤ | âœ… å½“å‰è®¾è®¡å¯æ¥å— |
| å®¡æ‰¹æ—¥å¿—è¡¨ | P2 | å¯é€‰ä¿®å¤ | âš ï¸ å»ºè®®è®¾ä¸ºå¿…éœ€ |
| é”™è¯¯ç ä½¿ç”¨ä¸ä¸€è‡´ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**æ–°å¢æ¨¡å—çš„å®‰å…¨è€ƒè™‘**ï¼š
- å‰ç«¯è·¯ç”±å®ˆå«éœ€è¦æ­£ç¡®å®æ–½ç™»å½•æ£€æŸ¥
- Storeéœ€è¦ç»Ÿä¸€ä½¿ç”¨ï¼Œé¿å…çŠ¶æ€ä¸ä¸€è‡´
- isLoggedInåˆ¤æ–­éœ€è¦è€ƒè™‘Cookieå­˜å‚¨æœºåˆ¶
- ç™»å½•é¡µé¢éœ€è¦é…åˆCSRFä¿æŠ¤å’Œé™æµæœºåˆ¶
- å¯†ç é‡ç½®åŠŸèƒ½ï¼ˆå¦‚æœå®ç°ï¼‰éœ€è¦è€ƒè™‘å®‰å…¨è®¾è®¡

---

## Phase 8: é€šçŸ¥ç³»ç»Ÿç°ä»£åŒ–æ”¹è¿›æ¼æ´

### P0 ä¸¥é‡æ¼æ´ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

#### 11. WebSocket é”™è¯¯ç å†²çª âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ° Token è¿‡æœŸå¤„ç†è¿”å› 4002 é”™è¯¯ç 
- ä½† `backend/utils/error_codes.py` ä¸­ `AUTH_TOKEN_INVALID = 4002` å·²å­˜åœ¨
- é”™è¯¯ç å†²çªå¯èƒ½å¯¼è‡´å‰ç«¯æ— æ³•æ­£ç¡®è¯†åˆ«é”™è¯¯ç±»å‹
- WebSocket close code ä¸ HTTP é”™è¯¯ç æ··ç”¨

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šé”™è¯¯å¤„ç†é€»è¾‘æ··ä¹±
- å‰ç«¯å¯èƒ½æ— æ³•æ­£ç¡®è¯†åˆ« WebSocket è¿æ¥å¤±è´¥åŸå› 

**ä¿®å¤å»ºè®®**ï¼š
- ä½¿ç”¨ WebSocket close code 4005 è¡¨ç¤º Token è¿‡æœŸï¼ˆé¿å…ä¸ç°æœ‰é”™è¯¯ç å†²çªï¼‰
- ä½¿ç”¨ WebSocket close code 4006 è¡¨ç¤ºè¿æ¥æ•°é™åˆ¶ï¼ˆé¿å…ä¸ç°æœ‰é”™è¯¯ç å†²çªï¼‰
- æ˜ç¡®åŒºåˆ† HTTP é”™è¯¯ç å’Œ WebSocket close code

---

#### 12. WebSocket Origin éªŒè¯ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠ Origin éªŒè¯
- æ”»å‡»è€…å¯èƒ½é€šè¿‡è·¨ç«™ WebSocket åŠ«æŒï¼ˆCSWSHï¼‰æ”»å‡»
- æ¶æ„ç½‘ç«™å¯èƒ½å»ºç«‹ WebSocket è¿æ¥å¹¶æ¥æ”¶ç”¨æˆ·é€šçŸ¥

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šæ•°æ®æ³„éœ²é£é™©
- è·¨ç«™æ”»å‡»é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- éªŒè¯ WebSocket è¿æ¥çš„ Origin å¤´
- ä»…å…è®¸æ¥è‡ªå—ä¿¡ä»»åŸŸåçš„è¿æ¥
- é˜²æ­¢è·¨ç«™ WebSocket åŠ«æŒï¼ˆCSWSHï¼‰æ”»å‡»

---

#### 13. WebSocket WSS å¼ºåˆ¶è¦æ±‚ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ WSS
- éåŠ å¯† WebSocket è¿æ¥å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²
- ä¸­é—´äººæ”»å‡»é£é™©

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šæ•°æ®ä¼ è¾“æœªåŠ å¯†
- ä¸­é—´äººæ”»å‡»é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨ WSSï¼ˆWebSocket Secureï¼‰
- æ‹’ç»é WSS è¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- ç¡®ä¿æ•°æ®ä¼ è¾“åŠ å¯†

---

#### 14. WebSocket è¿æ¥é€Ÿç‡é™åˆ¶ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠè¿æ¥é€Ÿç‡é™åˆ¶
- æ”»å‡»è€…å¯èƒ½å¿«é€Ÿå»ºç«‹/æ–­å¼€è¿æ¥å¯¼è‡´èµ„æºè€—å°½
- å¯èƒ½å¯¼è‡´ DoS æ”»å‡»

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šèµ„æºè€—å°½é£é™©
- DoS æ”»å‡»é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- æ¯ä¸ª IP æ¯åˆ†é’Ÿæœ€å¤šå»ºç«‹ 10 ä¸ª WebSocket è¿æ¥
- ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜è®°å½•è¿æ¥é¢‘ç‡
- é˜²æ­¢å¿«é€Ÿå»ºç«‹/æ–­å¼€è¿æ¥å¯¼è‡´èµ„æºè€—å°½

---

#### 15. WebSocket è¿æ¥æ•°é™åˆ¶ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠ WebSocket è¿æ¥æ•°é™åˆ¶
- æ”»å‡»è€…å¯èƒ½åˆ›å»ºå¤§é‡è¿æ¥å¯¼è‡´ DoS æ”»å‡»
- å•ä¸ªç”¨æˆ·å¯èƒ½åˆ›å»ºå¤šä¸ªè¿æ¥å ç”¨èµ„æº

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½
- å†…å­˜å ç”¨è¿‡é«˜

**ä¿®å¤å»ºè®®**ï¼š
- æ¯ä¸ªç”¨æˆ·æœ€å¤š 3 ä¸ªè¿æ¥
- ç³»ç»Ÿæœ€å¤š 1000 ä¸ªæ€»è¿æ¥
- è¶…å‡ºé™åˆ¶æ—¶è¿”å› WebSocket close code 4006ï¼ˆé¿å…ä¸ç°æœ‰é”™è¯¯ç å†²çªï¼‰

---

#### 16. WebSocket ç”¨æˆ·æƒé™éªŒè¯ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ°"JWT è®¤è¯æ”¯æŒ"ï¼Œä½†æœªè¯´æ˜å¦‚ä½•éªŒè¯ç”¨æˆ·åªèƒ½æ¥æ”¶è‡ªå·±çš„é€šçŸ¥
- æ”»å‡»è€…å¯èƒ½é€šè¿‡ä¼ªé€  Token æ¥æ”¶å…¶ä»–ç”¨æˆ·çš„é€šçŸ¥

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šæ•°æ®æ³„éœ²é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ WebSocket è¿æ¥æ—¶éªŒè¯ Token ä¸­çš„ user_id
- æ¨é€é€šçŸ¥æ—¶éªŒè¯ recipient_id ä¸è¿æ¥ç”¨æˆ· ID åŒ¹é…
- é˜²æ­¢è·¨ç”¨æˆ·é€šçŸ¥æ³„éœ²

---

#### 17. WebSocket æ¶ˆæ¯æ ¼å¼éªŒè¯ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠæ¶ˆæ¯æ ¼å¼éªŒè¯
- å¯èƒ½å—åˆ°æ¶ˆæ¯æ³¨å…¥æ”»å‡»
- æ¶æ„æ¶ˆæ¯å¯èƒ½å¯¼è‡´å‰ç«¯é”™è¯¯
- æœªé™åˆ¶é€šçŸ¥å†…å®¹é•¿åº¦

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´ XSS æˆ–å‰ç«¯é”™è¯¯
- å†…å­˜å ç”¨é£é™©ï¼ˆè¿‡é•¿é€šçŸ¥ï¼‰

**ä¿®å¤å»ºè®®**ï¼š
- ä½¿ç”¨ Pydantic éªŒè¯æ¶ˆæ¯æ ¼å¼
- éªŒè¯é€šçŸ¥å†…å®¹ï¼ˆrecipient_id åŒ¹é…ï¼‰
- é˜²æ­¢æ¶ˆæ¯æ³¨å…¥æ”»å‡»
- é€šçŸ¥å†…å®¹é•¿åº¦é™åˆ¶ï¼ˆæ ‡é¢˜æœ€å¤š 200 å­—ç¬¦ï¼Œå†…å®¹æœ€å¤š 1000 å­—ç¬¦ï¼‰

---

#### 18. WebSocket å¿ƒè·³æœºåˆ¶ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠå¿ƒè·³æœºåˆ¶
- æ— æ³•æ£€æµ‹æ­»è¿æ¥
- æ­»è¿æ¥å ç”¨èµ„æº

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šèµ„æºæµªè´¹

**ä¿®å¤å»ºè®®**ï¼š
- 30 ç§’å¿ƒè·³é—´éš”
- 120 ç§’æ— å“åº”åˆ™æ–­å¼€è¿æ¥
- è‡ªåŠ¨æ¸…ç†æ­»è¿æ¥

---

#### 19. å¿«é€Ÿæ“ä½œ CSRF é˜²æŠ¤ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.3 å¿«é€Ÿæ“ä½œæœªæåŠ CSRF é˜²æŠ¤
- æ”»å‡»è€…å¯èƒ½è¯±å¯¼ç”¨æˆ·æ‰§è¡Œæœªæˆæƒæ“ä½œ

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´æœªæˆæƒæ“ä½œ

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨å¿«é€Ÿæ“ä½œ API ä¸­æ·»åŠ  CSRF Token éªŒè¯
- æˆ–ä½¿ç”¨ SameSite Cookieï¼ˆå¦‚æœä½¿ç”¨ Cookie è®¤è¯ï¼‰
- æˆ–éªŒè¯ Origin/Referer å¤´

---

#### 20. å¿«é€Ÿæ“ä½œæƒé™éªŒè¯ä¸æ˜ç¡® âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.3 ææ¡ˆæåˆ°"æ“ä½œæƒé™éªŒè¯"ï¼Œä½†æœªè¯´æ˜å…·ä½“éªŒè¯é€»è¾‘
- æœªè¯´æ˜å¦‚ä½•ä»é€šçŸ¥çš„ `actions` å­—æ®µè§£ææ“ä½œç±»å‹
- æœªè¯´æ˜å¦‚ä½•éªŒè¯æ“ä½œç›®æ ‡èµ„æºçŠ¶æ€

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šæƒé™ç»•è¿‡é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- ä»é€šçŸ¥çš„ `actions` å­—æ®µè§£ææ“ä½œç±»å‹ï¼ˆå¦‚ `approve_user`ã€`reject_user`ï¼‰
- éªŒè¯ç”¨æˆ·æƒé™ï¼ˆä½¿ç”¨ `require_admin` æˆ–è‡ªå®šä¹‰æƒé™æ£€æŸ¥ï¼‰
- éªŒè¯æ“ä½œç›®æ ‡èµ„æºå­˜åœ¨ä¸”çŠ¶æ€æ­£ç¡®ï¼ˆå¦‚åªèƒ½æ‰¹å‡† `pending` çŠ¶æ€çš„ç”¨æˆ·ï¼‰

---

### P1 é‡è¦é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 21. WebSocket é™çº§æ–¹æ¡ˆç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠ WebSocket å¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆ
- å¦‚æœ WebSocket ä¸å¯ç”¨ï¼Œç”¨æˆ·å°†æ— æ³•æ¥æ”¶é€šçŸ¥

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯ç”¨æ€§é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- WebSocket å¤±è´¥æ—¶é™çº§åˆ°è½®è¯¢
- è‡ªåŠ¨æ£€æµ‹ WebSocket å¯ç”¨æ€§
- è‡ªåŠ¨åˆ‡æ¢è½®è¯¢/WebSocket

---

#### 22. æµè§ˆå™¨åŸç”Ÿé€šçŸ¥å†…å®¹éªŒè¯ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.2 ææ¡ˆæåˆ°"é€šçŸ¥å†…å®¹éªŒè¯"ï¼Œä½†æœªè¯´æ˜å…·ä½“éªŒè¯è§„åˆ™
- æœªé™åˆ¶é€šçŸ¥å†…å®¹é•¿åº¦

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´ XSS æˆ–å†…å­˜å ç”¨è¿‡é«˜

**ä¿®å¤å»ºè®®**ï¼š
- ç§»é™¤ HTML æ ‡ç­¾ï¼ˆé˜²æ­¢ XSSï¼‰
- è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
- é™åˆ¶é€šçŸ¥å†…å®¹é•¿åº¦ï¼ˆæ ‡é¢˜æœ€å¤š 200 å­—ç¬¦ï¼Œå†…å®¹æœ€å¤š 1000 å­—ç¬¦ï¼‰

---

#### 23. æ“ä½œæ—¥å¿—è®°å½•ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.3 ææ¡ˆæåˆ°"æ“ä½œæ—¥å¿—è®°å½•"ï¼Œä½†æœªè¯´æ˜å…·ä½“å®ç°
- æ— æ³•è¿½è¸ªå¿«é€Ÿæ“ä½œ

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå®¡è®¡è¿½è¸ªç¼ºå¤±

**ä¿®å¤å»ºè®®**ï¼š
- è®°å½•æ‰€æœ‰å¿«é€Ÿæ“ä½œåˆ°å®¡è®¡æ—¥å¿—
- è®°å½•æ“ä½œäººã€æ—¶é—´ã€æ“ä½œç±»å‹ã€ç›®æ ‡èµ„æº

---

#### 24. é€šçŸ¥ä¼˜å…ˆçº§éªŒè¯ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.5 ææ¡ˆæåˆ°"ä¼˜å…ˆçº§éªŒè¯"ï¼Œä½†æœªè¯´æ˜å…·ä½“éªŒè¯è§„åˆ™
- å¯èƒ½æ¥å—æ¶æ„ä¼˜å…ˆçº§å€¼

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šæ•°æ®å®Œæ•´æ€§é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- ä½¿ç”¨æšä¸¾éªŒè¯ä¼˜å…ˆçº§å€¼
- æ— æ•ˆä¼˜å…ˆçº§å€¼ä½¿ç”¨é»˜è®¤å€¼ï¼ˆmediumï¼‰
- é˜²æ­¢æ¶æ„ä¼˜å…ˆçº§å€¼æ³¨å…¥

---

#### 25. è¿æ¥è¶…æ—¶å¤„ç†ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ°"è¿æ¥è¶…æ—¶å¤„ç†"ï¼Œä½†æœªè¯´æ˜å…·ä½“å®ç°
- é•¿æ—¶é—´è¿æ¥å ç”¨èµ„æº

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šèµ„æºæµªè´¹

**ä¿®å¤å»ºè®®**ï¼š
- 1 å°æ—¶è¿æ¥è¶…æ—¶
- å®šæœŸæ¸…ç†è¶…æ—¶è¿æ¥

---

#### 26. æ‰¹é‡æ¨é€æ€§èƒ½é—®é¢˜

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ°"æ‰¹é‡æ¨é€"ï¼Œä½†æœªè¯´æ˜æ€§èƒ½ä¼˜åŒ–
- å¤§é‡ç®¡ç†å‘˜é€šçŸ¥å¯èƒ½å¯¼è‡´é˜»å¡
- æœªé™åˆ¶æ‰¹é‡é€šçŸ¥æ•°é‡

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šæ€§èƒ½é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- ä½¿ç”¨å¼‚æ­¥æ‰¹é‡åˆ›å»ºï¼ˆé¿å…é˜»å¡ï¼‰
- é™åˆ¶æ‰¹é‡é€šçŸ¥æ•°é‡ï¼ˆæœ€å¤š 50 ä¸ªç®¡ç†å‘˜ï¼‰
- è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¤§é‡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰

---

#### 27. WebSocket è¿æ¥çŠ¶æ€ç›‘æ§ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæœªæåŠè¿æ¥çŠ¶æ€ç›‘æ§
- æ— æ³•äº†è§£ç³»ç»Ÿ WebSocket è¿æ¥çŠ¶æ€
- æ— æ³•æ’æŸ¥è¿æ¥é—®é¢˜

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šè¿ç»´å›°éš¾

**ä¿®å¤å»ºè®®**ï¼š
- æ·»åŠ è¿æ¥ç»Ÿè®¡ APIï¼š`GET /api/notifications/ws/stats`
- è¿”å›ï¼šæ´»è·ƒè¿æ¥æ•°ã€æ¯ä¸ªç”¨æˆ·çš„è¿æ¥æ•°ã€è¿æ¥é”™è¯¯ç»Ÿè®¡

---

#### 28. é€šçŸ¥è®¾ç½®æŒä¹…åŒ–ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.2 ææ¡ˆæåˆ°"ç”¨æˆ·é€šçŸ¥åå¥½è®¾ç½®"ï¼Œä½†æœªè¯´æ˜æŒä¹…åŒ–æ–¹å¼
- ç”¨æˆ·è®¾ç½®å¯èƒ½ä¸¢å¤±
- æ— æ³•è·¨è®¾å¤‡åŒæ­¥

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒé—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ï¼ˆ`user_notification_preferences` è¡¨ï¼‰
- æ”¯æŒè·¨è®¾å¤‡åŒæ­¥
- å­—æ®µï¼š`user_id`, `notification_type`, `enabled`, `desktop_enabled`

---

## Phase 8 æ¼æ´ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| æ¼æ´ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| WebSocket é”™è¯¯ç å†²çª | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket Origin éªŒè¯ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket WSS å¼ºåˆ¶è¦æ±‚ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥é€Ÿç‡é™åˆ¶ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥æ•°é™åˆ¶ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket ç”¨æˆ·æƒé™éªŒè¯ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket æ¶ˆæ¯æ ¼å¼éªŒè¯ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket å¿ƒè·³æœºåˆ¶ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å¿«é€Ÿæ“ä½œ CSRF é˜²æŠ¤ç¼ºå¤± | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å¿«é€Ÿæ“ä½œæƒé™éªŒè¯ä¸æ˜ç¡® | P0 | å¿…é¡»ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket é™çº§æ–¹æ¡ˆç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æµè§ˆå™¨é€šçŸ¥å†…å®¹éªŒè¯ä¸å®Œæ•´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æ“ä½œæ—¥å¿—è®°å½•ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥ä¼˜å…ˆçº§éªŒè¯ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è¿æ¥è¶…æ—¶å¤„ç†ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æ‰¹é‡æ¨é€æ€§èƒ½é—®é¢˜ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥çŠ¶æ€ç›‘æ§ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥è®¾ç½®æŒä¹…åŒ–ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**ä¿®å¤è¿™äº›æ¼æ´åï¼ŒPhase 8 å¯ä»¥å®‰å…¨å®æ–½ã€‚**

---

## Phase 8 å®¡æŸ¥å‘ç°çš„æ–°é—®é¢˜ï¼ˆ2026-01-05ï¼‰

### P1 é‡è¦é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 29. user_notification_preferences è¡¨è®¾è®¡ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.2.3 ææ¡ˆæåˆ°éœ€è¦ `user_notification_preferences` è¡¨
- ä½†åœ¨ `modules/core/db/schema.py` ä¸­æ²¡æœ‰è¯¥è¡¨çš„å®šä¹‰
- ç¼ºå°‘è¡¨ç»“æ„è®¾è®¡å’Œè¿ç§»è„šæœ¬
- ç¼ºå°‘ç›¸å…³çš„ CRUD API è®¾è®¡

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šPhase 8.2.3 æ— æ³•å®æ–½
- é€šçŸ¥è®¾ç½®æ— æ³•æŒä¹…åŒ–
- æ— æ³•æ”¯æŒè·¨è®¾å¤‡åŒæ­¥

**ä¿®å¤å»ºè®®**ï¼š
- åˆ›å»º `UserNotificationPreference` æ¨¡å‹ï¼ˆåŒ…å« `preference_id`, `user_id`, `notification_type`, `enabled`, `desktop_enabled` å­—æ®µï¼‰
- æ·»åŠ å”¯ä¸€çº¦æŸï¼š`(user_id, notification_type)`
- åˆ›å»º Alembic è¿ç§»è„šæœ¬
- å®ç°ç›¸å…³ CRUD APIï¼š
  - `GET /api/users/me/notification-preferences`
  - `PUT /api/users/me/notification-preferences`
  - `GET /api/users/me/notification-preferences/{notification_type}`
  - `PUT /api/users/me/notification-preferences/{notification_type}`

---

#### 30. WebSocket close code ä¸ç°æœ‰ WebSocket é”™è¯¯ç æ··æ·† âš ï¸

**é—®é¢˜**ï¼š
- `collection_websocket.py` ä¸­å®šä¹‰äº† `WS_ERROR_TOKEN_EXPIRED = 4002`ï¼ˆç”¨äºæ¶ˆæ¯æ ¼å¼ï¼‰
- Phase 8 ä½¿ç”¨ WebSocket close code 4005/4006ï¼ˆç”¨äºå…³é—­è¿æ¥ï¼‰
- æ–‡æ¡£æœªæ˜ç¡®åŒºåˆ† WebSocket close code å’Œ WebSocket é”™è¯¯ç 

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´å‰ç«¯å¤„ç†é€»è¾‘æ··æ·†
- å¼€å‘äººå‘˜å¯èƒ½è¯¯ç”¨é”™è¯¯ç ç±»å‹

**ä¿®å¤å»ºè®®**ï¼š
- æ˜ç¡®åŒºåˆ†ï¼š
  - **WebSocket close code**ï¼šç”¨äºå…³é—­è¿æ¥ï¼ˆ4005/4006ï¼‰ï¼Œå‰ç«¯é€šè¿‡ `websocket.closeCode` è·å–
  - **WebSocket é”™è¯¯ç **ï¼šç”¨äºæ¶ˆæ¯ä¸­çš„é”™è¯¯ï¼ˆå¦‚ `WS_ERROR_TOKEN_EXPIRED = 4002`ï¼‰ï¼Œä»…ç”¨äºæ¶ˆæ¯æ ¼å¼
- åœ¨æ–‡æ¡£ä¸­è¯´æ˜åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯
- åœ¨ä»£ç æ³¨é‡Šä¸­æ˜ç¡®æ ‡æ³¨

---

#### 31. æ‰¹é‡æ¨é€çš„æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ä¸è¶³ âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ°"é™åˆ¶æ‰¹é‡é€šçŸ¥æ•°é‡ï¼ˆæœ€å¤š 50 ä¸ªç®¡ç†å‘˜ï¼‰"
- æœªè¯´æ˜å¦‚ä½•å¤„ç†è¶…è¿‡ 50 ä¸ªç®¡ç†å‘˜çš„æƒ…å†µ
- ç¼ºå°‘å…·ä½“çš„å¤„ç†ç­–ç•¥

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–åŠŸèƒ½ä¸å®Œæ•´

**ä¿®å¤å»ºè®®**ï¼š
- æ˜ç¡®å¤„ç†ç­–ç•¥ï¼š
  - å¦‚æœç®¡ç†å‘˜æ•°é‡ â‰¤ 50ï¼šç›´æ¥æ‰¹é‡æ¨é€
  - å¦‚æœç®¡ç†å‘˜æ•°é‡ > 50ï¼š
    - æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰ï¼šåˆ†æ‰¹æ¨é€ï¼ˆæ¯æ‰¹ 50 ä¸ªï¼Œå¼‚æ­¥å¤„ç†ï¼‰
    - æ–¹æ¡ˆ2ï¼šä»…æ¨é€å‰ 50 ä¸ªç®¡ç†å‘˜ï¼Œå…¶ä½™é€šè¿‡è½®è¯¢è·å–
    - æ–¹æ¡ˆ3ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis/RabbitMQï¼‰å¼‚æ­¥å¤„ç†
- è®°å½•æ‰¹é‡æ¨é€æ—¥å¿—ï¼ˆæˆåŠŸ/å¤±è´¥æ•°é‡ï¼‰

---

#### 32. WebSocket è¿æ¥ç»Ÿè®¡ API è®¾è®¡ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ° `GET /api/notifications/ws/stats`
- ä½†æœªè¯´æ˜å“åº”æ ¼å¼å’Œæƒé™è¦æ±‚
- ç¼ºå°‘ Pydantic schema å®šä¹‰

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šAPI è®¾è®¡ä¸å®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´å®æ–½å›°éš¾

**ä¿®å¤å»ºè®®**ï¼š
- æ˜ç¡®æƒé™è¦æ±‚ï¼šä»…ç®¡ç†å‘˜å¯è®¿é—®ï¼ˆä½¿ç”¨ `require_admin`ï¼‰
- å®šä¹‰å“åº”æ ¼å¼ï¼š
  ```python
  class WebSocketStatsResponse(BaseModel):
      total_connections: int
      active_users: int
      connections_per_user: Dict[int, int]
      error_stats: Dict[str, int]
      timestamp: datetime
  ```
- åœ¨ `backend/schemas/notification.py` ä¸­å®šä¹‰ schema

---

### P2 ä½ä¸¥é‡æ€§é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

#### 33. é€šçŸ¥è®¾ç½® API å‰ç«¯è°ƒç”¨ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.2.3 æåˆ°éœ€è¦é€šçŸ¥åå¥½è®¾ç½®
- ä½†æœªè¯´æ˜å‰ç«¯å¦‚ä½•è°ƒç”¨ API
- ç¼ºå°‘å‰ç«¯ç»„ä»¶è®¾è®¡

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå‰ç«¯å®æ–½å¯èƒ½ä¸å®Œæ•´

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ `frontend/src/api/users.js` ä¸­æ·»åŠ é€šçŸ¥åå¥½ API è°ƒç”¨æ–¹æ³•
- åˆ›å»º `frontend/src/views/settings/NotificationPreferences.vue` ç»„ä»¶
- æ›´æ–°è·¯ç”±é…ç½®

---

## Phase 8 å®¡æŸ¥é—®é¢˜ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| user_notification_preferences è¡¨è®¾è®¡ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket close code ä¸é”™è¯¯ç æ··æ·† | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æ‰¹é‡æ¨é€æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ä¸è¶³ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥ç»Ÿè®¡ API è®¾è®¡ä¸å®Œæ•´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥è®¾ç½® API å‰ç«¯è°ƒç”¨ç¼ºå¤± | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**ä¿®å¤è¿™äº›é—®é¢˜åï¼ŒPhase 8 è®¾è®¡å°†æ›´åŠ å®Œæ•´å’Œå¯å®æ–½ã€‚**

---

## Phase 1-7 å®¡æŸ¥å‘ç°çš„æ–°é—®é¢˜ï¼ˆ2026-01-05ï¼‰

### P1 é‡è¦é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 34. å®¡æ‰¹ API ç¼ºå°‘é€Ÿç‡é™åˆ¶ âš ï¸

**é—®é¢˜**ï¼š
- `POST /api/users/{user_id}/approve` ç«¯ç‚¹æ²¡æœ‰é€Ÿç‡é™åˆ¶
- `POST /api/users/{user_id}/reject` ç«¯ç‚¹æ²¡æœ‰é€Ÿç‡é™åˆ¶
- `GET /api/users/pending` ç«¯ç‚¹æ²¡æœ‰é€Ÿç‡é™åˆ¶
- å¦‚æœç®¡ç†å‘˜è´¦å·è¢«åŠ«æŒï¼Œå¯èƒ½è¢«æ»¥ç”¨è¿›è¡Œæ‰¹é‡æ“ä½œ

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´æ‰¹é‡è¯¯æ“ä½œæˆ– DoS æ”»å‡»

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨å®¡æ‰¹ API ä¸Šæ·»åŠ é™æµï¼š
  - `approve_user`: `@limiter.limit("20/minute")`
  - `reject_user`: `@limiter.limit("20/minute")`
  - `get_pending_users`: `@limiter.limit("30/minute")`ï¼ˆæŸ¥è¯¢æ“ä½œï¼Œé™åˆ¶æ›´é«˜ï¼‰

---

#### 35. å®¡æ‰¹ API ç¼ºå°‘è¾“å…¥éªŒè¯ âš ï¸

**é—®é¢˜**ï¼š
- `ApproveUserRequest` çš„ `role_ids` æœªéªŒè¯åˆ—è¡¨é•¿åº¦
- `ApproveUserRequest` çš„ `notes` æœªé™åˆ¶é•¿åº¦
- `RejectUserRequest` çš„ `reason` æœªé™åˆ¶é•¿åº¦
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–å­˜å‚¨é—®é¢˜

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šæ•°æ®å®Œæ•´æ€§é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ Pydantic schema ä¸­æ·»åŠ éªŒè¯ï¼š
  ```python
  class ApproveUserRequest(BaseModel):
      role_ids: Optional[List[int]] = Field(None, max_items=10)  # é™åˆ¶æœ€å¤š10ä¸ªè§’è‰²
      notes: Optional[str] = Field(None, max_length=500)  # é™åˆ¶å¤‡æ³¨é•¿åº¦

  class RejectUserRequest(BaseModel):
      reason: str = Field(..., min_length=1, max_length=500)  # é™åˆ¶åŸå› é•¿åº¦
  ```

---

#### 36. é€šçŸ¥åå¥½ API ç¼ºå°‘é€Ÿç‡é™åˆ¶ âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.2.3 çš„é€šçŸ¥åå¥½ API æœªæåŠé€Ÿç‡é™åˆ¶
- ç”¨æˆ·å¯èƒ½é¢‘ç¹ä¿®æ”¹åå¥½ï¼Œé€ æˆèµ„æºæµªè´¹

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šèµ„æºæµªè´¹

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨é€šçŸ¥åå¥½ API ä¸Šæ·»åŠ é™æµï¼š
  - `GET /api/users/me/notification-preferences`: `@limiter.limit("30/minute")`
  - `PUT /api/users/me/notification-preferences`: `@limiter.limit("10/minute")`
  - `GET /api/users/me/notification-preferences/{type}`: `@limiter.limit("30/minute")`
  - `PUT /api/users/me/notification-preferences/{type}`: `@limiter.limit("10/minute")`

---

#### 37. é€šçŸ¥åå¥½ API æƒé™éªŒè¯ä¸æ˜ç¡® âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.2.3 æåˆ°"æƒé™éªŒè¯ï¼šä»…å…è®¸ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„åå¥½"
- æœªè¯´æ˜å¦‚ä½•éªŒè¯ `user_id` ä¸ `current_user.user_id` åŒ¹é…
- æ‰¹é‡æ›´æ–° API ä¸­å¯èƒ½ç¼ºå°‘éªŒè¯

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šæƒé™ç»•è¿‡é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨é€šçŸ¥åå¥½ API ä¸­æ˜ç¡®éªŒè¯ï¼š
  ```python
  # æŸ¥è¯¢åå¥½æ—¶éªŒè¯
  result = await db.execute(
      select(UserNotificationPreference).where(
          UserNotificationPreference.user_id == current_user.user_id,  # âš ï¸ å¿…é¡»éªŒè¯
          UserNotificationPreference.notification_type == notification_type
      )
  )
  
  # åˆ›å»ºæ–°åå¥½æ—¶ä½¿ç”¨å½“å‰ç”¨æˆ·ID
  if not preference:
      preference = UserNotificationPreference(
          user_id=current_user.user_id,  # âš ï¸ ä½¿ç”¨å½“å‰ç”¨æˆ·IDï¼Œä¸èƒ½ä»è¯·æ±‚ä¸­è·å–
          notification_type=notification_type,
          ...
      )
  ```

---

#### 38. WebSocket è¿æ¥é€Ÿç‡é™åˆ¶çš„å­˜å‚¨é™çº§ç­–ç•¥ä¸æ˜ç¡® âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 ææ¡ˆæåˆ°"ä½¿ç”¨ Redis æˆ–å†…å­˜ç¼“å­˜è®°å½•è¿æ¥é¢‘ç‡"
- æœªè¯´æ˜ Redis ä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥
- æœªè¯´æ˜å†…å­˜ç¼“å­˜çš„æ¸…ç†æœºåˆ¶

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯ç”¨æ€§é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- æ˜ç¡®é™çº§ç­–ç•¥ï¼š
  - ä¼˜å…ˆä½¿ç”¨ Redisï¼ˆæŒä¹…åŒ–ã€åˆ†å¸ƒå¼ï¼‰
  - Redis ä¸å¯ç”¨æ—¶é™çº§åˆ°å†…å­˜ç¼“å­˜ï¼ˆå•æœºï¼‰
  - å†…å­˜ç¼“å­˜ä½¿ç”¨ LRU ç­–ç•¥ï¼Œé™åˆ¶å¤§å°ï¼ˆæœ€å¤š 10000 æ¡è®°å½•ï¼‰
- æ·»åŠ æ¸…ç†æœºåˆ¶ï¼š
  - å®šæœŸæ¸…ç†è¿‡æœŸçš„è¿æ¥é¢‘ç‡è®°å½•ï¼ˆå¦‚ 1 å°æ—¶ï¼‰
  - é™åˆ¶å†…å­˜ç¼“å­˜å¤§å°ï¼ˆå¦‚æœ€å¤š 10000 æ¡è®°å½•ï¼‰

---

### P2 ä½ä¸¥é‡æ€§é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

#### 39. æ³¨å†Œ API é™æµåŸºäº IP çš„å‰¯ä½œç”¨

**é—®é¢˜**ï¼š
- æ³¨å†Œ API ä½¿ç”¨ IP é™æµï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰
- åŒä¸€ IPï¼ˆå¦‚å…¬å¸ç½‘ç»œã€NATï¼‰çš„å¤šä¸ªç”¨æˆ·ä¼šäº’ç›¸å½±å“
- å¯èƒ½å¯¼è‡´æ­£å¸¸ç”¨æˆ·æ— æ³•æ³¨å†Œ

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒé—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- æ–¹æ¡ˆ1ï¼šæé«˜ IP é™æµé˜ˆå€¼ï¼ˆå¦‚ 10æ¬¡/åˆ†é’Ÿï¼‰
- æ–¹æ¡ˆ2ï¼šæ·»åŠ  CAPTCHA éªŒè¯ï¼ˆè¶…è¿‡é˜ˆå€¼åï¼‰
- æ–¹æ¡ˆ3ï¼šç»“åˆè®¾å¤‡æŒ‡çº¹è¯†åˆ«ï¼ˆå¯é€‰ï¼‰

---

#### 40. æ‰¹é‡æ¨é€å¤±è´¥å¤„ç†æœºåˆ¶ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.1 çš„æ‰¹é‡æ¨é€æœªè¯´æ˜å¤±è´¥å¤„ç†
- éƒ¨åˆ†ç®¡ç†å‘˜é€šçŸ¥å¤±è´¥æ—¶å¦‚ä½•å¤„ç†ä¸æ˜ç¡®

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå¯é æ€§é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- æ·»åŠ å¤±è´¥å¤„ç†ç­–ç•¥ï¼š
  - è®°å½•å¤±è´¥çš„ç®¡ç†å‘˜ ID
  - è¿”å›éƒ¨åˆ†æˆåŠŸçš„ç»“æœï¼ˆæˆåŠŸæ•°é‡ã€å¤±è´¥æ•°é‡ã€å¤±è´¥åˆ—è¡¨ï¼‰
  - å¯é€‰ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ¨é€ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
  - è®°å½•å¤±è´¥æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

---

#### 41. å¾…å®¡æ‰¹ç”¨æˆ·åˆ—è¡¨ API ä¿¡æ¯æ³„éœ²é£é™©

**é—®é¢˜**ï¼š
- `GET /api/users/pending` è¿”å›ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- æœªè¯´æ˜æ˜¯å¦è¿”å›æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚é‚®ç®±ã€ç”µè¯ï¼‰
- å¯èƒ½æ³„éœ²ç”¨æˆ·éšç§

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šéšç§é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- æ˜ç¡®è¿”å›å­—æ®µï¼š
  - å¿…éœ€ï¼š`user_id`, `username`, `created_at`, `status`
  - å¯é€‰ï¼š`email`ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
  - ç¦æ­¢ï¼š`password_hash`, `phone`ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰

---

#### 42. æ‰¹é‡æ¨é€æ—¶çš„é€šçŸ¥åå¥½æ£€æŸ¥ç¼ºå¤±

**é—®é¢˜**ï¼š
- Phase 8.1 æ‰¹é‡æ¨é€æ—¶æœªæ£€æŸ¥ç”¨æˆ·çš„é€šçŸ¥åå¥½
- å¯èƒ½å‘å·²ç¦ç”¨é€šçŸ¥çš„ç”¨æˆ·å‘é€é€šçŸ¥

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒé—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨æ¨é€å‰æ£€æŸ¥ç”¨æˆ·åå¥½ï¼š
  ```python
  # æ¨é€å‰æ£€æŸ¥ç”¨æˆ·åå¥½
  preference = await db.execute(
      select(UserNotificationPreference).where(
          UserNotificationPreference.user_id == admin_user.user_id,
          UserNotificationPreference.notification_type == notification_type,
          UserNotificationPreference.enabled == True
      )
  )
  if not preference.scalar_one_or_none():
      continue  # è·³è¿‡å·²ç¦ç”¨é€šçŸ¥çš„ç”¨æˆ·
  ```

---

#### 43. WebSocket è¿æ¥ç»Ÿè®¡ API ç¼ºå°‘åˆ†é¡µ

**é—®é¢˜**ï¼š
- `GET /api/notifications/ws/stats` è¿”å› `connections_per_user`
- å¦‚æœç”¨æˆ·æ•°é‡å¾ˆå¤§ï¼Œå¯èƒ½å¯¼è‡´å“åº”è¿‡å¤§

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šæ€§èƒ½é—®é¢˜

**ä¿®å¤å»ºè®®**ï¼š
- æ·»åŠ åˆ†é¡µæˆ–é™åˆ¶ï¼š
  - æ–¹æ¡ˆ1ï¼šé™åˆ¶è¿”å›çš„è¿æ¥æ•°ï¼ˆå¦‚æœ€å¤š 100 ä¸ªç”¨æˆ·ï¼‰
  - æ–¹æ¡ˆ2ï¼šæ·»åŠ åˆ†é¡µå‚æ•°ï¼ˆ`page`, `page_size`ï¼‰
  - æ–¹æ¡ˆ3ï¼šä»…è¿”å›è¿æ¥æ•°æœ€å¤šçš„å‰ N ä¸ªç”¨æˆ·

---

## Phase 1-7 å®¡æŸ¥é—®é¢˜ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| å®¡æ‰¹ API ç¼ºå°‘é€Ÿç‡é™åˆ¶ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹ API ç¼ºå°‘è¾“å…¥éªŒè¯ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥åå¥½ API ç¼ºå°‘é€Ÿç‡é™åˆ¶ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥åå¥½ API æƒé™éªŒè¯ä¸æ˜ç¡® | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥é€Ÿç‡é™åˆ¶å­˜å‚¨é™çº§ç­–ç•¥ä¸æ˜ç¡® | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æ³¨å†Œ API é™æµåŸºäº IP çš„å‰¯ä½œç”¨ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æ‰¹é‡æ¨é€å¤±è´¥å¤„ç†æœºåˆ¶ç¼ºå¤± | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å¾…å®¡æ‰¹ç”¨æˆ·åˆ—è¡¨ API ä¿¡æ¯æ³„éœ²é£é™© | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| æ‰¹é‡æ¨é€æ—¶çš„é€šçŸ¥åå¥½æ£€æŸ¥ç¼ºå¤± | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥ç»Ÿè®¡ API ç¼ºå°‘åˆ†é¡µ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**ä¿®å¤è¿™äº›é—®é¢˜åï¼Œææ¡ˆè®¾è®¡å°†æ›´åŠ å®Œæ•´å’Œå®‰å…¨ã€‚**

---

## Phase 1-7 å®æ–½åå®¡æŸ¥å‘ç°çš„æ–°é—®é¢˜ï¼ˆ2026-01-05ï¼‰

### P1 é‡è¦é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 44. å®¡æ‰¹ API è¾“å…¥éªŒè¯ä¸ä¸€è‡´ âš ï¸

**é—®é¢˜**ï¼š
- `ApproveUserRequest.role_ids` ç¼ºå°‘ `max_items=10` é™åˆ¶ï¼ˆææ¡ˆè¦æ±‚æœ€å¤š10ä¸ªè§’è‰²ï¼‰
- `ApproveUserRequest.notes` ç¼ºå°‘ `max_length=500` é™åˆ¶ï¼ˆææ¡ˆè¦æ±‚æœ€å¤š500å­—ç¬¦ï¼‰
- `RejectUserRequest.reason` å½“å‰å®ç°ä¸º `min_length=5`ï¼Œä½†ææ¡ˆè¦æ±‚ `min_length=1, max_length=500`
- å®é™…å®ç°ä¸ææ¡ˆè¦æ±‚ä¸ä¸€è‡´

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–å­˜å‚¨é—®é¢˜
- ç”¨æˆ·ä½“éªŒï¼šæ‹’ç»åŸå› è¦æ±‚è‡³å°‘5å­—ç¬¦å¯èƒ½è¿‡äºä¸¥æ ¼

**å½“å‰å®ç°**ï¼š
```python
# backend/schemas/auth.py
class ApproveUserRequest(BaseModel):
    role_ids: List[int] = Field(default_factory=list, ...)  # âŒ ç¼ºå°‘ max_items=10
    notes: Optional[str] = Field(None, ...)  # âŒ ç¼ºå°‘ max_length=500

class RejectUserRequest(BaseModel):
    reason: str = Field(..., min_length=5, ...)  # âš ï¸ ä¸ææ¡ˆä¸ä¸€è‡´
```

**ä¿®å¤å»ºè®®**ï¼š
```python
class ApproveUserRequest(BaseModel):
    role_ids: List[int] = Field(
        default_factory=list,
        max_items=10,  # âš ï¸ æ·»åŠ é™åˆ¶
        description="è§’è‰²IDåˆ—è¡¨ï¼ˆå¯é€‰ï¼Œæœ€å¤š10ä¸ªï¼Œé»˜è®¤operatorï¼‰"
    )
    notes: Optional[str] = Field(
        None,
        max_length=500,  # âš ï¸ æ·»åŠ é™åˆ¶
        description="å®¡æ‰¹å¤‡æ³¨ï¼ˆæœ€å¤š500å­—ç¬¦ï¼‰"
    )

class RejectUserRequest(BaseModel):
    reason: str = Field(
        ...,
        min_length=1,  # âš ï¸ ä¿®æ”¹ä¸º1ï¼ˆææ¡ˆè¦æ±‚ï¼‰
        max_length=500,  # âš ï¸ æ·»åŠ ä¸Šé™
        description="æ‹’ç»åŸå› ï¼ˆå¿…å¡«ï¼Œ1-500å­—ç¬¦ï¼‰"
    )
```

---

#### 45. å®¡æ‰¹ API é€Ÿç‡é™åˆ¶æœªå®æ–½ âš ï¸

**é—®é¢˜**ï¼š
- `POST /api/users/{user_id}/approve` ç«¯ç‚¹æœªæ·»åŠ é€Ÿç‡é™åˆ¶è£…é¥°å™¨
- `POST /api/users/{user_id}/reject` ç«¯ç‚¹æœªæ·»åŠ é€Ÿç‡é™åˆ¶è£…é¥°å™¨
- `GET /api/users/pending` ç«¯ç‚¹æœªæ·»åŠ é€Ÿç‡é™åˆ¶è£…é¥°å™¨
- ææ¡ˆè¦æ±‚æ·»åŠ é€Ÿç‡é™åˆ¶ï¼Œä½†å®é™…å®ç°ä¸­ç¼ºå¤±

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¦‚æœç®¡ç†å‘˜è´¦å·è¢«åŠ«æŒï¼Œå¯èƒ½è¢«æ»¥ç”¨è¿›è¡Œæ‰¹é‡æ“ä½œ

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py
@router.post("/{user_id}/approve")  # âŒ ç¼ºå°‘é€Ÿç‡é™åˆ¶
async def approve_user(...):
    ...

@router.post("/{user_id}/reject")  # âŒ ç¼ºå°‘é€Ÿç‡é™åˆ¶
async def reject_user(...):
    ...

@router.get("/pending")  # âŒ ç¼ºå°‘é€Ÿç‡é™åˆ¶
async def get_pending_users(...):
    ...
```

**ä¿®å¤å»ºè®®**ï¼š
```python
from backend.middleware.rate_limiter import limiter

@router.post("/{user_id}/approve")
@limiter.limit("20/minute")  # âš ï¸ æ·»åŠ é€Ÿç‡é™åˆ¶
async def approve_user(...):
    ...

@router.post("/{user_id}/reject")
@limiter.limit("20/minute")  # âš ï¸ æ·»åŠ é€Ÿç‡é™åˆ¶
async def reject_user(...):
    ...

@router.get("/pending")
@limiter.limit("30/minute")  # âš ï¸ æ·»åŠ é€Ÿç‡é™åˆ¶
async def get_pending_users(...):
    ...
```

---

#### 46. å¾…å®¡æ‰¹ç”¨æˆ·åˆ—è¡¨å­—æ®µæ§åˆ¶æœªæ˜ç¡® âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆè¦æ±‚æ˜ç¡®è¿”å›å­—æ®µæ§åˆ¶ï¼ˆç¦æ­¢æ•æ„Ÿä¿¡æ¯ï¼‰
- éœ€è¦ç¡®è®¤ `PendingUserResponse` schema æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µï¼ˆå¦‚ `password_hash`, `phone`ï¼‰
- å®ç°ä¸­æœªæ˜ç¡®è¯´æ˜å­—æ®µæ§åˆ¶ç­–ç•¥

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å­˜åœ¨ä¿¡æ¯æ³„éœ²é£é™©

**ä¿®å¤å»ºè®®**ï¼š
- æ£€æŸ¥ `PendingUserResponse` schema å®šä¹‰
- ç¡®ä¿ä¸åŒ…å«æ•æ„Ÿå­—æ®µï¼ˆ`password_hash`, `phone`ï¼‰
- åœ¨å®ç°ä¸­æ˜ç¡®è¯´æ˜å­—æ®µæ§åˆ¶ç­–ç•¥
- å¦‚æœ `email` å­—æ®µéœ€è¦è¿”å›ï¼Œåº”æ˜ç¡®æ ‡æ³¨"ä»…ç®¡ç†å‘˜å¯è§"

---

### P2 ä½ä¸¥é‡æ€§é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

#### 47. WebSocket è¿æ¥ç®¡ç†å®ç°çŠ¶æ€ä¸æ˜ç¡® âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 è¦æ±‚å®ç° WebSocket è¿æ¥ç®¡ç†å™¨
- éœ€è¦ç¡®è®¤æ˜¯å¦å·²æœ‰å®ç°ï¼Œæˆ–æ˜¯å¦åœ¨ Phase 8 å¾…å®æ–½
- ææ¡ˆä¸­æœªæ˜ç¡®è¯´æ˜ Phase 8 çš„å®æ–½çŠ¶æ€

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå®æ–½è®¡åˆ’ä¸æ¸…æ™°

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ `tasks.md` ä¸­æ˜ç¡®æ ‡è®° Phase 8 çš„å®æ–½çŠ¶æ€
- å¦‚æœ Phase 8 å°šæœªå®æ–½ï¼Œåº”åœ¨ææ¡ˆä¸­è¯´æ˜
- å¦‚æœå·²æœ‰éƒ¨åˆ†å®ç°ï¼Œåº”æ£€æŸ¥æ˜¯å¦ç¬¦åˆææ¡ˆè¦æ±‚

---

#### 48. Redis å¯ç”¨æ€§æ£€æŸ¥æœºåˆ¶ âš ï¸

**é—®é¢˜**ï¼š
- Phase 8.1 è¦æ±‚ WebSocket è¿æ¥é€Ÿç‡é™åˆ¶ä¼˜å…ˆä½¿ç”¨ Redisï¼ŒRedis ä¸å¯ç”¨æ—¶é™çº§åˆ°å†…å­˜ç¼“å­˜
- éœ€è¦ç¡®è®¤é™çº§é€»è¾‘æ˜¯å¦å®Œå–„
- éœ€è¦ç¡®è®¤æ˜¯å¦å¤ç”¨ç°æœ‰çš„ Redis åŸºç¡€è®¾æ–½

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå¯ç”¨æ€§é—®é¢˜

**å½“å‰çŠ¶æ€**ï¼š
- âœ… ç³»ç»Ÿå·²é…ç½® `REDIS_URL`ï¼ˆ`backend/utils/config.py`ï¼‰
- âœ… å·²æœ‰ Redis å®¢æˆ·ç«¯å®ç°ï¼ˆ`backend/utils/redis_client.py`ï¼‰
- âœ… å·²æœ‰é™çº§é€»è¾‘ç¤ºä¾‹ï¼ˆ`backend/services/rate_limit_stats.py`ï¼‰

**ä¿®å¤å»ºè®®**ï¼š
- Phase 8 å®æ–½æ—¶ï¼Œåº”å¤ç”¨ç°æœ‰çš„ Redis å®¢æˆ·ç«¯å’Œé™çº§é€»è¾‘
- ç¡®ä¿ WebSocket è¿æ¥ç®¡ç†å™¨èƒ½å¤Ÿæ­£ç¡®å¤„ç† Redis ä¸å¯ç”¨çš„æƒ…å†µ
- åœ¨ `design.md` ä¸­æ˜ç¡®è¯´æ˜å¦‚ä½•å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½

---

## Phase 1-7 å®æ–½åå®¡æŸ¥é—®é¢˜ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| å®¡æ‰¹ API è¾“å…¥éªŒè¯ä¸ä¸€è‡´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹ API é€Ÿç‡é™åˆ¶æœªå®æ–½ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å¾…å®¡æ‰¹ç”¨æˆ·åˆ—è¡¨å­—æ®µæ§åˆ¶æœªæ˜ç¡® | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| WebSocket è¿æ¥ç®¡ç†å®ç°çŠ¶æ€ä¸æ˜ç¡® | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| Redis å¯ç”¨æ€§æ£€æŸ¥æœºåˆ¶ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**ä¿®å¤è¿™äº›é—®é¢˜åï¼Œå®æ–½ä¸ææ¡ˆå°†æ›´åŠ ä¸€è‡´ã€‚**

---

## Phase 1-7 æœ€ç»ˆå®¡æŸ¥å‘ç°çš„æ–°é—®é¢˜ï¼ˆ2026-01-05ï¼‰

### P1 é‡è¦é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 49. PendingUserResponse ç¼ºå°‘ status å­—æ®µ âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆè¦æ±‚è¿”å› `status` å­—æ®µï¼ˆå¿…éœ€å­—æ®µï¼š`user_id`, `username`, `created_at`, `status`ï¼‰
- å®é™… `PendingUserResponse` schema ä¸­æ²¡æœ‰ `status` å­—æ®µ
- å®ç°ä¸­ä¹Ÿæ²¡æœ‰è¿”å› `status` å­—æ®µ
- å‰ç«¯æ— æ³•çŸ¥é“ç”¨æˆ·çš„å½“å‰çŠ¶æ€

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šåŠŸèƒ½ä¸å®Œæ•´ï¼Œå‰ç«¯æ— æ³•æ˜¾ç¤ºç”¨æˆ·çŠ¶æ€

**å½“å‰å®ç°**ï¼š
```python
# backend/schemas/auth.py
class PendingUserResponse(BaseModel):
    user_id: int
    username: str
    email: str
    full_name: Optional[str]
    department: Optional[str]
    created_at: datetime
    # âŒ ç¼ºå°‘ status å­—æ®µ
```

**ä¿®å¤å»ºè®®**ï¼š
```python
class PendingUserResponse(BaseModel):
    user_id: int
    username: str
    email: str
    status: str  # âš ï¸ æ·»åŠ  status å­—æ®µ
    full_name: Optional[str]
    department: Optional[str]
    created_at: datetime
```

åœ¨ `get_pending_users` ä¸­è¿”å› `status`ï¼š
```python
PendingUserResponse(
    user_id=user.user_id,
    username=user.username,
    email=user.email,
    status=user.status,  # âš ï¸ æ·»åŠ  status
    full_name=user.full_name,
    department=user.department,
    created_at=user.created_at
)
```

---

#### 50. è§’è‰² ID éªŒè¯ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- `approve_user` ä¸­ï¼Œå¦‚æœ `role_ids` åŒ…å«ä¸å­˜åœ¨çš„è§’è‰² IDï¼Œä»£ç ä¼šé™é»˜å¿½ç•¥
- åªåˆ†é…æ‰¾åˆ°çš„è§’è‰²ï¼Œæ²¡æœ‰éªŒè¯æ˜¯å¦æ‰€æœ‰è§’è‰² ID éƒ½å­˜åœ¨
- ææ¡ˆè¦æ±‚"éªŒè¯ `role_ids` æ˜¯å¦å­˜åœ¨"ï¼Œä½†å®ç°ä¸­ç¼ºå°‘éªŒè¯é€»è¾‘

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¯èƒ½å¯¼è‡´ç”¨æˆ·è§’è‰²åˆ†é…ä¸å®Œæ•´ï¼Œç®¡ç†å‘˜è¯¯ä»¥ä¸ºæ‰€æœ‰è§’è‰²éƒ½å·²åˆ†é…

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py
if request_body.role_ids:
    result = await db.execute(select(DimRole).where(DimRole.role_id.in_(request_body.role_ids)))
    roles = result.scalars().all()
    user.roles.clear()
    user.roles.extend(roles)
    # âŒ æ²¡æœ‰éªŒè¯æ˜¯å¦æ‰€æœ‰ role_ids éƒ½å­˜åœ¨
```

**ä¿®å¤å»ºè®®**ï¼š
```python
if request_body.role_ids:
    result = await db.execute(select(DimRole).where(DimRole.role_id.in_(request_body.role_ids)))
    roles = result.scalars().all()
    
    # âš ï¸ éªŒè¯æ˜¯å¦æ‰€æœ‰è§’è‰² ID éƒ½å­˜åœ¨
    found_role_ids = {role.role_id for role in roles}
    requested_role_ids = set(request_body.role_ids)
    missing_role_ids = requested_role_ids - found_role_ids
    
    if missing_role_ids:
        return error_response(
            code=ErrorCode.DATA_VALIDATION_FAILED,
            message=f"ä»¥ä¸‹è§’è‰²IDä¸å­˜åœ¨: {sorted(missing_role_ids)}",
            error_type=get_error_type(ErrorCode.DATA_VALIDATION_FAILED),
            recovery_suggestion="è¯·æ£€æŸ¥è§’è‰²IDæ˜¯å¦æ­£ç¡®",
            status_code=400
        )
    
    user.roles.clear()
    user.roles.extend(roles)
```

---

#### 51. é€šçŸ¥å‡½æ•°é”™è¯¯å¤„ç†ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- `notify_user_approved` å’Œ `notify_user_rejected` å¯èƒ½å¤±è´¥ï¼ˆå¦‚æ•°æ®åº“é”™è¯¯ã€é€šçŸ¥æœåŠ¡ä¸å¯ç”¨ï¼‰
- å®¡æ‰¹ API ä¸­è°ƒç”¨é€šçŸ¥å‡½æ•°æ—¶æ²¡æœ‰é”™è¯¯å¤„ç†
- é€šçŸ¥å¤±è´¥ä¸åº”å½±å“å®¡æ‰¹æ“ä½œï¼Œä½†åº”è®°å½•æ—¥å¿—ä»¥ä¾¿æ’æŸ¥

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šé€šçŸ¥å¤±è´¥å¯èƒ½å¯¼è‡´ç”¨æˆ·æ— æ³•åŠæ—¶æ”¶åˆ°å®¡æ‰¹ç»“æœ

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py
# v4.19.0: é€šçŸ¥ç”¨æˆ·å®¡æ‰¹é€šè¿‡
from backend.routers.notifications import notify_user_approved
await notify_user_approved(  # âŒ æ²¡æœ‰é”™è¯¯å¤„ç†
    db=db,
    user_id=user.user_id,
    approved_by=current_user.username
)
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# v4.19.0: é€šçŸ¥ç”¨æˆ·å®¡æ‰¹é€šè¿‡
try:
    from backend.routers.notifications import notify_user_approved
    await notify_user_approved(
        db=db,
        user_id=user.user_id,
        approved_by=current_user.username
    )
except Exception as e:
    # âš ï¸ é€šçŸ¥å¤±è´¥ä¸åº”å½±å“å®¡æ‰¹æ“ä½œï¼Œä½†åº”è®°å½•æ—¥å¿—
    logger.warning(f"[WARN] Failed to send approval notification to user {user.user_id}: {e}")
```

---

### P2 ä½ä¸¥é‡æ€§é—®é¢˜ï¼ˆå¯é€‰ä¿®å¤ï¼‰

#### 52. å®¡æ‰¹ API ä¸­ IP å’Œ User-Agent è·å–ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- `approve_user` å’Œ `reject_user` ä¸­ç¡¬ç¼–ç äº† IP å’Œ User-Agent
- å®¡è®¡æ—¥å¿—åº”è®°å½•çœŸå®çš„ IP å’Œ User-Agentï¼Œä¾¿äºå®‰å…¨å®¡è®¡å’Œé—®é¢˜æ’æŸ¥

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šå®¡è®¡æ—¥å¿—è´¨é‡ä¸‹é™ï¼Œä¸åˆ©äºå®‰å…¨å®¡è®¡

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py
# è®°å½•å®¡è®¡æ—¥å¿—
ip_address = "127.0.0.1"  # âŒ ç¡¬ç¼–ç 
user_agent = "Unknown"  # âŒ ç¡¬ç¼–ç 
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# è·å–çœŸå®IPå’ŒUser-Agent
from fastapi import Request

ip_address = request.client.host if request.client else "127.0.0.1"
forwarded_for = request.headers.get("X-Forwarded-For")
if forwarded_for:
    ip_address = forwarded_for.split(",")[0].strip()
user_agent = request.headers.get("User-Agent", "Unknown")
```

æ³¨æ„ï¼šéœ€è¦åœ¨å‡½æ•°ç­¾åä¸­æ·»åŠ  `request: Request` å‚æ•°ã€‚

---

#### 53. å¯†ç é‡ç½®é€šçŸ¥ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- `reset_user_password` API é‡ç½®å¯†ç åï¼Œæœªè°ƒç”¨ `notify_password_reset` å‡½æ•°
- ç”¨æˆ·æ— æ³•é€šè¿‡ç«™å†…é€šçŸ¥å¾—çŸ¥å¯†ç å·²è¢«é‡ç½®
- è™½ç„¶ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°ä¸´æ—¶å¯†ç ï¼Œä½†ç”¨æˆ·éœ€è¦å…¶ä»–æ–¹å¼è·çŸ¥

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“å¯†ç å·²è¢«é‡ç½®
- å®‰å…¨é£é™©ï¼šå¦‚æœç”¨æˆ·æœ‰æ´»è·ƒä¼šè¯ï¼Œå¯†ç é‡ç½®åä»å¯ä½¿ç”¨æ—§ä¼šè¯ï¼ˆéœ€è¦å¼ºåˆ¶æ’¤é”€ä¼šè¯ï¼‰

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py - reset_user_password
# é‡ç½®å¯†ç 
user.password_hash = auth_service.hash_password(new_password)
user.failed_login_attempts = 0
user.locked_until = None
await db.commit()
# âŒ æ²¡æœ‰è°ƒç”¨ notify_password_reset
# âŒ æ²¡æœ‰æ’¤é”€æ´»è·ƒä¼šè¯
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# 1. å¼ºåˆ¶æ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨è¦æ±‚ï¼‰
from modules.core.db import UserSession
from datetime import datetime

result = await db.execute(
    select(UserSession)
    .where(
        UserSession.user_id == user.user_id,
        UserSession.is_active == True,
        UserSession.expires_at > datetime.utcnow()
    )
)
sessions = result.scalars().all()
for session in sessions:
    session.is_active = False
    session.revoked_at = datetime.utcnow()
    session.revoked_reason = "å¯†ç é‡ç½®ï¼Œå¼ºåˆ¶ç™»å‡º"

# 2. å‘é€ç«™å†…é€šçŸ¥ï¼ˆç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶å¯è§ï¼‰
try:
    from backend.routers.notifications import notify_password_reset
    await notify_password_reset(
        db=db,
        user_id=user.user_id,
        reset_by=current_user.username
    )
except Exception as e:
    logger.warning(f"[WARN] Failed to send password reset notification: {e}")
```

**ç«™å†…é€šçŸ¥çš„ä»·å€¼**ï¼š
- ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¼šçœ‹åˆ°é€šçŸ¥ï¼š"æ‚¨çš„å¯†ç å·²è¢«ç®¡ç†å‘˜é‡ç½®ï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•"
- ä½œä¸ºå†å²è®°å½•ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹è´¦æˆ·çŠ¶æ€å˜æ›´å†å²

---

#### 54. è´¦æˆ·è§£é”é€šçŸ¥ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- `unlock_user_account` API è§£é”è´¦æˆ·åï¼Œæœªå‘é€é€šçŸ¥
- `NotificationType` ä¸­ç¼ºå°‘ `ACCOUNT_UNLOCKED` ç±»å‹
- ç”¨æˆ·æ— æ³•é€šè¿‡ç«™å†…é€šçŸ¥å¾—çŸ¥è´¦æˆ·å·²è§£é”

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è´¦æˆ·å·²è§£é”
- æ³¨æ„ï¼šè´¦æˆ·è§£é”æ—¶ï¼Œç”¨æˆ·å¯èƒ½æ— æ³•ç™»å½•ï¼ˆå¦‚æœè´¦æˆ·è¢«é”å®šï¼‰ï¼Œä½†é€šçŸ¥ä¼šåœ¨ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶å¯è§

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py - unlock_user_account
# è§£é”è´¦æˆ·
user.locked_until = None
user.failed_login_attempts = 0
await db.commit()
# âŒ æ²¡æœ‰å‘é€é€šçŸ¥
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# 1. åœ¨ NotificationType ä¸­æ·»åŠ  ACCOUNT_UNLOCKED
# backend/routers/notifications.py
class NotificationType(str, Enum):
    # ... ç°æœ‰ç±»å‹ ...
    ACCOUNT_UNLOCKED = "account_unlocked"

# 2. åˆ›å»ºé€šçŸ¥å‡½æ•°
async def notify_account_unlocked(
    db: AsyncSession,
    user_id: int,
    unlocked_by: str = "system",
    reason: str = None
) -> Notification:
    """é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è§£é”"""
    user = await db.get(DimUser, user_id)
    if not user:
        return None
    
    title = "è´¦æˆ·å·²è§£é”"
    content = f"æ‚¨çš„è´¦æˆ·å·²è¢«{unlocked_by}è§£é”"
    if reason:
        content += f"ï¼ŒåŸå› ï¼š{reason}"
    content += "ã€‚æ‚¨ç°åœ¨å¯ä»¥é‡æ–°ç™»å½•ã€‚"
    
    return await create_notification(
        db=db,
        recipient_id=user_id,
        notification_type=NotificationType.ACCOUNT_UNLOCKED,
        title=title,
        content=content,
        extra_data={
            "unlocked_by": unlocked_by,
            "reason": reason
        }
    )

# 3. åœ¨ unlock_user_account ä¸­è°ƒç”¨
try:
    from backend.routers.notifications import notify_account_unlocked
    await notify_account_unlocked(
        db=db,
        user_id=user.user_id,
        unlocked_by=current_user.username,
        reason=request_body.reason or "ç®¡ç†å‘˜æ‰‹åŠ¨è§£é”"
    )
except Exception as e:
    logger.warning(f"[WARN] Failed to send account unlocked notification: {e}")
```

**ç«™å†…é€šçŸ¥çš„ä»·å€¼**ï¼š
- ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¼šçœ‹åˆ°é€šçŸ¥ï¼š"æ‚¨çš„è´¦æˆ·å·²è§£é”ï¼Œå¯ä»¥é‡æ–°ç™»å½•"
- ä½œä¸ºå†å²è®°å½•ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹è´¦æˆ·çŠ¶æ€å˜æ›´å†å²

---

#### 55. ç”¨æˆ·æš‚åœé€šçŸ¥ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- `update_user` API è®¾ç½® `is_active=False` æ—¶ï¼ŒæœªåŒæ­¥è®¾ç½® `status="suspended"`
- `NotificationType` ä¸­ç¼ºå°‘ `USER_SUSPENDED` ç±»å‹
- æœªå‘é€æš‚åœé€šçŸ¥
- æœªæ’¤é”€æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨é£é™©ï¼‰

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šæ•°æ®ä¸ä¸€è‡´ï¼ˆ`is_active=False` ä½† `status="active"`ï¼‰
- é«˜ä¸¥é‡æ€§ï¼šå®‰å…¨é£é™©ï¼ˆç”¨æˆ·æš‚åœåä»å¯ä½¿ç”¨æ´»è·ƒä¼šè¯ï¼‰
- ä¸­ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è´¦æˆ·å·²è¢«æš‚åœ

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py - update_user
if user_update.is_active is not None:
    user.is_active = user_update.is_active
    # âŒ æ²¡æœ‰åŒæ­¥æ›´æ–° status å­—æ®µ
    # âŒ æ²¡æœ‰æ’¤é”€æ´»è·ƒä¼šè¯
    # âŒ æ²¡æœ‰å‘é€é€šçŸ¥
```

**ä¿®å¤å»ºè®®**ï¼š
```python
if user_update.is_active is not None:
    old_is_active = user.is_active
    user.is_active = user_update.is_active
    
    # âš ï¸ åŒæ­¥æ›´æ–° status å­—æ®µï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰
    if user_update.is_active == False and old_is_active == True:
        # ä» active å˜ä¸º inactiveï¼Œè®¾ç½®ä¸º suspended
        if user.status == "active":
            user.status = "suspended"
            
            # âš ï¸ å¼ºåˆ¶æ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨è¦æ±‚ï¼‰
            from modules.core.db import UserSession
            from datetime import datetime
            
            result = await db.execute(
                select(UserSession)
                .where(
                    UserSession.user_id == user.user_id,
                    UserSession.is_active == True,
                    UserSession.expires_at > datetime.utcnow()
                )
            )
            sessions = result.scalars().all()
            for session in sessions:
                session.is_active = False
                session.revoked_at = datetime.utcnow()
                session.revoked_reason = "è´¦æˆ·è¢«æš‚åœï¼Œå¼ºåˆ¶ç™»å‡º"
            
            # âš ï¸ å‘é€æš‚åœé€šçŸ¥ï¼ˆç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶å¯è§ï¼‰
            try:
                from backend.routers.notifications import notify_user_suspended
                await notify_user_suspended(
                    db=db,
                    user_id=user.user_id,
                    suspended_by=current_user.username,
                    reason="ç®¡ç†å‘˜æ‰‹åŠ¨æš‚åœ"
                )
            except Exception as e:
                logger.warning(f"[WARN] Failed to send suspension notification: {e}")
    elif user_update.is_active == True and old_is_active == False:
        # ä» inactive å˜ä¸º activeï¼Œè®¾ç½®ä¸º active
        if user.status == "suspended":
            user.status = "active"
```

**ç«™å†…é€šçŸ¥çš„ä»·å€¼**ï¼š
- ç”¨æˆ·ä¸‹æ¬¡å°è¯•ç™»å½•æ—¶ä¼šçœ‹åˆ°é€šçŸ¥ï¼š"æ‚¨çš„è´¦æˆ·å·²è¢«æš‚åœï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
- ä½œä¸ºå†å²è®°å½•ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹è´¦æˆ·çŠ¶æ€å˜æ›´å†å²

---

#### 56. update_user API ä¸­ status å’Œ is_active ä¸ä¸€è‡´ âš ï¸

**é—®é¢˜**ï¼š
- `update_user` API å¯ä»¥è®¾ç½® `is_active=False`ï¼Œä½†æ²¡æœ‰åŒæ­¥è®¾ç½® `status="suspended"`
- ææ¡ˆè¦æ±‚ `status` å’Œ `is_active` å¿…é¡»ä¿æŒä¸€è‡´
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼š`is_active=False` ä½† `status="active"`

**å½±å“**ï¼š
- é«˜ä¸¥é‡æ€§ï¼šæ•°æ®ä¸ä¸€è‡´ï¼Œè¿åè®¾è®¡åŸåˆ™
- å¯èƒ½å¯¼è‡´ç™»å½•æ£€æŸ¥é€»è¾‘æ··ä¹±

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py - update_user
if user_update.is_active is not None:
    user.is_active = user_update.is_active
    # âŒ æ²¡æœ‰åŒæ­¥æ›´æ–° status å­—æ®µ
```

**ä¿®å¤å»ºè®®**ï¼š
è§æ¼æ´ 55 çš„ä¿®å¤å»ºè®®ï¼ˆå·²åŒ…å«åŒæ­¥æ›´æ–° status çš„é€»è¾‘ï¼‰ã€‚

---

#### 57. è´¦æˆ·è‡ªåŠ¨é”å®šé€šçŸ¥ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- ç™»å½•å¤±è´¥ 5 æ¬¡åè´¦æˆ·è‡ªåŠ¨é”å®šï¼Œä½†æ²¡æœ‰é€šçŸ¥ç”¨æˆ·
- `NotificationType` ä¸­ç¼ºå°‘ `ACCOUNT_LOCKED` ç±»å‹
- ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è´¦æˆ·å·²è¢«é”å®š

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è´¦æˆ·å·²è¢«é”å®š
- æ³¨æ„ï¼šè´¦æˆ·è¢«é”å®šåï¼Œç”¨æˆ·æ— æ³•ç™»å½•ï¼Œä½†é€šçŸ¥ä¼šåœ¨ç”¨æˆ·ä¸‹æ¬¡å°è¯•ç™»å½•æ—¶å¯è§ï¼ˆå¦‚æœè´¦æˆ·å·²è§£é”ï¼‰

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/auth.py - login API
if user.failed_login_attempts >= MAX_FAILED_ATTEMPTS:
    user.locked_until = datetime.utcnow() + timedelta(minutes=LOCKOUT_DURATION_MINUTES)
    await db.commit()
    # âŒ æ²¡æœ‰é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è¢«é”å®š
    # âŒ æ²¡æœ‰æ’¤é”€æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨é£é™©ï¼‰
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# 1. åœ¨ NotificationType ä¸­æ·»åŠ  ACCOUNT_LOCKED
# backend/routers/notifications.py
class NotificationType(str, Enum):
    # ... ç°æœ‰ç±»å‹ ...
    ACCOUNT_LOCKED = "account_locked"

# 2. åˆ›å»ºé€šçŸ¥å‡½æ•°
async def notify_account_locked(
    db: AsyncSession,
    user_id: int,
    locked_until: datetime,
    reason: str = "å¤šæ¬¡ç™»å½•å¤±è´¥"
) -> Notification:
    """é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è¢«é”å®š"""
    user = await db.get(DimUser, user_id)
    if not user:
        return None
    
    remaining_minutes = int((locked_until - datetime.utcnow()).total_seconds() / 60)
    
    title = "è´¦æˆ·å·²è¢«é”å®š"
    content = f"æ‚¨çš„è´¦æˆ·å› {reason}å·²è¢«é”å®š {remaining_minutes} åˆ†é’Ÿã€‚è¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜è§£é”ã€‚"
    
    return await create_notification(
        db=db,
        recipient_id=user_id,
        notification_type=NotificationType.ACCOUNT_LOCKED,
        title=title,
        content=content,
        extra_data={
            "locked_until": locked_until.isoformat(),
            "reason": reason,
            "remaining_minutes": remaining_minutes
        }
    )

# 3. åœ¨ login API ä¸­è°ƒç”¨
if user.failed_login_attempts >= MAX_FAILED_ATTEMPTS:
    user.locked_until = datetime.utcnow() + timedelta(minutes=LOCKOUT_DURATION_MINUTES)
    await db.commit()
    
    # âš ï¸ å¼ºåˆ¶æ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨è¦æ±‚ï¼‰
    from modules.core.db import UserSession
    result = await db.execute(
        select(UserSession)
        .where(
            UserSession.user_id == user.user_id,
            UserSession.is_active == True,
            UserSession.expires_at > datetime.utcnow()
        )
    )
    sessions = result.scalars().all()
    for session in sessions:
        session.is_active = False
        session.revoked_at = datetime.utcnow()
        session.revoked_reason = "è´¦æˆ·è¢«é”å®šï¼Œå¼ºåˆ¶ç™»å‡º"
    
    # âš ï¸ é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è¢«é”å®š
    try:
        from backend.routers.notifications import notify_account_locked
        await notify_account_locked(
            db=db,
            user_id=user.user_id,
            locked_until=user.locked_until,
            reason="å¤šæ¬¡ç™»å½•å¤±è´¥"
        )
    except Exception as e:
        logger.warning(f"[WARN] Failed to send account locked notification: {e}")
```

**ç«™å†…é€šçŸ¥çš„ä»·å€¼**ï¼š
- ç”¨æˆ·ä¸‹æ¬¡å°è¯•ç™»å½•æ—¶ä¼šçœ‹åˆ°é€šçŸ¥ï¼š"æ‚¨çš„è´¦æˆ·å·²è¢«é”å®šï¼Œè¯·ç­‰å¾… X åˆ†é’Ÿåé‡è¯•"
- ä½œä¸ºå†å²è®°å½•ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹è´¦æˆ·çŠ¶æ€å˜æ›´å†å²

---

#### 58. è´¦æˆ·è‡ªåŠ¨è§£é”é€šçŸ¥ç¼ºå¤± âš ï¸

**é—®é¢˜**ï¼š
- é”å®šè¿‡æœŸåè‡ªåŠ¨è§£é”ï¼Œä½†æ²¡æœ‰é€šçŸ¥ç”¨æˆ·
- ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è´¦æˆ·å·²è§£é”

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šç”¨æˆ·ä½“éªŒä¸ä½³ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“è´¦æˆ·å·²è§£é”
- æ³¨æ„ï¼šè´¦æˆ·è§£é”æ—¶ï¼Œç”¨æˆ·å¯èƒ½æ— æ³•ç™»å½•ï¼ˆå¦‚æœè´¦æˆ·è¢«é”å®šï¼‰ï¼Œä½†é€šçŸ¥ä¼šåœ¨ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶å¯è§

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/auth.py - login API
elif user.locked_until and user.locked_until <= datetime.utcnow():
    # é”å®šå·²è¿‡æœŸï¼Œè‡ªåŠ¨è§£é”
    user.locked_until = None
    user.failed_login_attempts = 0
    await db.commit()
    # âŒ æ²¡æœ‰é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è‡ªåŠ¨è§£é”
```

**ä¿®å¤å»ºè®®**ï¼š
```python
elif user.locked_until and user.locked_until <= datetime.utcnow():
    # é”å®šå·²è¿‡æœŸï¼Œè‡ªåŠ¨è§£é”
    user.locked_until = None
    user.failed_login_attempts = 0
    await db.commit()
    
    # âš ï¸ é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è‡ªåŠ¨è§£é”ï¼ˆå¤ç”¨ notify_account_unlockedï¼‰
    try:
        from backend.routers.notifications import notify_account_unlocked
        await notify_account_unlocked(
            db=db,
            user_id=user.user_id,
            unlocked_by="system",
            reason="é”å®šæ—¶é—´å·²è¿‡æœŸï¼Œè‡ªåŠ¨è§£é”"
        )
    except Exception as e:
        logger.warning(f"[WARN] Failed to send account unlocked notification: {e}")
```

**ç«™å†…é€šçŸ¥çš„ä»·å€¼**ï¼š
- ç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶ä¼šçœ‹åˆ°é€šçŸ¥ï¼š"æ‚¨çš„è´¦æˆ·é”å®šå·²è¿‡æœŸï¼Œå¯ä»¥é‡æ–°ç™»å½•"
- ä½œä¸ºå†å²è®°å½•ï¼Œç”¨æˆ·å¯ä»¥æŸ¥çœ‹è´¦æˆ·çŠ¶æ€å˜æ›´å†å²

---

#### 59. å¯†ç é‡ç½®/è´¦æˆ·é”å®š/ç”¨æˆ·æš‚åœåæœªæ’¤é”€æ´»è·ƒä¼šè¯ âš ï¸

**é—®é¢˜**ï¼š
- å¯†ç é‡ç½®åï¼Œæœªæ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨é£é™©ï¼‰
- è´¦æˆ·é”å®šåï¼Œæœªæ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨é£é™©ï¼‰
- ç”¨æˆ·æš‚åœåï¼Œæœªæ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆå®‰å…¨é£é™©ï¼‰
- ç”¨æˆ·å¯èƒ½ç»§ç»­ä½¿ç”¨æ—§ä¼šè¯è¿›è¡Œæ“ä½œ

**å½±å“**ï¼š
- **P0 ä¸¥é‡æ€§**ï¼šå®‰å…¨é£é™©ï¼Œç”¨æˆ·å¯èƒ½ç»§ç»­ä½¿ç”¨æ—§ä¼šè¯è¿›è¡Œæ“ä½œ
- å¯†ç é‡ç½®åï¼Œç”¨æˆ·ä»å¯ä½¿ç”¨æ—§å¯†ç çš„ token ç»§ç»­æ“ä½œ
- è´¦æˆ·é”å®šåï¼Œç”¨æˆ·ä»å¯ä½¿ç”¨æ´»è·ƒä¼šè¯ç»§ç»­æ“ä½œ
- ç”¨æˆ·æš‚åœåï¼Œç”¨æˆ·ä»å¯ä½¿ç”¨æ´»è·ƒä¼šè¯ç»§ç»­æ“ä½œ

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py - reset_user_password
# é‡ç½®å¯†ç 
user.password_hash = auth_service.hash_password(new_password)
await db.commit()
# âŒ æ²¡æœ‰æ’¤é”€æ´»è·ƒä¼šè¯

# backend/routers/auth.py - login APIï¼ˆè´¦æˆ·é”å®šï¼‰
if user.failed_login_attempts >= MAX_FAILED_ATTEMPTS:
    user.locked_until = datetime.utcnow() + timedelta(minutes=30)
    await db.commit()
    # âŒ æ²¡æœ‰æ’¤é”€æ´»è·ƒä¼šè¯

# backend/routers/users.py - update_userï¼ˆç”¨æˆ·æš‚åœï¼‰
if user_update.is_active == False:
    user.is_active = user_update.is_active
    # âŒ æ²¡æœ‰æ’¤é”€æ´»è·ƒä¼šè¯
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# åˆ›å»ºé€šç”¨å‡½æ•°ï¼šæ’¤é”€ç”¨æˆ·æ‰€æœ‰æ´»è·ƒä¼šè¯
async def revoke_all_user_sessions(
    db: AsyncSession,
    user_id: int,
    reason: str
) -> int:
    """æ’¤é”€ç”¨æˆ·æ‰€æœ‰æ´»è·ƒä¼šè¯"""
    from modules.core.db import UserSession
    from datetime import datetime
    
    result = await db.execute(
        select(UserSession)
        .where(
            UserSession.user_id == user_id,
            UserSession.is_active == True,
            UserSession.expires_at > datetime.utcnow()
        )
    )
    sessions = result.scalars().all()
    
    revoked_count = 0
    for session in sessions:
        session.is_active = False
        session.revoked_at = datetime.utcnow()
        session.revoked_reason = reason
        revoked_count += 1
    
    return revoked_count

# 1. å¯†ç é‡ç½®åæ’¤é”€ä¼šè¯
await revoke_all_user_sessions(
    db=db,
    user_id=user.user_id,
    reason="å¯†ç é‡ç½®ï¼Œå¼ºåˆ¶ç™»å‡º"
)

# 2. è´¦æˆ·é”å®šåæ’¤é”€ä¼šè¯
await revoke_all_user_sessions(
    db=db,
    user_id=user.user_id,
    reason="è´¦æˆ·è¢«é”å®šï¼Œå¼ºåˆ¶ç™»å‡º"
)

# 3. ç”¨æˆ·æš‚åœåæ’¤é”€ä¼šè¯
await revoke_all_user_sessions(
    db=db,
    user_id=user.user_id,
    reason="è´¦æˆ·è¢«æš‚åœï¼Œå¼ºåˆ¶ç™»å‡º"
)
```

**å®‰å…¨è¦æ±‚**ï¼š
- å¯†ç é‡ç½®åï¼Œå¿…é¡»å¼ºåˆ¶æ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯
- è´¦æˆ·é”å®šåï¼Œå¿…é¡»å¼ºåˆ¶æ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯
- ç”¨æˆ·æš‚åœåï¼Œå¿…é¡»å¼ºåˆ¶æ’¤é”€æ‰€æœ‰æ´»è·ƒä¼šè¯

---

#### 60. NotificationType ä¸­ç¼ºå°‘ ACCOUNT_LOCKED å’Œ ACCOUNT_UNLOCKED âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆè¦æ±‚æ·»åŠ  `ACCOUNT_LOCKED` å’Œ `ACCOUNT_UNLOCKED` é€šçŸ¥ç±»å‹
- å®é™…ä»£ç ä¸­åªæœ‰ `PASSWORD_RESET` å’Œ `USER_SUSPENDED`
- ç¼ºå°‘è¿™ä¸¤ä¸ªç±»å‹ä¼šå¯¼è‡´é€šçŸ¥å‡½æ•°æ— æ³•æ­£å¸¸å·¥ä½œ

**å½±å“**ï¼š
- **P0 ä¸¥é‡æ€§**ï¼šé€šçŸ¥ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œï¼Œè´¦æˆ·é”å®š/è§£é”é€šçŸ¥æ— æ³•å‘é€

**å½“å‰å®ç°**ï¼š
```python
# backend/schemas/notification.py
class NotificationType(str, Enum):
    USER_REGISTERED = "user_registered"
    USER_APPROVED = "user_approved"
    USER_REJECTED = "user_rejected"
    USER_SUSPENDED = "user_suspended"  # âœ… å­˜åœ¨
    PASSWORD_RESET = "password_reset"  # âœ… å­˜åœ¨
    # âŒ ç¼ºå°‘ ACCOUNT_LOCKED
    # âŒ ç¼ºå°‘ ACCOUNT_UNLOCKED
    SYSTEM_ALERT = "system_alert"
```

**ä¿®å¤å»ºè®®**ï¼š
```python
# backend/schemas/notification.py
class NotificationType(str, Enum):
    USER_REGISTERED = "user_registered"
    USER_APPROVED = "user_approved"
    USER_REJECTED = "user_rejected"
    USER_SUSPENDED = "user_suspended"
    PASSWORD_RESET = "password_reset"
    ACCOUNT_LOCKED = "account_locked"  # âš ï¸ éœ€è¦æ·»åŠ 
    ACCOUNT_UNLOCKED = "account_unlocked"  # âš ï¸ éœ€è¦æ·»åŠ 
    SYSTEM_ALERT = "system_alert"
```

---

#### 61. ç¼ºå°‘é€šçŸ¥å‡½æ•°å®ç° âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆè¦æ±‚åˆ›å»º `notify_account_locked`ã€`notify_account_unlocked`ã€`notify_user_suspended` å‡½æ•°
- å®é™…ä»£ç ä¸­åªæœ‰ `notify_password_reset` å­˜åœ¨
- ç¼ºå°‘è¿™äº›å‡½æ•°ä¼šå¯¼è‡´ç›¸å…³ API æ— æ³•å‘é€é€šçŸ¥

**å½±å“**ï¼š
- **P0 ä¸¥é‡æ€§**ï¼šé€šçŸ¥ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œï¼Œè´¦æˆ·é”å®š/è§£é”/æš‚åœé€šçŸ¥æ— æ³•å‘é€

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/notifications.py
# âœ… notify_password_reset å­˜åœ¨ï¼ˆç¬¬515è¡Œï¼‰
# âŒ notify_account_locked ä¸å­˜åœ¨
# âŒ notify_account_unlocked ä¸å­˜åœ¨
# âŒ notify_user_suspended ä¸å­˜åœ¨
```

**ä¿®å¤å»ºè®®**ï¼š
åœ¨ `backend/routers/notifications.py` ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼š

```python
async def notify_account_locked(
    db: AsyncSession,
    user_id: int,
    locked_until: datetime,
    reason: str = "å¤šæ¬¡ç™»å½•å¤±è´¥"
) -> Notification:
    """é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è¢«é”å®š"""
    user = await db.get(DimUser, user_id)
    if not user:
        return None
    
    remaining_minutes = int((locked_until - datetime.utcnow()).total_seconds() / 60)
    
    title = "è´¦æˆ·å·²è¢«é”å®š"
    content = f"æ‚¨çš„è´¦æˆ·å› {reason}å·²è¢«é”å®š {remaining_minutes} åˆ†é’Ÿã€‚è¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜è§£é”ã€‚"
    
    return await create_notification(
        db=db,
        recipient_id=user_id,
        notification_type=NotificationType.ACCOUNT_LOCKED,
        title=title,
        content=content,
        extra_data={
            "locked_until": locked_until.isoformat(),
            "reason": reason,
            "remaining_minutes": remaining_minutes
        }
    )


async def notify_account_unlocked(
    db: AsyncSession,
    user_id: int,
    unlocked_by: str = "system",
    reason: str = None
) -> Notification:
    """é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è§£é”"""
    user = await db.get(DimUser, user_id)
    if not user:
        return None
    
    title = "è´¦æˆ·å·²è§£é”"
    content = f"æ‚¨çš„è´¦æˆ·å·²è¢«{unlocked_by}è§£é”"
    if reason:
        content += f"ï¼ŒåŸå› ï¼š{reason}"
    content += "ã€‚æ‚¨ç°åœ¨å¯ä»¥é‡æ–°ç™»å½•ã€‚"
    
    return await create_notification(
        db=db,
        recipient_id=user_id,
        notification_type=NotificationType.ACCOUNT_UNLOCKED,
        title=title,
        content=content,
        extra_data={
            "unlocked_by": unlocked_by,
            "reason": reason
        }
    )


async def notify_user_suspended(
    db: AsyncSession,
    user_id: int,
    suspended_by: str,
    reason: str = None
) -> Notification:
    """é€šçŸ¥ç”¨æˆ·è´¦æˆ·å·²è¢«æš‚åœ"""
    user = await db.get(DimUser, user_id)
    if not user:
        return None
    
    title = "è´¦æˆ·å·²è¢«æš‚åœ"
    content = f"æ‚¨çš„è´¦æˆ·å·²è¢«{suspended_by}æš‚åœ"
    if reason:
        content += f"ï¼ŒåŸå› ï¼š{reason}"
    content += "ã€‚è¯·è”ç³»ç®¡ç†å‘˜äº†è§£è¯¦æƒ…ã€‚"
    
    return await create_notification(
        db=db,
        recipient_id=user_id,
        notification_type=NotificationType.USER_SUSPENDED,
        title=title,
        content=content,
        extra_data={
            "suspended_by": suspended_by,
            "reason": reason
        }
    )
```

---

#### 62. P1 å®‰å…¨è¦æ±‚ç¼–å·é‡å¤ âš ï¸

**é—®é¢˜**ï¼š
- `proposal.md` ä¸­ P1 å®‰å…¨è¦æ±‚ä» 10 å¼€å§‹ç¼–å·
- ä½†å‰é¢å·²ç»æœ‰ 1-10 çš„ P0 è¦æ±‚
- è¿™ä¼šå¯¼è‡´ç¼–å·æ··ä¹±ï¼ˆP0 æœ‰ 1-10ï¼ŒP1 ä¹Ÿæœ‰ 10-17ï¼‰

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šæ–‡æ¡£å¯è¯»æ€§ä¸‹é™ï¼Œå¯èƒ½å¯¼è‡´æ··æ·†

**å½“å‰çŠ¶æ€**ï¼š
```markdown
#### P0 å®‰å…¨è¦æ±‚ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. å¯†ç é‡ç½®/è´¦æˆ·é”å®š/ç”¨æˆ·æš‚åœåå¼ºåˆ¶æ’¤é”€æ´»è·ƒä¼šè¯
2. WebSocket è®¤è¯å’Œæƒé™éªŒè¯
...
10. å¿«é€Ÿæ“ä½œæƒé™éªŒè¯

#### P1 å®‰å…¨è¦æ±‚ï¼ˆå»ºè®®ä¿®å¤ï¼‰
10. WebSocket é™çº§æ–¹æ¡ˆ  # âŒ ç¼–å·é‡å¤
11. æµè§ˆå™¨é€šçŸ¥å†…å®¹éªŒè¯
...
17. é€šçŸ¥è®¾ç½®æŒä¹…åŒ–
```

**ä¿®å¤å»ºè®®**ï¼š
å°† P1 å®‰å…¨è¦æ±‚é‡æ–°ç¼–å·ä¸º 1-8ï¼ˆæˆ– 18-25ï¼Œå¦‚æœä¿æŒè¿ç»­ç¼–å·ï¼‰ã€‚

---

#### 63. å®¡æ‰¹ API é€Ÿç‡é™åˆ¶å®æ–½çŠ¶æ€ä¸æ˜ç¡® âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆè¦æ±‚å®¡æ‰¹ API æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆ`@limiter.limit("20/minute")`ï¼‰
- ä»£ç ä¸­æœªæ‰¾åˆ° `@limiter` è£…é¥°å™¨
- æ— æ³•ç¡®è®¤æ˜¯å¦å·²å®æ–½

**å½±å“**ï¼š
- ä¸­ä¸¥é‡æ€§ï¼šå¦‚æœæœªå®æ–½ï¼Œå¯èƒ½å¯¼è‡´ API è¢«æ»¥ç”¨

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/users.py
@router.post("/{user_id}/approve")
async def approve_user(...):  # âŒ æ²¡æœ‰çœ‹åˆ° @limiter è£…é¥°å™¨

@router.post("/{user_id}/reject")
async def reject_user(...):  # âŒ æ²¡æœ‰çœ‹åˆ° @limiter è£…é¥°å™¨

@router.get("/pending")
async def get_pending_users(...):  # âŒ æ²¡æœ‰çœ‹åˆ° @limiter è£…é¥°å™¨
```

**ä¿®å¤å»ºè®®**ï¼š
1. ç¡®è®¤æ˜¯å¦å·²æ·»åŠ é€Ÿç‡é™åˆ¶
2. å¦‚æœæœªæ·»åŠ ï¼Œéœ€è¦è¡¥å……ï¼š
```python
from backend.middleware.rate_limiter import limiter

@router.post("/{user_id}/approve")
@limiter.limit("20/minute")
async def approve_user(...):
    ...

@router.post("/{user_id}/reject")
@limiter.limit("20/minute")
async def reject_user(...):
    ...

@router.get("/pending")
@limiter.limit("30/minute")
async def get_pending_users(...):
    ...
```

---

#### 64. ææ¡ˆæ–‡æ¡£ä¸­çŠ¶æ€æµè½¬å›¾ä¸å®Œæ•´ âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆä¸­çš„çŠ¶æ€æµè½¬å›¾æœªåŒ…å« `suspended` çŠ¶æ€å¦‚ä½•æ¢å¤ä¸º `active`
- ç¼ºå°‘ `suspended â†’ active` çš„æµè½¬è·¯å¾„

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šæ–‡æ¡£ä¸å®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´å®æ–½æ—¶é—æ¼æ¢å¤åŠŸèƒ½

**å½“å‰çŠ¶æ€æµè½¬**ï¼š
```
æ³¨å†Œ â†’ pending â†’ (ç®¡ç†å‘˜å®¡æ‰¹) â†’ active (å¯ç™»å½•)
                      â†“
                   rejected (è¢«æ‹’ç»)

active â†’ (ç®¡ç†å‘˜æ“ä½œ) â†’ suspended (æš‚åœ)
          â†“
        deleted (è½¯åˆ é™¤)
```

**ä¿®å¤å»ºè®®**ï¼š
æ·»åŠ  `suspended â†’ active` çš„æ¢å¤è·¯å¾„ï¼š
```
æ³¨å†Œ â†’ pending â†’ (ç®¡ç†å‘˜å®¡æ‰¹) â†’ active (å¯ç™»å½•)
                      â†“
                   rejected (è¢«æ‹’ç»)

active â†’ (ç®¡ç†å‘˜æ“ä½œ) â†’ suspended (æš‚åœ)
          â†“                    â†“
        deleted (è½¯åˆ é™¤)    (ç®¡ç†å‘˜æ¢å¤) â†’ active
```

---

#### 65. ææ¡ˆæ–‡æ¡£ä¸­ç¼ºå°‘é€šçŸ¥å‡½æ•°çš„è°ƒç”¨ä½ç½®è¯´æ˜ âš ï¸

**é—®é¢˜**ï¼š
- ææ¡ˆè¦æ±‚åˆ›å»ºå¤šä¸ªé€šçŸ¥å‡½æ•°ï¼Œä½†æœªæ˜ç¡®è¯´æ˜åœ¨å“ªäº› API ä¸­è°ƒç”¨
- å¯èƒ½å¯¼è‡´å®æ–½æ—¶é—æ¼

**å½±å“**ï¼š
- ä½ä¸¥é‡æ€§ï¼šæ–‡æ¡£ä¸å®Œæ•´ï¼Œå¯èƒ½å¯¼è‡´å®æ–½é—æ¼

**ä¿®å¤å»ºè®®**ï¼š
åœ¨ `design.md` ä¸­æ˜ç¡®åˆ—å‡ºæ¯ä¸ªé€šçŸ¥å‡½æ•°çš„è°ƒç”¨ä½ç½®ï¼š
- `notify_password_reset` â†’ `reset_user_password` API
- `notify_account_locked` â†’ `login` APIï¼ˆè´¦æˆ·é”å®šåï¼‰
- `notify_account_unlocked` â†’ `unlock_user_account` API å’Œ `login` APIï¼ˆè‡ªåŠ¨è§£é”ï¼‰
- `notify_user_suspended` â†’ `update_user` APIï¼ˆç”¨æˆ·æš‚åœåï¼‰

---

## Phase 1-7 æœ€ç»ˆå®¡æŸ¥é—®é¢˜ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| NotificationType ä¸­ç¼ºå°‘ ACCOUNT_LOCKED å’Œ ACCOUNT_UNLOCKED | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ |
| ç¼ºå°‘é€šçŸ¥å‡½æ•°å®ç° | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ |
| å¯†ç é‡ç½®/è´¦æˆ·é”å®š/ç”¨æˆ·æš‚åœåæœªæ’¤é”€æ´»è·ƒä¼šè¯ | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ |
| update_user API ä¸­ status å’Œ is_active ä¸ä¸€è‡´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å¯†ç é‡ç½®é€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è´¦æˆ·è§£é”é€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| ç”¨æˆ·æš‚åœé€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è´¦æˆ·è‡ªåŠ¨é”å®šé€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è´¦æˆ·è‡ªåŠ¨è§£é”é€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹ API é€Ÿç‡é™åˆ¶å®æ–½çŠ¶æ€ä¸æ˜ç¡® | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| PendingUserResponse ç¼ºå°‘ status å­—æ®µ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è§’è‰² ID éªŒè¯ä¸å®Œæ•´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥å‡½æ•°é”™è¯¯å¤„ç†ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| P1 å®‰å…¨è¦æ±‚ç¼–å·é‡å¤ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| ææ¡ˆæ–‡æ¡£ä¸­çŠ¶æ€æµè½¬å›¾ä¸å®Œæ•´ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| ææ¡ˆæ–‡æ¡£ä¸­ç¼ºå°‘é€šçŸ¥å‡½æ•°çš„è°ƒç”¨ä½ç½®è¯´æ˜ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹ API ä¸­ IP å’Œ User-Agent è·å–ä¸å®Œæ•´ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**ä¿®å¤è¿™äº›é—®é¢˜åï¼Œå®æ–½ä¸ææ¡ˆå°†å®Œå…¨ä¸€è‡´ã€‚**

---

## Phase 1-7 æœ€ç»ˆå®¡æŸ¥å‘ç°çš„æ–°é—®é¢˜ï¼ˆ2026-01-05 ç¬¬äºŒæ¬¡å®¡æŸ¥ï¼‰

### P0 ä¸¥é‡æ¼æ´ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

#### 66. Tokenåˆ·æ–°APIç¼ºå°‘è´¦æˆ·çŠ¶æ€æ£€æŸ¥ âš ï¸

**é—®é¢˜**ï¼š
- `refresh_token` APIï¼ˆ`backend/routers/auth.py:545-676`ï¼‰åªéªŒè¯äº† refresh token çš„æœ‰æ•ˆæ€§
- æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼ˆ`status`ï¼‰
- æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ´»è·ƒï¼ˆ`is_active`ï¼‰
- æ²¡æœ‰æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«é”å®šï¼ˆ`locked_until`ï¼‰
- æ²¡æœ‰æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è¢«æ’¤é”€ï¼ˆ`is_active=False`ï¼‰

**å½±å“**ï¼š
- **P0 ä¸¥é‡æ€§**ï¼šè´¦æˆ·è¢«æš‚åœã€é”å®šæˆ–å¯†ç é‡ç½®åï¼Œç”¨æˆ·ä»å¯ä½¿ç”¨æ—§çš„ refresh token åˆ·æ–° access token
- ç»•è¿‡å®‰å…¨æ§åˆ¶ï¼Œç»§ç»­è®¿é—®ç³»ç»Ÿ

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/auth.py:575-578
new_tokens = await auth_service.refresh_token_pair(refresh_token_value)
# âŒ æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·è´¦æˆ·çŠ¶æ€
# âŒ æ²¡æœ‰æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«é”å®š
# âŒ æ²¡æœ‰æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è¢«æ’¤é”€
```

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ `refresh_token` API ä¸­ï¼ŒéªŒè¯ refresh token åï¼š
  1. ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
  2. æ£€æŸ¥ `status == "active"` ä¸” `is_active == True`
  3. æ£€æŸ¥ `locked_until`ï¼ˆå¦‚æœå­˜åœ¨ä¸”æœªè¿‡æœŸï¼Œæ‹’ç»åˆ·æ–°ï¼‰
  4. æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è¢«æ’¤é”€ï¼ˆ`is_active=False`ï¼‰
  5. ä»¥ä¸Šä»»ä¸€ä¸æ»¡è¶³ï¼Œæ‹’ç»åˆ·æ–°å¹¶è¿”å›ç›¸åº”é”™è¯¯

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# backend/routers/auth.py:refresh_token
try:
    new_tokens = await auth_service.refresh_token_pair(refresh_token_value)
    
    # âš ï¸ æ–°å¢ï¼šæ£€æŸ¥ç”¨æˆ·è´¦æˆ·çŠ¶æ€
    payload = auth_service.verify_token(refresh_token_value)
    user_id = payload.get("user_id")
    
    if user_id:
        async with AsyncSessionLocal() as temp_db:
            # è·å–ç”¨æˆ·ä¿¡æ¯
            user_result = await temp_db.execute(
                select(DimUser).where(DimUser.user_id == user_id)
            )
            user = user_result.scalar_one_or_none()
            
            if not user:
                return error_response(
                    code=ErrorCode.AUTH_TOKEN_INVALID,
                    message="User not found",
                    status_code=401
                )
            
            # æ£€æŸ¥è´¦æˆ·çŠ¶æ€
            if user.status != "active" or not user.is_active:
                return error_response(
                    code=ErrorCode.AUTH_ACCOUNT_INACTIVE,
                    message="è´¦å·æœªæ¿€æ´»",
                    status_code=403
                )
            
            # æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«é”å®š
            if user.locked_until and user.locked_until > datetime.utcnow():
                return error_response(
                    code=ErrorCode.AUTH_ACCOUNT_LOCKED,
                    message="è´¦æˆ·å·²è¢«é”å®š",
                    status_code=403
                )
            
            # æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è¢«æ’¤é”€
            session_result = await temp_db.execute(
                select(UserSession)
                .where(
                    UserSession.user_id == user_id,
                    UserSession.is_active == True
                )
                .order_by(UserSession.last_active_at.desc())
                .limit(1)
            )
            session = session_result.scalar_one_or_none()
            
            if not session or session.is_active == False:
                return error_response(
                    code=ErrorCode.AUTH_TOKEN_INVALID,
                    message="Session has been revoked",
                    status_code=401
                )
            
            # ç»§ç»­æ›´æ–°ä¼šè¯...
```

---

### P1 ä¸­ä¸¥é‡æ¼æ´ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 67. get_current_user ç¼ºå°‘ status å­—æ®µæ£€æŸ¥ âš ï¸

**é—®é¢˜**ï¼š
- `get_current_user`ï¼ˆ`backend/routers/auth.py:40-98`ï¼‰åªæ£€æŸ¥äº† `is_active`ï¼Œæ²¡æœ‰æ£€æŸ¥ `status` å­—æ®µ
- `status="suspended"` ä½† `is_active=True` çš„ç”¨æˆ·ä»ç„¶å¯ä»¥é€šè¿‡ token éªŒè¯

**å½±å“**ï¼š
- **P1 ä¸¥é‡æ€§**ï¼šè¢«æš‚åœçš„ç”¨æˆ·ä»å¯ä½¿ç”¨ç°æœ‰ token è®¿é—®ç³»ç»Ÿ
- è™½ç„¶ç™»å½• API æ£€æŸ¥äº† statusï¼Œä½† token åˆ·æ–°å’Œ get_current_user æ²¡æœ‰æ£€æŸ¥

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/auth.py:84-88
if not user or not user.is_active:
    raise HTTPException(
        status_code=401,
        detail="User not found or inactive"
    )
# âŒ æ²¡æœ‰æ£€æŸ¥ user.status == "active"
```

**ä¿®å¤å»ºè®®**ï¼š
- åœ¨ `get_current_user` ä¸­æ·»åŠ  `status` æ£€æŸ¥ï¼š
```python
if not user or not user.is_active or user.status != "active":
    raise HTTPException(
        status_code=401,
        detail="User not found or inactive"
    )
```

---

#### 68. ä¼šè¯æ›´æ–°æ—¶æ²¡æœ‰æ£€æŸ¥è´¦æˆ·çŠ¶æ€å’Œä¼šè¯æ’¤é”€çŠ¶æ€ âš ï¸

**é—®é¢˜**ï¼š
- `refresh_token` API æ›´æ–°ä¼šè¯æ—¶ï¼ˆç¬¬610-616è¡Œï¼‰æ²¡æœ‰æ£€æŸ¥ï¼š
  - ç”¨æˆ·è´¦æˆ·çŠ¶æ€
  - ä¼šè¯æ˜¯å¦å·²è¢«æ’¤é”€ï¼ˆ`is_active=False`ï¼‰
- å³ä½¿ä¼šè¯å·²è¢«æ’¤é”€ï¼Œä»£ç ä»ç„¶ä¼šå°†å…¶é‡æ–°æ¿€æ´»

**å½±å“**ï¼š
- **P1 ä¸¥é‡æ€§**ï¼šå·²è¢«æ’¤é”€çš„ä¼šè¯å¯èƒ½è¢«é‡æ–°æ¿€æ´»
- è´¦æˆ·çŠ¶æ€å˜æ›´åï¼Œä¼šè¯ç®¡ç†ä¸ä¸€è‡´

**å½“å‰å®ç°**ï¼š
```python
# backend/routers/auth.py:610-616
if session:
    # âŒ æ²¡æœ‰æ£€æŸ¥ session.is_active
    # âŒ æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·è´¦æˆ·çŠ¶æ€
    session.is_active = True  # å¯èƒ½é‡æ–°æ¿€æ´»å·²è¢«æ’¤é”€çš„ä¼šè¯
    await temp_db.commit()
```

**ä¿®å¤å»ºè®®**ï¼š
- æ›´æ–°ä¼šè¯å‰æ£€æŸ¥ï¼š
  1. ä¼šè¯æ˜¯å¦å·²è¢«æ’¤é”€ï¼ˆ`session.is_active == False`ï¼‰
  2. ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼ˆ`status == "active"` ä¸” `is_active == True`ï¼‰
  3. è´¦æˆ·æ˜¯å¦è¢«é”å®š
- å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œä¸æ›´æ–°ä¼šè¯ï¼Œè¿”å›é”™è¯¯

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# backend/routers/auth.py:refresh_token
session = session_result.scalar_one_or_none()

if session:
    # âš ï¸ æ–°å¢ï¼šæ£€æŸ¥ä¼šè¯å’Œè´¦æˆ·çŠ¶æ€
    if session.is_active == False:
        return error_response(
            code=ErrorCode.AUTH_TOKEN_INVALID,
            message="Session has been revoked",
            status_code=401
        )
    
    # è·å–ç”¨æˆ·ä¿¡æ¯å¹¶æ£€æŸ¥çŠ¶æ€
    user_result = await temp_db.execute(
        select(DimUser).where(DimUser.user_id == user_id)
    )
    user = user_result.scalar_one_or_none()
    
    if not user or user.status != "active" or not user.is_active:
        return error_response(
            code=ErrorCode.AUTH_ACCOUNT_INACTIVE,
            message="Account is not active",
            status_code=403
        )
    
    # æ›´æ–°ä¼šè¯ä¿¡æ¯
    session.session_id = new_session_id
    session.last_active_at = datetime.utcnow()
    session.expires_at = datetime.utcnow() + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    session.is_active = True
    await temp_db.commit()
```

---

## Phase 1-7 æœ€ç»ˆå®¡æŸ¥é—®é¢˜ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“ï¼ˆæ›´æ–°ï¼‰

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|---------|--------|------|
| NotificationType ä¸­ç¼ºå°‘ ACCOUNT_LOCKED å’Œ ACCOUNT_UNLOCKED | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ |
| ç¼ºå°‘é€šçŸ¥å‡½æ•°å®ç° | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ |
| å¯†ç é‡ç½®/è´¦æˆ·é”å®š/ç”¨æˆ·æš‚åœåæœªæ’¤é”€æ´»è·ƒä¼šè¯ | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ |
| **Tokenåˆ·æ–°APIç¼ºå°‘è´¦æˆ·çŠ¶æ€æ£€æŸ¥** | **P0** | **å¿…é¡»ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| update_user API ä¸­ status å’Œ is_active ä¸ä¸€è‡´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å¯†ç é‡ç½®é€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è´¦æˆ·è§£é”é€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| ç”¨æˆ·æš‚åœé€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è´¦æˆ·è‡ªåŠ¨é”å®šé€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è´¦æˆ·è‡ªåŠ¨è§£é”é€šçŸ¥ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹ API é€Ÿç‡é™åˆ¶å®æ–½çŠ¶æ€ä¸æ˜ç¡® | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| PendingUserResponse ç¼ºå°‘ status å­—æ®µ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| è§’è‰² ID éªŒè¯ä¸å®Œæ•´ | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| é€šçŸ¥å‡½æ•°é”™è¯¯å¤„ç†ç¼ºå¤± | P1 | å»ºè®®ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| **get_current_user ç¼ºå°‘ status å­—æ®µæ£€æŸ¥** | **P1** | **å»ºè®®ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| **ä¼šè¯æ›´æ–°æ—¶æ²¡æœ‰æ£€æŸ¥è´¦æˆ·çŠ¶æ€å’Œä¼šè¯æ’¤é”€çŠ¶æ€** | **P1** | **å»ºè®®ä¿®å¤** | ğŸ“‹ å¾…ä¿®å¤ï¼ˆæ–°å¢ï¼‰ |
| P1 å®‰å…¨è¦æ±‚ç¼–å·é‡å¤ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| ææ¡ˆæ–‡æ¡£ä¸­çŠ¶æ€æµè½¬å›¾ä¸å®Œæ•´ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| ææ¡ˆæ–‡æ¡£ä¸­ç¼ºå°‘é€šçŸ¥å‡½æ•°çš„è°ƒç”¨ä½ç½®è¯´æ˜ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |
| å®¡æ‰¹ API ä¸­ IP å’Œ User-Agent è·å–ä¸å®Œæ•´ | P2 | å¯é€‰ä¿®å¤ | ğŸ“‹ å¾…ä¿®å¤ |

**ä¿®å¤è¿™äº›é—®é¢˜åï¼Œå®æ–½ä¸ææ¡ˆå°†å®Œå…¨ä¸€è‡´ã€‚**

**æ€»æ¼æ´æ•°ï¼š68ï¼ˆP0: 13, P1: 34, P2: 21ï¼‰**

