# Change: 基于角色的限流配置设计

> **状态**: ✅ 全部完成（Phase 0/1/2/3）  
> **创建日期**: 2026-01-04  
> **修复日期**: 2026-01-04  
> **审查日期**: 2026-01-05  
> **完成日期**: 2026-01-05  
> **优先级**: P0 - 生产环境关键问题  
> **漏洞修复**: [VULNERABILITY_FIXES.md](VULNERABILITY_FIXES.md) - 所有 P0 和 P1 漏洞已修复

## Why

当前限流系统存在以下问题：

### 1. 角色映射不完整（高严重性）

- **问题**：限流配置中的 `premium` 角色在系统中不存在
- **影响**：无法为实际角色（manager、operator、finance）配置合适的限流配额
- **场景**：主管、操作员、财务等角色使用默认限流，无法体现业务差异

### 2. 限流配额不合理（中严重性）

- **问题**：所有非 admin 用户使用相同的限流配额
- **影响**：无法根据角色职责分配不同的限流配额
- **场景**：财务需要查看大量报表，但限流配额与操作员相同

### 3. 配置缺乏灵活性（中严重性）

- **问题**：限流配置硬编码在代码中
- **影响**：调整限流配额需要修改代码并重新部署
- **场景**：业务需求变化时，无法快速调整限流配置

### 4. ⚠️ 基于角色的限流未被实际使用（严重性 - P0）

- **问题**：虽然实现了 `get_rate_limit_for_endpoint()` 函数，但所有 API 端点仍使用硬编码限流值
- **影响**：所有用户使用相同的限流配额，无法体现角色差异，提案目标未达成
- **场景**：财务、主管等角色无法获得更高配额，与普通用户相同
- **发现日期**：2026-01-05

## What Changes

### Phase 0: 修复基础漏洞 - ✅ 已完成

#### 0.1 更新限流配置

- [x] 移除不存在的 `premium` 角色
- [x] 添加实际角色：`manager`（主管）、`operator`（操作员）、`finance`（财务）
- [x] 设计合理的限流配额策略

#### 0.2 完善角色映射逻辑

- [x] 更新 `get_user_rate_limit_tier()` 函数
- [x] 支持 `role_code` 和 `role_name` 两种映射方式
- [x] 添加角色优先级（admin > manager > finance > operator）

### Phase 1: 实际应用基于角色的限流 - ✅ 已完成

#### 1.1 创建动态限流装饰器

- [x] 创建 `role_based_rate_limit()` 装饰器
- [x] 支持根据用户角色动态获取限流值
- [x] 支持端点类型参数（default/data_sync/auth）
- [x] 支持降级机制（限流器未启用时直接返回原函数）

#### 1.2 替换硬编码限流

- [x] 替换 `backend/routers/data_sync.py` 中的硬编码限流（4个端点）
- [x] 替换 `backend/routers/auth.py` 中的硬编码限流（1个端点）
- [x] 替换 `backend/routers/users.py` 中的硬编码限流（7个端点）
- [x] 替换 `backend/routers/notification_websocket.py` 中的硬编码限流（1个端点）

#### 1.3 完善角色映射逻辑（修复新发现的漏洞）

- [x] 添加空字符串检查（`role_code` 和 `role_name` 不能为空字符串或仅空白字符）
- [x] 添加角色对象类型检查（支持字典和对象两种格式）
- [x] 优化多角色优先级实现（使用优先级列表，提高可维护性）

### Phase 2: 限流配额策略设计 - P1

#### 2.1 业务需求分析

- [ ] 分析各角色的典型使用场景
- [ ] 确定各角色的限流配额需求
- [ ] 设计配额分配策略

#### 2.2 配额配置设计

- [x] admin（管理员）：系统管理，最高配额
- [x] manager（主管）：审批、查看，较高配额
- [x] finance（财务）：报表查询，中等配额
- [x] operator（操作员）：日常操作，标准配额

#### 2.3 集成测试和验证

- [x] 创建集成测试，验证 API 端点实际使用角色限流
- [x] 测试多角色用户的限流行为
- [x] 验证不同角色获得不同的限流配额
- [x] 所有测试通过（43个测试用例，0失败）

### Phase 3: 配置可扩展性设计 - ✅ 已完成

#### 3.1 数据库配置支持（可选）

- [ ] 设计限流配置表结构
- [ ] 实现从数据库读取限流配置
- [ ] 支持运行时动态调整

#### 3.2 配置管理 API（可选）

- [ ] 创建限流配置管理 API
- [ ] 支持管理员动态调整限流配额
- [ ] 添加配置变更审计日志

## Impact

### 受影响的代码位置

| 类型               | 文件数  | 修改点数 | 优先级 | 状态          |
| ------------------ | ------- | -------- | ------ | ------------- |
| 限流中间件         | 1       | 50+      | P0     | ✅ 已完成     |
| 限流配置           | 1       | 30+      | P0     | ✅ 已完成     |
| 角色映射           | 1       | 20+      | P0     | ✅ 已完成     |
| **动态限流装饰器** | **1**   | **50+**  | **P0** | **✅ 已完成** |
| **替换硬编码限流** | **13**  | **100+** | **P0** | **✅ 已完成** |
| 配置管理（可选）   | 2       | 100+     | P2     | ✅ 已完成 |

### 预期效果

- ✅ **当前状态**：各角色使用合适的限流配额（基于角色动态获取）
- ✅ **目标状态**：各角色使用合适的限流配额（基于角色动态获取）
- ✅ 限流配置与实际角色系统一致（已完成）
- ✅ 所有 API 端点已应用基于角色的动态限流（已完成）
- ✅ 支持未来扩展（数据库配置、动态调整 - Phase 3 已完成）

## 角色限流配额设计建议

### 配额策略

| 角色      | 默认限流 | 数据同步限流 | 认证限流 | 说明                 |
| --------- | -------- | ------------ | -------- | -------------------- |
| admin     | 200/分钟 | 100/分钟     | 20/分钟  | 系统管理，最高配额   |
| manager   | 150/分钟 | 80/分钟      | 15/分钟  | 审批、查看，较高配额 |
| finance   | 120/分钟 | 30/分钟      | 10/分钟  | 报表查询，中等配额   |
| operator  | 100/分钟 | 50/分钟      | 10/分钟  | 日常操作，标准配额   |
| normal    | 60/分钟  | 30/分钟      | 5/分钟   | 降级方案             |
| anonymous | 30/分钟  | 10/分钟      | 3/分钟   | 未认证用户           |

### 设计原则

1. **职责导向**：根据角色职责分配配额
2. **安全优先**：认证接口限流更严格
3. **业务平衡**：数据同步配额适中，避免滥用
4. **可扩展性**：预留配置扩展空间

## 风险评估

| 风险                     | 严重程度 | 缓解措施                   | 状态            |
| ------------------------ | -------- | -------------------------- | --------------- |
| **基于角色的限流未应用** | **高**   | **立即实施 Phase 1**       | **✅ 已解决** |
| 配额设置不合理           | 中       | 充分测试，根据实际使用调整 | ⏳ 待验证       |
| 角色映射错误             | 高       | 完善测试，验证所有角色     | ✅ 已修复       |
| 配置变更影响             | 低       | 支持降级，保留默认配置     | ⏳ 待 Phase 3   |

## 后续优化

1. **数据库配置**：将限流配置存储在数据库中，支持动态调整
2. **智能限流**：根据用户历史行为动态调整配额
3. **配额告警**：当用户接近配额时发送提醒
4. **配额统计**：统计各角色的限流使用情况
