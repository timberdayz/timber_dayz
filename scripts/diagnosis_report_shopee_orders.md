# Shopee订单文件问题诊断报告

## 📊 问题确认

### 诊断结果
- **文件系统中Shopee订单文件**: 10个
- **数据库中Shopee订单文件总数**: 31个（有重复记录）
- **数据库中pending状态**: 1个
- **数据库中needs_shop状态**: 30个

### 问题根源
1. **前端默认筛选条件**: 只显示 `status='pending'` 的文件
2. **文件状态分布**: 大部分Shopee订单文件的状态是 `needs_shop`（需要指派店铺），而不是 `pending`
3. **数据库重复记录**: 数据库中有31个记录，但文件系统只有10个文件（可能是重复注册或历史记录）

## 🔍 扫描逻辑说明

### 扫描路径
- **扫描目录**: `data/raw`（项目根目录下的 `data/raw`）
- **实际路径**: `F:\Vscode\python_programme\AI_code\xihong_erp\data\raw`

### 扫描范围（重要限制）
- ✅ **扫描**: `data/raw/2025/`、`data/raw/2024/` 等年份分区目录（格式：`20XX`）
- ❌ **不扫描**: `data/raw/` 根目录下的文件
- ❌ **不扫描**: 其他非年份格式的目录

### 文件过滤条件
扫描时会跳过：
1. `.json` 文件（元数据文件）
2. 不支持的文件格式（只支持 `.csv`, `.xlsx`, `.xls`）
3. `data/raw/repaired/**` 目录下的文件（修复缓存）
4. 文件名不符合规范且无法解析的文件
5. 不在白名单中的平台/数据域/粒度

### 文件状态设置逻辑
- **`pending`**: 店铺解析成功（置信度≥0.9）
- **`needs_shop`**: 店铺解析失败（置信度<0.6）且不是 miaoshou 平台
- **`pending`**: miaoshou 平台（即使店铺解析失败，也设为 `pending`，`shop_id='none'`）

## ✅ 已实施的修复

### 1. 前端修复
- **修改位置**: `frontend/src/views/DataSyncFiles.vue`
- **修改内容**: 默认筛选条件从 `status: 'pending'` 改为 `status: null`
- **效果**: 默认显示所有状态的文件（包括 `pending` 和 `needs_shop`）

### 2. 后端API修复
- **修改位置**: `backend/routers/data_sync.py` 的 `list_files` API
- **修改内容**: `status` 参数默认值从 `"pending"` 改为 `None`
- **效果**: 当 `status` 为空时，不添加状态筛选条件，返回所有状态的文件

## 📋 待同步文件统计逻辑

### 当前逻辑
- **统计方式**: 直接扫描文件系统，统计扫描到的文件总数（415个）
- **说明**: 这样可以匹配扫描结果，而不是数据库中的pending总数

### 建议
如果需要区分不同状态的文件，可以考虑：
1. **待同步文件**: `pending` 状态的文件（可以直接同步）
2. **需要处理文件**: `pending` + `needs_shop` 状态的文件（需要人工处理）

## 🎯 验证步骤

1. **重启后端服务**: 使API修改生效
2. **刷新前端页面**: 查看文件列表是否显示所有状态的文件
3. **检查Shopee订单文件**: 应该能看到31个文件（包括pending和needs_shop状态）

## 💡 后续建议

1. **清理重复记录**: 检查并清理数据库中的重复文件记录
2. **优化店铺解析**: 提高Shopee订单文件的店铺解析成功率，减少needs_shop状态
3. **状态说明**: 在前端添加状态说明，让用户了解不同状态的含义

