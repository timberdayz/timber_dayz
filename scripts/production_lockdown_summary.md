# ç”Ÿäº§ç¯å¢ƒæœ€å°ç«¯å£æš´éœ²é…ç½®æ€»ç»“

**åˆ›å»ºæ—¶é—´**: 2025-01-09  
**çŠ¶æ€**: âœ… é…ç½®å®Œæˆå¹¶éªŒè¯é€šè¿‡

## âœ… é…ç½®å®Œæˆ

### å·²åˆ›å»ºçš„æ–‡ä»¶

1. **`docker-compose.prod.lockdown.yml`**
   - é”å®šæ ¸å¿ƒæœåŠ¡ç«¯å£ï¼ˆPostgreSQLã€Redisã€Backendã€Frontendã€Celery Exporterï¼‰
   - ä¿ç•™ Nginx çš„ 80/443 ç«¯å£

2. **`docker-compose.metabase.lockdown.yml`**
   - Metabase ç»‘å®šåˆ° `127.0.0.1:8080`ï¼Œä»…æœ¬åœ°è®¿é—®

3. **`scripts/production_lockdown_deployment_guide.md`**
   - å®Œæ•´çš„éƒ¨ç½²æŒ‡å—å’Œè¯´æ˜æ–‡æ¡£

4. **`scripts/test_production_lockdown.py`**
   - ç«¯å£é”å®šé…ç½®éªŒè¯è„šæœ¬

## ğŸ“Š ç«¯å£æ˜ å°„å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆä¸å®‰å…¨ï¼‰
| æœåŠ¡ | å®¿ä¸»æœºç«¯å£ | çŠ¶æ€ |
|------|-----------|------|
| postgres | 5432 | âŒ å¯¹å¤–æš´éœ² |
| redis | 6379 | âŒ å¯¹å¤–æš´éœ² |
| backend | 8000 | âŒ å¯¹å¤–æš´éœ² |
| frontend | 3000 | âŒ å¯¹å¤–æš´éœ² |
| nginx | 80, 443 | âœ… éœ€è¦æš´éœ² |
| celery-exporter | 9808 | âŒ å¯¹å¤–æš´éœ² |
| metabase | 8080 | âŒ å¯¹å¤–æš´éœ² |

**æ€»è®¡**: 7 ä¸ªå¯¹å¤–æš´éœ²ç«¯å£

### ä¿®æ”¹åï¼ˆå®‰å…¨ï¼‰
| æœåŠ¡ | å®¿ä¸»æœºç«¯å£ | çŠ¶æ€ |
|------|-----------|------|
| postgres | - | âœ… ä»…å®¹å™¨ç½‘ç»œ |
| redis | - | âœ… ä»…å®¹å™¨ç½‘ç»œ |
| backend | - | âœ… ä»…å®¹å™¨ç½‘ç»œ |
| frontend | - | âœ… ä»…å®¹å™¨ç½‘ç»œ |
| nginx | **80, 443** | âœ… **å”¯ä¸€å¯¹å¤–æš´éœ²** |
| celery-exporter | - | âœ… ä»…å®¹å™¨ç½‘ç»œ |
| metabase | **127.0.0.1:8080** | âœ… **ä»…æœ¬åœ°è®¿é—®** |

**æ€»è®¡**: 2 ä¸ªå¯¹å¤–æš´éœ²ç«¯å£ï¼ˆ80/443ï¼‰+ 1 ä¸ªæœ¬åœ°ç«¯å£ï¼ˆ127.0.0.1:8080ï¼‰

## ğŸ¯ å®‰å…¨æ€§æå‡

- âœ… **ç«¯å£æš´éœ²å‡å°‘**: ä» 7 ä¸ªå‡å°‘åˆ° 2 ä¸ªï¼ˆå‡å°‘ 71%ï¼‰
- âœ… **æ•°æ®åº“éš”ç¦»**: PostgreSQL å’Œ Redis å®Œå…¨éš”ç¦»ï¼Œå…¬ç½‘æ— æ³•è®¿é—®
- âœ… **åç«¯éš”ç¦»**: Backend API ä¸ç›´æ¥æš´éœ²ï¼Œåªèƒ½é€šè¿‡ Nginx è®¿é—®
- âœ… **å‰ç«¯éš”ç¦»**: Frontend ä¸ç›´æ¥æš´éœ²ï¼Œåªèƒ½é€šè¿‡ Nginx è®¿é—®
- âœ… **Metabase å®‰å…¨**: ä»…ç®¡ç†å‘˜å¯é€šè¿‡ SSH éš§é“è®¿é—®

## ğŸš€ éƒ¨ç½²å‘½ä»¤

### æ ¸å¿ƒæœåŠ¡ï¼ˆæ¨èï¼‰

```bash
docker-compose --env-file .env \
  -f docker-compose.yml \
  -f docker-compose.prod.yml \
  -f docker-compose.cloud.yml \
  -f docker-compose.prod.lockdown.yml \
  --profile production up -d
```

### æ ¸å¿ƒæœåŠ¡ + Metabase

```bash
docker-compose --env-file .env \
  -f docker-compose.yml \
  -f docker-compose.prod.yml \
  -f docker-compose.cloud.yml \
  -f docker-compose.metabase.yml \
  -f docker-compose.prod.lockdown.yml \
  -f docker-compose.metabase.lockdown.yml \
  --profile production up -d
```

## âœ… åŠŸèƒ½éªŒè¯

### æœåŠ¡é—´é€šä¿¡ï¼ˆä¸å—å½±å“ï¼‰

- âœ… åç«¯ â†’ æ•°æ®åº“: `postgres:5432`ï¼ˆå®¹å™¨ç½‘ç»œï¼‰
- âœ… åç«¯ â†’ Redis: `redis:6379`ï¼ˆå®¹å™¨ç½‘ç»œï¼‰
- âœ… Nginx â†’ åç«¯: `backend:8000`ï¼ˆå®¹å™¨ç½‘ç»œï¼‰
- âœ… Nginx â†’ å‰ç«¯: `frontend:80`ï¼ˆå®¹å™¨ç½‘ç»œï¼‰

### å¤–éƒ¨è®¿é—®

- âœ… å‰ç«¯: `http://YOUR_SERVER_IP/`ï¼ˆé€šè¿‡ Nginxï¼‰
- âœ… åç«¯ API: `http://YOUR_SERVER_IP/api/health`ï¼ˆé€šè¿‡ Nginxï¼‰
- âœ… Metabase: `http://localhost:8080`ï¼ˆä»…æœ¬åœ°ï¼Œéœ€ SSH éš§é“ï¼‰

## ğŸ” Metabase è®¿é—®æ–¹å¼

### SSH éš§é“ï¼ˆæ¨èï¼‰

```bash
# åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œ
ssh -L 8080:127.0.0.1:8080 deploy@YOUR_SERVER_IP

# ç„¶åæµè§ˆå™¨è®¿é—®
http://localhost:8080
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“ç®¡ç†å·¥å…·**: å¦‚éœ€ä½¿ç”¨ pgAdminï¼Œä½¿ç”¨ SSH éš§é“æˆ–ä¸´æ—¶å¼€æ”¾ç«¯å£
2. **Redis ç®¡ç†å·¥å…·**: ä½¿ç”¨ SSH éš§é“æˆ–åœ¨å®¹å™¨å†…ä½¿ç”¨ `redis-cli`
3. **ç›‘æ§å·¥å…·**: Prometheus åº”åœ¨åŒä¸€ Docker ç½‘ç»œä¸­ï¼Œé€šè¿‡å®¹å™¨ç½‘ç»œåè®¿é—®

## ğŸ“ å›é€€æ–¹æ¡ˆ

å¦‚éœ€å›é€€åˆ°åŸæ¥çš„é…ç½®ï¼ˆæ‰€æœ‰ç«¯å£éƒ½æš´éœ²ï¼‰ï¼š

```bash
# ä¸ä½¿ç”¨ lockdown é…ç½®æ–‡ä»¶
docker-compose --env-file .env \
  -f docker-compose.yml \
  -f docker-compose.prod.yml \
  -f docker-compose.cloud.yml \
  --profile production up -d
```

## âœ… æ€»ç»“

**é…ç½®çŠ¶æ€**: âœ… **å®Œæˆå¹¶éªŒè¯é€šè¿‡**

**å®‰å…¨æ€§**: âœ… **å¤§å¹…æå‡**ï¼ˆç«¯å£æš´éœ²å‡å°‘ 71%ï¼‰

**åŠŸèƒ½å®Œæ•´æ€§**: âœ… **ä¸å—å½±å“**ï¼ˆæ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œï¼‰

**éƒ¨ç½²å°±ç»ª**: âœ… **æ˜¯** - å¯ä»¥å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
